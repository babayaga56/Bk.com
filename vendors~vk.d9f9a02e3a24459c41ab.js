/*! For license information please see vendors~vk.d9f9a02e3a24459c41ab.js.LICENSE.txt */
(self.webpackChunkvk=self.webpackChunkvk||[]).push([[8],{408:function(e,t,i){"use strict";i.d(t,{Path:function(){return f}});var n=function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};var r=i(1516),a=/[^!$'()*+,;|:]/g,s=function(e){return e.replace(a,(function(e){return encodeURIComponent(e)}))},o={default:s,uri:encodeURI,uriComponent:encodeURIComponent,none:function(e){return e},legacy:encodeURI},c={default:decodeURIComponent,uri:decodeURI,uriComponent:decodeURIComponent,none:function(e){return e},legacy:decodeURIComponent},l=function(e,t,i){var n=o[t]||s;return i?String(e).split("/").map(n).join("/"):n(String(e))},u=function(e){return"("+(e?e.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%':|=+\\*@$]+")+")"},d=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(u(e[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^?]*)/},{name:"url-parameter-matrix",pattern:/^;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(e){return new RegExp(";"+e[1]+"="+u(e[2]))}},{name:"query-parameter",pattern:/^(?:\?|&)(?::)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(?:=([a-zA-Z0-9-_]+))?/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(e){return new RegExp("\\"+e[0])}},{name:"sub-delimiter",pattern:/^(!|&|-|_|\.|;)/,regex:function(e){return new RegExp(e[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(e){return new RegExp(e[0])}}],h=function e(t,i){if(void 0===i&&(i=[]),!d.some((function(n){var r=t.match(n.pattern);return!!r&&(i.push({type:n.name,match:r[0],val:r.slice(1,2),otherVal:r.slice(2),regex:n.regex instanceof Function?n.regex(r):n.regex}),r[0].length<t.length&&(i=e(t.substr(r[0].length),i)),!0)})))throw new Error("Could not parse path '"+t+"'");return i},p=function(e){return null!=e},_=function(e){return e.filter((function(e){return/^query-parameter/.test(e.type)})).reduce((function(e,t){return t.otherVal[0]&&(e[t.val[0]]=t.otherVal[0]),e}),{})},m={urlParamsEncoding:"default"},f=function(){function e(e,t){if(!e)throw new Error("Missing path in Path constructor");this.path=e,this.options=n(n({},m),t),this.tokens=h(e),this.hasUrlParams=this.tokens.filter((function(e){return/^url-parameter/.test(e.type)})).length>0,this.hasSpatParam=this.tokens.filter((function(e){return/splat$/.test(e.type)})).length>0,this.hasMatrixParams=this.tokens.filter((function(e){return/matrix$/.test(e.type)})).length>0,this.hasQueryParams=this.tokens.filter((function(e){return/^query-parameter/.test(e.type)})).length>0,this.spatParams=this.getParams("url-parameter-splat"),this.urlParams=this.getParams(/^url-parameter/),this.queryParams=this.getParams("query-parameter"),this.params=this.urlParams.concat(this.queryParams),this.source=this.tokens.filter((function(e){return void 0!==e.regex})).map((function(e){return e.regex.source})).join("")}return e.createPath=function(t,i){return new e(t,i)},e.prototype.isQueryParam=function(e){return-1!==this.queryParams.indexOf(e)},e.prototype.isSpatParam=function(e){return-1!==this.spatParams.indexOf(e)},e.prototype.test=function(e,t){var i=this,a=n(n({caseSensitive:!1,strictTrailingSlash:!1},this.options),t),s=function(e,t){return t||"\\/"===e?e:e.replace(/\\\/$/,"")+"(?:\\/)?"}(this.source,a.strictTrailingSlash),o=this.urlTest(e,s+(this.hasQueryParams?"(\\?.*$|$)":"$"),a.caseSensitive,a.urlParamsEncoding);if(!o||!this.hasQueryParams)return o;var c=(0,r.parse)(e,a.queryParams),l=Object.keys(c).some((function(e){return!i.isQueryParam(e)})),u=_(this.tokens),d=Object.keys(c).some((function(e){return!!u[e]&&u[e]!==c[e]}));return l||d?null:(Object.keys(c).forEach((function(e){return o[e]=c[e]})),o)},e.prototype.partialTest=function(e,t){var i=this,a=n(n({caseSensitive:!1,delimited:!0},this.options),t),s=function(e,t){return t?/(\/)$/.test(e)?e:e+"(\\/|\\?|\\.|;|$)":e}(this.source,a.delimited),o=this.urlTest(e,s,a.caseSensitive,a.urlParamsEncoding);if(!o)return o;if(!this.hasQueryParams)return o;var c=(0,r.parse)(e,a.queryParams);return Object.keys(c).filter((function(e){return i.isQueryParam(e)})).forEach((function(e){return function(e,t,i){void 0===i&&(i="");var n=e[t];return e[t]=void 0===n?i:Array.isArray(n)?n.concat(i):[n,i],e}(o,e,c[e])})),o},e.prototype.build=function(e,t){var i=this;void 0===e&&(e={});var a=n(n({ignoreConstraints:!1,ignoreSearch:!1,queryParams:{}},this.options),t),s=Object.keys(e).filter((function(e){return!i.isQueryParam(e)})).reduce((function(t,n){if(!p(e[n]))return t;var r=e[n],s=i.isSpatParam(n);return"boolean"==typeof r?t[n]=r:Array.isArray(r)?t[n]=r.map((function(e){return l(e,a.urlParamsEncoding,s)})):t[n]=l(r,a.urlParamsEncoding,s),t}),{});if(this.urlParams.some((function(t){return!p(e[t])}))){var o=this.urlParams.filter((function(t){return!p(e[t])}));throw new Error("Cannot build path: '"+this.path+"' requires missing parameters { "+o.join(", ")+" }")}if(!a.ignoreConstraints&&!this.tokens.filter((function(e){return/^url-parameter/.test(e.type)&&!/-splat$/.test(e.type)})).every((function(e){return new RegExp("^"+u(e.otherVal[0])+"$").test(s[e.val])})))throw new Error("Some parameters of '"+this.path+"' are of invalid format");var c=this.tokens.filter((function(e){return!1===/^query-parameter/.test(e.type)})).map((function(e){return"url-parameter-matrix"===e.type?";"+e.val+"="+s[e.val[0]]:/^url-parameter/.test(e.type)?s[e.val[0]]:e.match})).join("");if(a.ignoreSearch)return c;var d=_(this.tokens),h=this.queryParams.filter((function(t){return-1!==Object.keys(e).indexOf(t)||d[t]})).reduce((function(t,i){return t[i]=e[i]||d[i],t}),{}),m=(0,r.build)(h,a.queryParams);return m?c+"?"+m:c},e.prototype.getParams=function(e){var t=e instanceof RegExp?function(t){return e.test(t.type)}:function(t){return t.type===e};return this.tokens.filter(t).map((function(e){return e.val[0]}))},e.prototype.urlTest=function(e,t,i,n){var r=this,a=new RegExp("^"+t,i?"":"i"),s=e.match(a);return s?this.urlParams.length?s.slice(1,this.urlParams.length+1).reduce((function(e,t,i){return e[r.urlParams[i]]=(c[n]||decodeURIComponent)(t),e}),{}):{}:null},e}()},59:function(e,t,i){"use strict";i.r(t),i.d(t,{Api:function(){return En},ApiExternal:function(){return Un},ArrayDequeue:function(){return xn},AuthData:function(){return hi},BaseApi:function(){return C},BaseLogger:function(){return I},BaseSignaling:function(){return R},CallDirection:function(){return w},CallType:function(){return k},ChatRoomEventType:function(){return O},ConversationFeature:function(){return M},ConversationOption:function(){return x},DebugMessageType:function(){return bi},ExternalIdType:function(){return wi},FacingMode:function(){return Tt},FatalError:function(){return W},HangupReason:function(){return Be},HangupType:function(){return K},MediaOption:function(){return z},MediaTrackKind:function(){return He},MediaType:function(){return Oi},MuteState:function(){return Y},ParticipantState:function(){return Z},ParticipantStatus:function(){return vi},RecordRole:function(){return Ln},RoomsEventType:function(){return ee},Signaling:function(){return Dn},SignalingCommandType:function(){return In},SignalingConnectionType:function(){return ie},SignalingNotification:function(){return se},TransportTopology:function(){return en},UserRole:function(){return _e},UserType:function(){return ge},acceptCall:function(){return Zn},acceptPromotion:function(){return sa},activateRooms:function(){return qr},addMovie:function(){return Hr},addParticipant:function(){return rr},addParticipantInternal:function(){return ar},authorize:function(){return Qn},browser:function(){return Fn},callInternal:function(){return zn},callTo:function(){return qn},captureScreen:function(){return lr},captureVmoji:function(){return ur},changeConversationOptions:function(){return br},changeDevice:function(){return cr},changeParticipantState:function(){return fr},changePriorities:function(){return mr},changeVideoEffect:function(){return Xr},chatHistory:function(){return wr},chatMessage:function(){return Rr},chatMessageInternal:function(){return Ar},createJoinLink:function(){return Nr},customData:function(){return Pr},customDataInternal:function(){return kr},debug:function(){return Qr},debugMessage:function(){return Zr},declineCall:function(){return Xn},enableFeatureForRoles:function(){return da},feedback:function(){return la},forceRelayPolicy:function(){return Ur},getAnonymTokenByLink:function(){return Lr},getAudienceModeHands:function(){return na},getParticipantListChunk:function(){return oa},getParticipants:function(){return ca},getStreamInfo:function(){return Br},getWaitingHall:function(){return ia},grantRoles:function(){return vr},grantRolesInternal:function(){return Sr},hangup:function(){return nr},init:function(){return Kn},joinCall:function(){return er},joinCallByLink:function(){return ir},joinCallInternal:function(){return tr},muteParticipant:function(){return yr},muteParticipantInternal:function(){return Tr},pinParticipant:function(){return Er},pinParticipantInternal:function(){return Cr},processPush:function(){return Jn},processPushInternal:function(){return Yn},promoteParticipant:function(){return ra},publishStream:function(){return jr},recordSetConf:function(){return $r},removeHistoryRecords:function(){return pa},removeJoinLink:function(){return Mr},removeMovie:function(){return Gr},removeParticipant:function(){return sr},removeParticipantInternal:function(){return or},removeRooms:function(){return Jr},requestAsr:function(){return fa},requestPromotion:function(){return aa},setApi:function(){return $n},setAudioStream:function(){return ea},setLocalResolution:function(){return _r},setLogger:function(){return Hn},setMediaModifiers:function(){return Ir},setSignalingFactory:function(){return Bn},setStatisticsInterval:function(){return Yr},setVideoEffects:function(){return Wn},setVideoStream:function(){return dr},setVmoji:function(){return Gn},setVmojiSvg:function(){return ta},setVolume:function(){return xr},startAsr:function(){return _a},startAudienceConversation:function(){return Or},startConversation:function(){return Dr},startStream:function(){return Vr},stopAsr:function(){return ma},stopStream:function(){return Fr},switchRoom:function(){return zr},toggleLocalAudio:function(){return pr},toggleLocalVideo:function(){return hr},updateDisplayLayout:function(){return gr},updateMovie:function(){return Wr},updateRooms:function(){return Kr},userFeedbackStats:function(){return ua},utils:function(){return jn},version:function(){return ga}});var n,r,a,s=i(1426),o=i(778),c=i.n(o),l=i(985),u=i(779),d=i(1199),h=Object.defineProperty,p=Object.defineProperties,_=Object.getOwnPropertyDescriptors,m=Object.getOwnPropertySymbols,f=Object.prototype.hasOwnProperty,g=Object.prototype.propertyIsEnumerable,v=Math.pow,S=(e,t,i)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,y=(e,t)=>{for(var i in t||(t={}))f.call(t,i)&&S(e,i,t[i]);if(m)for(var i of m(t))g.call(t,i)&&S(e,i,t[i]);return e},T=(e,t)=>p(e,_(t)),E=(e,t,i)=>new Promise(((n,r)=>{var a=e=>{try{o(i.next(e))}catch(e){r(e)}},s=e=>{try{o(i.throw(e))}catch(e){r(e)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,s);o((i=i.apply(e,t)).next())})),C=class{createJoinLink(e){return E(this,null,(function*(){return{join_link:"nop"}}))}removeJoinLink(e){return E(this,null,(function*(){return{success:!0}}))}getAnonymTokenByLink(e,t){return E(this,null,(function*(){return""}))}log(e){}prepareUserIds(e){return E(this,null,(function*(){}))}getCachedOkIdByExternalId(e){return null}cacheExternalId(e,t){}hangupConversation(e){}sendUserFeedbackStats(e,t,i,n){}removeHistoryRecords(e){return E(this,null,(function*(){}))}cleanup(){}},I=class{log(e,t,i=!1){}destroy(){}},b=class{_triggerEvent(e,...t){if(this._handlers.hasOwnProperty(e))for(let i of this._handlers[e])i.apply(this,t)}addEventListener(e,t){if("function"!=typeof t)throw new Error("Listener should be a function");return this._handlers.hasOwnProperty(e)||(this._handlers[e]=[]),this._handlers[e].push(t),{dispose:this.removeEventListener.bind(this,e,t)}}removeEventListener(e,t){if(!this._handlers.hasOwnProperty(e))return;t||delete this._handlers[e];let i=this._handlers[e].indexOf(t);i>=0&&this._handlers[e].splice(i,1)}subscribe(e,t,i){let n=e.addEventListener(t,i);this._listeners.push(n)}unsubscribe(){this._listeners.forEach((e=>{e.dispose()}))}constructor(){this._handlers={},this._listeners=[]}},R=class extends b{get ready(){return!0}setParticipantIdRegistry(e){}requestRealloc(){}setEndpoint(e){}setConversationId(e){}readyToSend(e=!0){}cleanup(){}requestTestMode(e,t){}getNextCommandSequenceNumber(){return 0}},A=((n=A||{}).INCOMING="INCOMING",n.OUTGOING="OUTGOING",n.JOINING="JOINING",n),w=A,P=(e=>(e.USER="USER",e.GROUP="GROUP",e.CHAT="CHAT",e))(P||{}),k=P,D=((r=D||{}).ATTENDEE="ATTENDEE",r.HAND_UP="HAND_UP",r),O=D,N=(e=>(e.ADD_PARTICIPANT="ADD_PARTICIPANT",e.RECORD="RECORD",e.MOVIE_SHARE="MOVIE_SHARE",e))(N||{}),M=N,L=((a=L||{}).REQUIRE_AUTH_TO_JOIN="REQUIRE_AUTH_TO_JOIN",a.AUDIENCE_MODE="AUDIENCE_MODE",a.WAITING_HALL="WAITING_HALL",a.ASR="ASR",a.FEEDBACK="FEEDBACK",a),x=L;var U,V,F,j,$,B,H=((U=H||{}).MIC_CAMERA_PERMISSION="mic_camera",U.CAMERA_PERMISSION="camera",U.MIC_PERMISSION="mic",U.CAMERA_ACCESS="cameralock",U.MIC_ACCESS="miclock",U.MIC_NOT_FOUND="nomic",U.SCREEN_PERMISSION="screenpermission",U.SCREEN_ACCESS="screenlock",U.CONNECTION="connection",U.NETWORK="network",U.UNKNOWN="unknown",U.UNSUPPORTED="unsupported",U.SIGNALING_FAILED="signalingfailed",U.API="api",U.AUTH="auth",U),W=H,G=((V=G||{}).CANCELED="CANCELED",V.REJECTED="REJECTED",V.REMOVED="REMOVED",V.HUNGUP="HUNGUP",V.MISSED="MISSED",V.BUSY="BUSY",V.FAILED="FAILED",V.NETWORK_ERROR="NETWORK_ERROR",V.KILLED="KILLED",V.BANNED="BANNED",V.HAS_ACTIVE_CALL="HAS_ACTIVE_CALL",V.CALLER_IS_BLOCKED="CALLER_IS_BLOCKED",V.NOT_FRIENDS="NOT_FRIENDS",V.CALLEE_IS_OFFLINE="CALLEE_IS_OFFLINE",V.CALLER_IS_REJECTED="CALLER_IS_REJECTED",V.UNKNOWN_ERROR="UNKNOWN_ERROR",V.UNSUPPORTED="UNSUPPORTED",V.OLD_VERSION="OLD_VERSION",V.SERVICE_DISABLED="SERVICE_DISABLED",V.EXTERNAL_API_ERROR="EXTERNAL_API_ERROR",V.SOCKET_CLOSED="SOCKET_CLOSED",V.ENDED="ENDED",V.KILLED_WITHOUT_DELETE="KILLED_WITHOUT_DELETE",V.ANOTHER_DEVICE="ANOTHER_DEVICE",V.NOT_FOUND="NOT_FOUND",V),K=G,q=((F=q||{}).AUDIO="AUDIO",F.VIDEO="VIDEO",F.SCREEN_SHARING="SCREEN_SHARING",F.MOVIE_SHARING="MOVIE_SHARING",F.AUDIO_SHARING="AUDIO_SHARING",F.ANIMOJI="ANIMOJI",F),z=q,J=(e=>(e.UNMUTE="UNMUTE",e.MUTE="MUTE",e.MUTE_PERMANENT="MUTE_PERMANENT",e))(J||{}),Y=J,Q=((j=Q||{}).CALLED="CALLED",j.ACCEPTED="ACCEPTED",j.REJECTED="REJECTED",j.HUNGUP="HUNGUP",j),Z=Q,X=(e=>(e.UPDATE="UPDATE",e.REMOVE="REMOVE",e.ACTIVATE="ACTIVATE",e))(X||{}),ee=X,te=(e=>(e.START="start",e.ACCEPT="accept",e.JOIN="join",e.RETRY="retry",e))(te||{}),ie=te,ne=(e=>(e.NOTIFICATION="NOTIFICATION",e.FAILED="FAILED",e.RECONNECT="RECONNECT",e))(ne||{}),re=ne,ae=(($=ae||{}).TRANSMITTED_DATA="transmitted-data",$.ACCEPTED_CALL="accepted-call",$.HUNGUP="hungup",$.PARTICIPANT_ADDED="participant-added",$.PARTICIPANT_JOINED="participant-joined",$.CLOSED_CONVERSATION="closed-conversation",$.MEDIA_SETTINGS_CHANGED="media-settings-changed",$.PARTICIPANT_STATE_CHANGED="participant-state-changed",$.RATE_CALL_DATA="rate-call-data",$.FEATURE_SET_CHANGED="feature-set-changed",$.TOPOLOGY_CHANGED="topology-changed",$.PRODUCER_UPDATED="producer-updated",$.CONSUMER_ANSWERED="consumer-answered",$.MULTIPARTY_CHAT_CREATED="multiparty-chat-created",$.FORCE_MEDIA_SETTINGS_CHANGE="force-media-settings-change",$.SETTINGS_UPDATE="settings-update",$.VIDEO_QUALITY_UPDATE="video-quality-update",$.REGISTERED_PEER="registered-peer",$.SWITCH_MICRO="switch-micro",$.RECORD_STARTED="record-started",$.RECORD_STOPPED="record-stopped",$.REALLOC_CON="realloc-con",$.AUDIO_ACTIVITY="audio-activity",$.SPEAKER_CHANGED="speaker-changed",$.STALLED_ACTIVITY="stalled-activity",$.CHAT_MESSAGE="chat-message",$.CUSTOM_DATA="custom-data",$.ROLES_CHANGED="roles-changed",$.MUTE_PARTICIPANT="mute-participant",$.PIN_PARTICIPANT="pin-participant",$.OPTIONS_CHANGED="options-changed",$.NETWORK_STATUS="network-status",$.PARTICIPANT_SOURCES_UPDATE="participant-sources-update",$.PROMOTE_PARTICIPANT="promote-participant",$.CHAT_ROOM_UPDATED="chat-room-updated",$.PROMOTION_APPROVED="promotion-approved",$.JOIN_LINK_CHANGED="join-link-changed",$.FEEDBACK="feedback",$.MOVIE_UPDATE_NOTIFICATION="movie-update-notification",$.MOVIE_SHARE_STARTED="movie-share-started",$.MOVIE_SHARE_STOPPED="movie-share-stopped",$.ROOM_UPDATED="room-updated",$.ROOMS_UPDATED="rooms-updated",$.ROOM_PARTICIPANTS_UPDATED="room-participants-updated",$.FEATURES_PER_ROLE_CHANGED="features-per-role-changed",$.PARTICIPANT_ANIMOJI_CHANGED="participant-animoji-changed",$.ASR_STARTED="asr-started",$.ASR_STOPPED="asr-stopped",$),se=ae,oe=((B=oe||{}).ERROR="callError",B.DEVICES="callDevices",B.CALL_SPEC_ERROR="callSpecError",B.ICE_CONNECTION_STATE="callIceConnectionState",B.ICE_CONNECTION_TYPE="callIceConnectionType",B.ICE_RESTART="callIceRestart",B.PUSH="callPush",B.OUTGOING_CALL="callStart",B.OUTGOING_MULTIPARTY_CALL="callStartMultiparty",B.JOIN_CONVERSATION="callJoinConversation",B.ACCEPTED_OUTGOING="callAcceptedOutgoing",B.ACCEPT_INCOMING="callAcceptIncoming",B.DECLINE_INCOMING="callDeclineIncoming",B.ACCEPT_CONCURRENT="callAcceptConcurrent",B.HANGUP="callHangup",B.MEDIA_STATUS="callMediaStatus",B.DEVICE_CHANGED="callDeviceChanged",B.SOCKET_ACTION="callSocketAction",B.ADD_PARTICIPANT="callAddParticipant",B.REMOVE_PARTICIPANT="callRemoveParticipant",B.POOR_CONNECTION="callPoorConnection",B.TOPOLOGY_CHANGE_REQUESTED="callTopologyChangeRequested",B.RELAY_POLICY="callForceRelay",B.PAT_ALLOCATED="patAllocate",B.PAT_DEALLOCATED="patDeallocate",B.PAT_ERROR="patError",B.PAT_WAITING_TIME_ERROR="patWaitingTimeError",B.PAT_OUTDATED_RESPONSE="patOutdatedResponse",B.SIGNALING_CONNECTED="signaling_connected",B.RECONNECT="callReconnect",B.SCREENSHARE_FIRST_FRAME="screen_share_first_frame",B.SCREENSHARE_FREEZE_DURATION="callScreenshareFreezeDuration",B.FIRST_MEDIA_RECEIVED="first_media_received",B.CALL_EVENTUAL_STAT="callEventualStat",B),ce=oe,le=(e=>(e.AUDIO_MIX="audio-mix",e.PARTICIPANT_AGNOSTIC_TRACK_PREFIX="pat",e))(le||{}),ue=le,de=(e=>(e.NO_AVAILABLE_TRACKS="no-available-tracks",e.UNKNOWN_ERROR="unknown-error",e))(de||{}),he=de;var pe=(e=>(e.CREATOR="CREATOR",e.ADMIN="ADMIN",e))(pe||{}),_e=pe;function me(e,t){if(e.length!==t.length)return!1;for(let i of e)if(!t.includes(i))return!1;return!0}var fe=(e=>(e.USER="USER",e.GROUP="GROUP",e))(fe||{}),ge=fe,ve=2097152,Se=524288,ye=102400,Te="_okcls_logs_session_";function Ee(){return`${Te}${Date.now()}`}function Ce(e){return new Blob([e]).size}function Ie(e){try{window.localStorage.removeItem(e)}catch(e){console.error("Failed to remove log from storage",e)}}function be(){let e=ke.toString();if(!Pe.available||!e)return;let t=Ce(e);Pe.cleanup(t);try{window.localStorage.setItem(De,e)}catch(e){return console.warn("Failed to write log to storage",e),Pe.storageSize=Pe.size+t,Pe.cleanup(ye+t),Pe.available>=ye+t?void be():t>ye?(ke.bisect(),void be()):void(Pe.storageSize=0)}t>Se&&(Pe.add(De,t),De=Ee(),ke.clear(),Pe.cleanup(ye))}function Re(){!Pe.available||!ke.length||be()}function Ae(e=!1){let t=[];try{let e=window.localStorage;for(let i of Pe.items){let n=e.getItem(i.key);t.push(n)}let i=ke.toString();i&&t.push(i)}catch(e){console.error("Storage is blocked",e)}let i=`[${t.join(",")}]`;if(e)return i;let n=`logs_${Date.now()}.json`;return function(e,t){let i=document.createElement("a"),n=new Blob([e],{type:"text/json"});i.href=URL.createObjectURL(n),i.download=t,i.click()}(i,n),n}function we(){Pe||(Pe=new class{get size(){return this._itemsSize}get length(){return this._items.length}get available(){return Math.max(this._storageSize-this._itemsSize,0)}get items(){return this._items}set storageSize(e){this._storageSize=e}add(e,t){let i=parseInt(e.replace(Te,""),10);this._itemsSize+=t,this._items.push({key:e,size:t,date:i})}deleteOldestItem(){let e=this._items.shift();e&&(Ie(e.key),this._itemsSize-=e.size)}cleanup(e){for(;this.length&&(this.size>ve||this.length>4||this.size+e>this.available);)this.deleteOldestItem()}constructor(){this._items=[],this._itemsSize=0,this._storageSize=ve;try{let e=window.localStorage;for(let t of Object.keys(e)){if(0!==t.indexOf(Te))continue;let i=e.getItem(t);if(!i){Ie(t);continue}let n=Ce(i);this.add(t,n)}}catch(e){console.error("Storage is blocked",e),this._storageSize=0}this._items.sort(((e,t)=>e.date-t.date)),this.cleanup(ye)}},ke=new class{get length(){return this._items.length}push(...e){this._items.push(...e)}merge(e){this._items.push(...e._items)}shift(){return this._items.shift()||null}bisect(){let e=this.length>1?Math.floor(this.length/2):0;this._items=this._items.slice(e)}head(){return this._items[0]||null}tail(){let e=this._items.length;return e?this._items[e-1]:null}clear(){this._items=[]}toString(){return this._items.length?JSON.stringify(this._items,((e,t)=>t instanceof Error?String(t):t)):""}constructor(){this._items=[]}},De=Ee(),window.addEventListener("beforeunload",Re))}var Pe,ke,De,Oe=null;window.__VKCallsSDKLogs__=(e=!1)=>(Pe||we(),Re(),Ae(e));var Ne=class extends I{_send(e){this._api.log(e)}_sendBatch(){this._stopTimeout(),this._batch.length>0&&(this._send(this._batch),this._batch=[],this._startTimeout())}_startTimeout(){this._batchTimeout=window.setTimeout((()=>this._sendBatch()),this._batchInterval)}_stopTimeout(){this._batchTimeout&&(clearTimeout(this._batchTimeout),this._batchTimeout=null)}_onUnload(){this._sendBatch(),this._stopTimeout()}log(e,t,i=!1){let n={};void 0!==t&&(n.param=t),this._logInternal(e,n,i),this._externalLogger&&this._externalLogger.log(e,t,i)}logCustom(e,t,i=!1){this._logInternal(e,t,i)}_logInternal(e,t,i){let n={type:1,time:0,operation:e,timestamp:Date.now(),custom:Object.assign(t,{vcid:hn.id()}),uid:this._api.getUserId()};this._batch.push(n),(i||!this._batchTimeout)&&this._sendBatch()}destroy(){this._sendBatch(),this._stopTimeout(),this._externalLogger&&this._externalLogger.destroy()}static create(e,t){Ne._instance||(Ne._instance=new Ne(e,t))}static log(e,t,i=!1){Ne._instance&&Ne._instance.log(e,t,i)}static logCustom(e,t,i=!1){Ne._instance&&Ne._instance.logCustom(e,t,i)}static destroy(){Ne._instance&&Ne._instance.destroy(),Ne._instance=null}constructor(e,t){super(),this._batchInterval=3e3,this._batch=[],this._batchTimeout=null,this._api=e,this._externalLogger=t}},Me=class{_createWorker(e,t){return E(this,arguments,(function*(e,t,i=[],n={},r=[]){return new Promise(((a,s)=>{let o=i.join(","),c=new Blob([e,`exports.default(${o});`],{type:"application/javascript; charset=utf-8"}),l=window.URL.createObjectURL(c);this._worker=new Worker(l),this._worker.onmessage=e=>{switch(e.data.type){case"ready":a();break;case"error":s(e.data.error);break;case"frame":t(e.data);break;case"debug":Ai.debug(e.data.message);break;case"log_error":Ne.log(ce.ERROR,e.data.message)}},this._sendToWorker("init",n,r)}))}))}_removeWorker(){var e;null==(e=this._worker)||e.terminate(),this._worker=null}_sendToWorker(e,t={},i=[]){var n;null==(n=this._worker)||n.postMessage(Object.assign({type:e},t),i)}static isBrowserSupported(){throw new Error("Not implemented")}constructor(){this._worker=null}},Le=class extends Me{init(e){return E(this,null,(function*(){Ai.debug("LibVPxDecoder started"),yield this._createWorker('"use strict";var exports=(()=>{var d=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var R=(o,t)=>{for(var e in t)d(o,e,{get:t[e],enumerable:!0})},h=(o,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of x(t))!E.call(o,s)&&s!==e&&d(o,s,{get:()=>t[s],enumerable:!(a=y(t,s))||a.enumerable});return o};var V=o=>h(d({},"__esModule",{value:!0}),o);var D={};R(D,{default:()=>M});var M=(o,t)=>{let e=null,a=null,s=!0;function c(){return o({locateFile:t}).then(r=>a=r)}function f(r,u,n,m){if(!a){self.postMessage({type:"log_error",message:"decoder-init-fail-libvpx"}),self.postMessage({type:"frame",error:"Fatal initialization error"});return}if(s!==n&&(s=n,e&&(e=null,self.postMessage({type:"debug",message:`LibVPxDecoder codec changed to ${n?"VP9":"VP8"} - reinitialize`}))),!e&&(self.postMessage({type:"debug",message:`LibVPxDecoder codec ${n?"VP9":"VP8"}`}),e=new a.VpxDecoder,e.debug(m),!e.init(n?a.VpxType.VP9:a.VpxType.VP8))){e=null,self.postMessage({type:"frame",error:"Decoder failed to create"});return}try{e.allocateBuffer(u.byteLength).set(new Uint8Array(u))}catch(i){self.postMessage({type:"debug",message:i}),e=null,self.postMessage({type:"frame",error:String(i)});return}if(!(e.decode()&&e.nextImage())){self.postMessage({type:"frame",error:"Decode failed"});return}let l=e.getImageBuffer();if(!l){self.postMessage({type:"frame",error:"No decoded data"});return}let b=e.getImageWidth(),g=e.getImageHeight();e.nextImage()&&(self.postMessage({type:"debug",message:"LibVPxDecoder dropped frame"}),self.postMessage({type:"log_error",message:"LibVPxDecoder-drop"}));let p=new Uint8ClampedArray(l.byteLength);p.set(l),self.postMessage({type:"frame",data:p.buffer,width:b,height:g},[p.buffer])}c().then(()=>{self.onmessage=r=>{switch(r.data.type){case"frame":f(r.data.timestamp,r.data.data,r.data.isVP9,r.data.debug);break}},self.postMessage({type:"ready"})}).catch(r=>{self.postMessage({type:"error",error:String(r)})})};return V(D);})();\n',(t=>{if(t.error)Ai.warn("LibVPxDecoder",t.error);else{let i=new ImageData(new Uint8ClampedArray(t.data),t.width,t.height);e(i)}}),[c(),c().getUrl])}))}decodeFrame(e,t,i,n){this._sendToWorker("frame",{timestamp:e,data:t.buffer,isVP9:i,keyFrame:n,debug:Ai.enabled()},[t.buffer])}destroy(){this._removeWorker(),Ai.debug("LibVPxDecoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window}};function xe(e,t){if(e.isAudioEnabled!==t.isAudioEnabled||e.isVideoEnabled!==t.isVideoEnabled||e.isScreenSharingEnabled!==t.isScreenSharingEnabled||e.isFastScreenSharingEnabled!==t.isFastScreenSharingEnabled||e.isAudioSharingEnabled!==t.isAudioSharingEnabled||e.isAnimojiEnabled!==t.isAnimojiEnabled||e.videoStreams.length!==t.videoStreams.length)return!1;for(let i of e.videoStreams)if(!t.videoStreams.find((e=>e.id===i.id&&e.source===i.source)))return!1;return!0}function Ue(e){return Object.assign({isAudioEnabled:!1,isVideoEnabled:!1,isScreenSharingEnabled:!1,isFastScreenSharingEnabled:!1,isAudioSharingEnabled:!1,isAnimojiEnabled:!1,videoStreams:[]},e||{})}var Ve=e=>e.stop(),Fe=e=>e.getTracks().forEach(Ve);function je(e,t){return E(this,arguments,(function*(e,{width:t,height:i}){try{yield e.applyConstraints({width:{max:t,ideal:t},height:{max:i,ideal:i}})}catch(e){Ai.warn("setVideoResolution failed",e)}}))}var $e,Be=class extends Error{constructor(e,t){super(),this.name="HangupReason",this.code=t&&t.code||0,this.remote=t&&t.remote||!1,Object.values(K).indexOf(e)>-1?this.hangup=e:this.error=e;let i=[];this.error&&i.push("error"),this.remote&&i.push("remote"),this.code&&i.push(`code: ${this.code}`),t&&t.message&&i.push(`message: '${t.message}'`),this.message=e+(i.length?` (${i.join(", ")})`:""),Error.captureStackTrace&&Error.captureStackTrace(this,Be)}},He=(e=>(e.audio="audio",e.video="video",e.screen="screen",e.audioshare="audioshare",e))(He||{}),We=class extends b{request(){return E(this,arguments,(function*(e=[z.AUDIO],t=!0){var i;if(this._stream)return;let n=e.includes(z.VIDEO),r=e.includes(z.AUDIO),a=e.includes(z.ANIMOJI);if(!Pt.isBrowserSupported())throw new Be(W.UNSUPPORTED);try{this._stream=yield Pt.getUserMedia(n,r,t),null==(i=this._cameraVideoTrack)||i.stop(),this._cameraVideoTrack=this._stream.getVideoTracks()[0],this._mediaSettings.isVideoEnabled=n&&this._stream.getVideoTracks().filter((e=>e.enabled)).length>0||!1,this._mediaSettings.isAudioEnabled=r&&this._stream.getAudioTracks().filter((e=>e.enabled)).length>0||!1,this._mediaSettings.isAnimojiEnabled=a&&!this._mediaSettings.isVideoEnabled||!1,this._animojiEnabled=a}catch(e){throw new Be(e)}}))}getStream(){return this._stream}getScreenTrack(){return this._screenTrack}getSendVideoTrack(e=!1){return this._sendVideoTrack&&!e?this._sendVideoTrack:this._stream?this._stream.getVideoTracks()[0]:null}getSendAudioTrack(){var e;return(null==(e=this._stream)?void 0:e.getAudioTracks().find((e=>!e.contentHint)))||null}get isAnimojiRequested(){return this._animojiEnabled&&!this._mediaSettings.isVideoEnabled}addTrackToPeerConnection(e,t,i){let n=this.getStream(),r=this.getSendAudioTrack(),a=this.getSendVideoTrack(i);if(!n||!r&&!a&&!t)throw new Error("No local stream found");r&&!t&&e.addTrack(r,n),a&&!t&&e.addTrack(a,n)}getMediaSettings(){return this._mediaSettings}changeDevice(e){return E(this,null,(function*(){switch(e){case"videoinput":if(this._mediaSettings.isVideoEnabled)return this._changeVideoInput();break;case"audioinput":if(this._mediaSettings.isAudioEnabled)return this._changeAudioInput();break;default:return Promise.reject(W.UNKNOWN)}}))}stopVideoTrack(){var e;this._mediaSettings.isVideoEnabled&&(this._stopEffect(),this._stream&&this._stream.getVideoTracks().forEach(Ve),null==(e=this._cameraVideoTrack)||e.stop())}setVideoStream(e,t){return E(this,null,(function*(){return t?this._changeScreen(!1,!1,e):this._changeVideoInput(e)}))}_initDeviceChangeListener(){!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices||!navigator.mediaDevices.addEventListener||(this._onDeviceChange=e=>E(this,null,(function*(){var t,i;if(!this._stream)return;let n=Pt.getSavedMicrophone(),r=Pt.getSavedCamera(),a=this._mediaSettings.isAudioEnabled&&(null==n?void 0:n.groupId)!==(null==(t=e.microphone)?void 0:t.groupId),s=this._mediaSettings.isVideoEnabled&&(null==r?void 0:r.groupId)!==(null==(i=e.camera)?void 0:i.groupId);try{a&&(yield this._changeAudioInput()),s&&(yield this._changeVideoInput())}catch(e){}})),Pt.addEventListener("devicechange",this._onDeviceChange))}_destroyDeviceChangeListener(){this._onDeviceChange&&Pt.removeEventListener("devicechange",this._onDeviceChange)}_changeVideoInput(e){return E(this,null,(function*(){var t;this._busy();try{let i=e?"stream":"video",n=e||(yield Pt._getUserVideo(!!this._effect));if(null==(t=this._cameraVideoTrack)||t.stop(),this._cameraVideoTrack=n.getVideoTracks()[0],this._stream){_i.consumerScreenTrack||(yield this._disableScreenCapture());let e=yield this._setEffect(this._effect,this._cameraVideoTrack);Ne.log(ce.DEVICE_CHANGED,i),Ai.log("Video stream changed"),yield this._replaceLocalTrack(e),this._mediaSettings.isVideoEnabled=!0,this._triggerEvent("SOURCE_CHANGED",{kind:"video",mediaSettings:this._mediaSettings})}else Fe(n)}catch(e){throw Ne.log(ce.ERROR,"change_video"),Ai.warn("Camera change failed",e),e}finally{this._free()}}))}setAudioStream(e){return E(this,null,(function*(){return this._changeAudioInput(e)}))}_busy(){if(this._sourceBusy)throw Ne.log(ce.ERROR,"change_device"),Ai.warn("Device change failed: MediaSource is busy"),new Error("MediaSource is busy");this._sourceBusy=!0}_free(){this._sourceBusy=!1}_changeAudioInput(e=null){return E(this,null,(function*(){this._busy();try{if(e=e||(yield Pt.getUserAudio()),this._stream){let t=e.getAudioTracks()[0];Ne.log(ce.DEVICE_CHANGED,"audio"),Ai.log("Audio stream changed",t),yield this._replaceLocalTrack(t),this._mediaSettings.isAudioEnabled=!0,this._triggerEvent("SOURCE_CHANGED",{kind:"audio",mediaSettings:this._mediaSettings})}else Fe(e)}catch(e){throw Ne.log(ce.ERROR,"change_audio"),Ai.error("Microphone change failed",e),e}finally{this._free()}}))}_changeScreen(e,t,i){return E(this,null,(function*(){this._busy();try{if(i=i||(yield Pt.getScreenMedia(e,t)),this._stream){let n=i.getVideoTracks()[0];if(n.addEventListener("ended",(()=>{this._mediaSettings.isScreenSharingEnabled&&this.disableScreenCapturing()}),!1),_i.consumerScreenTrack||this._stopEffect(),Ne.log(ce.DEVICE_CHANGED,"screen"),Ai.log("Screen capturing started"),this._screenTrack=n,this._mediaSettings.isScreenSharingEnabled=!0,this._mediaSettings.isFastScreenSharingEnabled=e,_i.consumerScreenTrack||(this._videoStatusOnScreenCapturingEnabled=this._mediaSettings.isVideoEnabled,this._mediaSettings.isVideoEnabled=!0,this._sendVideoTrack=_i.consumerScreenDataChannel?Pt.getBlackMediaTrack(_i.videoMinWidth,_i.videoMinHeight):n,yield this._replaceLocalTrack(n,this._sendVideoTrack)),i.getAudioTracks().length>0){let e=i.getAudioTracks()[0];e.contentHint="music",this._audioShareTrack=e,yield this._replaceLocalTrack(e),this._mediaSettings.isAudioSharingEnabled=!0}t&&!this._mediaSettings.isAudioSharingEnabled&&Ai.debug("Audio share requested but not captured"),this._triggerEvent("SCREEN_STATUS",{track:n,mediaSettings:this._mediaSettings}),this._triggerEvent("SOURCE_CHANGED",{kind:"screen",mediaSettings:this._mediaSettings})}else Fe(i)}catch(e){throw Ne.log(ce.ERROR,"screen"),Ai.warn("Screen capturing failed",e),e}finally{this._free()}}))}_disableScreenCapture(){return E(this,null,(function*(){this._sendVideoTrack&&(this._sendVideoTrack.stop(),this._sendVideoTrack=null),this._screenTrack&&(this._screenTrack.stop(),this._screenTrack=null),yield this.stopAudioShareTrack(),this._mediaSettings.isScreenSharingEnabled&&(this._mediaSettings.isScreenSharingEnabled=!1,this._mediaSettings.isFastScreenSharingEnabled=!1,this._triggerEvent("SCREEN_STATUS",{mediaSettings:this._mediaSettings}),this._triggerEvent("SOURCE_CHANGED",{kind:"screen",mediaSettings:this._mediaSettings}))}))}disableAudioShare(){return E(this,null,(function*(){yield this.stopAudioShareTrack(),this._triggerEvent("SCREEN_STATUS",{mediaSettings:this._mediaSettings}),this._triggerEvent("SOURCE_CHANGED",{kind:"audioshare",mediaSettings:this._mediaSettings})}))}stopAudioShareTrack(){return E(this,null,(function*(){if(this._audioShareTrack){this._audioShareTrack.stop();let e=this.getSilentAudioShareTrack();yield this._replaceLocalTrack(e),this._mediaSettings.isAudioSharingEnabled=!1}}))}getSilentAudioShareTrack(){let e=Pt.getSilentMediaTrack();return e.contentHint="music",e.stop(),e}_replaceLocalTrack(e,t){return E(this,null,(function*(){var i,n;if(!this._stream)return;let r=this._stream.getTracks().find((t=>t.kind===e.kind&&t.contentHint===e.contentHint));r?(r.stop(),null==(i=this._stream)||i.removeTrack(r),null==(n=this._stream)||n.addTrack(e),this._triggerEvent("TRACK_REPLACED",e,t)):(this._stream.addTrack(e),this._triggerEvent("TRACK_REPLACED",e,t))}))}_setEffect(e,t){return E(this,null,(function*(){if(!_i.videoEffects)return t;try{return _i.videoEffects.setEffect(e,t)}catch(e){return Ai.warn("Video effect failed",e),t}}))}_stopEffect(){if(_i.videoEffects)try{_i.videoEffects.stopEffect()}catch(e){Ai.warn("Video effect failed",e)}}destroy(){var e;this._destroyDeviceChangeListener(),_i.videoEffects&&(this._effect=null,_i.videoEffects.destroy()),this._stream&&(Fe(this._stream),this._stream=null),null==(e=this._cameraVideoTrack)||e.stop(),this._disableScreenCapture()}toggleScreenCapturing(e){return E(this,null,(function*(){if(!e.captureScreen)return _i.consumerScreenTrack?this._disableScreenCapture():(e.captureAudio||(yield this.disableAudioShare()),this._videoStatusOnScreenCapturingEnabled?this._changeVideoInput():this.toggleVideo(!1));yield this._changeScreen(e.fastScreenSharing,e.captureAudio)}))}disableScreenCapturing(){return E(this,null,(function*(){return this.toggleScreenCapturing({captureScreen:!1,fastScreenSharing:!1,captureAudio:!1})}))}toggleVideo(e){return E(this,null,(function*(){var t;if(!this._stream)return;let i;if(_i.consumerScreenTrack||(yield this._disableScreenCapture()),null==(t=this._cameraVideoTrack)||t.stop(),e){let e=yield Pt._getUserVideo(!!this._effect);this._cameraVideoTrack=e.getVideoTracks()[0],i=yield this._setEffect(this._effect,this._cameraVideoTrack)}else i=Pt.getBlackMediaTrack(_i.videoMinWidth,_i.videoMinHeight),this._stopEffect();yield this._replaceLocalTrack(i),this._mediaSettings.isVideoEnabled=e,this._animojiEnabled?this._triggerEvent("ANIMOJI_STATUS",!e):this._triggerEvent("SOURCE_CHANGED",{kind:"video",mediaSettings:this._mediaSettings})}))}toggleAudio(e){return E(this,null,(function*(){if(!this._stream)return;let t;t=e?(yield Pt.getUserAudio()).getAudioTracks()[0]:Pt.getSilentMediaTrack(),yield this._replaceLocalTrack(t),this._mediaSettings.isAudioEnabled=e,this._triggerEvent("SOURCE_CHANGED",{kind:"audio",mediaSettings:this._mediaSettings})}))}toggleAnimojiCapturing(e){this._animojiEnabled=e,this._mediaSettings.isVideoEnabled||this._triggerEvent("ANIMOJI_STATUS",e)}onAnimojiSender(e){this._mediaSettings.isAnimojiEnabled=e,this._triggerEvent("SOURCE_CHANGED",{kind:"video",mediaSettings:this._mediaSettings})}setResolution(e){return E(this,arguments,(function*({video:e,effect:t}){if(!_i.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled||!this._mediaSettings.isVideoEnabled)return;if(!this._stream)throw new Error("Local stream not found");if(!this._cameraVideoTrack)throw new Error("Local video track not found");let i=this._effect&&t||e;yield je(this._cameraVideoTrack,i)}))}updateNoiseSuppression(){return E(this,null,(function*(){if(!this._stream||!this._mediaSettings.isAudioEnabled)return;let e=this._stream.getAudioTracks().find((e=>!e.contentHint));if(!e)throw new Error("Local audio track not found");return e.enabled?e.applyConstraints({noiseSuppression:_i.noiseSuppression}):void 0}))}videoEffect(e){return E(this,null,(function*(){if(!_i.videoEffects)throw new Error("Video Effects library is not set");if(!_i.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled)throw new Error("Can't apply effect to screensharing");if(Ne.log(ce.DEVICE_CHANGED,`effect_${(null==e?void 0:e.effect)||"none"}`),this._mediaSettings.isVideoEnabled){if(this._stream&&e!==this._effect&&this._cameraVideoTrack){let t=this._effect;this._effect=e;try{let t=this._cameraVideoTrack.clone(),i=new MediaStream([t]);return yield je(t,{width:e?_i.videoEffectMaxWidth:_i.videoMaxWidth,height:e?_i.videoEffectMaxHeight:_i.videoMaxHeight}),this._changeVideoInput(i)}catch(e){throw this._effect=t,e}}}else this._effect=e}))}getAudioShareTrack(){return this._audioShareTrack}constructor(){super(),this._stream=null,this._screenTrack=null,this._audioShareTrack=null,this._sendVideoTrack=null,this._cameraVideoTrack=null,this._mediaSettings=Ue(),this._videoStatusOnScreenCapturingEnabled=!1,this._effect=null,this._sourceBusy=!1,this._animojiEnabled=!1,this._initDeviceChangeListener(),_i.audioShare&&(this._audioShareTrack=this.getSilentAudioShareTrack())}},Ge="_okcls_",Ke=(()=>{try{let e=Date.now().toString(),t=window.localStorage,i=!1;return t.setItem(e,e),i=t.getItem(e)===e,t.removeItem(e),i?t:null}catch(e){return null}})();(e=>{e.get=function(e){return function(e){let t=Ke?Ke.getItem(Ge+e):null;if(null===t)return null;try{return JSON.parse(t)}catch(e){return null}}(e)||null},e.set=function(e,t){!function(e,t){try{Ke&&Ke.setItem(Ge+e,JSON.stringify(t))}catch(e){}}(e,t)},e.remove=function(e){!function(e){Ke&&Ke.removeItem(Ge+e)}(e)}})($e||($e={}));var qe=$e,ze="function"==typeof Object.fromEntries?Object.fromEntries:function(e){if(!e||!e[Symbol.iterator])throw new Error("Object.fromEntries() requires a single iterable argument");let t={};for(let[i,n]of e)t[i]=n;return t};var Je,Ye=":",Qe="a=fmtp:";(e=>{let t=/[\r\n]+/,i="\r\n";function n(e,t){let i,n=new RegExp("a=rtpmap:(\\d+) ([a-zA-Z0-9-]+)\\/\\d+"),r=[];for(i=0;i<e.length;++i){let a=e[i].match(n);a&&3===a.length&&a[2]===t&&r.push(a[1])}return r}function r(e,t,i){let n,r=e.split(" "),a=r.slice(0,3);for(n=3;n<r.length;n++)i.includes(r[n])&&a.push(r[n]);for(n=3;n<r.length;n++)!i.includes(r[n])&&!t.includes(r[n])&&a.push(r[n]);return a.join(" ")}function a(e,t,i,n){let a,s="m="+t;for(a=0;a<e.length;++a)e[a].startsWith(s)&&(e[a]=r(e[a],i,n))}function s(e,t,i,r){let s=n(e,"H264");if(t){let t,i=s.slice(0),n=new RegExp(Qe+"(\\d+) apt=(\\d+)");for(t=0;t<e.length;++t){let r=e[t].match(n);r&&3===r.length&&i.includes(r[2])&&i.push(r[1])}let r=new RegExp("a=(rtpmap|rtcp-fb|fmtp):(\\d+) .*");for(t=e.length;t--;){let n=e[t].match(r);n&&3===n.length&&i.includes(n[2])&&e.splice(t,1)}a(e,"video",i,[])}else i&&a(e,"video",[],s),r&&function(e,t){let i=new RegExp(Qe+"(\\d+)");for(let n=0;n<e.length;++n){let r=e[n].match(i);if(r&&2===r.length&&t.includes(r[1])){let t=e[n].trim()===Qe+r[1]?" ":";";e[n]+=t+"sps-pps-idr-in-keyframe=1"}}}(e,s)}function o(e){a(e,"video",[],n(e,"VP9"))}e.patchLocalSDP=function(e,r,c,l,u,d=!1,h=!1){if(!(r||c||l||h||d||u))return e;let p=e.split(t);return(c||r||u)&&s(p,c,r,u),l&&o(p),h&&function(e){let t=n(e,"red");t.length>0&&a(e,"audio",[],t)}(p),d&&function(e){let t=e.findIndex((e=>e.startsWith("a=rtcp-fb:111")));~t&&(e[t]=e[t]+i+["a=rtcp-fb:111 nack","a=rtcp-fb:111 nack pli"].join(i))}(p),p.join(i)},e.patchRemoteSDP=function(e){return"Firefox"===Pt.browserName()&&Number(Pt.browserVersion())<60&&(e=e.replace("m=application 9 UDP/DTLS/SCTP webrtc-datachannel","m=application 9 DTLS/SCTP 5000").replace("a=sctp-port:5000","a=sctpmap:5000 webrtc-datachannel 256")),e},e.patchDirectRemoteSDP=function(e,r,c,l){let u=e.split(t);return(c||r)&&s(u,c,r,!1),l&&o(u),a(u,"video",[],n(u,"VP9")),u.join(i)},e.getPeerIdString=function(e){return e?`${e.type||"WEB_SOCKET"}_${e.id}`:"_"},e.comparePeerId=function(e,t){return e&&e.id===t.id&&(e.type||"WEB_SOCKET")===(t.type||"WEB_SOCKET")},e.getPeerConnectionHostInfo=function(e){return E(this,null,(function*(){let t={local:null,remote:null};if(!e||!e.getStats)return t;try{let i=yield e.getStats(null),n=null;if(i.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId?n=i.get(e.selectedCandidatePairId):"candidate-pair"===e.type&&"succeeded"===e.state&&!n&&(!e.hasOwnProperty("selected")||e.selected)&&(n=e)})),null!=n&&n.localCandidateId){let e=i.get(n.localCandidateId);e&&(t.local={type:e.candidateType,ip:e.ip||e.ipAddress,port:e.port||e.portNumber})}if(null!=n&&n.remoteCandidateId){let e=i.get(n.remoteCandidateId);e&&(t.remote={type:e.candidateType,ip:e.ip||e.ipAddress,port:e.port||e.portNumber})}return t}catch(e){return t}}))};let c=/^[0-9]+$/,l=/^([gu])([0-9]+)$/;function u(e,t){let i=String(e);return l.test(i)?(Ai.warn(`Already composite id [${e}] type supplied [${t}]`),i):t===ge.GROUP?"g"+i:t===ge.USER?"u"+i:(Ai.warn(`Unknown type [${t}] for id [${e}]`),i.match(c)?"u"+i:i)}function d(e,t,i=0){return h(u(e,t),i)}function h(e,t){return t?e+Ye+"d"+t:e}function p(e){return d(e.id,e.idType||ge.USER,e.deviceIdx)}function _(e){let t=String(e),i=t.match(l);return i?{id:Number(i[2]),type:"g"===i[1]?ge.GROUP:ge.USER}:(Ai.warn(`Unsupported compositeId [${e}]`),{id:Number(t),type:ge.USER})}function m(e){let t=e.split(":d");return{compositeUserId:t[0],deviceIdx:t.length>1?parseInt(t[1],10):0}}function f(e,t,i,n,r){var a;if(e&&i&&"video"===i.kind){let s=i.getSettings();if(s){let o=e.maxBitrateK?1024*e.maxBitrateK:null,c=s.width,l=s.height,u=c&&l&&e.maxDimension?Math.max(1,Math.max(c,l)/e.maxDimension):null,d=e.maxFramerate?e.maxFramerate:null;if(c&&l&&e.maxDimension&&e.maxDimension>Math.max(c,l)){let e=Math.round(c*l/256),t=1e4*(Math.round(533*e/1e4)+1);o=null===o?t:Math.min(t,o)}let h=e.degradationPreference?e.degradationPreference:"balanced",p=n[i.id];if(p&&p.bitrate===o&&p.scaleResolutionDownBy===u&&p.maxFramerate===d&&p.degradationPreference===h)return void(r[i.id]=p);r[i.id]={bitrate:o,scaleResolutionDownBy:u,maxFramerate:d,degradationPreference:h};let _=t.getParameters();_.encodings||(_.encodings=[{}]),_.encodings.forEach((t=>{null!=e&&e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),o?t.maxBitrate=o:delete t.maxBitrate,u?t.scaleResolutionDownBy=u:delete t.scaleResolutionDownBy,d?t.maxFramerate=d:delete t.maxFramerate})),_.degradationPreference=h,null==(a=t.setParameters)||a.call(t,_)}}}e.composeUserId=u,e.composeParticipantId=d,e.compose=h,e.composeId=p,e.composeMessageId=function(e){return e.participant?p(e.participant):d(e.participantId,e.participantType||ge.USER,e.deviceIdx)},e.decomposeId=_,e.decomposeParticipantId=m,e.uuid=function(){var e,t;let i=null==(t=null==(e=window.crypto)?void 0:e.randomUUID)?void 0:t.call(e);if(i)return i;let n,r,a="0123456789abcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),o=0;for(r=0;r<36;r++)8===r||13===r||18===r||23===r?s[r]="-":14===r?s[r]="4":(o<=2&&(o=33554432+16777216*Math.random()|0),n=15&o,o>>=4,s[r]=a[19===r?3&n|8:n]);return s.join("")},e.throttle=function(e,t){let i;return function(){let n=this,r=arguments;i&&window.clearTimeout(i),i=window.setTimeout((()=>{e.apply(n,r)}),t)}},e.sdpFingerprint=function(e){if(!window.BigInt)return null;let t="",i=e.split("\n");for(let e of i)if(e.startsWith("a=fingerprint")){let i=e.split(" ");if(2===i.length){t=i[1];break}}if(!t)return BigInt(-1);let n=t.split(":"),r=BigInt(0);for(let e=Math.min(7,n.length-1);e>=0;e--){let t=BigInt(parseInt(n[e],16));r<<=BigInt(8),r|=t}return BigInt.asIntN(64,r)},e.delay=function(e){return E(this,null,(function*(){return new Promise((t=>window.setTimeout(t,e)))}))},e.applySettings=function(e,t,i){let n=[];return e.getSenders().forEach((e=>f(t,e,e.track,i,n))),n},e.applyVideoTrackSettings=f,e.includesOneOf=function(e,t){Array.isArray(t)||(t=[t]);for(let i of t)if(e.includes(i))return!0;return!1},e.mapParticipantState=function(e){var t;return Object.entries((null==(t=e.participantState)?void 0:t.state)||{}).reduce(((t,[i,n])=>(e.participantState&&(t[i]={ts:e.participantState.stateUpdateTs[i],state:n}),t)),{})},e.mapSharedParticipants=function(e){let t=e.map((e=>({uid:e.externalId,mediaSettings:e.mediaSettings,status:e.status,muteStates:e.muteStates,unmuteOptions:e.unmuteOptions,participantState:e.participantState,markers:e.markers,movieShareInfos:e.movieShareInfos})));return _i.filterObservers?t.filter((e=>!e.uid.observer)):t},e.isEqualParticipantState=function(e,t){let i=Object.keys(e),n=Object.keys(t);if(i.length!==n.length)return!1;for(let r of i)if(!n.hasOwnProperty(r)||e[r].state!==t[r].state||e[r].ts!==t[r].ts)return!1;return!0},e.isObjectsEquals=function(e,t){let i=Object.keys(e),n=Object.keys(t);if(i.length!==n.length)return!1;for(let n of i)if(!t.hasOwnProperty(n)||e[n]!==t[n])return!1;return!0},e.isArraysEquals=function(e,t){if(e.length!==t.length)return!1;for(let i of e)if(t.indexOf(i)<0)return!1;return!0},e.isEmptyObject=function(e){return!Object.keys(e).length},e.participantMarkerCompare=function(e,t){return e||t?e&&t?i(t.rank,e.rank)||i(e.ts,t.ts)||function(e,t){let n={[ge.USER]:0,[ge.GROUP]:1},{compositeUserId:r,deviceIdx:a}=m(e.id),{compositeUserId:s,deviceIdx:o}=m(t.id),{id:c,type:l}=_(r),{id:u,type:d}=_(s);return i(n[l],n[d])||i(c,u)||i(a,o)}(e,t):e?-1:1:0;function i(e,t){return e<t?-1:e===t?0:1}},e.objectFilterOutValues=function(e,t){let i=Object.entries(e).filter((([,e])=>Array.isArray(t)?!t.includes(e):e!==t));return ze(i)},e.objectReduce=function(e,t,i){let n=i;for(let i in e)e.hasOwnProperty(i)&&(n=t(n,e[i],i));return n},e.setImmediate=(()=>{let e=1,t={},i=null;return"undefined"!=typeof MessageChannel&&(i=new MessageChannel,i.port1.onmessage=e=>{let i=e.data;t[i]&&(t[i](),delete t[i])}),function(n){if(i&&"hidden"===document.visibilityState){let r=e;return e=e>=Number.MAX_SAFE_INTEGER?1:e+1,t[r]=n,i.port2.postMessage(r),()=>{t[r]&&delete t[r]}}let r=setTimeout(n,0);return()=>clearTimeout(r)}})(),e.isObject=function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}})(Je||(Je={}));var Ze,Xe,et,tt,it=Je,nt=null,rt=null,at=[],st=[],ot=[],ct=null,lt=null,ut=null,dt=!1,ht=!1,pt=null,_t="",mt=[],ft=null,gt=navigator.appVersion,vt=navigator.appName,St=navigator.userAgent,yt={},Tt=(e=>(e.USER="user",e.ENVIRONMENT="environment",e))(Tt||{});(tt=Tt||(Tt={})).contains=function(e){return Object.values(tt).includes(e)};var Et,Ct=class{getNative(){return Object.assign({},{audio:this.audio,video:this.video})}simplify(){return"object"==typeof this.video&&(this.video.width||this.video.height?(delete this.video.width,delete this.video.height):this.video.aspectRatio?delete this.video.aspectRatio:this.video.frameRate?delete this.video.frameRate:(this.video.deviceId||this.video.groupId||this.video.facingMode)&&(delete this.video.deviceId,delete this.video.groupId,delete this.video.facingMode)),"object"==typeof this.audio&&(this.audio.echoCancellation||this.audio.autoGainControl||this.audio.noiseSuppression?(delete this.audio.echoCancellation,delete this.audio.autoGainControl,delete this.audio.noiseSuppression):(this.audio.deviceId||this.audio.groupId)&&(delete this.audio.deviceId,delete this.audio.groupId)),!0===this.video&&!0===this.audio?this.video=!1:!1===this.video&&!0===this.audio?(this.audio=!1,this.video=this.needVideo):!0===this.video&&!1===this.audio&&(this.video=!1),this.video&&!Object.keys(this.video).length&&(this.video=!0),this.audio&&!Object.keys(this.audio).length&&(this.audio=!0),!this.audio&&!this.video&&(this.lastSimplifyWasReached=!0,this.audio=!this.isVideoRequested(),this.video=this.isVideoRequested()),this}canSimplify(){let e="object"==typeof this.video&&(this.video.width||this.video.height||this.video.aspectRatio||this.video.frameRate||this.video.facingMode||this.video.deviceId||this.video.groupId)||this.video;return!!("object"==typeof this.audio&&(this.audio.deviceId||this.audio.groupId||this.audio.noiseSuppression||this.audio.echoCancellation||this.audio.autoGainControl)||this.audio||e)&&!this.lastSimplifyWasReached}isVideo(){return!!this.video}isAudio(){return!!this.audio}constructor(e,t=!1,i=_i.videoMaxWidth,n=_i.videoMaxHeight){this.isVideoRequested=()=>this.needVideo;let r=!1;if(e){let t,i;if(r={noiseSuppression:_i.noiseSuppression,echoCancellation:!0,autoGainControl:!0},lt&&(i=lt.groupId,t=lt.deviceId),"string"==typeof e){let n=Et.getMicrophones().find((t=>t.deviceId===e));i=null==n?void 0:n.groupId,t=e}i?r.groupId={ideal:i}:t&&(r.deviceId={exact:t})}let a=!1;if(t){let e,r;if(a={width:{min:_i.videoMinWidth,max:i,ideal:i},height:{min:_i.videoMinHeight,max:n,ideal:n},aspectRatio:{ideal:_i.videoAspectRatio},frameRate:{ideal:_i.videoFrameRate}},ct&&(r=ct.groupId,e=ct.deviceId),"string"==typeof t){let i=Et.getCameras().find((e=>e.deviceId===t));r=null==i?void 0:i.groupId,e=t}r?a.groupId={ideal:r}:e&&(a.deviceId={exact:e}),_i.videoFacingMode&&(a.facingMode={ideal:_i.videoFacingMode},delete a.deviceId,delete a.groupId)}this.audio=r,this.video=a,this.needVideo=!!a,this.lastSimplifyWasReached=!1}},It=class extends Ct{getNative(){return Object.assign(super.getNative(),{systemAudio:"exclude",controller:this.captureController})}constructor(e,t,i,n){super(!1,!0),this.captureController="CaptureController"in window?new CaptureController:null,"object"==typeof this.video?(delete this.video.deviceId,delete this.video.groupId,delete this.video.aspectRatio,delete this.video.frameRate,delete this.video.facingMode):this.video={},this.video.cursor="motion",this.video.width={max:e},this.video.height={max:t},this.video.frameRate=i,this.video.displaySurface=_i.displaySurface,n&&(this.audio={noiseSuppression:!1,echoCancellation:!1,autoGainControl:!1})}};function bt(){return E(this,null,(function*(){ht=!1,nt=null;let e={camera:Et.getSavedCamera(),microphone:Et.getSavedMicrophone(),output:Et.getSavedOutput()};yield Rt(),function(e,...t){if(yt[e])for(let i of yt[e])i(...t)}("devicechange",e),Ii.onDeviceChange()}))}function Rt(){return E(this,null,(function*(){return nt||(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(!rt&&navigator.mediaDevices.addEventListener&&(rt=it.throttle(bt,_i.enumerateDevicesDelay),navigator.mediaDevices.addEventListener("devicechange",rt)),nt=navigator.mediaDevices.enumerateDevices().then((e=>{at=e.filter((e=>"videoinput"===e.kind&&(e.label&&(dt=!0),!0))),st=e.filter((e=>"audioinput"===e.kind&&(e.label?ht=!0:Et.isMobile()&&"Firefox"===Et.browserName()&&(ht=dt),!0))),ot=e.filter((e=>"audiooutput"===e.kind));let t=qe.get("videoinput")||(null==ct?void 0:ct.deviceId),i=qe.get("audioinput")||(null==lt?void 0:lt.deviceId),n=qe.get("audiooutput")||(null==ut?void 0:ut.deviceId);return ct=at.find((e=>e.deviceId===t))||null,lt=st.find((e=>e.deviceId===i))||null,ut=ot.find((e=>e.deviceId===n))||ot[0]||null,nt=Promise.resolve(e),e})).catch((()=>(nt=null,[])))):[])}))}function At(e,t){return E(this,null,(function*(){Ai.debug("Try to get media",JSON.parse(JSON.stringify(e.getNative())));let i=Et.hasPermissions(e.isVideo());!i&&!t&&Ii.onPermissionsRequested();try{let t=yield navigator.mediaDevices.getUserMedia(e.getNative());return i||(yield bt()),function(e){if(ct&&lt)return;let t=(e,t)=>{var i;let n=null==(i=t.getSettings())?void 0:i.deviceId;return e.find((e=>e.deviceId===n||e.label===t.label))||null};null==e||e.getTracks().forEach((e=>{lt||"audio"!==e.kind?!ct&&"video"===e.kind&&(ct=t(Et.getCameras(),e)):lt=t(Et.getMicrophones(),e)}))}(t),t}catch(i){switch(Ai.error("getUserMedia error",i),i.name){case"PermissionDeniedError":case"PermissionDismissedError":case"NotAllowedError":case"SecurityError":case"DOMException":t=e.isVideoRequested()?W.CAMERA_PERMISSION:W.MIC_PERMISSION;break;case"OverconstrainedError":case"TypeError":case"NotFoundError":t=W.UNKNOWN;break;case"AbortError":case"NotReadableError":t=e.isVideoRequested()?W.CAMERA_ACCESS:W.MIC_ACCESS}if(e.canSimplify())return At(e.simplify(),t);let n=t||W.UNKNOWN;throw Ii.onPermissionsError(n,i),n}}))}function wt(){return mt.length||(mt=(()=>{let e,t=!1,i=0,n="0",r=St.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(r[1]))return e=/\brv[ :]+(\d+)/g.exec(St),["IE",e&&e[1]||"Unknown",t,i,n];if("Safari"===r[1]){if(e=St.match(/\bEdge\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,i,n];if(e=St.match(/\bCriOS\/(\d+)/),e)return["Chrome",e[1],!0,Number(e[1]),n];if(e=St.match(/\bFxiOS\/(\d+)/),e)return["Firefox",e[1],!1,i,n];if(e=St.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1],!1,i,n];if(e=St.match(/\bOPT\/(\d+)/),e)return["Opera",e[1],!1,i,n]}if("Chrome"===r[1]){if(t=!0,i=Number(r[2]),e=St.match(/\bOPR\/(\d+)/),e)return["Opera",e[1]||"Unknown",t,i,n];if(e=St.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1]||"Unknown",t,i,n];if(e=St.match(/\bSferum\/((\d+)(?:\.\d+)*)/),e)return["Sferum",e[1]||"Unknown",t,i,n];if(e=St.match(/\bEdge?\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,i,n];if(void 0!==window.opr&&/^(.+\.)?ok.ru$/.test(window.location.host))return["Opera","Hidden",t,i,n]}return e=St.match(/version\/(\d+)(?:(?:\.)(\d+))?/i),e&&void 0!==e[2]&&(n=e[2]),[r[2]?r[1]:vt,e&&e[1]||r[2]||gt,t,i,n]})()),mt}(e=>{function t(){return at.length>0}function i(){return st.length>0}function n(){return dt}function r(){return ht}function a(){return wt()[0]}function s(){return wt()[1]}e.init=function(){return E(this,null,(function*(){let t=()=>{e.getSilentMediaTrack(),document.removeEventListener("click",t),document.removeEventListener("touchstart",t)};return document.addEventListener("click",t),document.addEventListener("touchstart",t),Rt()}))},e.getCameras=function(){return at},e.getMicrophones=function(){return st},e.getOutput=function(){return ot},e.hasCamera=t,e.hasMicrophone=i,e.getSavedCamera=function(){return ct},e.getSavedMicrophone=function(){return lt},e.getSavedOutput=function(){return ut},e.getVideoFacingMode=function(){return _i.videoFacingMode},e.hasCameraPermission=n,e.hasMicrophonePermission=r,e.hasPermissions=function(e=!1){return!!r()&&(!t()||!e||n())},e.getUserMedia=function(n=!1,r=!0,a=!0){return E(this,null,(function*(){let s,o=i()&&r,c=t()&&n;if(o||c)try{s=yield At(new Ct(o,c))}catch(e){s=new MediaStream}else s=new MediaStream;return!s.getVideoTracks().length&&a&&s.addTrack(e.getBlackMediaTrack()),!s.getAudioTracks().length&&a&&s.addTrack(e.getSilentMediaTrack()),s}))},e.getScreenMedia=function(e,t){return E(this,null,(function*(){let i=e?_i.fastScreenShareWidth:window.screen.width,n=e?_i.fastScreenShareHeight:window.screen.height,r=_i.getScreenFrameRate(e);return function(e){return E(this,null,(function*(){var t;Ai.debug("Try to get screen",JSON.parse(JSON.stringify(e.getNative())));try{let i=yield navigator.mediaDevices.getDisplayMedia(e.getNative()),n=null==i?void 0:i.getVideoTracks()[0];if(n){let i=null==(t=n.getSettings())?void 0:t.displaySurface;if(Ai.debug(`Got display media track: ${n.id} (${i})`),n.contentHint="text",e.captureController&&("browser"===i||"window"===i))try{e.captureController.setFocusBehavior("no-focus-change")}catch(e){Ai.warn("Failed to set focus behavior",e)}}return i}catch(e){switch(e.name){case"PermissionDeniedError":case"NotAllowedError":case"SecurityError":throw W.SCREEN_PERMISSION;default:throw W.SCREEN_ACCESS}}}))}(new It(i,n,r,t))}))},e._getUserVideo=function(e=!1){return E(this,null,(function*(){let t=e?_i.videoEffectMaxWidth:_i.videoMaxWidth,i=e?_i.videoEffectMaxHeight:_i.videoMaxHeight;return At(new Ct(!1,!0,t,i))}))},e.getUserVideo=function(e,t){return E(this,null,(function*(){let i=(null==t?void 0:t.width)||_i.videoMaxWidth,n=(null==t?void 0:t.height)||_i.videoMaxHeight;return At(new Ct(!1,e||!0,i,n))}))},e.getUserAudio=function(e){return E(this,null,(function*(){return At(new Ct(e||!0,!1))}))},e.setResolution=function(e,t){return E(this,null,(function*(){let[i]=e.getVideoTracks();if(!i)throw new Error("Video track not found in stream");return je(i,t)}))},e._saveDeviceId=function(e,t){return E(this,null,(function*(){let i=(yield Rt()).find((i=>i.kind===e&&i.deviceId===t));return i?("videoinput"===e?ct=i:"audioinput"===e?lt=i:"audiooutput"===e&&(ut=i),qe.set(e,t),i):null}))},e.getSilentMediaTrack=function(){if(!et||"ended"===et.readyState){let t=e.getAudioContext(),i=t.createMediaStreamDestination(),n=t.createGain();n.gain.value=1e-5,n.connect(i),n.connect(t.destination);let r=t.createOscillator();r.type="sine",r.frequency.value=0,r.connect(n),r.start(),et=i.stream.getAudioTracks()[0]}return Object.assign(et.clone(),{enabled:!1})},e.getBlackMediaTrack=function(e=_i.videoMinWidth,t=_i.videoMinHeight){Xe||(Xe=document.createElement("canvas")),Xe.width=e,Xe.height=t;let i=Xe.getContext("2d");return i.rect(0,0,e,t),i.fillStyle="black",i.fill(),(!Ze||"ended"===Ze.readyState)&&(Ze=Xe.captureStream(_i.videoFrameRate).getVideoTracks()[0]),Object.assign(Ze.clone(),{enabled:!1})},e.isBrowserSupported=function(){if("Edge"===a()&&Number(s())<70)return!1;try{let e=window;return!!("mediaDevices"in e.navigator&&"getUserMedia"in e.navigator.mediaDevices&&e.RTCPeerConnection&&e.RTCIceCandidate&&e.RTCSessionDescription&&e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype.captureStream&&e.RTCRtpSender&&e.RTCRtpSender.prototype.replaceTrack&&e.RTCRtpSender.prototype.getParameters&&"sendBeacon"in navigator)}catch(e){return!1}},e.isScreenCapturingSupported=function(){return!!navigator.mediaDevices.getDisplayMedia},e.isBrokenH264=function(){let t="Safari"===e.browserName()&&"15"===e.browserVersion()&&"1"===e.browserSubVersion(),i="Opera"===e.browserName()&&"Windows"===e.os();return t||i},e.canPreferH264=function(){return!(e.baseChromeVersion()&&e.isMobile())},e.os=function(){return _t||(_t=(()=>{let e={Windows:/Win/,Android:/Android/,OpenBSD:/OpenBSD/,SunOS:/SunOS/,Linux:/(Linux|X11)/,iPad:/(iPad)/,iPhone:/(iPhone)/,iPod:/(iPod)/,MacOS:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh|Mac OS X)/,QNX:/QNX/,UNIX:/UNIX/,BeOS:/BeOS/,OS2:/OS\/2/,Bot:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/};for(let t in e)if(e.hasOwnProperty(t)&&e[t].test(St))return t;return"Unknown"})()),_t},e.isMobile=function(){return null===pt&&(pt=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(gt)),pt},e.browserName=a,e.browserVersion=s,e.baseChromeVersion=function(){return wt()[3]},e.getAudioContext=function(){return ft||(ft=new(window.AudioContext||window.webkitAudioContext)),ft},e.browserSubVersion=function(){return wt()[4]},e.isAudioShareSupported=function(){return e.baseChromeVersion()>=105&&!e.isMobile()},e.addEventListener=function(e,t){yt[e]||(yt[e]=[]),yt[e].push(t)},e.removeEventListener=function(e,t){if(yt[e])if(t){let i=yt[e].indexOf(t);i>-1&&yt[e].splice(i,1)}else delete yt[e]}})(Et||(Et={}));var Pt=Et,kt=class extends Me{init(e){return E(this,null,(function*(){Ai.debug("WebCodecsDecoder started"),yield this._createWorker('"use strict";var exports=(()=>{var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var E=(o,e)=>{for(var t in e)c(o,t,{get:e[t],enumerable:!0})},g=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of f(e))!b.call(o,r)&&r!==t&&c(o,r,{get:()=>e[r],enumerable:!(s=p(e,r))||s.enumerable});return o};var V=o=>g(c({},"__esModule",{value:!0}),o);var y={};E(y,{default:()=>k});var k=o=>{let e=null,t=!0;function s(){self.postMessage({type:"ready"})}function r(a,l,n,i=!1){if(!e||t!==n){if(!i){self.postMessage({type:"debug",message:"WebCodecsDecoder dropped frame - waiting for keyframe"});return}t=n,e?self.postMessage({type:"debug",message:`WebCodecsDecoder codec changed to ${n?"VP9":"VP8"}`}):(self.postMessage({type:"debug",message:`WebCodecsDecoder codec ${n?"VP9":"VP8"}`}),e=new VideoDecoder({output:d=>{let m=o?[d]:[];self.postMessage({type:"frame",data:d},m),d.close()},error:d=>{e&&e.state!=="closed"&&e.close(),e=null,self.postMessage({type:"frame",error:"WebCodecsDecoder failed, reinitialize: "+String(d)})}})),e.configure({codec:n?"vp09.00.50.08":"vp8"})}let u=new EncodedVideoChunk({type:i?"key":"delta",timestamp:a,data:l});e.decode(u)}self.onmessage=a=>{switch(a.data.type){case"init":s();break;case"frame":r(a.data.timestamp,a.data.data,a.data.isVP9,a.data.keyFrame);break}}};return V(y);})();\n',(t=>{t.error?Ai.warn("WebCodecsDecoder",t.error):(e(t.data),t.data.close())}),[Pt.baseChromeVersion()>=92||"Safari"===Pt.browserName()])}))}decodeFrame(e,t,i,n=!1){this._sendToWorker("frame",{timestamp:e,data:t.buffer,isVP9:i,keyFrame:n},[t.buffer])}destroy(){this._removeWorker(),Ai.debug("WebCodecsDecoder destroyed")}static isBrowserSupported(){return"VideoDecoder"in window&&"Worker"in window&&"VideoFrame"in window}},Dt=class{increment(e=1){this._counter+=e}calculate(){var e;let t=Date.now(),i=t-this._lastCalculationTime,n=Math.round(1e3*this._counter/i);return this._counter=0,this._lastCalculationTime=t,null==(e=this._onCalculated)||e.call(this,n),n}destroy(){window.clearInterval(this._interval),this._interval=0}constructor(e=null,t=0){this._counter=0,this._interval=0,this._lastCalculationTime=Date.now(),this._onCalculated=null,this._onCalculated=e,t&&(this._interval=window.setInterval((()=>this.calculate()),t))}};function Ot(e,t,i=0){return t in e&&e[t]?e[t]:i}function Nt(...e){return t=>{for(let i of e)if(i(t))return!0;return!1}}function Mt(e,t){return i=>i[e]===t}function Lt(e,t){return t.reduce(((t,i)=>(t[i[e]]=i,t)),{})}function xt(e){let t={},i=[];for(let n of e)t[n.id]||(t[n.id]=!0,i.push(n));return i}function Ut(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>[t,e[t]])).reduce(((e,t)=>(e[t[0]]=it.isObject(t[1])?Ut(t[1]):t[1],e)),{})}function Vt(e){let t=[];for(let i of e)i.forEach((e=>t.push(e)));return t}function Ft(e){let t=e.filter(Mt("type","candidate-pair")).sort(function(e){return(t,i)=>t[e]-i[e]}("priority")).find(Nt(Mt("nominated",!0),Mt("selected",!0)));if(!t)return{totalRoundTripTime:0,currentRoundTripTime:0,bytesSent:0,bytesReceived:0};let i={totalRoundTripTime:t.totalRoundTripTime||0,currentRoundTripTime:t.currentRoundTripTime||0,bytesSent:t.bytesSent||0,bytesReceived:t.bytesReceived||0},n=e.find(Mt("id",t.remoteCandidateId));n&&Object.assign(i,{remote:{type:n.candidateType,address:n.ip||n.address,port:n.port,protocol:n.protocol}});let r=e.find(Mt("id",t.localCandidateId));return r&&Object.assign(i,{local:{type:r.candidateType,address:r.ip||r.address,port:r.port,protocol:r.protocol,relayProtocol:r.relayProtocol,networkType:r.networkType}}),Ut(i)}function jt(e,t,i=!1){let n=Lt("id",e),r=i?e.filter(Nt(Mt("type","remote-inbound-rtp"))):e.filter(Nt(Mt("type","inbound-rtp"),Mt("type","outbound-rtp")));"Firefox"===Pt.browserName()&&(r=Object.values(r.reduce(((e,t)=>{if(e[t.ssrc]){let i=Object.assign({},e[t.ssrc],t),n=e[t.ssrc].isRemote?t:e[t.ssrc];i.id=n.id,i.type=n.type,delete i.isRemote,delete i.remoteId,e[i.ssrc]=i}else e[t.ssrc]=t;return e}),{})));let a={};if("Safari"===Pt.browserName()){let t=e.filter(Mt("type","track"));a=Lt("trackIdentifier",t)}return r.map((e=>{let i=Number(e.ssrc),r=e.mediaType||e.kind,s=e.trackId,o=e.type,c=e.codecId;if("Safari"===Pt.browserName()){let n=/^.+_([\d]+)$/.exec(e.id);if(n&&(i=parseInt(n[1],10)),r=e.id.indexOf("Audio")>0?"audio":"video",t[i]){let e=r+"-"+t[i];a[e]&&(s=a[e].id)}}if(!o||!i||!r)return null;let l={ssrc:i,type:o,kind:r,bytesReceived:Ot(e,"bytesReceived"),bytesSent:Ot(e,"bytesSent"),jitter:Ot(e,"jitter"),packetsLost:Ot(e,"packetsLost"),packetsReceived:Ot(e,"packetsReceived"),packetsSent:Ot(e,"packetsSent"),fractionLost:Ot(e,"fractionLost"),pliCount:Ot(e,"pliCount"),firCount:Ot(e,"firCount"),nackCount:Ot(e,"nackCount"),userId:t[i],freezeCount:Ot(e,"freezeCount",0),totalFreezesDuration:Ot(e,"totalFreezesDuration",0)};if("video"===r){let t=Ot(e,"framesDecoded"),i=Ot(e,"totalInterFrameDelay"),n=Ot(e,"totalSquaredInterFrameDelay");l.interframeDelayVariance=(n-i*i/t)/t}if("audio"===r&&(l.totalSamplesReceived=Ot(e,"totalSamplesReceived"),l.concealedSamples=Ot(e,"concealedSamples"),l.insertedSamplesForDeceleration=Ot(e,"insertedSamplesForDeceleration"),l.removedSamplesForAcceleration=Ot(e,"removedSamplesForAcceleration"),l.silentConcealedSamples=Ot(e,"silentConcealedSamples"),l.concealmentEvents=Ot(e,"concealmentEvents"),l.totalAudioEnergy=Ot(e,"totalAudioEnergy")),c&&n[c]){let e=n[c];l.clockRate=e.clockRate,l.mimeType=e.mimeType}if(s&&n[s]){let e=n[s];l.frameHeight=e.frameHeight,l.frameWidth=e.frameWidth,l.framesDecoded=e.framesDecoded,l.framesReceived=e.framesReceived,l.framesDropped=e.framesDropped}return Ut(l)})).filter((e=>!!e))}function $t(e,t){return E(this,arguments,(function*(e,t,i={},n=!1){let r=yield function(e){return E(this,null,(function*(){let t=[];return RTCRtpReceiver.prototype.getStats?(t.push(...e.getReceivers().map((e=>e.getStats()))),t.push(...e.getSenders().map((e=>e.getStats())))):t.push(e.getStats()),Promise.all(t).then(Vt).then(xt)}))}(e),a={timestamp:Date.now(),transport:Ft(r),rtps:jt(r,i)};return n&&(a.remoteRtps=jt(r,i,!0)),t?function(e,t,i=!1){if(!t||!t.rtps||!e.rtps)return e;let n,r;i&&(n=Lt("ssrc",(null==e?void 0:e.remoteRtps)||[]),r=Lt("ssrc",(null==t?void 0:t.remoteRtps)||[]));let a=Lt("ssrc",e.rtps),s=Lt("ssrc",t.rtps),o=(e.timestamp-t.timestamp)/1e3;return!a||!s||Object.keys(a).forEach((c=>{let l=a[c],u=s[c];if(l&&u){if(l.bytesReceived&&l.bytesReceived>u.bytesReceived&&(l.bandwidth=Math.round((l.bytesReceived-u.bytesReceived)/o)),l.bytesSent&&l.bytesSent>u.bytesSent&&(l.bandwidth=Math.round((l.bytesSent-u.bytesSent)/o)),l.packetsReceived)if(l.packetsReceived>u.packetsReceived||l.packetsLost>u.packetsLost){let e=l.packetsLost-u.packetsLost,t=l.packetsReceived-u.packetsReceived;l.packetLoss=parseFloat((100*e/(e+t)).toFixed(2))}else l.packetLoss=0;if(l.freezeCount>u.freezeCount&&(l.freezeCountDelta=l.freezeCount-u.freezeCount),l.totalFreezesDuration>u.totalFreezesDuration){let e=Math.round(l.totalFreezesDuration-u.totalFreezesDuration);l.totalFreezesDurationDelta=e}if(l.framesDropped&&u.framesDropped&&l.framesDropped>u.framesDropped&&(l.framesDroppedDelta=parseFloat(((l.framesDropped-u.framesDropped)/o).toFixed(0))),i&&"outbound-rtp"===l.type&&"video"===l.kind){let i=null==n?void 0:n[c],a=null==r?void 0:r[c],s=e=>null!=e?e:0,o=Math.max(0,s(null==i?void 0:i.packetsLost)-s(null==a?void 0:a.packetsLost)),d=Math.max(1,l.packetsSent-u.packetsSent);e.transport.averageNetStat={currentRoundTripTime:(e.transport.currentRoundTripTime+t.transport.currentRoundTripTime)/2*1e3,lostPercent:Math.round(o/d*100)}}}})),e}(a,t,n):(yield it.delay(1e3),$t(e,a,i))}))}function Bt(e){performance.clearMarks(e),performance.mark(e)}function Ht(e){performance.clearMarks(e)}function Wt(e){let t=performance.getEntriesByName(e)[0];if(void 0===t)return null;let i=Math.round(performance.now()-t.startTime);return performance.clearMarks(e),i}function Gt(e){return`${ce.SCREENSHARE_FIRST_FRAME}_${function(e){return"string"==typeof e?e:JSON.stringify(e)}(e)}`}var Kt=class{static create(){Kt._instance=new Kt}static logCallStat(e){var t;if(null!=(t=Kt._instance)&&t._eventualLogs.size){for(let t of Kt._instance._eventualLogs)Object.assign(t,{call_topology:e.call_topology,local_address:e.local_address,local_connection_type:e.local_connection_type,network_type:e.network_type,remote_address:e.remote_address,remote_connection_type:e.remote_connection_type,rtt:e.rtt,transport:e.transport}),Ne.logCustom(ce.CALL_EVENTUAL_STAT,t);Kt._instance._eventualLogs.clear()}Ne.logCustom("callStat",e)}static logEventualStat(e){var t;void 0===e.value&&(e.value=Wt(e.name)),null!==e.value&&(null==(t=Kt._instance)||t._eventualLogs.add(e))}static destroy(){var e;null==(e=Kt._instance)||e._destroy(),Kt._instance=null}_destroy(){this._eventualLogs.clear()}constructor(){this._eventualLogs=new Set}},qt=Kt;qt._instance=null;var zt=class{appendChunk(e){let t=this._chunks.length;if(e.start)this._measureFreezeDuration(!1),this._measureFreezeDuration(!0),t&&(Ai.warn("[FrameBuilder] Cleanup buffer",Array.prototype.slice.call(this._chunks)),this._chunks=[]);else if(!t||(this._chunks[t-1].sequence+1)%65536!==e.sequence)return void Ai.warn("[FrameBuilder] Got incorrect chunk");if(this._chunks.push(e),e.end){let t=this._processFrameData(),{width:i,height:n}=zt.getFrameSize(t);this._processFrame({timestamp:e.timestamp,frameData:t,isVP9:e.isVP9,keyframe:e.keyframe,width:i,height:n}),this._statScreenShareFirstFrame.measure(i,n)}}destroy(){Ht(ce.SCREENSHARE_FREEZE_DURATION),Ht(Gt(this._participantId)),this._chunks=[]}_processFrameData(){let e=this._chunks;this._chunks=[];let t=e.reduce(((e,t)=>e+t.data.byteLength),0),i=new Uint8Array(t),n=0;for(let t of e)i.set(new Uint8Array(t.data),n),n+=t.data.byteLength;return i}static getFrameSize(e){let t={width:0,height:0},i=new l.BitStream(e.buffer);i.bigEndian=!0,i.index+=2;let n=i.readBits(1),r=i.readBits(1)<<1|n;return 3===r&&i.index++,1===i.readBits(1)||0!==i.readBits(1)||(i.index++,i.index++,i.index+=24,r>=2&&i.index++,7!==i.readBits(3)?(i.index++,(1===r||3===r)&&(i.index+=3)):(1===r||3===r)&&i.index++,t.width=i.readBits(16)+1,t.height=i.readBits(16)+1),t}static isBrowserSupported(){throw new Error("Method `isBrowserSupported` is not implemented")}_measureFreezeDuration(e){if(e)return void Bt(ce.SCREENSHARE_FREEZE_DURATION);let t=Wt(ce.SCREENSHARE_FREEZE_DURATION);null!==t&&t>1e3&&this._onStat({freeze_duration:t})}constructor(e,t,i){this._chunks=[],this._participantId=e,this._onStream=t,this._onStat=i,this._statScreenShareFirstFrame=new class{measure(e,t){if(this._firstFrameReceived)return;this._firstFrameReceived=!0;let i=Wt(Gt(this._participantId));null!==i&&qt.logEventualStat({name:ce.SCREENSHARE_FIRST_FRAME,value:i,width:e,height:t})}constructor(e){this._firstFrameReceived=!1,this._participantId=e}}(e)}},Jt=class{drawFrame(e){return E(this,null,(function*(){throw new Error("Method `drawFrame` is not supported by this implementation")}))}drawImage(e){return E(this,null,(function*(){throw new Error("Method `drawImage` is not supported by this implementation")}))}static isBrowserSupported(){throw new Error("Method `isBrowserSupported` is not implemented")}constructor(e){this._onStream=e}},Yt=class extends Jt{_createStream(e,t){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=e,this._canvas.height=t,this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="0",this._canvas.style.zIndex="5000",document.body.appendChild(this._canvas),this._useImageBitmap?this._canvasContext=this._canvas.getContext("bitmaprenderer"):this._canvasContext=this._canvas.getContext("2d"),this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],this._track.contentHint="text")}_removeStream(){this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._canvasContext=null;try{this._canvas&&document.body.removeChild(this._canvas)}catch(e){}this._canvas=null}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}_drawImage(e){return E(this,null,(function*(){this._track||(this._createStream(e.width,e.height),this._onStream(this._stream));let t=this._canvas;if(t.width=e.width,t.height=e.height,this._useImageBitmap){let t;t=e instanceof ImageBitmap?e:yield createImageBitmap(e,0,0,e.width,e.height),this._canvasContext.transferFromImageBitmap(t),t.close()}else{let i=this._canvasContext;i.clearRect(0,0,t.width,t.height),i.putImageData(e,0,0)}this._requestCanvasFrame()}))}drawFrame(e){return E(this,null,(function*(){let t="createImageBitmap"in e?yield e.createImageBitmap():yield createImageBitmap(e);yield this._drawImage(t)}))}drawImage(e){return E(this,null,(function*(){yield this._drawImage(e)}))}destroy(){this._removeStream(),Ai.debug("CanvasRenderer destroyed")}static isBrowserSupported(){return!(!("CanvasCaptureMediaStream"in window)&&!("CanvasCaptureMediaStreamTrack"in window)||"Safari"===Pt.browserName()&&15===Number(Pt.browserVersion())||"Firefox"===Pt.browserName()&&Number(Pt.browserVersion())<60)}constructor(e){super(e),this._canvas=null,this._canvasContext=null,this._stream=null,this._track=null,Ai.debug("CanvasRenderer started"),this._useImageBitmap="ImageBitmap"in window}},Qt=class extends Jt{drawFrame(e){return E(this,null,(function*(){yield this._writer.write(e)}))}destroy(){this._writer.releaseLock(),this._generator.writable.close().then((()=>this._generator.stop())),Ai.debug("TrackGeneratorRenderer destroyed")}static isBrowserSupported(){return"VideoFrame"in window&&"MediaStreamTrackGenerator"in window&&kt.isBrowserSupported()}constructor(e){super(e),Ai.debug("TrackGeneratorRenderer started"),this._generator=new MediaStreamTrackGenerator({kind:"video"}),this._writer=this._generator.writable.getWriter(),this._stream=new MediaStream([this._generator]),this._onStream(this._stream)}},Zt=class extends zt{_processFrame(e){!this._decoderReady||this._decoderQueue.length?(this._decoderQueue.push(e),this._decodeQueue()):this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe)}_decodeQueue(){if(!this._decoderReady)return;let e=this._decoderQueue;this._decoderQueue=[],e.forEach((e=>{this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe)}))}destroy(){super.destroy(),this._fpsMeter.destroy(),this._decoder.destroy(),this._renderer.destroy(),Ai.debug(`StreamBuilder destroyed for participant ${this._participantId}`)}static isBrowserSupported(){return Yt.isBrowserSupported()||Qt.isBrowserSupported()}constructor(e,t,i){super(e,t,i),this._decoderReady=!1,this._decoderQueue=[],Ai.debug(`StreamBuilder started for participant [${e}]`),Qt.isBrowserSupported()?this._renderer=new Qt(t):this._renderer=new Yt(t),kt.isBrowserSupported()?this._decoder=new kt:this._decoder=new Le;this._decoder.init((e=>E(this,null,(function*(){"VideoFrame"in window&&e instanceof VideoFrame?yield this._renderer.drawFrame(e):yield this._renderer.drawImage(e),this._fpsMeter.increment()})))).then((()=>{this._decoderReady=!0,this._decodeQueue()})),this._fpsMeter=new Dt((t=>Ai.log(`[StreamBuilder][${e}] fps: ${t}`)),2e4)}};var Xt=v(2,15)-1,ei=class{_handleQueue(){if(!this._sourceBuffer||this._sourceBuffer.updating||!this._queue.length)return;if(this._clearBufferTill&&this._sourceBuffer.buffered.length){let e=this._sourceBuffer.buffered.start(0);return e<this._clearBufferTill&&(this._sourceBuffer.remove(e,this._clearBufferTill),Ai.debug(`[WebmBuilder] SourceBuffer cleanup from ${e} to ${this._clearBufferTill}`)),void(this._clearBufferTill=0)}let e=this._queue;this._queue=[];let t=ei._buildQueue(e);this._sourceBuffer.appendBuffer(t)}static _buildQueue(e){if(!e.length)return new Uint8Array;if(1===e.length)return u.build(e[0]);let t=e.reduce(((e,t)=>e+t.countSize()),0),i=new Uint8Array(t),n=0;for(let t of e){let e=u.build(t);i.set(e,n),n+=e.byteLength}return i}_initBuffer(){this._sourceBuffer=this._mediaSource.addSourceBuffer(`video/webm; codecs="${this._codec}"`),this._sourceBuffer.mode="sequence",this._sourceBuffer.addEventListener("updateend",(()=>this._handleQueue()))}changeType(e){var t;return this._codec=e,null==(t=this._sourceBuffer)?void 0:t.changeType(e)}append(e,t=!1){this._queue.push(e),t&&this._handleQueue()}cleanup(){var e,t,i;"open"===(null==(e=this._mediaSource)?void 0:e.readyState)&&(null==(t=this._sourceBuffer)||t.abort());let n=null==(i=this._sourceBuffer)?void 0:i.buffered,r=null==n?void 0:n.length;if(!r)return;let a=n.start(0),s=Math.max(0,n.end(r-1)-5);s-a>5&&(this._clearBufferTill=s)}destroy(){var e;this._queue=[],"open"===this._mediaSource.readyState&&(null==(e=this._sourceBuffer)||e.abort(),this._mediaSource.endOfStream()),this._sourceBuffer=null,this._clearBufferTill=0}get codec(){return this._codec}get mediaSource(){return this._mediaSource}get buffered(){var e;return null==(e=this._sourceBuffer)?void 0:e.buffered}constructor(e){this._sourceBuffer=null,this._queue=[],this._clearBufferTill=0,this._mediaSource=new MediaSource,this._codec=e;let t=()=>{this._mediaSource.removeEventListener("sourceopen",t),this._initBuffer(),this._handleQueue()};this._mediaSource.addEventListener("sourceopen",t,!1)}},ti=class extends zt{static _intToU16BE(e){return new Uint8Array([e>>8,e])}static _genWebmHeader(){return u.element(u.ID.EBML,[u.element(u.ID.EBMLVersion,u.number(1)),u.element(u.ID.EBMLReadVersion,u.number(1)),u.element(u.ID.EBMLMaxIDLength,u.number(4)),u.element(u.ID.EBMLMaxSizeLength,u.number(8)),u.element(u.ID.DocType,u.string("webm")),u.element(u.ID.DocTypeVersion,u.number(2)),u.element(u.ID.DocTypeReadVersion,u.number(2))])}static _genSegmentHeader(e,t,i){let n=u.element(u.ID.Info,[u.element(u.ID.TimecodeScale,u.number(1e6)),u.element(u.ID.MuxingApp,u.string("vk-webm-builder")),u.element(u.ID.WritingApp,u.string("vk-webm-builder"))]),r=[u.element(u.ID.PixelWidth,u.number(e)),u.element(u.ID.PixelHeight,u.number(t))],a=u.element(u.ID.Tracks,u.element(u.ID.TrackEntry,[u.element(u.ID.TrackNumber,u.number(1)),u.element(u.ID.TrackUID,u.number(1)),u.element(u.ID.TrackType,u.number(1)),u.element(u.ID.FlagLacing,u.number(0)),u.element(u.ID.DefaultDuration,u.number(1e9)),u.element(u.ID.CodecID,u.string(`V_${i.toUpperCase()}`)),u.element(u.ID.Video,r)]));return u.unknownSizeElement(u.ID.Segment,[n,a])}static _genClusterHeader(e){return u.unknownSizeElement(u.ID.Cluster,[u.element(u.ID.Timecode,u.number(Math.round(e)))])}_createVideo(e){this._mediaBuffer=new ei(e),this._video=document.createElement("video"),this._video.autoplay=!0,this._video.controls=!1,this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",this._video.src=URL.createObjectURL(this._mediaBuffer.mediaSource),document.body.appendChild(this._video);let t=()=>{var e;if(null!=(e=this._video)&&e.src){Ai.warn(`[WebmBuilder] Video paused for participant [${this._participantId}], try to play again`);let e=this._video.seekable;e.length&&(this._video.currentTime=e.end(e.length-1)-.1),this._video.play().catch((()=>{}))}};this._video.onpause=t,this._video.onwaiting=t,this._video.onstalled=t,this._video.onerror=()=>{var e;return Ai.warn(`[WebmBuilder] Video Error for participant [${this._participantId}]`,null==(e=this._video)?void 0:e.error)},this._stream=this._video.captureStream(),this._onStream(this._stream)}_processFrame(e){var t,i,n,r,a;let s=e.isVP9?"vp9":"vp8";this._mediaBuffer?this._mediaBuffer.codec!==s&&this._mediaBuffer.changeType(s):this._createVideo(s);let o=e.timestamp;if(o<=this._lastFrameTimestamp&&(o=this._lastFrameTimestamp+10,Ai.debug(`[WebmBuilder] Fixup timestamp for participant [${this._participantId}]`)),this._lastFrameTimestamp=o,this._earliestTimestamp)o-=this._earliestTimestamp;else{if(!e.keyframe)return;this._earliestTimestamp=o,o=0}if(e.keyframe){this._clusterStartTime=o,null==(t=this._mediaBuffer)||t.cleanup(),Ai.debug(`[WebmBuilder] Segment header for participant [${this._participantId}]`);let r=ti._genWebmHeader();null==(i=this._mediaBuffer)||i.append(r);let a=ti._genSegmentHeader(e.width,e.height,s);null==(n=this._mediaBuffer)||n.append(a)}let c=Math.round(o-this._clusterStartTime);if(c>Xt&&(this._clusterStartTime=o,c=0),0===c){Ai.debug(`[WebmBuilder] Cluster header for participant [${this._participantId}]`);let e=ti._genClusterHeader(this._clusterStartTime);null==(r=this._mediaBuffer)||r.append(e)}let l=u.element(u.ID.SimpleBlock,[u.vintEncodedNumber(1),u.bytes(ti._intToU16BE(c)),u.number((e.keyframe?1:0)<<7),u.bytes(e.frameData)]);null==(a=this._mediaBuffer)||a.append(l,!0)}destroy(){super.destroy(),this._video&&(this._video.onpause=null,this._video.onwaiting=null,this._video.onstalled=null,this._video.onerror=null,this._video.pause(),this._video.src="",document.body.removeChild(this._video)),this._mediaBuffer&&(this._mediaBuffer.destroy(),this._mediaBuffer=null),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null),Ai.debug(`[WebmBuilder] destroyed for participant [${this._participantId}]`)}static isBrowserSupported(){var e,t,i;return"captureStream"in(null==(e=window.HTMLVideoElement)?void 0:e.prototype)&&(null==(t=window.MediaSource)?void 0:t.isTypeSupported('video/webm; codecs="vp8"'))&&(null==(i=window.MediaSource)?void 0:i.isTypeSupported('video/webm; codecs="vp9"'))}constructor(e,t,i){super(e,t,i),this._mediaBuffer=null,this._video=null,this._stream=null,this._earliestTimestamp=0,this._clusterStartTime=0,this._lastFrameTimestamp=0,Ai.debug(`[WebmBuilder] started for participant [${e}]`)}},ii=class{_onDataChannelMessage(e){var t,i;let n=function(e){let t=new DataView(e),i=t.getUint8(0),n=t.getUint16(1),r=t.getUint32(3),a=1===t.getUint8(7),s=t.getUint16(8),o=t.getUint8(10),c=!!(1&o),l=!!(2&o),u=!!(4&o),d=!!(8&o);if(1!==i)throw new Error(`Unexpected protocol version. Got ${i}, expected 1`);return{timestamp:r,start:c,end:l,keyframe:u,sequence:n,isVP9:a,ssrc:s,eos:d,data:e.slice(11)}}(e),r=null==(i=null==(t=this._participantIdRegistry)?void 0:t.getStreamDescription(n.ssrc))?void 0:i.participantId;if(!r)return void Ai.warn(`Participant id for ssrc ${n.ssrc} not found in registry`);if(n.eos)return this.close(r),void this._onEos(r);let a=this._streamBuilders[r];if(!a){let e=e=>this._onStream(r,e);a=_i.screenShareWebmBuilder&&ti.isBrowserSupported()?new ti(r,e,this._onStat):new Zt(r,e,this._onStat),this._streamBuilders[r]=a}a.appendChunk(n)}close(e){let t=this._streamBuilders[e];t&&(t.destroy(),delete this._streamBuilders[e])}destroy(){this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null,this._onStream=()=>{},Object.values(this._streamBuilders).forEach((e=>e.destroy())),this._streamBuilders={},this._participantIdRegistry=null,Ai.debug("ScreenCaptureReceiver destroyed")}static isBrowserSupported(){return(kt.isBrowserSupported()||Le.isBrowserSupported())&&(Zt.isBrowserSupported()||ti.isBrowserSupported())}constructor(e,t,i,n,r){this._participantIdRegistry=null,this._streamBuilders={},this._onStream=()=>{},this._onEos=()=>{},Ai.debug("ScreenCaptureReceiver started"),this._datachannel=e,this._participantIdRegistry=t,this._onStream=i,this._onEos=n,this._onStat=r,this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)}},ni=class{get prev(){return this._prev}set prev(e){this._prev=e}get next(){return this._next}set next(e){this._next=e}get data(){return this._data}constructor(e,t,i){this._next=i,i&&(i.prev=this),this._prev=t,t&&(t.next=this),this._data=e}},ri=class{get length(){return this._length}push(...e){for(let t of e)this._tail=new ni(t,this._tail,null),this._head||(this._head=this._tail),this._length++}merge(e){this._tail&&(this._tail.next=e._head),this._head||(this._head=e._head),this._tail=e._tail,this._length+=e._length,e.clear()}shift(){if(!this._length||!this._head)return null;let e=this._head;return this._head=e.next,this._head&&(e.next=null,this._head.prev=null),this._length--,1===this.length?this._tail=this._head:this.length||(this._head=this._tail=null),e.data}bisect(){if(this.length){let e=this.length>1?Math.floor(this.length/2):0;for(let t=0;t<e;t++)this.shift()}}head(){var e;return(null==(e=this._head)?void 0:e.data)||null}tail(){var e;return(null==(e=this._tail)?void 0:e.data)||null}clear(){this._head=null,this._tail=null,this._length=0}toString(){let e=[],t=this._head;for(;null!==t;)e.push(t.data),t=t.next;return e.length?JSON.stringify(e,((e,t)=>t instanceof Error?String(t):t)):""}constructor(){this._head=null,this._tail=null,this._length=0}},ai=class extends Me{_createDom(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="160px",this._canvas.style.zIndex="5000",this._canvasCtx=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)),!this._video&&!this._useImageCapture&&(this._video=document.createElement("video"),this._video.controls=!1,this._video.autoplay=!1,this._video.preload="auto",this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",document.body.appendChild(this._video))}_removeDom(){try{this._canvas&&document.body.removeChild(this._canvas),this._video&&document.body.removeChild(this._video)}catch(e){}this._canvasCtx=null,this._canvas=null,this._video=null}_createStream(e){return E(this,null,(function*(){if(!this._canvas)throw new Error("Canvas not found");if(!this._video&&!this._useImageCapture)throw new Error("Video element not found");return this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],new Promise(((t,i)=>{if(this._useImageCapture)this._imageCapture=new ImageCapture(e),t();else{let n=this._video;n.srcObject=new MediaStream([e]),n.onloadeddata=e=>t(),n.onerror=()=>i(new Error("Video element error"));let r=n.play(),a=()=>i(new Error("Autoplay is disabled"));r?r.catch(a):a()}}))}))}_removeStream(){var e;window.clearTimeout(this._frameReadTimeout),null==(e=this._lastFrame)||e.close(),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._video&&(this._video.pause(),this._video.srcObject=null),this._imageCapture&&(this._imageCapture=null)}_drawFrameVideo(){if(!(this._canvas&&this._canvasCtx&&this._video&&this._track))throw new Error("Fatal error");this._video.paused&&this._video.play();let e=this._video.videoWidth,t=this._video.videoHeight;return this._canvas.width=this._video.width=e,this._canvas.height=this._video.height=t,this._canvasCtx.clearRect(0,0,e,t),this._canvasCtx.drawImage(this._video,0,0,e,t),this._requestCanvasFrame(),this._canvasCtx.getImageData(0,0,e,t)}_getFrameBitmap(){return E(this,null,(function*(){if(!this._imageCapture)throw new Error("Destroyed");return this._imageCapture.grabFrame()}))}_drawFrameData(e){var t;if(!this._canvas||!this._canvasCtx||!this._track)throw new Error("Destroyed");let i=e.width,n=e.height;return this._canvas.width=i,this._canvas.height=n,this._canvasCtx.clearRect(0,0,i,n),this._canvasCtx.drawImage(e,0,0,i,n),this._requestCanvasFrame(),null==(t=this._canvasCtx)?void 0:t.getImageData(0,0,i,n)}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}init(){return E(this,null,(function*(){this._createDom();let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height;Ai.debug(`LibVPxEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createStream(this._sourceTrack),yield this._createWorker('"use strict";var exports=(()=>{var u=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var V=(a,r)=>{for(var s in r)u(a,s,{get:r[s],enumerable:!0})},h=(a,r,s,i)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of y(r))!x.call(a,e)&&e!==s&&u(a,e,{get:()=>r[e],enumerable:!(i=R(r,e))||i.enumerable});return a};var A=a=>h(u({},"__esModule",{value:!0}),a);var M={};V(M,{default:()=>F});var F=(a,r,s,i)=>{let e;function m(t,o){return a({locateFile:r}).then(n=>{if(e=new n.VpxEncoder,e.debug(o),!e.init(t?n.VpxType.VP9:n.VpxType.VP8))throw self.postMessage({type:"log_error",message:"encoder-init-fail-libvpx"}),new Error("LibVPxEncoder failed to create");if(s){let d=Math.round(i/1e3);e.setTargetBitrate(d)}else e.setMaxQuantizer(10),e.setTargetBitrate(1024)})}function E(t,o,n,p){let d=e.allocateImage(t,o);if(!d){self.postMessage({type:"frame",error:"No buffer data"});return}d.set(new Uint8Array(n));let l=Math.round(performance.now()),f=150;if(!e.encode(l,f,p)){self.postMessage({type:"frame",error:"Encode failed"});return}let b=e.readFrame();if(!b){self.postMessage({type:"frame",error:"No encoded data"});return}e.readFrame()&&(self.postMessage({type:"debug",message:"LibVPxEncoder dropped frame"}),self.postMessage({type:"log_error",message:"LibVPxEncoder-drop"}));let c=new Uint8Array(b.byteLength);c.set(b),self.postMessage({type:"frame",frameType:p?"key":"delta",timestamp:l,duration:f,width:t,height:o,data:c.buffer},[c.buffer])}function g(t,o){let n=Math.round(t/1e3);e.setTargetBitrate(n)}self.onmessage=t=>{switch(t.data.type){case"init":m(t.data.isVP9,t.data.debug).then(()=>self.postMessage({type:"ready"})).catch(o=>self.postMessage({type:"error",error:String(o)}));break;case"frame":E(t.data.width,t.data.height,t.data.imageData,t.data.keyFrame);break;case"set_bitrate":g(t.data.bitrate,t.data.useCbr);break}}};return A(M);})();\n',(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength,width:e.width,height:e.height})}),[c(),c().getUrl,this._useCongestionControl,this._maxBitrate],{isVP9:this.isVP9(),debug:Ai.enabled()})}))}_encode(e,t){let i=e.data.buffer;this._sendToWorker("frame",{width:e.width,height:e.height,imageData:i,keyFrame:t},[i])}_requestFrameVideo(e){let t=this._drawFrameVideo();this._encode(t,e)}_requestFrameBitmap(e){window.clearTimeout(this._frameReadTimeout),this._frameReadTimeout=window.setTimeout((()=>{if(this._lastFrame){let t=this._drawFrameData(this._lastFrame);this._encode(t,e)}else this._onFrame(null)}),1e3),this._getFrameBitmap().then((t=>{var i;window.clearTimeout(this._frameReadTimeout),null==(i=this._lastFrame)||i.close(),this._lastFrame=t;let n=this._drawFrameData(t);this._encode(n,e)})).catch((()=>{}))}requestFrame(e=!1){this._useImageCapture?this._requestFrameBitmap(e):this._requestFrameVideo(e)}setBitrate(e,t,i){this._sendToWorker("set_bitrate",{bitrate:e,useCbr:t})}isVP9(){return!1}destroy(){this._removeWorker(),this._removeStream(),this._removeDom(),Ai.debug("LibVPxEncoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window&&("CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window)}constructor(e,t,i,n){super(),this._video=null,this._imageCapture=null,this._canvas=null,this._canvasCtx=null,this._stream=null,this._track=null,this._frameReadTimeout=0,this._lastFrame=null,this._sourceTrack=e,this._onFrame=t,this._useCongestionControl=i,this._maxBitrate=n,this._useImageCapture="ImageCapture"in window&&"ImageBitmap"in window,("live"!==e.readyState||!e.enabled||e.muted)&&(this._useImageCapture=!1)}},si=class extends Me{init(){return E(this,null,(function*(){let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height,i=this._trackProcessor.readable;Ai.debug(`WebCodecsEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createWorker('"use strict";var exports=(()=>{var R=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var x=(a,t)=>{for(var n in t)R(a,n,{get:t[n],enumerable:!0})},_=(a,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of T(t))!B.call(a,o)&&o!==n&&R(a,o,{get:()=>t[o],enumerable:!(i=C(t,o))||i.enumerable});return a};var I=a=>_(R({},"__esModule",{value:!0}),a);var S={};x(S,{default:()=>M});var M=()=>{let t,n,i,o,p,u,d=null,m=0,b=!1,s=0,g,V,c=!1;function y(e){t=e.readable,n=t.getReader(),i=e.width,o=e.height,p=e.isVP9,u=e.framerate,g=e.useCongestionControl,V=e.maxBitrate,g&&(s=V,c=e.useCbr),f(),self.postMessage({type:"ready"})}function A(e){self.clearTimeout(m),m=self.setTimeout(r=>{d&&h(d,r)},1e3,e),!b&&(b=!0,n.read().finally(()=>{b=!1,self.clearTimeout(m)}).then(({done:r,value:l})=>{if(d==null||d.close(),d=null,!(r||!l)){if(!E){n.releaseLock(),t.cancel();return}d=l,h(l,e)}}))}function h(e,r){(e.codedWidth!==i||e.codedHeight!==o)&&(i=e.codedWidth,o=e.codedHeight,f()),E.encode(e,{keyFrame:r})}function f(){let e={framerate:u,codec:p?"vp09.00.50.08":"vp8",width:i,height:o,latencyMode:"realtime",bitrateMode:c?"constant":"variable"};s>0&&(e.bitrate=s),E.configure(e)}function F(e,r,l){s=e,c=r,u=l,f()}let E=new VideoEncoder({output:e=>{let r;e.data?r=e.data:(r=new ArrayBuffer(e.byteLength),e.copyTo(r)),self.postMessage({type:"frame",frameType:e.type,timestamp:e.timestamp,duration:e.duration,width:i,height:o,data:r},[r])},error:e=>{self.postMessage({type:"frame",error:String(e)})}});self.onmessage=e=>{switch(e.data.type){case"init":y(e.data);break;case"frame":A(e.data.keyFrame);break;case"set_bitrate":F(e.data.bitrate,e.data.useCbr,e.data.fps);break}}};return I(S);})();\n',(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength,width:e.width,height:e.height})}),[],{readable:i,width:e,height:t,isVP9:this.isVP9(),framerate:this._frameRate,useCongestionControl:this._useCongestionControl,maxBitrate:this._maxBitrate,useCbr:this._useCbr},[i])}))}requestFrame(e=!1){this._sendToWorker("frame",{keyFrame:e})}setBitrate(e,t,i){this._sendToWorker("set_bitrate",{bitrate:e,useCbr:t,fps:i})}isVP9(){return!0}destroy(){this._removeWorker(),Ai.debug("WebCodecsEncoder destroyed")}static isBrowserSupported(){return"VideoEncoder"in window&&"Worker"in window&&"EncodedVideoChunk"in window&&"MediaStreamTrackProcessor"in window}constructor(e,t,i,n,r,a){super(),this._sourceTrack=e,this._onFrame=t,this._useCongestionControl=i,this._maxBitrate=n,this._useCbr=r,this._frameRate=a,this._trackProcessor=new MediaStreamTrackProcessor(e)}},oi=8e3,ci=(e=>(e[e.NONE=0]="NONE",e[e.UP=1]="UP",e[e.DOWN=2]="DOWN",e))(ci||{}),li=65536,ui=0,di=class{_handleQueue(){if(this._destroyed)return;let e=this._queue.shift();if(e){if(!this._sendFrameChunk(e))return this._needKeyframe=this._needKeyframe||!this._cleanupQueue(),void it.setImmediate((()=>this._handleQueue()));if(e.isLast){this._frameNum++,this._fpsMeter.increment(),e.isKey&&Ai.debug(`#${this._frameNum}: sharing: send keyframe size=${Math.round(e.frameSize/1e3)}k`);let t=this._feedback.getCurrentDelay(),i=this._feedback.getServerBitrateK(2e3);t>0&&this._congestionControl.checkDelay(this._frameNum,t,i)}else it.setImmediate((()=>this._handleQueue()))}else(this._lastSentFrameSeq-this._lastDeliveredFrameSeq+li)%li>5?Ai.debug(`[ScreenCaptureSender] Buffer is full, waiting cc update. Last sent sequence: ${this._lastSentFrameSeq}, last delivered ${this._lastDeliveredFrameSeq}`):this._requestFrame()}_cleanupQueue(){let e=this._queue.head();for(;e;){if(e.isFirst&&e.isKey)return!0;this._queue.shift(),e=this._queue.head()}return!1}_requestFrame(){this._destroyed||(this._encoder.requestFrame(this._needKeyframe),this._needKeyframe=!1)}_sliceFrame(e){let t="key"===e.type,i=e.data.byteLength,n=new ri;for(let r=0;r<i;r+=this.DATA_SIZE){let a=e.data.slice(r,r+this.DATA_SIZE),s=0===r,o=i<=r+a.byteLength,c=this._wrapHeader(e.timestamp,s,o,t,a);n.push({data:c.data,sequence:c.sequence,frameSize:i,isFirst:s,isLast:o,isKey:t,timestamp:e.timestamp})}return n}_wrapHeader(e,t,i,n,r){let a=function(e,t,i,n,r,a,s){let o=0;t&&(o|=1),i&&(o|=2),n&&(o|=4),s||(o|=8);let c=new ArrayBuffer(11),l=new DataView(c);if(l.setUint8(0,1),l.setUint16(1,r),l.setUint32(3,e),l.setUint8(7,a?1:0),l.setUint16(8,0),l.setUint8(10,o),!s)return c;let u=new Uint8Array(c.byteLength+s.byteLength);return u.set(new Uint8Array(c),0),u.set(new Uint8Array(s),c.byteLength),u.buffer}(e,t,i,n,ui,this._encoder.isVP9(),r),s={sequence:ui,data:a};return ui=(ui+1)%li,s}_stopPacket(){return this._wrapHeader(Date.now(),!1,!1,!1,null).data}_sendFrameChunk(e){if(!this._datachannel||"open"!==this._datachannel.readyState)return!1;try{return this._datachannel.send(e.data),this._feedback.add(e.sequence,e.timestamp,e.data.byteLength,e.isFirst,e.isLast),e.isLast&&(this._lastSentFrameSeq=e.sequence),!0}catch(e){return Ai.warn("Error sending chunk to DataChannel",e),!1}}destroy(){this._queue.clear(),this._fpsMeter.destroy(),this._datachannel.onmessage=null,this._feedback.clear(),"open"===this._datachannel.readyState&&this._datachannel.send(this._stopPacket()),this._destroyed=!0,this._encoder.destroy(),Ai.debug("ScreenCaptureSender destroyed")}static isBrowserSupported(){return si.isBrowserSupported()||ai.isBrowserSupported()}_onCongestionCallback(e,t,i){this._encoder.setBitrate(e,t,i)}_onResize(e,t){let{minBitrate:i,maxBitrate:n}=this._calcMinMaxBitrate(e,t),r=Math.round(i/1e3),a=Math.round(n/1e3);Ai.log(`cc: resize to ${e}x${t}, minBitrate=${r} maxBitrate=${a}`),this._congestionControl.reconfigure(i,n)}_calcMinMaxBitrate(e,t){(void 0===e||e<640)&&(e=640),(void 0===t||t<360)&&(t=360);let i=e*t/256;return{minBitrate:Math.max(3e5,Math.min(1e6,Math.round(50*i))),maxBitrate:Math.round(400*i)}}_checkCcFeedback(e){let t=this._feedback.update(e.seq,e.ts2);null===t?Ai.debug(`cc: update failed, seq=${e.seq}`):t.end&&(this._lastDeliveredFrameSeq=t.seq,this._handleQueue())}_sendSharingStat(){let e=Date.now();if(e-this._lastSharingStat>3e4){let t=this._congestionControl.getStat();null!==t&&(Ai.debug(`cc: send stats: ${JSON.stringify(t)}`),this._signaling.reportSharingStat(t)),this._lastSharingStat=e}}constructor(e,t,i,n){this._destroyed=!1,this._needKeyframe=!0,this._frameNum=0,this._feedback=new class{add(e,t,i,n,r){this._tail===this._head&&this._size>0&&(this._head=++this._head%this._maxSize);let a=this._tail;return this._buffer[this._tail]={seq:e,ts:t,size:i,sent:Date.now(),start:n,end:r,ts2:-1,recv:-1},this._tail=++this._tail%this._maxSize,this._size++,a}update(e,t){let i=this.get(e);return null===i?null:(i.ts2=t,i.recv=Date.now(),i)}get(e){let t=this._head;for(let i=0;i<this._maxSize;i++){let i=this._buffer[t];if(e===(null==i?void 0:i.seq))return i;if(t=++t%this._maxSize,t===this._tail)break}return null}getServerBitrateK(e){let t=0,i=0,n=-1,r=-1,a=this._tail;for(let t=0;t<this._maxSize;t++){a>0?--a:a=this._maxSize-1;let t=this._buffer[a];if(!t||(-1===r&&(r=t.ts2,i=0),r>=0&&(i+=t.size),n=t.ts2,r-n>=e)||a===this._head)break}if(n>=0&&r>=0){let e=r-n;t=Math.round(e>0?8*i/e:0)}return t}getCurrentDelay(){let e=this._tail;for(let t=0;t<this._maxSize;t++){e>0?--e:e=this._maxSize-1;let t=this._buffer[e];if(!t)break;if(t.recv>=0&&t.sent>=0)return t.recv-t.sent;if(e===this._head)break}return 0}getMaxBandwidth(){let e=0,t=0,i=-1,n=-1,r=this._tail;for(let a=0;a<this._maxSize;a++){r>0?--r:r=this._maxSize-1;let a=this._buffer[r];if(a){if(-1===n&&a.end&&!a.start&&(n=a.ts2,t=0),-1===i&&n>=0&&a.start&&!a.end&&(i=a.ts2),i>=0&&n>=0){let r=n-i;e=r>0?8*t/r:0;break}if(n>=0&&(t+=a.size),r===this._head)break}}return Math.round(e)}clear(){this._buffer.fill(void 0),this._size=0,this._head=0,this._tail=0}constructor(e){this._size=0,this._head=0,this._tail=0,this._maxSize=e,this._buffer=new Array(e)}}(1024),this._lastSentFrameSeq=0,this._lastDeliveredFrameSeq=0,this._lastSharingStat=Date.now(),this._queue=new ri,Ai.debug("ScreenCaptureSender started"),this.DATA_SIZE=_i.consumerScreenDataChannelPacketSize-11,this._datachannel=t,this._signaling=i,this._fastSharing=n,this._congestionControlEnabled=_i.screenShareCongestionControl||this._fastSharing,this._width=e.getSettings().width,this._height=e.getSettings().height;let r=_i.getScreenFrameRate(this._fastSharing),{minBitrate:a,maxBitrate:s}=this._calcMinMaxBitrate(this._width,this._height),o=this._onCongestionCallback.bind(this);Ai.log(`ScreenCaptureSender: CongestionControl: enabled=${this._congestionControlEnabled} minBitrate=${Math.round(a/1e3)}k maxBitrate=${Math.round(s/1e3)}k delayThreshold=${_i.screenShareCongestionControlThreshold}`),this._congestionControl=new class{checkDelay(e,t,i){let n=Date.now();if(this._calcFps(n),this._calcDelay(t,n),this._delayAvgShort<=0||this._delayAvgLong<=0||!this._ccEnabled)return;let r=0,a=this._delayAvgShort-this._delayAvgLong,s=Math.round(100*Math.abs(a)/this._delayAvgLong),o=a>40&&s>30&&this._delayAvgShort>this._trendDelayThreshold,c=this._delayAvgShort>this._highDelayThreshold;o||c?r=2:Math.abs(a)<40&&s<10&&!c&&(r=1);let l=Math.round(this._targetBitrate/1e3),u=i;e%10==0&&Ai.debug(`#${e}: cc: delay=${t} short=${this._delayAvgShort} long=${this._delayAvgLong} delta=${a} percent=${s} -> ${ci[r]} tr=${l} br=${i}`);let d=n-this._lastDown;if(2===r&&d>2e3){this._probing&&(this._upPenalty=Math.min(++this._upPenalty,4),this._probing=!1);let i=.8*u*1e3;if(i>=this._targetBitrate&&(i=.8*this._targetBitrate),i=Math.max(i,this._minBitrate),i<this._targetBitrate){let n=Math.round(i/1e3),o=Math.round(this._upPenalty*oi/1e3);Ai.log(`#${e}: cc: delay=${t} short=${this._delayAvgShort} long=${this._delayAvgLong} delta=${a} percent=${s} -> ${ci[r]}`),Ai.log(`#${e}: cc: DOWN delay=${t} bitrate=${u} target=${l} -> newBitrate=${n} penalty=${o}s`),this._setBitrate(i,!0),this._targetBitrate=i}this._lastDown=n}let h=n-this._lastUp,p=8e3+this._upPenalty*oi;if(1===r&&h>p&&d>p){let i=Math.min(1.2*this._targetBitrate,this._maxBitrate);if(i>this._targetBitrate){let o=Math.round(i/1e3),c=Math.round(this._targetBitrate/1e3),l=Math.round(this._upPenalty*oi/1e3);Ai.log(`#${e}: cc: delay=${t} short=${this._delayAvgShort} long=${this._delayAvgLong} delta=${a} percent=${s} -> ${ci[r]}`),Ai.log(`#${e}: cc: UP bitrate=${u} target=${c} -> newBitrate=${o} penalty=${l}s`),this._setBitrate(i,!1),this._targetBitrate=i,this._probing=!0,this._lastProbing=n,this._lastUp=n}}let _=n-this._lastProbing;this._probing&&_>16e3&&(this._probing=!1);let m=n-this._lastDown;this._upPenalty>0&&m>3*p&&(Ai.log(`#${e}: cc: UP reset penalty: oldPenalty=${this._upPenalty}`),this._upPenalty=0)}_setBitrate(e,t){this._fastSharing&&(t=!0);let i=this._targetFps;this._fps>0&&(i=this._fps),this._onCongestion(e,t,i)}_calcDelay(e,t){if(!(e<=0)){if(-1===this._delayAvgShort&&(this._delayAvgShort=e,this._delayAvgLong=e),this._delayAvgShort=Math.round((3*this._delayAvgShort+e)/4),this._delayAvgLong=Math.round((23*this._delayAvgLong+e)/24),e>0&&e<this._minDelay?this._minDelay=e:e>this._maxDelay&&(this._maxDelay=e),0===this._lastCheckDelay&&(this._lastCheckDelay=t),e>2e3){let e=t-this._lastCheckDelay;this._largeDelayDuration+=e}this._lastCheckDelay=t}}reconfigure(e,t){this._minBitrate=e,this._maxBitrate=t}getStat(){if(this._minDelay===Number.MAX_VALUE||0===this._maxDelay||this._delayAvgLong<=0)return null;let e={minDelay:this._minDelay,maxDelay:this._maxDelay,avgDelay:this._delayAvgLong,largeDelayDuration:this._largeDelayDuration};return this._minDelay=Number.MAX_VALUE,this._maxDelay=0,this._largeDelayDuration=0,e}_calcFps(e){this._frames++;let t=e-this._lastFpsCalcMs;if(t>5e3){this._lastFpsCalcMs=e;let i=this._fps,n=1e3*this._frames/t;0===this._fps?this._fps=Math.round(n):this._fps=Math.round((3*this._fps+n)/4),this._frames=0,this._fps!==i&&Ai.log(`cc: fps=${this._fps}`)}}constructor(e,t,i,n,r,a,s){this._upPenalty=0,this._delayAvgShort=-1,this._delayAvgLong=-1,this._minDelay=Number.MAX_VALUE,this._maxDelay=0,this._largeDelayDuration=0,this._frames=0,this._fps=0,this._onCongestion=e,this._ccEnabled=n,this._minBitrate=t,this._maxBitrate=i,this._fastSharing=r,this._targetFps=s,this._highDelayThreshold=a>0?a:2100,r&&(this._highDelayThreshold=600),this._trendDelayThreshold=Math.round(this._highDelayThreshold/3),this._targetBitrate=this._maxBitrate,this._probing=!1;let o=Date.now();this._lastDown=0,this._lastUp=o,this._lastProbing=o,this._lastCheckDelay=0,this._lastFpsCalcMs=0}}(o,a,s,this._congestionControlEnabled,this._fastSharing,_i.screenShareCongestionControlThreshold,r);let c=(e,t)=>{if(this._destroyed)return;if(!e)return Ai.warn("requestFrame failed, keyFrame: "+this._needKeyframe,t),this._needKeyframe=!0,void this._handleQueue();(e.width!==this._width||e.height!==this._height)&&(this._width=e.width,this._height=e.height,this._onResize(this._width,this._height));let i=this._sliceFrame(e);this._queue.merge(i),this._handleQueue(),this._sendSharingStat()};if(si.isBrowserSupported()){let t=this._fastSharing;this._encoder=new si(e,c,this._congestionControlEnabled,s,t,r)}else this._encoder=new ai(e,c,this._congestionControlEnabled,s);this._datachannel.onmessage=e=>{(function(e){if(!e||!e.byteLength||4!==e.byteLength)return!1;let t=new DataView(e);return!(1!==t.getUint8(0)||1!==t.getUint8(1)||0!==t.getUint16(2))})(e.data)&&(Ai.debug(`[${this._datachannel.label}] Requested keyframe`),this._needKeyframe=!0);let t=function(e){if(!e||!e.byteLength||10!==e.byteLength)return null;let t=new DataView(e);return 1!==t.getUint8(0)||2!==t.getUint8(1)||0!==t.getUint16(2)?null:{seq:t.getUint16(4),ts2:t.getUint32(6)}}(e.data);null!==t&&this._checkCcFeedback(t)},this._encoder.init().then((()=>this._handleQueue())).catch((e=>Ai.warn("ScreenCaptureSender init failed",e))),this._fpsMeter=new Dt((e=>Ai.log(`[ScreenCaptureSender] fps: ${e}`)),2e4)}},hi=class{static get sessionKey(){return hi._sessionKey}static set sessionKey(e){hi._sessionKey=e}static get sessionSecretKey(){return hi._sessionSecretKey}static set sessionSecretKey(e){hi._sessionSecretKey=e}static get accessToken(){return hi._accessToken}static set accessToken(e){hi._accessToken=e}static isEmpty(){return!hi._sessionKey}},pi=class{static set(e){e.hasOwnProperty("voiceParams")&&(Object.assign(pi._params.voiceParams,e.voiceParams),delete e.voiceParams),e.hasOwnProperty("specListenerParams")&&(Object.assign(pi._params.specListenerParams,e.specListenerParams),delete e.specListenerParams),e.hasOwnProperty("apiAuth")&&(hi.accessToken=e.apiAuth.accessToken,hi.sessionKey=e.apiAuth.sessionKey,hi.sessionSecretKey=e.apiAuth.sessionSecretKey),Object.assign(pi._params,it.objectFilterOutValues(e,void 0))}static get(e){return pi._params[e]}static get appName(){return"ok.calls.sdk.js"}static get appVersion(){return 1.1}static get sdkVersion(){return"2.8.3-beta.6"}static get debug(){}static get protocolVersion(){return pi._params.joinFromMultipleDevices?6:5}static get platform(){return pi._params.platform}static set platform(e){pi._params.platform=e}static get clientType(){return pi._params.clientType}static set clientType(e){pi._params.clientType=e}static get externalUserType(){return pi._params.externalUserType}static set externalUserType(e){pi._params.externalUserType=e}static get device(){return pi._params.device}static get apiKey(){return pi._params.apiKey}static get apiEnv(){return pi._params.apiEnv}static apiEndpoint(e){switch(null!=e?e:pi.apiEnv){case"AUTO":case"PROD":return"https://api.mycdn.me";case"PROD_OK":return"https://api.ok.ru";case"TEST":return"https://apitest.ok.ru/api";case"VIDEOTEST":return"https://videotestapi.ok.ru/api";default:return pi._params.apiEnv}}static get authToken(){return pi._params.authToken}static set authToken(e){pi._params.authToken=e}static get anonymToken(){return pi._params.anonymToken}static set anonymToken(e){pi._params.anonymToken=e}static get domain(){return pi._params.domain}static get externalDomain(){return pi._params.externalDomain}static get iceServers(){return pi._params.iceServers}static set iceServers(e){pi._params.iceServers=e}static get wssBase(){return pi._params.wssBase}static set wssBase(e){pi._params.wssBase=e}static get wssToken(){return pi._params.wssToken}static set wssToken(e){pi._params.wssToken=e}static get signalingReconnectDelay(){return pi._params.signalingReconnectDelay}static get signalingReconnectMaxDelay(){return pi._params.signalingReconnectMaxDelay}static get signalingReconnectMaxCount(){return pi._params.signalingReconnectMaxCount}static get waitConnectionDelay(){return pi._params.waitConnectionDelay}static get waitResponseDelay(){return pi._params.waitResponseDelay}static get waitMessageDelay(){return pi._params.waitMessageDelay}static get waitAnotherTabDelay(){return pi._params.waitAnotherTabDelay}static get debugLog(){return pi._params.debugLog}static get forceRelayPolicy(){return pi._params.forceRelayPolicy}static set forceRelayPolicy(e){pi._params.forceRelayPolicy=e}static get videoMinWidth(){return pi._params.videoMinWidth}static get videoMaxWidth(){return pi._params.videoMaxWidth}static set videoMaxWidth(e){pi._params.videoMaxWidth=e}static get videoMinHeight(){return pi._params.videoMinHeight}static get videoMaxHeight(){return pi._params.videoMaxHeight}static set videoMaxHeight(e){pi._params.videoMaxHeight=e}static get videoAspectRatio(){return pi._params.videoAspectRatio}static get videoFrameRate(){return pi._params.videoFrameRate}static get videoFacingMode(){return pi._params.videoFacingMode||(Pt.isMobile()?"user":null)}static set videoFacingMode(e){pi._params.videoFacingMode=e}static get displaySurface(){return pi._params.displaySurface}static get videoEffects(){return pi._params.videoEffects}static set videoEffects(e){pi._params.videoEffects=e}static get videoEffectMaxWidth(){return pi._params.videoEffectMaxWidth}static set videoEffectMaxWidth(e){pi._params.videoEffectMaxWidth=e}static get videoEffectMaxHeight(){return pi._params.videoEffectMaxHeight}static set videoEffectMaxHeight(e){pi._params.videoEffectMaxHeight=e}static get vmoji(){var e;return null!=(e=pi._params.vmoji)&&e.isBrowserSupported()?pi._params.vmoji:null}static set vmoji(e){pi._params.vmoji=e}static get vmojiRenderingOptions(){return pi._params.vmojiRenderingOptions||{}}static set vmojiRenderingOptions(e){pi._params.vmojiRenderingOptions=e}static get voiceParams(){return pi._params.voiceParams}static get specListenerParams(){return pi._params.specListenerParams}static get iceRestartWaitTime(){return pi._params.iceRestartWaitTime}static get transportConnectionWaitTime(){return pi._params.transportConnectionWaitTime}static get statisticsInterval(){return pi._params.statisticsInterval}static set statisticsInterval(e){pi._params.statisticsInterval=e}static get networkStatisticsInterval(){return pi._params.networkStatisticsInterval}static get perfStatReportEnabled(){return pi._params.perfStatReportEnabled}static get callStatReportEnabled(){return pi._params.callStatReportEnabled}static get enableLogPerfStatReport(){return pi._params.enableLogPerfStatReport}static get producerNotificationDataChannel(){return pi._params.producerNotificationDataChannel}static get producerCommandDataChannel(){return pi._params.producerCommandDataChannel}static get consumerScreenDataChannel(){return pi._params.consumerScreenDataChannel&&di.isBrowserSupported()}static get producerScreenDataChannel(){return pi._params.producerScreenDataChannel&&pi.producerNotificationDataChannel&&ii.isBrowserSupported()}static get asrDataChannel(){return pi._params.asrDataChannel&&pi.producerNotificationDataChannel}static get consumerScreenDataChannelPacketSize(){return pi._params.consumerScreenDataChannelPacketSize}static get screenShareWebmBuilder(){return pi._params.screenShareWebmBuilder}static get noiseSuppression(){return pi._params.noiseSuppression}static set noiseSuppression(e){pi._params.noiseSuppression=e}static get preferH264(){return pi._params.preferH264}static get preferVP9(){return pi._params.preferVP9}static get audioNack(){return pi._params.audioNack}static get consumerScreenTrack(){return pi._params.consumerScreenTrack&&pi.consumerScreenDataChannel}static get producerScreenTrack(){return pi._params.producerScreenTrack}static get movieShare(){return pi._params.movieShare&&pi.videoTracksCount>0}static get videoTracksCount(){return pi.producerNotificationDataChannel?Number(pi._params.videoTracksCount):0}static get breakVideoPayloadTypes(){return pi._params.breakVideoPayloadTypes}static get useParticipantListChunk(){return pi._params.useParticipantListChunk&&pi.videoTracksCount>0}static get useRooms(){return pi._params.useRooms}static get participantListChunkInitIndex(){var e;return null!=(e=pi._params.participantListChunkInitIndex)?e:0}static get participantListChunkInitCount(){var e;return null!=(e=pi._params.participantListChunkInitCount)?e:null}static get serverAudioRed(){return pi._params.serverAudioRed}static get p2pAudioRed(){return pi._params.p2pAudioRed}static get h264spsPpsIdrInKeyframe(){return pi._params.h264spsPpsIdrInKeyframe}static get filterObservers(){return pi._params.filterObservers}static get muteMode(){return pi._params.muteMode}static get preserveAudioTracks(){return pi._params.preserveAudioTracks}static get audioShare(){return Pt.isAudioShareSupported()&&pi._params.audioShare}static get fastScreenShare(){return pi._params.fastScreenShare}static get screenShareCongestionControl(){return pi._params.screenShareCongestionControl}static get screenShareCongestionControlThreshold(){return pi._params.screenShareCongestionControlThreshold}static get fastScreenShareWidth(){return pi._params.fastScreenShareWidth}static get fastScreenShareHeight(){return pi._params.fastScreenShareHeight}static get newMuteRules(){return pi._params.newMuteRules}static get videoSuspend(){return pi._params.videoSuspend}static get enumerateDevicesDelay(){return pi._params.enumerateDevicesDelay}static getScreenFrameRate(e){return e?pi._params.fastScreenShareFrameRate:pi._params.screenFrameRate}static get switchVideoAtBadNetwork(){return pi._params.switchVideoAtBadNetwork}},_i=pi;_i._params={platform:"WEB",clientType:"PORTAL",externalUserType:"",device:"browser",apiKey:"",authToken:"",anonymToken:"",apiEnv:"AUTO",domain:"",externalDomain:"",iceServers:[],wssBase:"",wssToken:"",signalingReconnectDelay:1e3,signalingReconnectMaxDelay:5e3,signalingReconnectMaxCount:10,waitConnectionDelay:1e4,waitResponseDelay:1e4,waitMessageDelay:15e3,waitAnotherTabDelay:200,debugLog:!1,forceRelayPolicy:!1,videoMinWidth:428,videoMinHeight:240,videoMaxWidth:1280,videoMaxHeight:720,videoAspectRatio:16/9,videoFrameRate:25,screenFrameRate:15,videoFacingMode:null,displaySurface:"monitor",videoEffects:null,videoEffectMaxWidth:640,videoEffectMaxHeight:360,vmoji:null,vmojiRenderingOptions:null,iceRestartWaitTime:2e4,transportConnectionWaitTime:5e3,statisticsInterval:5e3,networkStatisticsInterval:2e4,perfStatReportEnabled:!0,callStatReportEnabled:!1,enableLogPerfStatReport:!1,voiceParams:{smoothing:.8,minFreq:200,maxFreq:5e3,interval:500,threshold:.35,speakerLevelMultiplier:1.8},specListenerParams:{connectionTimeout:1e4,volumeTimeout:1e4},producerNotificationDataChannel:!0,producerCommandDataChannel:!0,consumerScreenDataChannel:!0,producerScreenDataChannel:!0,asrDataChannel:!1,consumerScreenDataChannelPacketSize:65536,screenShareWebmBuilder:!1,noiseSuppression:!0,preferH264:!1,preferVP9:!0,audioNack:!0,consumerScreenTrack:!0,producerScreenTrack:!0,videoTracksCount:30,movieShare:!1,useParticipantListChunk:!1,useRooms:!1,participantListChunkInitIndex:0,participantListChunkInitCount:null,serverAudioRed:!0,p2pAudioRed:!0,h264spsPpsIdrInKeyframe:!0,breakVideoPayloadTypes:!1,joinFromMultipleDevices:!1,filterObservers:!1,muteMode:!1,preserveAudioTracks:!1,audioShare:!1,fastScreenShare:!1,screenShareCongestionControl:!1,screenShareCongestionControlThreshold:2100,fastScreenShareFrameRate:24,fastScreenShareWidth:1280,fastScreenShareHeight:720,newMuteRules:!1,videoSuspend:!1,enumerateDevicesDelay:2e3,switchVideoAtBadNetwork:!1};var mi,fi,gi,vi=((mi=vi||{}).WAITING_HALL="WAITING_HALL",mi.WAITING="WAITING",mi.CONNECTING="CONNECTING",mi.CONNECTED="CONNECTED",mi.RECONNECT="RECONNECT",mi.ERROR="ERROR",mi.HANGUP="HANGUP",mi.PERMISSIONS="PERMISSIONS",mi);function Si(e,...t){let i=_i.get(e);"function"==typeof i&&setTimeout(i,0,...t)}function yi(e,t,...i){if(_i.filterObservers)if(Array.isArray(t)){if(t=t.filter((e=>!e.observer)),!t.length)return}else if(t.observer)return;Si(e,t,...i)}function Ti(e){return Object.assign({},e)}function Ei(e){return e.slice()}(gi=fi||(fi={})).onLocalStream=function(e,t){Si("onLocalStream",e,Ti(t))},gi.onScreenStream=function(e,t){Si("onScreenStream",e,Ti(t))},gi.onVmojiStream=function(e,t){Si("onVmojiStream",e,Ti(t))},gi.onLocalStreamUpdate=function(e,t){Si("onLocalStreamUpdate",Ti(e),t)},gi.onLocalStatus=function(e){Ai.debug("Local status:",e),Si("onLocalStatus",e)},gi.onRemoteStream=function(e,t){yi("onRemoteStream",e,t)},gi.onRemoteLive=function(e,t){yi("onRemoteLive",e,t)},gi.onLocalLive=function(e,t){yi("onLocalLive",e,t)},gi.onRemoteLiveUpdate=function(e,t){yi("onRemoteLiveUpdate",e,t)},gi.onLocalLiveUpdate=function(e,t){yi("onLocalLiveUpdate",e,t)},gi.onRemoteScreenStream=function(e,t){yi("onRemoteScreenStream",e,t)},gi.onRemoteVmojiStream=function(e,t){yi("onRemoteVmojiStream",e,t)},gi.onRemoteStreamSuspended=function(e,t){yi("onRemoteStreamSuspended",e,t)},gi.onRemoteScreenStreamSuspended=function(e,t){yi("onRemoteScreenStreamSuspended",e,t)},gi.onConversation=function(e,t,i,n,r){yi("onConversation",e,Ti(t),Ti(i),n,r)},gi.onConversationParticipantListChunk=function(e){e&&Si("onConversationParticipantListChunk",e)},gi.onRemoteMediaSettings=function(e,t,i){yi("onRemoteMediaSettings",e,Ti(t),i)},gi.onLocalMediaSettings=function(e,t){yi("onLocalMediaSettings",e,Ti(t))},gi.onRemoteSharedMovieInfo=function(e,t,i){yi("onRemoteSharedMovieInfo",e,Ti(t),i)},gi.onRemoteSharedMovieStoppedInfo=function(e,t,i){yi("onRemoteSharedMovieStoppedInfo",e,Ti(t),i)},gi.onLocalSharedMovieInfo=function(e,t,i){yi("onLocalSharedMovieInfo",e,Ti(t),i)},gi.onLocalSharedMovieStoppedInfo=function(e,t,i){yi("onLocalSharedMovieStoppedInfo",e,Ti(t),i)},gi.onParticipantAdded=function(e,t){yi("onParticipantAdded",e,t)},gi.onParticipantJoined=function(e,t){yi("onParticipantJoined",e,t)},gi.onRemoteParticipantState=function(e,t,i){yi("onRemoteParticipantState",e,Ti(t),i)},gi.onRemoteStatus=function(e,t,i=null){Ai.debug("Remote status:",t,e),yi("onRemoteStatus",e,t,i)},gi.onPermissionsRequested=function(){Si("onPermissionsRequested")},gi.onPermissionsError=function(e,t){Si("onPermissionsError",e,t)},gi.onRemoteRemoved=function(e,t){yi("onRemoteRemoved",e,t)},gi.onCallState=function(e,t,i){Si("onCallState",e,t,Ti(i))},gi.onDeviceSwitched=function(e,t){Si("onDeviceSwitched",e,t)},gi.onMuteStates=function(e,t,i,n=!1,r=!1,a=null,s=null,o,c,l=null){let u=c?Ei(c):void 0;Si("onMuteStates",Ti(e),Ei(t),Ei(i),n,r,a,s,o,u,l)},gi.onRolesChanged=function(e,t){yi("onRolesChanged",e,Ei(t))},gi.onLocalRolesChanged=function(e){Si("onLocalRolesChanged",Ei(e))},gi.onPinnedParticipant=function(e,t,i,n){yi("onPinnedParticipant",e,t,i,n)},gi.onLocalPin=function(e,t){Si("onLocalPin",e,t)},gi.onOptionsChanged=function(e){Si("onOptionsChanged",Ei(e))},gi.onCallAccepted=function(){Si("onCallAccepted")},gi.onRateNeeded=function(){Si("onRateNeeded")},gi.onSpeakerChanged=function(e){yi("onSpeakerChanged",e)},gi.onVolumesDetected=function(e){Si("onVolumesDetected",Ei(e))},gi.onLocalVolume=function(e,t){Si("onLocalVolume",e,t)},gi.onJoinStatus=function(e,t){Si("onJoinStatus",e,t)},gi.onHangup=function(e,t){Si("onHangup",e,t)},gi.onMultipartyChatCreated=function(e){Si("onMultipartyChatCreated",Ti(e))},gi.onDeviceChange=function(){Si("onDeviceChange")},gi.onFingerprintChange=function(e){Si("onFingerprintChange",e)},gi.onTokenExpired=function(){Si("onTokenExpired")},gi.onChatMessage=function(e,t,i=!1){Si("onChatMessage",e,t,i)},gi.onCustomData=function(e,t,i=!1){Si("onCustomData",e,t,i)},gi.onRecordStarted=function(e,t,i,n,r,a,s=null){Si("onRecordStarted",e,t,i,n,r,a,s)},gi.onRecordStopped=function(e=null){Si("onRecordStopped",e)},gi.onLocalNetworkStatusChanged=function(e){Si("onLocalNetworkStatusChanged",e)},gi.onNetworkStatusChanged=function(e){Si("onNetworkStatusChanged",e)},gi.onDebugMessage=function(e,...t){Si("onDebugMessage",e,...t)},gi.onStatistics=function(e,t){Si("onStatistics",Object.assign({},e,{memory:t}))},gi.onAutoplayError=function(){Si("onAutoplayError")},gi.onChatRoomUpdated=function(e,t,i,n,r){Si("onChatRoomUpdated",e,t,i,n,r)},gi.onPromoted=function(e){Si("onPromoted",e)},gi.onRemoteMixedAudioStream=function(e){Si("onRemoteMixedAudioStream",e)},gi.onJoinLinkChanged=function(e){Si("onJoinLinkChanged",e)},gi.onRoomsUpdated=function(e){Si("onRoomsUpdated",e)},gi.onRoomUpdated=function(e,t,i,n){Si("onRoomUpdated",e,t,i,n)},gi.onRoomParticipantsUpdated=function(e){Si("onRoomParticipantsUpdated",e)},gi.onRoomSwitched=function(e){Si("onRoomSwitched",e)},gi.onRoomStart=function(e){Si("onRoomStart",e)},gi.onFeedback=function(e,t=null){Si("onFeedback",e,t)},gi.onFeaturesPerRoleChanged=function(e){Si("onFeaturesPerRoleChanged",e)},gi.onParticipantVmojiUpdate=function(e){Si("onParticipantVmojiUpdate",e)},gi.onAsrSet=function(e,t){Si("onAsrSet",e,t)},gi.onAsrStarted=function(e,t,i){Si("onAsrStarted",e,t,i)},gi.onAsrStopped=function(e){Si("onAsrStopped",e)},gi.onAsrTranscription=function(e,t,i,n){Si("onAsrTranscription",e,t,i,n)},gi.onSignalingMessage=function(e){Si("onSignalingMessage","string"==typeof e?e:Ti(e))},gi.onPromotionApproved=function(e){Si("onPromotionApproved",e)};var Ci,Ii=fi,bi=(e=>(e.DEBUG="DEBUG",e.LOG="LOG",e.WARN="WARN",e.ERROR="ERROR",e))(bi||{});(e=>{let t="📞",i=(e,...t)=>{Ii.onDebugMessage(e,...t)},n=!1,r=(e,t)=>(...i)=>{e(...i),function(e,t){if(!Pe.available)return;let i=new Date;ke.push({t:i.getTime(),l:e,d:t,h:i.toLocaleString("ru-RU",{dateStyle:"short",timeStyle:"long"})}),Oe||(Oe=window.setTimeout((()=>{Oe=null,Re()}),3e4))}(t,i)},a=console.debug.bind(console,t),s=console.log.bind(console,t),o=console.warn.bind(console,t),c=console.error.bind(console,t),l=i.bind(null,"DEBUG"),u=i.bind(null,"LOG"),d=i.bind(null,"WARN"),h=i.bind(null,"ERROR");e.debug=l,e.log=u,e.warn=d,e.error=h,e.enabled=function(){return n},e.toggle=function(t){n=t,_i.debugLog&&we(),t?(e.debug=_i.debugLog?r(a,"DEBUG"):a,e.log=_i.debugLog?r(s,"LOG"):s,e.warn=_i.debugLog?r(o,"WARN"):o,e.error=_i.debugLog?r(c,"ERROR"):c):(e.debug=_i.debugLog?r(l,"DEBUG"):l,e.log=_i.debugLog?r(u,"LOG"):u,e.warn=_i.debugLog?r(d,"WARN"):d,e.error=_i.debugLog?r(h,"ERROR"):h)},e.send=function(t,...i){switch(t){case"DEBUG":(0,e.debug)(...i);break;case"LOG":(0,e.log)(...i);break;case"WARN":(0,e.warn)(...i);break;case"ERROR":(0,e.error)(...i)}}})(Ci||(Ci={}));var Ri,Ai=Ci,wi=(e=>(e.USER="USER",e.ANONYM="ANONYM",e.GROUP="GROUP",e))(wi||{});(e=>{function t(e,t="USER",i=0){return{id:e,type:t,deviceIdx:i}}function i(e){let t=e.deviceIdx||0;return`{"id":"${e.id}","type":"${e.type}","deviceIdx":${t}}`}e.fromIds=function(e){return e.length?"object"==typeof e[0]?e:e.map((e=>t(e))):[]},e.fromId=t,e.fromSignaling=function(e,t=0){return{id:e.id,type:"ANONYM"===e.type?"ANONYM":"USER",deviceIdx:t}},e.toString=i,e.fromIdToString=function(e,n="USER",r=0){return i(t(e,n,r))},e.fromString=function(e){try{return JSON.parse(e)}catch(t){throw new Error(`Failed to parse ExternalId from string '${e}'`)}},e.compare=function(e,t){return e.id===t.id&&e.type===t.type&&e.deviceIdx===t.deviceIdx},e.getDeviceIdx=function(e){return(null==e?void 0:e.deviceIdx)||0}})(Ri||(Ri={}));function Pi(e){return e.stopStream}function ki(e){return e.keyFrameRequested}function Di(e){if(Pi(e))return"ss";if(ki(e))return"kf";let t="";return void 0!==e.priority&&(t+="p="+e.priority),void 0!==e.width&&void 0!==e.height&&(""!==t&&(t+=":"),t+="sz="+Math.round(e.width)+"x"+Math.round(e.height)),void 0!==e.fit&&(""!==t&&(t+=":"),t+="fit="+e.fit),t}var Oi=(e=>(e.CAMERA="CAMERA",e.SCREEN="SCREEN",e.STREAM="STREAM",e.MOVIE="MOVIE",e.ANIMOJI="ANIMOJI",e))(Oi||{});function Ni(e){return e.participantId+(e.mediaType?":s"+e.mediaType:"")+(e.streamName?":m"+e.streamName:"")}function Mi(e){let t=e.split(Ye),i=t.shift();if(!i)throw new Error("Illegal stream description: "+e);let n,r=null,a=0;for(let i of t)switch(i.charAt(0)){case"s":r=Li(i.slice(1));break;case"m":n=i.slice(1);break;case"d":a=Number.parseInt(i.slice(1),10);break;default:throw new Error("Unexpected parameter type "+i.charAt(0)+" in stream description "+e)}return{participantId:it.compose(i,a),mediaType:r,streamName:n}}function Li(e){for(let t of Object.keys(Oi))if(t===e)return Oi[t];return null}function xi(e,t){return null===e||null===t?null===e&&null===t:!(e.maxDimension!==t.maxDimension||e.maxBitrateK!==t.maxBitrateK||e.maxFramerate!==t.maxFramerate||e.degradationPreference!==t.degradationPreference)}function Ui(e,t){return!(!xi(e.camera,t.camera)||!xi(e.screenSharing,t.screenSharing))}function Vi(e,t){return{camera:Object.assign({},e.camera,t.camera),screenSharing:Object.assign({},e.screenSharing,t.screenSharing)}}var Fi=(e,t)=>it.objectReduce(e,((e,i,n)=>(i===t&&e.push(n),e)),[]),ji=class{_fixAudioDeviceNoPackets(e){if(!this._fixNoPacketsApplied||!this._fixNoPacketsChecked){if(this._fixNoPacketsApplied&&!this._fixNoPacketsChecked)return this._fixNoPacketsChecked=!0,void Ne.log(ce.ERROR,"audio_device_recover_"+(e.bandwidth?"success":"fail"));!this._fixNoPacketsApplied&&!e.bandwidth&&(this._fixNoPacketsApplied=!0,Ne.log(ce.ERROR,"audio_device_recover"),Ai.log("[AudioFix] Trying to fix RV (no packets)"),this._mediaSource.toggleAudio(!0))}}_fixAudioDeviceTooManyPackets(e){if(this._fixTooManyPacketsSucceeded||this._fixTooManyPacketsFailed)return;let t=Date.now();if(this._lastPacketsSentTime){if(t-this._lastPacketsSentTime>500){let i=1e3*(e.packetsSent-this._lastPacketsSent)/(t-this._lastPacketsSentTime);this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent,this._fixTooManyPacketsApplied?i>75?(Ai.log("[AudioFix] Failed to fix RV"),Ne.log(ce.ERROR,"audio_device_recover_rv_fail"),this._fixTooManyPacketsFailed=!0):t-this._fixTooManyPacketsTime>6e4&&(Ai.log("[AudioFix] Fixed RV"),Ne.log(ce.ERROR,"audio_device_recover_rv_success"),this._fixTooManyPacketsSucceeded=!0):i>75&&(this._fixTooManyPacketsApplied=!0,Ne.log(ce.ERROR,"audio_device_recover"),Ai.log("[AudioFix] Trying to fix RV (too many packets)"),this._mediaSource.toggleAudio(!0),this._fixTooManyPacketsTime=t)}}else e.packetsSent>0&&(this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent)}fix(e){if(!this._mediaSource)return;let t=e.find((e=>"audio"===e.kind));t&&(this._fixAudioDeviceNoPackets(t),this._fixAudioDeviceTooManyPackets(t))}constructor(e){this._fixNoPacketsApplied=!1,this._fixNoPacketsChecked=!1,this._fixTooManyPacketsApplied=!1,this._fixTooManyPacketsSucceeded=!1,this._fixTooManyPacketsFailed=!1,this._mediaSource=e}},$i=(e=>(e.producerNotification="producerNotification",e.producerCommand="producerCommand",e.consumerScreenShare="consumerScreenShare",e.producerScreenShare="producerScreenShare",e.asr="asr",e.animoji="animoji",e))($i||{}),Bi=$i,Hi=class extends b{getState(){return this._state||"IDLE"}constructor(e,t){super(),this._state="IDLE",this._pc=null,this._signaling=e,this._mediaSource=t}},Wi="videochat-epi",Gi=class extends b{destroy(){this.unsubscribe()}static getEstimatedPerformanceIndex(){try{let e=parseInt(localStorage.getItem(Wi)||"",10);return isNaN(e)?0:e}catch(e){return 0}}_handleStats(e){return E(this,null,(function*(){if(!e.inbound||!e.inbound.rtps)return;let t=Date.now();!this._directTopology&&_i.perfStatReportEnabled&&this._previousTimestamp+5e3<=t&&(yield this.reportPerfStats(e),this._previousTimestamp=t),_i.callStatReportEnabled&&this._previousCallStatReportTimestamp+_i.statisticsInterval<=t&&(this._reportCallStats(e),this._previousCallStatReportTimestamp=t)}))}reportPerfStats(e){return E(this,null,(function*(){let t=e.inbound.rtps.reduce(((e,t)=>("video"===t.kind&&(e.framesDecoded+=t.framesDecoded||0,e.framesReceived+=t.framesReceived||0),e)),{framesDecoded:0,framesReceived:0});if(t.framesDecoded)try{let e=yield this._signaling.reportPerfStat(t);localStorage.setItem(Wi,e.estimatedPerformanceIndex)}catch(e){}}))}_reportCallStats(e){var t,i,n,r;let a={call_topology:this._directTopology?"D":"S",nack_received:0,pli_received:0,fir_received:0,frames_dropped:0,jitter_video:0,jitter_audio:0,interframe_delay_variance:0,nack_sent:0,pli_sent:0,fir_sent:0,total_audio_samples_received:0,concealed_audio_samples:0,silent_concealed_audio_samples:0,inserted_audio_samples_for_deceleration:0,removed_audio_samples_for_acceleration:0,audio_concealment_events:0,total_audio_energy:0,inbound_video_count:0,inbound_audio_count:0,freeze_count:0,total_freezes_duration:0,rtt:Math.round(1e3*e.inbound.transport.currentRoundTripTime),ss_freeze_count:0,ss_total_freezes_duration:0,local_address:qi(e.inbound.transport.local),local_connection_type:null==(t=e.inbound.transport.local)?void 0:t.type,network_type:null==(i=e.inbound.transport.local)?void 0:i.networkType,transport:null==(n=e.inbound.transport.local)?void 0:n.protocol,remote_address:qi(e.inbound.transport.remote),remote_connection_type:null==(r=e.inbound.transport.remote)?void 0:r.type};this._previousCallStatReport||(this._previousCallStatReport=Object.assign({},a));let s=!1,o=!1;for(e.inbound.rtps.reduce(((e,t)=>("video"===t.kind?(s=!0,t.framesReceived&&(e.jitter_video=e.jitter_video*e.inbound_video_count/(e.inbound_video_count+1)+1e3*t.jitter/(e.inbound_video_count+1),e.interframe_delay_variance=e.interframe_delay_variance*e.inbound_video_count/(e.inbound_video_count+1)+1e6*(t.interframeDelayVariance||0)/(e.inbound_video_count+1),e.inbound_video_count++),e.frames_dropped+=t.framesDropped||0,e.nack_sent+=t.nackCount,e.pli_sent+=t.pliCount,e.fir_sent+=t.firCount,e.freeze_count+=t.freezeCountDelta||0,e.total_freezes_duration+=t.totalFreezesDurationDelta||0):(o=!0,t.totalSamplesReceived&&(e.jitter_audio=e.jitter_audio*e.inbound_audio_count/(e.inbound_audio_count+1)+1e3*t.jitter/(e.inbound_audio_count+1),e.total_audio_energy=e.total_audio_energy*e.inbound_audio_count/(e.inbound_audio_count+1)+(t.totalAudioEnergy||0)/(e.inbound_audio_count+1),e.inbound_audio_count++),e.total_audio_samples_received+=t.totalSamplesReceived||0,e.inserted_audio_samples_for_deceleration+=t.insertedSamplesForDeceleration||0,e.removed_audio_samples_for_acceleration+=t.removedSamplesForAcceleration||0,e.concealed_audio_samples+=t.concealedSamples||0,e.silent_concealed_audio_samples+=t.silentConcealedSamples||0,e.audio_concealment_events+=t.concealmentEvents||0),e)),a),e.outbound.rtps.reduce(((e,t)=>("video"===t.kind&&(e.nack_received+=t.nackCount,e.pli_received+=t.pliCount,e.fir_received+=t.firCount),e)),a);this._screenShareStats.length;){let e=this._screenShareStats.pop();null!=e&&e.freeze_duration&&(a.ss_freeze_count+=1,a.ss_total_freezes_duration+=e.freeze_duration)}let c={call_topology:a.call_topology,nack_sent:Math.max(0,a.nack_sent-this._previousCallStatReport.nack_sent),nack_received:Math.max(0,a.nack_received-this._previousCallStatReport.nack_received),pli_sent:Math.max(0,a.pli_sent-this._previousCallStatReport.pli_sent),pli_received:Math.max(0,a.pli_received-this._previousCallStatReport.pli_received),fir_sent:Math.max(0,a.fir_sent-this._previousCallStatReport.fir_sent),fir_received:Math.max(0,a.fir_received-this._previousCallStatReport.fir_received),frames_dropped:Math.max(0,a.frames_dropped-this._previousCallStatReport.frames_dropped),rtt:a.rtt};if(s&&!zi(a.jitter_video)&&(c.jitter_video=a.jitter_video),o&&!zi(a.jitter_audio)&&(c.jitter_audio=a.jitter_audio),s&&!zi(a.interframe_delay_variance)&&(c.interframe_delay_variance=a.interframe_delay_variance),a.freeze_count&&a.total_freezes_duration&&(c.freeze_count=a.freeze_count,c.total_freezes_duration=1e3*a.total_freezes_duration),a.ss_freeze_count&&a.ss_total_freezes_duration&&(c.ss_freeze_count=a.ss_freeze_count,c.ss_total_freezes_duration=a.ss_total_freezes_duration),o&&!zi(a.total_audio_samples_received)){let e=Math.max(0,a.total_audio_samples_received-this._previousCallStatReport.total_audio_samples_received),t=Math.max(0,a.inserted_audio_samples_for_deceleration-this._previousCallStatReport.inserted_audio_samples_for_deceleration),i=Math.max(0,a.removed_audio_samples_for_acceleration-this._previousCallStatReport.removed_audio_samples_for_acceleration),n=Math.max(0,a.concealed_audio_samples-this._previousCallStatReport.concealed_audio_samples),r=Math.max(0,a.silent_concealed_audio_samples-this._previousCallStatReport.silent_concealed_audio_samples),s=Math.max(0,a.audio_concealment_events-this._previousCallStatReport.audio_concealment_events);c.inserted_audio_samples_for_deceleration=Ji(t/e*1e3),c.removed_audio_samples_for_acceleration=Ji(i/e*1e3),c.concealed_audio_samples=Ji(n/e*1e3),c.concealed_silent_audio_samples=Ji(r/e*1e3),c.concealment_audio_avg_size=Ji(n/s),c.total_audio_energy=a.total_audio_energy}Ki(a,"local_address","local_connection_type","network_type","transport")&&(c.local_address=a.local_address,c.local_connection_type=a.local_connection_type,c.network_type=a.network_type,c.transport=a.transport),Ki(a,"remote_address","remote_connection_type")&&(c.remote_address=a.remote_address,c.remote_connection_type=a.remote_connection_type),qt.logCallStat(c),_i.enableLogPerfStatReport&&Ai.log("Sent call stats",c),this._previousCallStatReport=a}constructor(e,t,i=!1){super(),this._previousTimestamp=0,this._previousCallStatReportTimestamp=0,this._previousCallStatReport=null,this._screenShareStats=[],this._handleScreenSharingStat=e=>{this._screenShareStats.push(e)},this._signaling=t,this._directTopology=i,this.subscribe(e,"REMOTE_DATA_STATS",this._handleStats.bind(this)),this.subscribe(e,"SCREEN_SHARING_STAT",this._handleScreenSharingStat.bind(this))}};function Ki(e,...t){for(let i of t)if(!e.hasOwnProperty(i)||void 0===e[i])return!1;return!0}function qi(e){if(e)return`${e.address}:${e.port}`}function zi(e){return void 0===e}function Ji(e){return Number.isNaN(e)?0:e}var Yi=.8,Qi=class extends Hi{get participantId(){return this._participantId}updateStatisticsInterval(){this._stopStatInterval(),this._isDeadConnection()||this._startStatInterval()}_isDeadConnection(){return["IDLE","CLOSED","FAILED"].includes(this.getState())}open(e=null){return E(this,null,(function*(){if(this._isOpen)return void Ai.warn("DirectTransport: Already opened",{participantId:this._participantId});if(this._failedOnCreate)return void this.close(this._failedOnCreate);if(Ai.debug("DirectTransport: Open transport",{participantId:this._participantId}),this._isOpen=!0,this._remotePeerId=e,!this._isMaster)try{this._mediaSource.addTrackToPeerConnection(this._pc,!1,!0),this._applySettings()}catch(e){return Ne.log(ce.ERROR,"addTrack-direct"),Ai.error("DirectTransport: Unable to add media source tracks",e,{participantId:this._participantId}),void this.close(e)}this._setState("OPENED");let t=e;if(!e){let e=Object.keys(this._remoteSDP);t=e[e.length-1]}if(t&&this._remoteSDP[t])try{yield this._setRemoteDescription(t,this._remoteSDP[t])}catch(e){return void this.close()}this._remoteSDP={},this._remoteCandidates={}}))}updateSettings(e){Ui(e,this._serverSettings)||(this._serverSettings=e,this._applySettings())}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}setAnimojiTransport(e,t){if(_i.vmoji&&(this._animojiReceiver=e,this._animojiSender=t,e.setParticipantId(this._participantId),this._animojiDataChannel))return e.setDataChannel(this._animojiDataChannel),void t.setDataChannel(this._animojiDataChannel)}close(e){this._isOpen&&(this._isOpen=!1,this._stopReconnection(),this._remoteStream&&(this._remoteStream.getTracks().forEach((e=>{e.stop(),this._triggerEvent("REMOTE_TRACK_REMOVED",this._remoteStream,e)})),this._remoteStream=null),this._stopStatInterval(),this._stopSettingsInterval(),this._pc&&(this._animojiDataChannel&&(this._animojiDataChannel.onopen=null,this._animojiDataChannel.onmessage=null,this._animojiDataChannel.onerror=null,this._animojiDataChannel.close()),this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.oniceconnectionstatechange=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._pc.close(),this._pc=null),this.unsubscribe(),e?(Ai.error("DirectTransport: Closed",e,{participantId:this._participantId}),this._setState("FAILED")):(Ai.debug("DirectTransport: Closed",{participantId:this._participantId}),this._setState("CLOSED")),this._triggerEvent("PEER_CONNECTION_CLOSED"))}_setState(e){this._state!==e&&(Ai.debug(`DirectTransport: State changed to ${e}`,{participantId:this._participantId}),this._state=e,this._triggerEvent("STATE_CHANGED",e))}_onSignalingNotification(e){var t,i,n,r;switch(e.notification){case se.TRANSMITTED_DATA:this._handleTransmittedData(e);break;case se.SETTINGS_UPDATE:Object.assign(this._networkLimits.badNet,(null==(t=e.settings)?void 0:t.badNet)||{}),Object.assign(this._networkLimits.goodNet,(null==(i=e.settings)?void 0:i.goodNet)||{});break;case se.CUSTOM_DATA:e.data.hasOwnProperty("sdk")&&(this._remoteNetworkStat.rtt=(null==(n=e.data.sdk)?void 0:n.rtt)||0,this._remoteNetworkStat.loss=(null==(r=e.data.sdk)?void 0:r.loss)||0)}}_handleTransmittedData(e){let t=e.data,i=it.getPeerIdString(e.peerId);it.composeMessageId(e)===this._participantId&&(t.candidate&&t.candidate.candidate?this._addIceCandidate(i,t.candidate).catch(this.close.bind(this)):t.sdp&&this._setRemoteDescription(i,t.sdp).catch(this.close.bind(this)))}_addIceCandidate(e,t){return E(this,null,(function*(){if(this._isOpen&&(!this._remotePeerId||this._remotePeerId===e)&&this._pc&&this._pc.remoteDescription){Ai.debug("Add remote ice candidate",{participantId:this._participantId,candidate:t});try{yield this._pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){throw Ne.log(ce.ERROR,"addIceCandidate-direct"),Ai.error("Unable to add remote ice candidate",e,{participantId:this._participantId,candidate:t}),e}}else Ai.debug("Cache remote ice candidate",{participantId:this._participantId,candidate:t}),this._remoteCandidates[e]=this._remoteCandidates[e]||[],this._remoteCandidates[e].push(t)}))}_setRemoteCandidates(e){return E(this,null,(function*(){if(!this._remoteCandidates[e])return void Ai.log(`No cached candidates found for peer ${e}`);let t=this._remoteCandidates[e];this._remoteCandidates[e]=[];for(let i of t)try{yield this._addIceCandidate(e,i)}catch(e){}}))}_setRemoteDescription(e,t){return E(this,null,(function*(){var i;if(!this._isOpen||this._remotePeerId&&this._remotePeerId!==e||!this._pc)this._remoteSDP[e]=t;else{if((null==(i=this._lastRemoteSDP)?void 0:i.sdp)===t.sdp)return;this._lastRemoteSDP=t,t=Qi._patchRemoteDescription(t),Ai.debug("Add remote description",{participantId:this._participantId,sdp:t}),this._calcFingerprint(t.sdp);try{yield this._pc.setRemoteDescription(t),yield this._setRemoteCandidates(e)}catch(e){throw Ne.log(ce.ERROR,"setRemoteDescription-direct"),Ai.error("Unable to set remote description",e,{participantId:this._participantId,sdp:t}),e}}}))}_onAddTrack(e){Ai.debug("Added remote track",{participantId:this._participantId,kind:e.track.kind}),this._remoteStream?this._remoteStream.addTrack(e.track):(this._remoteStream=new MediaStream([e.track]),this._remoteStream.onremovetrack=e=>{this._triggerEvent("REMOTE_TRACK_REMOVED",this._remoteStream,e.track)}),this._triggerEvent("REMOTE_TRACK_ADDED",this._remoteStream,e.track)}_handleIceCandidate(e){return E(this,null,(function*(){e.candidate&&this._signaling.ready&&(Ai.debug("Local ice candidate",{participantId:this._participantId,candidate:e.candidate}),yield this._signaling.sendCandidate(this._participantId,e.candidate))}))}_onSignalingStateChange(){var e,t;switch(Ai.debug(`DirectTransport: Signaling state changed to ${null==(e=this._pc)?void 0:e.signalingState}`,{participantId:this._participantId}),null==(t=this._pc)?void 0:t.signalingState){case"have-local-offer":let e=this._pc.localDescription;e?this._signaling.sendSdp(this._participantId,e).catch(this.close.bind(this)):this.close(new Error);break;case"have-remote-offer":this._createAnswer().then((e=>this._signaling.sendSdp(this._participantId,e))).catch(this.close.bind(this))}}_onIceConnectionStateChange(){var e,t;if("checking"===(Ai.debug(`DirectTransport: Ice Connection state changed to ${null==(e=this._pc)?void 0:e.iceConnectionState}`,{participantId:this._participantId}),null==(t=this._pc)?void 0:t.iceConnectionState)){let e=this.getState();"IDLE"===e||"OPENED"===e?this._setState("CONNECTING"):this._setState("RECONNECTING")}}_onConnectionStateChange(){var e,t,i;switch(Ai.debug(`DirectTransport: Connection state changed to ${null==(e=this._pc)?void 0:e.connectionState}`,{participantId:this._participantId}),Ne.log(ce.ICE_CONNECTION_STATE,null==(t=this._pc)?void 0:t.connectionState),null==(i=this._pc)?void 0:i.connectionState){case"connected":this._neverConnected=!1,this._setState("CONNECTED"),this._stopReconnection(),it.getPeerConnectionHostInfo(this._pc).then((e=>{null!=e&&e.local&&(Ne.log(ce.ICE_CONNECTION_TYPE,e.local.type),Ai.debug("Selected ICE candidates",e))})),this._startStatInterval();break;case"failed":case"disconnected":this._reconnectionPrevented?this.close(new Error(`Ice connection ${this._pc.connectionState}`)):(this._setState("RECONNECTING"),this._startReconnection());break;case"closed":this.close(new Error("Ice connection closed"))}}_startReconnection(){this._reconnectionTimeout||this._iceRestartTimeout||(Ai.log("Waiting for reconnection...",{participantId:this._participantId}),this._reconnectionTimeout=window.setTimeout((()=>{this._reconnectionTimeout=null,this._neverConnected?this._requestTopologySwitch():this._startIceRestart()}),_i.transportConnectionWaitTime))}_requestTopologySwitch(){this._isMaster&&this._signaling.ready&&(Ai.log("Switch topology DIRECT to SERVER",{participantId:this._participantId}),this._signaling.switchTopology("SERVER"))}_stopReconnection(){this._reconnectionTimeout&&(clearTimeout(this._reconnectionTimeout),this._reconnectionTimeout=null),this._iceRestartTimeout&&(clearTimeout(this._iceRestartTimeout),this._iceRestartTimeout=null)}_startIceRestart(){this._isMaster?(Ne.log(ce.ICE_RESTART),Ai.log("Ice restart",{participantId:this._participantId}),this._createOffer(!0).catch(this.close.bind(this))):Ai.debug("Waiting for ice restart...",{participantId:this._participantId}),this._iceRestartTimeout=window.setTimeout((()=>{this._iceRestartTimeout=null,Ai.error("Ice restart failed",{participantId:this._participantId}),Ne.log(ce.ERROR,"iceRestart-direct"),this._requestTopologySwitch()}),_i.iceRestartWaitTime)}_createOffer(e){return E(this,null,(function*(){var t,i;let n,r={iceRestart:e,offerToReceiveAudio:!0,offerToReceiveVideo:!0};Ai.debug("Create offer",{participantId:this._participantId,options:r});try{n=yield null==(t=this._pc)?void 0:t.createOffer(r),Ai.debug("Created offer",{participantId:this._participantId,offer:n}),n=Qi._patchLocalDescription(n)}catch(e){throw Ai.error("Unable to create offer",e,{participantId:this._participantId}),Ne.log(ce.ERROR,"createOffer-direct"),e}try{return Ai.debug("Set local description",{participantId:this._participantId,offer:n}),this._calcFingerprint(n.sdp),yield null==(i=this._pc)?void 0:i.setLocalDescription(n),n}catch(e){throw Ai.error("Unable to set local description",e,{participantId:this._participantId}),Ne.log(ce.ERROR,"setLocalDescription-direct"),e}}))}_createAnswer(){return E(this,null,(function*(){var e,t;let i;Ai.debug("Create answer",{participantId:this._participantId});try{i=yield null==(e=this._pc)?void 0:e.createAnswer(),Ai.debug("Created answer",{participantId:this._participantId,answer:i}),i=Qi._patchLocalDescription(i)}catch(e){throw Ai.error("Unable to create answer",e,{participantId:this._participantId}),Ne.log(ce.ERROR,"createAnswer-direct"),e}try{return Ai.debug("Set local description",{participantId:this._participantId,answer:i}),this._calcFingerprint(i.sdp),yield null==(t=this._pc)?void 0:t.setLocalDescription(i),i}catch(e){throw Ai.error("Unable to set local description",e,{participantId:this._participantId}),Ne.log(ce.ERROR,"setLocalDescription-direct"),e}}))}static _patchLocalDescription(e){let t=!!Pt.baseChromeVersion();return e.sdp=it.patchLocalSDP(e.sdp,_i.preferH264&&Pt.canPreferH264(),Pt.isBrokenH264(),_i.preferVP9,_i.h264spsPpsIdrInKeyframe,t&&_i.audioNack,_i.p2pAudioRed),e}static _patchRemoteDescription(e){return e.sdp=it.patchDirectRemoteSDP(e.sdp,!1,!1,_i.preferVP9),e}_onReplacedTrack(e){this._pc&&(this._pc.getSenders().forEach((t=>{t.track&&t.track.kind===e.kind&&t.track.contentHint===e.contentHint&&(t.track.enabled=e.enabled,t.replaceTrack(e).catch((e=>{Ai.error("DirectTransport: Unable to replace track",e,{participantId:this._participantId}),Ne.log(ce.ERROR,"replaceTrack-direct")})))})),this._applySettings())}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._isDeadConnection()?this._stopStatInterval():$t(this._pc,this._lastStat,void 0,_i.switchVideoAtBadNetwork).then((t=>{this._lastStat=t;let i={inbound:{topology:"DIRECT",transport:t.transport,rtps:t.rtps.filter((e=>"inbound-rtp"===e.type&&(e.userId=this._participantId,!0)))},outbound:{topology:"DIRECT",transport:t.transport,rtps:t.rtps.filter((e=>"outbound-rtp"===e.type))}};this._checkPPTNetwork(i),this._checkBadNetwork(i),this._triggerEvent("REMOTE_DATA_STATS",i),this._statInterval=window.setTimeout(e,_i.statisticsInterval)}))};this._statInterval=window.setTimeout(e,_i.statisticsInterval)}_checkPPTNetwork(e){if(!_i.switchVideoAtBadNetwork||!e.inbound.transport.averageNetStat)return;let{averageNetStat:t}=e.inbound.transport,i=t.currentRoundTripTime<=this._networkLimitsForVideo.good.rtt&&t.lostPercent<=this._networkLimitsForVideo.good.loss,n=t.currentRoundTripTime>=this._networkLimitsForVideo.bad.rtt||t.lostPercent>=this._networkLimitsForVideo.bad.loss,r=t.currentRoundTripTime<this._networkLimitsForVideo.bad.rtt,a=this._videoMaxDimensionsForNet.good,s="L1T1";if(n?(this._lastBadConnection=Date.now(),r?(a=this._videoMaxDimensionsForNet.bad,s="L1T2"):(a=this._videoMaxDimensionsForNet.worst,s="L1T3")):i&&(a=this._videoMaxDimensionsForNet.good,s="L1T1"),!(a<this._lastVideoMaxDimension||Date.now()-this._lastBadConnection>3e4)||this._lastVideoMaxDimension===a)return;Ai.debug("Switch outbound video frame size and scalabilityMode",{scalabilityMode:s,averageNetStat:t,nextVideoMaxDimension:a}),this._lastVideoMaxDimension=a;let o=this._serverSettings.camera;if(!o)return;let c=T(y({},this._serverSettings),{camera:T(y({},o),{scalabilityMode:s,maxDimension:this._lastVideoMaxDimension})});this.updateSettings(c)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null)}_checkBadNetwork(e){if(!this._signaling.ready)return;let t=e=>e.rtt<=this._networkLimits.goodNet.rtt&&e.loss<=this._networkLimits.goodNet.loss,i=e=>e.rtt>=this._networkLimits.badNet.rtt||e.loss>=this._networkLimits.badNet.loss,n=Math.round(1e3*e.outbound.transport.currentRoundTripTime)||0,r=e.inbound.rtps.reduce(((e,t)=>Math.max(e,t.packetLoss||0)),0),a={rtt:this._lastNetworkStat.rtt*(1-Yi)+n*Yi,loss:this._lastNetworkStat.loss*(1-Yi)+r*Yi},s=i(a),o=t(a),c=i(this._remoteNetworkStat),l=t(this._remoteNetworkStat),u=i(this._lastNetworkStat),d=t(this._lastNetworkStat),h=s||c?.2:o&&l?1:0,p=Date.now();if((u!==s||d!==o||p-this._lastNetworkStat.date>_i.networkStatisticsInterval)&&(this._lastNetworkStat.date=Date.now(),this._signaling.customData({sdk:Object.assign({type:"bad-net"},a)},null).catch((e=>{Ai.warn("Unable to send [bad-net]",e)}))),h){let e={};e[this._participantId]=e[""]=h,this._triggerEvent("NETWORK_STATUS",e)}this._lastNetworkStat.rtt=a.rtt,this._lastNetworkStat.loss=a.loss}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applySettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_calcFingerprint(e){let t=it.sdpFingerprint(e);null!==t?null===this._fingerprint?this._fingerprint=t:(Ii.onFingerprintChange((this._fingerprint^t).toString()),this._fingerprint=null):Ai.warn("Fingerprint calculation is unsupported")}_applySettings(){var e;let t=this._mediaSource.getMediaSettings().isScreenSharingEnabled?this._serverSettings.screenSharing:this._serverSettings.camera;t&&"connected"===(null==(e=this._pc)?void 0:e.connectionState)&&(this._prevConsumerSettings=it.applySettings(this._pc,t,this._prevConsumerSettings))}_createDataChannel(e,t,i){Ai.debug(`[${t}] data channel opening`);let n=e.createDataChannel(t,{negotiated:!0,id:1});n.onopen=()=>{let e=n.readyState;"open"===e?(Ai.debug(`[${t}] data channel opened`),n.onerror=e=>{Ai.error(`[${t}] data channel error`,e)},i(n)):Ai.error(`[${t}] data channel open failed, state [${e}]`)}}constructor(e,t,i,n,r){if(super(i,n),this._remoteSDP={},this._remoteCandidates={},this._lastRemoteSDP=null,this._animojiDataChannel=null,this._animojiReceiver=null,this._animojiSender=null,this._isOpen=!1,this._remotePeerId=null,this._statInterval=null,this._settingsInterval=null,this._failedOnCreate=null,this._remoteStream=null,this._iceRestartTimeout=null,this._reconnectionTimeout=null,this._reconnectionPrevented=!1,this._fingerprint=null,this._neverConnected=!0,this._prevConsumerSettings={},this._lastNetworkStat={rtt:0,loss:0,date:0},this._remoteNetworkStat={rtt:0,loss:0},this._networkLimits={badNet:{loss:3,rtt:1e3},goodNet:{loss:.5,rtt:600}},this._networkLimitsForVideo={bad:{loss:4,rtt:1e3},good:{loss:2,rtt:700}},this._videoMaxDimensionsForNet={worst:320,bad:640,good:1280},this._lastVideoMaxDimension=this._videoMaxDimensionsForNet.good,this._lastBadConnection=0,this._participantId=e,this._isMaster=t,this._serverSettings=r,this._perfStatReporter=new Gi(this,i,!0),this.subscribe(this._signaling,re.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,"TRACK_REPLACED",this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,"SOURCE_CHANGED",this._applySettings.bind(this)),this._pc=new RTCPeerConnection({iceServers:_i.iceServers,iceTransportPolicy:_i.forceRelayPolicy?"relay":"all"},{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.onicecandidate=this._handleIceCandidate.bind(this),this._pc.ontrack=this._onAddTrack.bind(this),this._pc.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this),this._pc.onconnectionstatechange=this._onConnectionStateChange.bind(this),this._pc.onsignalingstatechange=this._onSignalingStateChange.bind(this),this._prevConsumerSettings={},_i.vmoji&&this._createDataChannel(this._pc,Bi.animoji,(e=>{var t,i;this._animojiDataChannel=e,this._animojiDataChannel.binaryType="arraybuffer",null==(t=this._animojiReceiver)||t.setDataChannel(this._animojiDataChannel),null==(i=this._animojiSender)||i.setDataChannel(this._animojiDataChannel)})),this._isMaster){try{this._mediaSource.addTrackToPeerConnection(this._pc,!1,!0),this._applySettings()}catch(e){return Ne.log(ce.ERROR,"addTrack-direct"),Ai.error("Unable to add media source tracks",e,{participantId:this._participantId}),void(this._failedOnCreate=e)}this._createOffer(!1).catch((e=>{"IDLE"===this._state?this._failedOnCreate=e:this.close(e)}))}this._startSettingsInterval()}},Zi=class{static parse(e){let t=new DataView(e),i=t.getUint8(0),n=t.getUint8(1);if(0!==n)throw new Error(`Unsupported message type. Message type: ${n}`);let r=t.getUint16(2),a=t.getUint32(4),s=t.getUint32(8),o=t.getUint32(12);if(1!==i)throw new Error(`Unexpected protocol version. Got ${i}, expected 1`);return{sequence:r,ssrc:a,timestamp:s,duration:o,data:e.slice(16)}}_onDataChannelMessage(e){var t,i;let n=Zi.parse(e),r=null==(i=null==(t=this._participantIdRegistry)?void 0:t.getStreamDescription(n.ssrc))?void 0:i.participantId;if(!r)return void Ai.warn(`Participant id for ssrc ${n.ssrc} not found in registry`);let a={participantId:r,text:this._textDecoder.decode(n.data),timestamp:n.timestamp,duration:n.duration};this._asrCallback(a)}destroy(){this._datachannel.onmessage=null}constructor(e,t,i){Ai.debug("AsrReceiver started"),this._datachannel=e,this._participantIdRegistry=t,this._asrCallback=i,this._textDecoder=new TextDecoder,this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)}},Xi=class extends Hi{updateStatisticsInterval(){this._stopStatInterval();let e=this.getState();"IDLE"!==e&&"CLOSED"!==e&&"FAILED"!==e&&this._startStatInterval()}open(e=!1){this._isOpen?Ai.log("ServerTransport: Already opened connections"):(this._isOpen=!0,this._observer=e,this._openConnection())}close(e){this._isOpen&&(this._isOpen=!1,this._closeConnection(),this.unsubscribe(),e?(Ai.error("ServerTransport: Closed",e),this._setState("FAILED")):(Ai.debug("ServerTransport: Closed"),this._setState("CLOSED")))}removeParticipant(e){var t;null==(t=this._captureReceiver)||t.close(e)}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}updateSettings(e){Ui(e,this._serverSettings)||(this._serverSettings=e,this._applyConsumerSettings())}setAnimojiTransport(e,t){if(_i.vmoji&&(this._animojiReceiver=e,this._animojiSender=t,this._participantIdRegistry&&e.setParticipantIdRegistry(this._participantIdRegistry),this._animojiDataChannel))return e.setDataChannel(this._animojiDataChannel),void t.setDataChannel(this._animojiDataChannel)}_createPerfStatsReporter(){var e;null==(e=this._perfStatReporter)||e.destroy(),this._perfStatReporter=new Gi(this,this._signaling)}_closeConnection(){this._stopStatInterval(),this._stopSettingsInterval(),this._removeAsrTrack(),this._removeCaptureSender(),this._removeCaptureReceiver(),this._pc&&(this._rtpReceiversByStreamId={},this._disabledSenders.forEach((e=>{var t;return null==(t=e.track)?void 0:t.stop()})),this._disabledSenders.clear(),this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._participantIdRegistry=null,Xi._closeDataChannel(this._producerNotification),Xi._closeDataChannel(this._producerCommand),Xi._closeDataChannel(this._producerScreen),Xi._closeDataChannel(this._consumerScreen),Xi._closeDataChannel(this._asr),Xi._closeDataChannel(this._animojiDataChannel),this._pc.close(),this._pc=null,this._producerOfferIsProcessing=!1,this._producerNextOffer=null),this._triggerEvent("PEER_CONNECTION_CLOSED")}static _closeDataChannel(e){e&&(e.onopen=null,e.onmessage=null,e.onerror=null,e.close())}_createDataChannel(e,t,i){Ai.debug(`[${t}] data channel opening`);let n=e.createDataChannel(t,{ordered:!0});n.onopen=()=>{let e=n.readyState;"open"===e?(Ai.debug(`[${t}] data channel opened`),i(n)):Ai.error(`[${t}] data channel open failed, state [${e}]`)},n.onerror=e=>{let i=e.error;Ai.error(`[${t}] data channel error`,null==i?void 0:i.errorDetail,null==i?void 0:i.message)}}_openConnection(e=!1){Ai.debug("ServerTransport: Open single connection"),this._pc=new RTCPeerConnection({},{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.ontrack=this._onAddTrack.bind(this,this._pc),this._pc.onconnectionstatechange=it.throttle((e=>{this._pc&&this._onConnectionStateChange(this._pc,e)}),500),this._pc.onsignalingstatechange=Xi._onSignalingStateChange.bind(this,this._pc),this._participantIdRegistry=new class{getStreamDescription(e){return this.streamDescriptionByCompactId.get(e)}getCompactId(e){return this.compactIdByStreamDescription.get(e)}handleMessage(e){var t,i;let n=new Uint8Array(e),r=n[0],a=n.subarray(1);switch(r){case 1:let e=(0,d.decode)(a);return Object.entries(e).forEach((([e,t])=>{let i=Mi(e);this.streamDescriptionByCompactId.set(t,i),this.compactIdByStreamDescription.set(e,t)})),null;case 2:case 4:let n=(0,d.decode)(a),s=[];for(let e of n){let t=this.getStreamDescription(e);t&&s.push(t.participantId)}return 2===r?{type:"notification",notification:se.AUDIO_ACTIVITY,activeParticipants:s}:{type:"notification",notification:se.STALLED_ACTIVITY,stalledParticipants:s};case 3:let o=(0,d.decode)(a);return{type:"notification",notification:se.SPEAKER_CHANGED,speaker:null==(t=this.getStreamDescription(o))?void 0:t.participantId};case 5:let c=(0,d.decode)(a);return{type:"notification",notification:se.VIDEO_QUALITY_UPDATE,quality:{maxBitrate:c[0],maxDimension:c[1]}};case 6:let l=(0,d.decode)(a),u={};for(let[e,t]of Object.entries(l)){let n=null==(i=this.getStreamDescription(Number(e)))?void 0:i.participantId;n&&(u[n]=t/100)}return{type:"notification",notification:se.NETWORK_STATUS,statuses:u};case 7:return this._createParticipantSourcesUpdateNotification(a);case 8:{let e=(0,d.decode)(a).map((e=>{var t;let[i,n,r,a,s,o,c]=e;return{participantId:null==(t=this.getStreamDescription(i))?void 0:t.participantId,gain:n,pause:r,offset:a,mute:s,liveStatus:o,startTimeMs:c}}));return{type:"notification",notification:se.MOVIE_UPDATE_NOTIFICATION,data:e}}default:return Ai.debug("unsupported message type: "+r),null}}_createParticipantSourcesUpdateNotification(e){let t=(0,d.decode)(e),i=[];for(let[e,n]of Object.entries(t)){let t,r=n[0],a=n[1],s=n[2],o=!!n[3],c=!!n[4];if(null!==r){if(t=this.getStreamDescription(r),!t){Ai.error(`could not uncompress participant ID ${r}`);continue}}else t=null;if(null===s){Ai.error("unexpected null sequenceNumber",e,n);continue}let l=ue.PARTICIPANT_AGNOSTIC_TRACK_PREFIX+"-"+e,u=a?a>>>0:null;i.push({participantStreamDescription:t,streamId:l,rtpTimestamp:u,sequenceNumber:s,fastScreenShare:o,suspend:c})}return{type:"notification",notification:se.PARTICIPANT_SOURCES_UPDATE,participantUpdateInfos:i}}constructor(){this.streamDescriptionByCompactId=new Map,this.compactIdByStreamDescription=new Map}},this._signaling.setParticipantIdRegistry(this._participantIdRegistry),_i.producerNotificationDataChannel&&this._createDataChannel(this._pc,Bi.producerNotification,(e=>{this._producerNotification=e,this._producerNotification.binaryType="arraybuffer",this._signaling.setProducerNotificationDataChannel(e)})),_i.producerCommandDataChannel&&(this._signaling.useCommandDataChannel(!0),this._createDataChannel(this._pc,Bi.producerCommand,(e=>{this._producerCommand=e,this._signaling.setProducerCommandDataChannel(e)}))),_i.producerScreenDataChannel&&this._createDataChannel(this._pc,Bi.producerScreenShare,(e=>{this._producerScreen=e,this._producerScreen.binaryType="arraybuffer",this._createCaptureReceiver()})),_i.asrDataChannel&&this._createDataChannel(this._pc,Bi.asr,(e=>{this._asr=e,this._asr.binaryType="arraybuffer",this._removeAsrTrack(),this._asrTrack=new Zi(e,this._participantIdRegistry,(e=>{this._onAsrTranscription(e)}))})),_i.vmoji&&this._createDataChannel(this._pc,Bi.animoji,(e=>{var t,i,n;this._animojiDataChannel=e,this._animojiDataChannel.binaryType="arraybuffer",null==(t=this._animojiReceiver)||t.setDataChannel(e),null==(i=this._animojiReceiver)||i.setParticipantIdRegistry(this._participantIdRegistry),null==(n=this._animojiSender)||n.setDataChannel(e)})),this._newAudioShareTrack=this._mediaSource.getAudioShareTrack();try{this._mediaSource.addTrackToPeerConnection(this._pc,this._observer,!1),this._prevConsumerSettings={},this._applyConsumerSettings()}catch(e){return Ai.error("ServerTransport: Unable to add media source tracks",e),Ne.log(ce.ERROR,"addTrack-single"),void this.close(e)}_i.consumerScreenDataChannel&&this._createDataChannel(this._pc,Bi.consumerScreenShare,(e=>{this._consumerScreen=e,this._consumerScreen.binaryType="arraybuffer";let t=this._mediaSource.getScreenTrack();t&&this._createCaptureSender(t)})),e||this._allocateConsumer(),this._setState("OPENED"),this._startStatInterval(),this._startSettingsInterval()}_removeAsrTrack(){var e;null==(e=this._asrTrack)||e.destroy(),this._asrTrack=null}_reconnect(){"OPENED"!==this.getState()&&(this._setState("RECONNECTING"),this._closeConnection(),this._openConnection(!0))}_signalActiveParticipants(e){this._triggerEvent("SIGNALLED_ACTIVE_PARTICIPANTS",e)}_signalStalledParticipants(e){this._triggerEvent("SIGNALLED_STALLED_PARTICIPANTS",e)}_signalSpeakerChanged(e){this._triggerEvent("SIGNALLED_SPEAKER_CHANGED",e)}_signalNetworkStatus(e){this._triggerEvent("NETWORK_STATUS",e)}_updateSSRCMap(e){e&&e.sdp.split("\n").forEach((e=>{let t=`a=ssrc:([0-9]+) label:(audio|video)-((?:[ug]?[\\d]+)|(?:mix)|(?:${ue.PARTICIPANT_AGNOSTIC_TRACK_PREFIX}-[0-9]+))`,i=new RegExp(t).exec(e);i&&(this._ssrcMap[i[1]]=i[3],this._ssrcMapUpdated=!0)}))}_createCaptureSender(e){let t=this._mediaSource.getMediaSettings();!e||!_i.consumerScreenDataChannel||!this._consumerScreen||!t.isScreenSharingEnabled||(this._captureSender&&this._removeCaptureSender(),this._captureSender=new di(e,this._consumerScreen,this._signaling,t.isFastScreenSharingEnabled))}_removeCaptureSender(){var e;null==(e=this._captureSender)||e.destroy(),this._captureSender=null}_createCaptureReceiver(){!_i.producerScreenDataChannel||!this._producerScreen||(this._captureReceiver&&this._removeCaptureReceiver(),this._captureReceiver=new ii(this._producerScreen,this._participantIdRegistry,((e,t)=>{this._triggerEvent("REMOTE_STREAM_SECOND",e,t)}),(e=>{this._triggerEvent("REMOTE_STREAM_SECOND",e,null)}),(e=>{this._triggerEvent("SCREEN_SHARING_STAT",e)})))}_removeCaptureReceiver(){var e;null==(e=this._captureReceiver)||e.destroy(),this._captureReceiver=null}_applyConsumerSettings(){let e=this._mediaSource.getMediaSettings().isScreenSharingEnabled&&!_i.consumerScreenDataChannel?this._serverSettings.screenSharing:this._serverSettings.camera;if(e&&this._pc){let t=[];this._pc.getSenders().forEach((i=>{if(!i.track||"video"!==i.track.kind)return;let n=!this._disabledSenders.has(i),r=0!==e.maxDimension;if(n&&!r)return Ai.log("Disabling video upload"),this._disabledSenders.add(i),void i.replaceTrack(Pt.getBlackMediaTrack()).catch((e=>{Ai.error("Could not disable video upload",e)}));let a=this._mediaSource.getSendVideoTrack();if(!n&&r&&a){Ai.log("Enabling video upload"),this._disabledSenders.delete(i);let e=i.track;e.enabled=a.enabled,i.replaceTrack(a).then((()=>e.stop())).catch((e=>{Ai.error("Could not enable video upload",e)}))}it.applyVideoTrackSettings(e,i,null!=a?a:i.track,this._prevConsumerSettings,t)})),this._prevConsumerSettings=t}}_onScreenSharingStatus(e){e.track?this._createCaptureSender(e.track):this._removeCaptureSender()}_setState(e){this._state!==e&&(this._state=e,this._triggerEvent("STATE_CHANGED",e))}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._pc?(this._collectStat().then((e=>{this._reportStats(e),this._detectStaleTracks(e)})).catch((()=>{})),this._statInterval=window.setTimeout(e,_i.statisticsInterval)):this._stopStatInterval()};this._statInterval=window.setTimeout(e,_i.statisticsInterval)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null),this._statBytes={}}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applyConsumerSettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_collectStat(){return E(this,null,(function*(){if(!this._pc)return Promise.reject();this._ssrcMapUpdated&&(this._lastStat=null,this._ssrcMapUpdated=!1,this._createPerfStatsReporter());let e=yield $t(this._pc,this._lastStat,this._ssrcMap);return this._lastStat=e,e}))}_reportStats(e){this._triggerEvent("REMOTE_DATA_STATS",{inbound:{topology:"SERVER",transport:e.transport,rtps:e.rtps.filter((e=>"inbound-rtp"===e.type))},outbound:{topology:"SERVER",transport:e.transport,rtps:e.rtps.filter((e=>"outbound-rtp"===e.type))}})}_detectStaleTracks(e){let t=e.rtps.find((e=>"inbound-rtp"===e.type&&"audio"===e.kind&&"mix"===this._ssrcMap[e.ssrc]));if(!t)return;let i=ue.AUDIO_MIX,n=this._statBytes[i],r=!1;if(n){let e=t.bytesReceived-n.bytesReceived;e>=0&&e<=5&&(r=!0),n.stalled!==r&&this._triggerEvent("AUDIO_MIX_STALL",r)}this._statBytes[i]={bytesReceived:t.bytesReceived,stalled:r}}_allocateConsumer(){if(!this._signaling.ready)return;let e={estimatedPerformanceIndex:Gi.getEstimatedPerformanceIndex(),audioMix:!0,consumerUpdate:!0,producerNotificationDataChannelVersion:_i.producerNotificationDataChannel?7:0,producerCommandDataChannelVersion:_i.producerCommandDataChannel?3:0,consumerScreenDataChannelVersion:_i.consumerScreenDataChannel?1:0,producerScreenDataChannelVersion:_i.producerScreenDataChannel?1:0,asrDataChannelVersion:_i.asrDataChannel?1:0,animojiDataChannelVersion:_i.vmoji?1:0,animojiBackendRender:!_i.vmojiRenderingOptions.useFullClientRendering,onDemandTracks:!0,unifiedPlan:!0,singleSession:!0,videoTracksCount:_i.videoTracksCount,red:_i.serverAudioRed,audioShare:_i.audioShare,fastScreenShare:_i.fastScreenShare,videoSuspend:_i.videoSuspend};!_i.videoTracksCount&&!this._observer&&Ai.warn("Setting videoTracksCount to 0 is deprecated"),this._signaling.allocateConsumer(null,e)}_processOffer(e){return E(this,null,(function*(){if(!this._pc)throw new Error("Interrupt allocation");try{yield this._pc.setRemoteDescription(e)}catch(e){throw Ai.error("[single] unable to set remote offer",e),Ne.log(ce.ERROR,"setRemoteDescription-single"),e}let t;try{if(yield this._handleTracks(),Ai.debug("[single] create local answer"),!this._pc)throw new Error("Interrupt allocation");t=yield this._pc.createAnswer()}catch(e){throw Ai.error("[single] unable to create answer",e),Ne.log(ce.ERROR,"createAnswer-single"),e}try{if(!this._pc)throw new Error("Interrupt allocation");t.sdp=it.patchLocalSDP(t.sdp,!1,Pt.isBrokenH264(),!1,_i.h264spsPpsIdrInKeyframe),Ai.debug("[single] set local answer",{answer:t}),yield this._pc.setLocalDescription(t)}catch(e){throw Ai.error("[single] unable to set local answer",e),Ne.log(ce.ERROR,"setLocalDescription-single"),e}try{Ai.debug("[single] transmit local answer",{answer:t}),this._updateSSRCMap(e),yield this._signaling.acceptProducer(t,Object.keys(this._ssrcMap)),Ai.debug("[single] remote offer has been processed")}catch(e){Ai.warn("[single] unable to send local answer",e),Ne.log(ce.ERROR,"acceptProducer")}}))}_acceptProducer(e){return E(this,null,(function*(){if(this._producerOfferIsProcessing)return this._producerNextOffer=e,void Ai.debug("[single] wait until other remote offer is processed");this._producerOfferIsProcessing=!0;let t={type:"offer",sdp:it.patchRemoteSDP(e)};if(Ai.debug("[single] set remote offer",{offer:t}),!this._pc)throw new Error("Interrupt allocation");try{if(yield this._processOffer(t),this._producerOfferIsProcessing=!1,this._producerNextOffer){Ai.debug("[single] there is other unprocessed remote offer, process it");let e=this._producerNextOffer;this._producerNextOffer=null,yield this._acceptProducer(e)}}catch(e){this.close(e)}}))}_handleTracks(){return E(this,null,(function*(){var e;if(!this._newAudioShareTrack||this._observer)return;let t=null==(e=this._pc)?void 0:e.getTransceivers().find((e=>{var t;return null==(t=e.mid)?void 0:t.endsWith("s")}));if(t&&t.sender){null!==t.sender.track&&Ai.warn("Unexpected track assigned to audioshare");try{t.direction="sendonly",yield t.sender.replaceTrack(this._newAudioShareTrack),this._newAudioShareTrack=null}catch(e){Ai.error("ServerTransport: Unable to replace track",e),Ne.log(ce.ERROR,"replaceTrack-single")}}else Ai.warn("Cannot find audioshare transceiver")}))}_onSignalingNotification(e){return E(this,null,(function*(){if(this._isOpen)switch(e.notification){case se.PRODUCER_UPDATED:yield this._onProducerUpdated(e);break;case se.REALLOC_CON:this._reconnect();break;case se.AUDIO_ACTIVITY:this._signalActiveParticipants(e.activeParticipants);break;case se.SPEAKER_CHANGED:this._signalSpeakerChanged(e.speaker);break;case se.STALLED_ACTIVITY:this._signalStalledParticipants(e.stalledParticipants);break;case se.NETWORK_STATUS:this._signalNetworkStatus(e.statuses)}}))}_onAsrTranscription(e){this._triggerEvent("ASR_TRANSCRIPTION",e)}_onProducerUpdated(e){return E(this,null,(function*(){this._producerSessionId&&this._producerSessionId!==e.sessionId&&this._reconnect(),_i.breakVideoPayloadTypes&&(Ai.log("test mode enabled, video switched off"),this._signaling.requestTestMode("breakVideoPayloadTypes",null)),this._producerSessionId=e.sessionId,yield this._acceptProducer(e.description)}))}_onAddTrack(e,t){Ai.debug("[single] remote track (added)",{track:t.track});let i=t.streams[0];i?(i.onremovetrack||(i.onremovetrack=e=>{this._triggerEvent("REMOTE_TRACK_REMOVED",i.id,i,e.track)}),i.getTracks().find((e=>e.id===t.track.id))||i.addTrack(t.track),this._rtpReceiversByStreamId[i.id]=t.receiver,this._triggerEvent("REMOTE_TRACK_ADDED",i.id,i,t.track)):Ai.error("[single] unable to get media stream from track event")}static _onSignalingStateChange(e,t){Ai.debug("[single] signaling state changed",{state:e.signalingState},t)}_onConnectionStateChange(e,t){switch(Ai.debug("[single] connection state changed",{state:e.connectionState},t),Ne.log(ce.ICE_CONNECTION_STATE,e.connectionState),e.connectionState){case"failed":this._reconnectionPrevented?this.close(new Error("Ice connection failed")):(Ne.logCustom(ce.RECONNECT,{param:1}),this._reconnect());break;case"connecting":let t=this.getState();"IDLE"===t||"OPENED"===t?this._setState("CONNECTING"):"checking"===e.iceConnectionState&&this._setState("RECONNECTING");break;case"disconnected":this._reconnectionPrevented?this.close(new Error("Ice connection disconnected")):this._setState("RECONNECTING");break;case"connected":this._setState("CONNECTED"),it.getPeerConnectionHostInfo(e).then((e=>{null!=e&&e.local&&(Ne.log(ce.ICE_CONNECTION_TYPE,e.local.type),Ai.debug("Selected ICE candidates",e))})),Ne.logCustom(ce.RECONNECT,{param:0})}}_onReplacedTrack(e,t){var i;if(this._pc){_i.consumerScreenDataChannel&&t&&(e=t);let n=null==(i=this._pc)?void 0:i.getSenders().find((t=>t.track&&t.track.kind===e.kind&&!this._disabledSenders.has(t)&&t.track.contentHint===e.contentHint));null!=n&&n.track?(n.track.enabled=e.enabled,n.replaceTrack(e).catch((e=>{Ai.error("ServerTransport: Unable to replace track",e),Ne.log(ce.ERROR,"replaceTrack-single")}))):"audio"===e.kind&&"music"===e.contentHint&&(this._newAudioShareTrack=e)}this._applyConsumerSettings()}getStreamWaitingTimeMs(e,t){if(!this._pc)return Ne.log(ce.PAT_WAITING_TIME_ERROR,"noConnection"),Ai.error("Cannot get stream waiting time, peer connection is not initialized"),0;if(!RTCRtpReceiver.prototype.getSynchronizationSources)return Ne.log(ce.PAT_WAITING_TIME_ERROR,"oldBrowser"),Ai.error("Cannot get stream waiting time, RTCRtpReceiver.getSynchronizationSources is not supported"),0;let i=this._rtpReceiversByStreamId[e];if(!i)return Ne.log(ce.PAT_WAITING_TIME_ERROR,"noReceiver"),Ai.error(`Cannot get stream waiting time, cannot find RTP receiver by stream ID: ${e}`),0;let n=i.getSynchronizationSources();if(!n||!n.length)return Ai.log(`Cannot get stream waiting time, ${e} receiver has no synchronization sources`),0;let r=n[0].rtpTimestamp;if(!Number.isInteger(r))return Ne.log(ce.PAT_WAITING_TIME_ERROR,"timestampNotInteger"),Ai.error(`Cannot get stream waiting time, ${e} receiver's RTP timestamp is not an integer: ${r}`),0;let a=t-r&4294967295,s=Math.ceil(a/90);return Math.min(100,Math.max(0,s))}constructor(e,t,i){super(e,t),this._producerNotification=null,this._producerCommand=null,this._producerScreen=null,this._consumerScreen=null,this._asr=null,this._animojiDataChannel=null,this._animojiReceiver=null,this._animojiSender=null,this._isOpen=!1,this._observer=!1,this._reconnectionPrevented=!1,this._statInterval=null,this._settingsInterval=null,this._statBytes={},this._ssrcMap={},this._ssrcMapUpdated=!1,this._producerOfferIsProcessing=!1,this._producerNextOffer=null,this._lastStat=null,this._prevConsumerSettings={},this._asrTrack=null,this._captureSender=null,this._captureReceiver=null,this._participantIdRegistry=null,this._disabledSenders=new Set,this._rtpReceiversByStreamId={},this._producerSessionId="",this._newAudioShareTrack=null,this.subscribe(this._signaling,re.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,"TRACK_REPLACED",this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,"SOURCE_CHANGED",this._applyConsumerSettings.bind(this)),this.subscribe(this._mediaSource,"SCREEN_STATUS",this._onScreenSharingStatus.bind(this)),this._createPerfStatsReporter(),this._serverSettings=i,Ai.debug("ServerTransport: Created")}},en=(e=>(e.DIRECT="DIRECT",e.SERVER="SERVER",e))(en||{}),tn=class extends b{updateSettings(e){Ai.log("Update transport settings",e),this._serverSettings=e,this._directTransport&&this._directTransport.updateSettings(e),this._serverTransport&&this._serverTransport.updateSettings(e)}updateStatisticsInterval(){this._directTransport&&this._directTransport.updateStatisticsInterval(),this._serverTransport&&this._serverTransport.updateStatisticsInterval()}allocate(e,t=!1){Ai.log(`Trying allocate participant [${e}]`),-1===this._allocated.indexOf(e)?(this._allocated.push(e),"DIRECT"===this._topology&&!this._directTransport&&(this._directTransport=this._createDirectTransport(e,t)),"SERVER"===this._topology&&!this._serverTransport&&(this._serverTransport=this._createServerTransport())):Ai.warn(`The participant [${e}] has already had allocated transport`)}open(e,t=null,i=!1,n=!1){Ai.log("Trying open participant",{participantIds:e});let r=n;for(let t of e)-1===this._opened.indexOf(t)?-1!==this._allocated.indexOf(t)?(this._opened.push(t),r=!0):Ai.warn(`The participant [${t}] has no allocated transport`):Ai.warn(`The participant [${t}] has already had opened transport`);r&&("DIRECT"===this._topology&&this._directTransport&&this._directTransport.open(t),"SERVER"===this._topology&&this._serverTransport&&(this._serverTransport.open(i),this._setStates(e,this._serverTransport.getState()),this._setLocalState(this._serverTransport.getState())),Ai.debug("The transport has been opened",e))}close(e){var t;let i=this._allocated.indexOf(e),n=this._opened.indexOf(e);i<0&&Ai.warn(`The participant [${e}] transport has already deallocated`),"DIRECT"===this._topology&&this._directTransport&&this._releaseDirectTransport(),"SERVER"===this._topology&&(null==(t=this._serverTransport)||t.removeParticipant(e),this._setStates([e],"CLOSED")),n>=0&&this._opened.splice(n,1),i>=0&&this._allocated.splice(i,1),delete this._states[e]}destroy(){var e,t;this.unsubscribe();for(let e of this._dtListeners)e.dispose();for(let e of this._stListeners)e.dispose();this._removeAnimojiTransport(),null==(e=this._directTransport)||e.close(),this._directTransport=null,null==(t=this._serverTransport)||t.close(),this._serverTransport=null,this._allocated=[],this._opened=[]}getTopology(){return this._topology}isAllocated(e){return this._allocated.indexOf(e)>=0}allocated(){return this._allocated.slice()}opened(){return this._opened.slice()}getState(){var e,t;return"SERVER"===this._topology?null==(e=this._serverTransport)?void 0:e.getState():null==(t=this._directTransport)?void 0:t.getState()}getStates(){return this._states}setAnimojiSvg(e,t){var i,n;_i.vmoji&&t.isMe&&(null==(i=_i.vmoji.AnimojiPreviewGenerator)||i.setSvgData(t)),(!(t.svg instanceof ArrayBuffer)||0!==t.svg.byteLength)&&(null==(n=this._animojiReceiver)||n.setParticipantSvg(e,t))}_setStates(e,t){let i=e.filter((e=>this._states[e]!==t&&(this._states[e]=t,!0)));i.length&&this._triggerEvent("STATE_CHANGED",i,t)}_setLocalState(e){this._localState!==e&&(this._localState=e,this._triggerEvent("LOCAL_STATE_CHANGED",e))}_onSignalingNotification(e){if(e.notification===se.TOPOLOGY_CHANGED)return this._onTopologyChanged(e)}_onTopologyChanged(e){var t;if(e.topology!==this._topology){if(Ai.log(`Topology changed ${this._topology} -> ${e.topology}`),Ne.log(ce.TOPOLOGY_CHANGE_REQUESTED,e.topology),this._topology=e.topology,"SERVER"===this._topology&&(this._serverTransport?this._serverTransport.allowRestart():(this._serverTransport=this._createServerTransport(),this._opened.length>0&&(null==(t=this._directTransport)||t.preventRestart(),this._serverTransport.open()))),"DIRECT"===this._topology){let t=e.offerTo||[],i=e.offerToTypes||[],n=e.offerToDeviceIdxs||[],r=t.length&&i.length?it.composeParticipantId(t[0],i[0],n[0]):null;if(this._serverTransport&&this._serverTransport.preventRestart(),!this._allocated||0===this._allocated.length)return void Ai.error("Topology changed to DIRECT, but the list of allocated participants is empty");this._allocated.length>1&&Ai.warn("Topology changed to DIRECT, but the allocated participants count more then one");let a=this._allocated[0];if(this._directTransport)this._directTransport.allowRestart();else{let e=r===a;this._directTransport=this._createDirectTransport(a,e)}this._opened.indexOf(a)>=0&&this._directTransport.open()}this._triggerEvent("TOPOLOGY_CHANGED",this._topology)}}_createDirectTransport(e,t=!1){let i=new Qi(e,t,this._signaling,this._mediaSource,this._serverSettings);return this._dtListeners.length>0&&Ai.warn(`The list of direct listeners for the participant [${e}] is not empty`),this._dtListeners=[],this._dtListeners.push(i.addEventListener("REMOTE_TRACK_ADDED",this._onDirectRemoteTrackAdded.bind(this,e)),i.addEventListener("REMOTE_TRACK_REMOVED",this._onDirectRemoteTrackRemoved.bind(this,e)),i.addEventListener("REMOTE_DATA_STATS",this._onDirectRemoteDataStats.bind(this)),i.addEventListener("STATE_CHANGED",this._onDirectTransportChanged.bind(this)),i.addEventListener("NETWORK_STATUS",this._onTransportNetworkStatus.bind(this)),i.addEventListener("PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this,"DIRECT"))),this._animojiReceiver&&this._animojiSender&&i.setAnimojiTransport(this._animojiReceiver,this._animojiSender),i}_createServerTransport(){let e=new Xi(this._signaling,this._mediaSource,this._serverSettings);return this._stListeners.length>0&&Ai.warn("The list of server transport listeners is not empty"),this._stListeners=[],this._stListeners.push(e.addEventListener("REMOTE_TRACK_ADDED",this._onServerRemoteTrackAdded.bind(this)),e.addEventListener("REMOTE_TRACK_REMOVED",this._onServerRemoteTrackRemoved.bind(this)),e.addEventListener("AUDIO_MIX_STALL",this._onServerAudioMixStall.bind(this)),e.addEventListener("REMOTE_DATA_STATS",this._onServerRemoteDataStats.bind(this)),e.addEventListener("STATE_CHANGED",this._onServerTransportChanged.bind(this)),e.addEventListener("SIGNALLED_ACTIVE_PARTICIPANTS",this._onTransportActiveParticipants.bind(this)),e.addEventListener("SIGNALLED_SPEAKER_CHANGED",this._onTransportSpeakerChanged.bind(this)),e.addEventListener("SIGNALLED_STALLED_PARTICIPANTS",this._onTransportStalledParticipants.bind(this)),e.addEventListener("NETWORK_STATUS",this._onTransportNetworkStatus.bind(this)),e.addEventListener("REMOTE_STREAM_SECOND",this._onRemoteStreamSecond.bind(this)),e.addEventListener("PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this,"SERVER")),e.addEventListener("ASR_TRANSCRIPTION",this._onAsrTranscription.bind(this))),this._animojiReceiver&&this._animojiSender&&e.setAnimojiTransport(this._animojiReceiver,this._animojiSender),e}_releaseDirectTransport(){var e;null==(e=this._directTransport)||e.close(),this._directTransport=null;for(let e of this._dtListeners)e.dispose();this._dtListeners=[]}_releaseServerTransport(){var e;null==(e=this._serverTransport)||e.close(),this._serverTransport=null;for(let e of this._stListeners)e.dispose();this._stListeners=[]}_setLocalNoiseSuppression(e){var t;_i.noiseSuppression!==e&&(_i.noiseSuppression=e,null==(t=this._mediaSource)||t.updateNoiseSuppression())}_onDirectTransportChanged(e){var t;let i=null==(t=this._directTransport)?void 0:t.participantId;if("CONNECTED"===e&&"DIRECT"===this._topology&&this._releaseServerTransport(),("CLOSED"===e||"FAILED"===e)&&(this._releaseDirectTransport(),"DIRECT"===this._topology)){let e=this._opened.indexOf(i);e>=0&&this._opened.splice(e,1);let t=this._allocated.indexOf(i);t>=0&&this._allocated.splice(t,1)}"DIRECT"===this._topology&&i&&(this._setStates([i],e),this._setLocalState(e))}_onServerTransportChanged(e){let t=this._opened.slice();"CONNECTED"===e&&"SERVER"===this._topology&&this._releaseDirectTransport(),("CLOSED"===e||"FAILED"===e)&&(this._releaseServerTransport(),"SERVER"===this._topology&&(this._allocated=[],this._opened=[])),"SERVER"===this._topology&&(this._setStates(t,e),this._setLocalState(e))}_onTransportActiveParticipants(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_ACTIVE_PARTICIPANTS",e)}_onTransportStalledParticipants(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_STALLED_PARTICIPANTS",e)}_onTransportSpeakerChanged(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_SPEAKER_CHANGED",e)}_onTransportNetworkStatus(e){this._triggerEvent("NETWORK_STATUS",e)}_onRemoteStreamSecond(e,t){this._triggerEvent("REMOTE_STREAM_SECOND",e,t)}_onPeerConnectionClosed(e){this._triggerEvent("PEER_CONNECTION_CLOSED",e)}_onServerAudioMixStall(e){"SERVER"===this._topology&&this._triggerEvent("AUDIO_MIX_STALL",e)}_onServerRemoteDataStats(e){this._triggerEvent("REMOTE_DATA_STATS",e)}_onDirectRemoteTrackAdded(e,t,i){this._triggerEvent("REMOTE_TRACK_ADDED",e,t,i)}_onDirectRemoteTrackRemoved(e,t,i){this._triggerEvent("REMOTE_TRACK_REMOVED",e,t,i)}_onDirectRemoteDataStats(e){this._triggerEvent("REMOTE_DATA_STATS",e)}_onServerRemoteTrackAdded(e,t,i){this._triggerEvent("REMOTE_TRACK_ADDED",e,t,i)}_onServerRemoteTrackRemoved(e,t,i){this._triggerEvent("REMOTE_TRACK_REMOVED",e,t,i)}_onAsrTranscription(e){this._triggerEvent("ASR_TRANSCRIPTION",e)}_onSourceChanged(){var e;let t=this._mediaSource.getStream();t&&(null==(e=this._animojiSender)||e.setStream(t))}_onAnimojiStream(e,t){this._triggerEvent("ANIMOJI_STREAM",e,t)}_onAnimojiStatus(e){var t,i;e?null==(t=this._animojiSender)||t.resume():null==(i=this._animojiSender)||i.pause(),this._mediaSource.onAnimojiSender(e)}_createAnimojiTransport(){if(!_i.vmoji)return;this._animojiReceiver=new _i.vmoji.AnimojiReceiver(((e,t)=>this._onAnimojiStream(e,t)),(e=>this._onAnimojiStream(e,null)),_i.vmojiRenderingOptions);let e=this._mediaSource.getStream();this._animojiSender=new _i.vmoji.AnimojiSender(e,this._mediaSource.isAnimojiRequested),this._animojiSender.onLocalData=e=>{var t;return null==(t=this._animojiReceiver)?void 0:t.receive(e)}}_removeAnimojiTransport(){var e,t;null==(e=this._animojiSender)||e.destroy(),this._animojiSender=null,null==(t=this._animojiReceiver)||t.destroy(),this._animojiReceiver=null}getStreamWaitingTimeMs(e,t){return"SERVER"!==this._topology?(Ne.log(ce.PAT_WAITING_TIME_ERROR,"wrongTopology"),Ai.error(`Cannot get stream waiting time, incorrect topology: ${this._topology}`),0):this._serverTransport?this._serverTransport.getStreamWaitingTimeMs(e,t):(Ne.log(ce.PAT_WAITING_TIME_ERROR,"noTransport"),Ai.error("Cannot get stream waiting time, server transport is not initialized"),0)}constructor(e,t,i,n){super(),this._allocated=[],this._opened=[],this._directTransport=null,this._serverTransport=null,this._dtListeners=[],this._stListeners=[],this._states={},this._localState="IDLE",this._animojiReceiver=null,this._animojiSender=null,this._signaling=t,this._mediaSource=i,this._topology=e,this._serverSettings=n,this.subscribe(this._signaling,re.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,"ANIMOJI_STATUS",this._onAnimojiStatus.bind(this)),this.subscribe(this._mediaSource,"SOURCE_CHANGED",this._onSourceChanged.bind(this)),this._createAnimojiTransport(),"SERVER"===e&&(this._serverTransport=this._createServerTransport())}},nn=class{measureSignalingConnection(e){let t=ce.FIRST_MEDIA_RECEIVED;if(!e)return void Bt(t);let i=Wt(t);null===i||"SERVER"!==e.conversation.topology||qt.logEventualStat({name:t,value:i,call_type:"server_join_server"})}markAcceptCall(e){nn._callType="DIRECT"===e?"direct_incoming":"server_incoming",this._isCallMarked=!0,Bt(ce.FIRST_MEDIA_RECEIVED)}markAcceptedCall(e){this._isCallMarked||"SERVER"===e||(nn._callType="direct_outgoing",this._isCallMarked=!0,Bt(ce.FIRST_MEDIA_RECEIVED))}markParticipantJoined(e){this._isCallMarked||"DIRECT"!==e||(nn._callType="server_change_topology",this._isCallMarked=!0,Bt(ce.FIRST_MEDIA_RECEIVED))}static measure(){let e={name:ce.FIRST_MEDIA_RECEIVED};nn._callType&&(e.call_type=nn._callType,nn._callType=null),qt.logEventualStat(e)}constructor(){this._isCallMarked=!1}},rn=nn;rn._callType=null;var an=class extends b{onRemoteDataStats(e,t){this._calcMemory(),e.inbound.rtps.map((e=>{let i="string"==typeof e.userId&&t[e.userId]||null;e.userId=null==i?void 0:i.externalId})),Ii.onStatistics(e,this._lastMemoryStat)}_calcMemory(){var e;let t=null==(e=null==window?void 0:window.performance)?void 0:e.memory;if(!t||!t.usedJSHeapSize||!t.jsHeapSizeLimit)return;let i=Number((100*t.usedJSHeapSize/t.jsHeapSizeLimit).toFixed(2)),n=Number((t.usedJSHeapSize/1024/1024).toFixed(1));i>90?Ai.warn(`High memory usage: ${i}% (${n} MiB)`):(!this._lastMemoryStat.percent||Math.abs(i-this._lastMemoryStat.percent)>=3)&&(Ai.debug(`Memory usage: ${i}% (${n} MiB)`),this._lastMemoryStat.percent=i,this._lastMemoryStat.bytes=t.usedJSHeapSize)}constructor(){super(...arguments),this._lastMemoryStat={percent:0,bytes:0}}},sn=class{get stream(){return this._stream}get trackId(){return this._trackId}_getBins(){if(!this._fftBins||!this._analyser)return new Uint8Array;this._analyser.getByteFrequencyData(this._fftBins);let e=44100/this._fftBins.length,t=Math.ceil(_i.voiceParams.minFreq/e),i=Math.floor(_i.voiceParams.maxFreq/e);return this._fftBins.subarray(t,i)}getLevel(){let e=this._getBins(),t=e.reduce(((e,t)=>e+t),0)/e.length/255,i=this._lastSmoothedLevel*_i.voiceParams.smoothing+t*(1-_i.voiceParams.smoothing);return this._lastSmoothedLevel=i,{real:t,smoothed:i}}destroy(){this._mediaStreamSource&&(this._mediaStreamSource.disconnect(),this._mediaStreamSource=null),this._gainNode&&(this._gainNode.disconnect(),this._gainNode=null),this._analyser&&(this._analyser.disconnect(),this._analyser=null,this._fftBins=null,this._lastSmoothedLevel=0)}constructor(e,t){this._analyser=null,this._gainNode=null,this._fftBins=null,this._mediaStreamSource=null,this._lastSmoothedLevel=0,this._trackId=e,this._stream=t;try{let e=Pt.getAudioContext();this._gainNode=e.createGain(),this._gainNode.gain.value=1e-5,this._gainNode.connect(e.destination),this._analyser=e.createAnalyser(),this._analyser.fftSize=1024,this._analyser.smoothingTimeConstant=0,this._analyser.connect(this._gainNode),this._fftBins=new Uint8Array(this._analyser.frequencyBinCount),this._mediaStreamSource=e.createMediaStreamSource(t),this._mediaStreamSource.connect(this._analyser)}catch(e){}}},on=class extends b{init(e){this._stopDetector(),this._track=e.clone(),this._detector=new sn("local",new MediaStream([this._track]))}_stopDetector(){this._detector&&(this._detector.destroy(),this._detector=null),this._track&&(this._track.stop(),this._track=null)}destroy(){this.unsubscribe(),this._interval&&(window.clearTimeout(this._interval),this._interval=null),this._stopDetector()}constructor(e){super(),this._detector=null,this._track=null,this._interval=null;let t=()=>{this._detector&&Ii.onLocalVolume(this._detector.getLevel().real,e.getMediaSettings().isAudioEnabled),this._interval=window.setTimeout(t,_i.voiceParams.interval)};this._interval=window.setTimeout(t,_i.voiceParams.interval);let i=()=>{let t=e.getSendAudioTrack();t&&this.init(t)};this.subscribe(e,"SOURCE_CHANGED",(e=>{"audio"===e.kind&&e.mediaSettings.isAudioEnabled&&i()})),i()}},cn=class extends b{destroy(){var e;this._interval&&(window.clearTimeout(this._interval),this._interval=null),this.unsubscribe(),null==(e=this._detector)||e.destroy(),this._detector=null}_onRemoteTrackAdded(e,t,i){var n;if("audio"===i.kind&&(null==(n=this._detector)||n.destroy(),this._detector=new sn(e,t),!this._interval)){let e=()=>{this._collectVolumes(),this._interval=window.setTimeout(e,_i.voiceParams.interval)};this._interval=window.setTimeout(e,_i.voiceParams.interval)}}_onRemoteTrackRemoved(e,t,i){"audio"===i.kind&&(!this._detector||this._detector.stream!==t||(this._detector.destroy(),this._detector=null))}_collectVolumes(){if(!this._detector)return;let e={},t=this._detector.trackId,i=this._detector.getLevel();if(t===ue.AUDIO_MIX){if(this._activeParticipants)for(let t of this._activeParticipants)e[t]=i}else e[t]=i;this._triggerEvent("VOLUMES_DETECTED",e)}_onSignalledActiveParticipants(e){this._activeParticipants=e}_onTopologyChanged(e){"DIRECT"===e&&(this._activeParticipants=null)}constructor(e){super(),this._detector=null,this._interval=null,this.subscribe(e,"REMOTE_TRACK_ADDED",this._onRemoteTrackAdded.bind(this)),this.subscribe(e,"REMOTE_TRACK_REMOVED",this._onRemoteTrackRemoved.bind(this)),this.subscribe(e,"SIGNALLED_ACTIVE_PARTICIPANTS",this._onSignalledActiveParticipants.bind(this)),this.subscribe(e,"TOPOLOGY_CHANGED",this._onTopologyChanged.bind(this))}},ln=class extends b{destroy(){this.unsubscribe()}_onVolumesDetected(e){if(this._serverSideSpeakerDetection)return;let t=0,i=null;if(Object.keys(e).forEach((n=>{let r=e[n].smoothed;r>t&&r>_i.voiceParams.threshold&&(t=r,i=n)})),i&&i!==this._speakerId){let n=this._speakerId&&e.hasOwnProperty(this._speakerId)?e[this._speakerId].smoothed:0;t>n*_i.voiceParams.speakerLevelMultiplier&&(this._speakerId=i,this._triggerEvent("SPEAKER_CHANGED",i))}}_onServerSpeakerChanged(e){this._serverSideSpeakerDetection&&this._triggerEvent("SPEAKER_CHANGED",e)}_onTopologyChanged(e){this._serverSideSpeakerDetection="SERVER"===e}constructor(e,t,i){super(),this._speakerId=null,this._serverSideSpeakerDetection=!1,this._serverSideSpeakerDetection="SERVER"===i,this.subscribe(e,"VOLUMES_DETECTED",this._onVolumesDetected.bind(this)),this.subscribe(t,"SIGNALLED_SPEAKER_CHANGED",this._onServerSpeakerChanged.bind(this)),this.subscribe(t,"TOPOLOGY_CHANGED",this._onTopologyChanged.bind(this))}},un=class extends b{destroy(){this.unsubscribe(),this._connectionTimeout&&window.clearTimeout(this._connectionTimeout),this._volumeTimeout&&window.clearTimeout(this._volumeTimeout)}onChangeRemoteMediaSettings(e,t){t.isAudioEnabled||(this._volumes[e]=1),t.isAudioEnabled&&(this._volumes[e]=0)}_onTransportStateChanged(e,t){"OPENED"===t&&(this._connectionTimeout||(this._connectionTimeout=window.setTimeout(this._onConnectionTimeout.bind(this),_i.specListenerParams.connectionTimeout)),this._volumeTimeout||(this._volumeTimeout=window.setTimeout(this._onVolumeTimeout.bind(this),_i.specListenerParams.volumeTimeout))),"FAILED"===t&&this._connectionTimeout&&(Ai.warn("Transport failed, send callSpecError"),Ne.log(ce.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`))}_onVolumesDetected(e){Object.keys(e).forEach((t=>{this._volumes[t]=Math.max(e[t].real,this._volumes[t]||0)}))}_onConnectionTimeout(){let e=e=>"CONNECTED"!==e;(()=>Object.values(this._transport.getStates()).filter(e).length>0)()&&(Ai.warn("There is not connected transport, send callSpecError"),Ne.log(ce.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`)),this._connectionTimeout=0}_onVolumeTimeout(){let e=[];Object.keys(this._volumes).forEach((t=>{if(this._volumes[t]>0)return;let i="UNKNOWN",n=this._participants[t];n&&n.platform&&(i=n.platform),e.indexOf(i)<0&&(e.push(i),Ne.log(ce.CALL_SPEC_ERROR,`${this._transport.getTopology()}_VOLUME_TIMEOUT_${i}`))})),e.length&&Ai.warn("There is silent participant, send callSpecError"),this._volumeTimeout=0}constructor(e,t,i){super(),this._volumes={},this._participants={},this._connectionTimeout=0,this._volumeTimeout=0,this._transport=e,this._participants=i,this.subscribe(e,"STATE_CHANGED",this._onTransportStateChanged.bind(this)),this.subscribe(t,"VOLUMES_DETECTED",this._onVolumesDetected.bind(this))}},dn=class extends b{static current(){return dn._current}static hangupAfterInit(){dn._activationMutex&&!dn._current&&(dn._delayedHangup=!0)}static id(){var e,t;return(null==(t=null==(e=dn._current)?void 0:e._conversation)?void 0:t.id)||null}onStart(e,t,i,n="",r=!1,a=!1,s){return E(this,null,(function*(){if(dn._activationMutex)throw Ne.log(ce.ERROR,"startCall"),Ai.warn("Conversation: there is already running activation"),new Be(K.FAILED);dn._activationMutex=!0;try{this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(i);let o=this._mediaSource.getMediaSettings();t===k.CHAT||e.length>1?this._logWithMediaSettings(ce.OUTGOING_MULTIPARTY_CALL,o):this._logWithMediaSettings(ce.OUTGOING_CALL,o);let c=yield this._startConversation(e,t,w.OUTGOING,i,n,r,a,s);if(!this._conversation)throw new Be(K.UNKNOWN_ERROR);if(this._participantState=Z.ACCEPTED,this._signaling.changeMediaSettings(o),yield this._processConnection(c),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),dn._delayedHangup)throw new Be(K.CANCELED);Ai.debug("Outgoing call",{opponentIds:e,opponentType:t,mediaOptions:i});let l=Object.values(this._participants),u=it.mapSharedParticipants(l);return yield this._processConnectionSharedMovieInfo(c),Ii.onLocalStream(this._mediaSource.getStream(),this._mediaSource.getMediaSettings()),Ii.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._getMuteStatesForCurrentRoom(),u),this._onConversationParticipantListChunk(c),this._processPinnedParticipants(c),Ii.onLocalStatus("WAITING"),this._toggleJoinAvailability(),this._changeFeatureSet(),this._changeNeedRate(),dn._current=this,this._conversation.concurrent&&(yield this._acceptConcurrent()),this._conversation}catch(e){throw this._close(e,"Unable to start conversation"),e}finally{dn._activationMutex=!1}}))}onJoin(e){return E(this,null,(function*(){var t;if(dn._activationMutex)throw Ne.log(ce.ERROR,"joinCall"),Ai.warn("Conversation: there is already running activation"),new Be(K.FAILED);dn._activationMutex=!0,this._state="PROCESSING";try{let i=!(null==(t=e.observedIds)||!t.length);if(i&&_i.videoTracksCount>0)throw Ai.error("Observer mode: please set videoTracksCount=0"),new Be(K.UNSUPPORTED);this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(e.mediaOptions,!i);let n=this._mediaSource.getMediaSettings();this._logWithMediaSettings(ce.JOIN_CONVERSATION,n);let r=yield this._joinConversation(e);if(!this._conversation)throw new Be(K.UNKNOWN_ERROR);return this._conversation.observer=i,Ii.onLocalStream(this._mediaSource.getStream(),n),this._conversation.waitingHall?(Ai.log("In waiting hall"),dn._current=this,dn._activationMutex=!1,this._signaling.readyToSend(),Ii.onLocalStatus("WAITING_HALL"),this._conversation):this._onJoinPart2(r)}catch(e){throw dn._activationMutex=!1,this._close(e,"Unable to join conversation"),e}}))}_onJoinPart2(e){return E(this,null,(function*(){var t,i,n,r,a,s,o;Ai.debug("Join conversation part 2"),dn._activationMutex=!0;try{if(this._participantState=Z.ACCEPTED,!this._conversation||!this._mediaSource)throw new Be(K.UNKNOWN_ERROR);if(!this._conversation.observer&&!this._isAudienceModeListener()&&this._signaling.changeMediaSettings(this._mediaSource.getMediaSettings()),yield this._processConnection(e),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),dn._delayedHangup)throw new Be(K.CANCELED);let c=Object.values(this._participants),l=it.mapSharedParticipants(c.filter((e=>!e.isInRoom))),u=[];if(null!=(i=null==(t=null==e?void 0:e.rooms)?void 0:t.rooms)&&i.length)for(let t of e.rooms.rooms)u.push({id:t.id,name:t.name,participantCount:t.participantCount,participantIds:yield Promise.all((null==(r=null==(n=null==t?void 0:t.participantIds)?void 0:n.map)?void 0:r.call(n,this._getExternalIdByParticipantId.bind(this)))||[]),participants:null!=(a=null==t?void 0:t.participants)&&a.participants?this._participantListChunkToExternalChunk(t.participants):void 0,active:t.active,muteStates:t.muteStates});let d=null!=(o=null==(s=null==e?void 0:e.rooms)?void 0:s.roomId)?o:null;return yield this._processConnectionSharedMovieInfo(e),yield this._processConnectionAsrInfo(e),Ii.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._getMuteStatesForCurrentRoom(),l,{rooms:u,roomId:d}),this._onConversationParticipantListChunk(e),this._processPinnedParticipants(e),Ii.onLocalStatus("WAITING"),this._toggleJoinAvailability(),this._changeNeedRate(),this._state="ACTIVE",this._changeFeatureSet(),dn._current=this,this._openTransport(c,!1),this._conversation.audienceMode&&!this._conversation.restricted&&this._forceOpenTransportForAloneInCall(),this._conversation}catch(e){throw this._close(e,"Unable to join conversation"),e}finally{dn._activationMutex=!1}}))}onPush(e){return E(this,arguments,(function*(e,t=ge.USER,i){if(dn._activationMutex)throw Ai.warn("Conversation: there is already running activation"),new Be(K.REJECTED);dn._activationMutex=!0;try{let n=yield this._prepareConversation(e,t,i);if(this._mediaSource=this._createMediaSource(),!this._conversation)throw new Be(K.UNKNOWN_ERROR);if(!n.conversation.participants.find((e=>{var t;return e.state===Z.CALLED&&e.id===(null==(t=this._conversation)?void 0:t.userId)})))throw Ai.log("Push rejected (there is an active call)"),Ne.log(ce.PUSH,"rejected"),new Be(K.REJECTED);if(yield this._processConnection(n),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._processPinnedParticipants(n),this._signaling.readyToSend(),Ne.log(ce.PUSH,"accepted"),dn._current=this,dn._delayedHangup)throw new Be(K.CANCELED);dn._activationMutex=!1}catch(e){throw dn._activationMutex=!1,this._close(e,"Unable to handle inbound call push"),e}}))}_isInWaitingHall(e){return!(!e.conversation||(e.conversation.options||[]).indexOf(x.WAITING_HALL)<0)&&this._isRestricted(e)}_isRestricted(e){let t=(e.conversation.participants||[]).find((t=>it.comparePeerId(t.peerId,e.peerId)));return t&&t.restricted||!1}_isAudienceMode(e){var t,i;return(null==(i=null==(t=e.conversation)?void 0:t.options)?void 0:i.includes(x.AUDIENCE_MODE))||!1}_isAudienceModeListener(){var e,t;return(null==(e=this._conversation)?void 0:e.audienceMode)&&(null==(t=this._conversation)?void 0:t.restricted)}_acceptConcurrent(){return E(this,null,(function*(){if(!this._mediaSource||!this._conversation||!this._transport)throw new Be(K.UNKNOWN_ERROR);this._state="PROCESSING";let e=this._mediaSource.getMediaSettings();this._logWithMediaSettings(ce.ACCEPT_CONCURRENT,e),Ai.debug("Concurrent call",{conversationId:this._conversation.id});try{this._statFirstMediaReceived.markAcceptCall(this._transport.getTopology()),yield this._signaling.acceptCall(this._mediaSource.getMediaSettings()),Ii.onCallAccepted(),this._state="ACTIVE",this._participantState=Z.ACCEPTED,this._changeFeatureSet(),this._openTransport(Object.values(this._participants),!0)}catch(e){this._close(e,"Unable to accept concurrent call")}}))}accept(e){return E(this,null,(function*(){var t;if("IDLE"!==this._state)throw Ne.log(ce.ERROR,"acceptIncoming"),Ai.error("Unable to accept a call - invalid state"),new Error("Unable to accept a call - invalid state");if(!this._mediaSource||!this._conversation||!this._transport)throw new Be(K.UNKNOWN_ERROR);this._state="PROCESSING",Ai.debug("Accept incoming call",e);try{yield this._mediaSource.request(e);let i=this._mediaSource.getMediaSettings();this._logWithMediaSettings(ce.ACCEPT_INCOMING,i),this._signaling.changeMediaSettings(i),this._statFirstMediaReceived.markAcceptCall(this._transport.getTopology()),yield this._signaling.acceptCall(i),this._participantState=Z.ACCEPTED;let n=Object.values(this._participants),r=it.mapSharedParticipants(n);if(Ii.onCallAccepted(),Ii.onLocalStream(this._mediaSource.getStream(),i),Ii.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._getMuteStatesForCurrentRoom(),r),_i.useParticipantListChunk){let e=yield this._getInitialParticiapntListChunk();null==(t=null==e?void 0:e.participants)||t.forEach((e=>{let t=it.composeId(e),i=this._participants[t];i&&(i.movieShareInfos=e.movieShareInfos)})),this._onConversationParticipantListChunk({participants:e})}Ii.onLocalStatus("WAITING"),this._toggleJoinAvailability(),this._changeNeedRate();let a=Fi(this._getMuteStatesForCurrentRoom(),Y.MUTE),s=Fi(this._getMuteStatesForCurrentRoom(),Y.MUTE_PERMANENT);for(let e of[a,s])e.length&&(yield this._processMuteState({mediaOptions:e,stateUpdated:!0}));return this._state="ACTIVE",this._changeFeatureSet(),this._openTransport(n,!0),this._conversation}catch(e){throw this._close(e,"Unable to accept call"),e}}))}decline(){return E(this,null,(function*(){var e;if("IDLE"!==this._state)throw Ne.log(ce.ERROR,"declineIncoming"),Ai.error("Unable to decline a call - invalid state"),new Error("Unable to decline a call - invalid state");this._state="PROCESSING",Ai.debug("Decline incoming call"),this._logWithMediaSettings(ce.DECLINE_INCOMING,null==(e=this._mediaSource)?void 0:e.getMediaSettings()),this._participantState=Z.HUNGUP,this._signaling.ready&&(yield this._signaling.hangup(K.REJECTED)),this._close(new Be(K.REJECTED))}))}hangup(){return E(this,null,(function*(){Ai.debug("Hangup");let e="ACTIVE"===this._state?K.HUNGUP:K.CANCELED;Ne.log(ce.HANGUP,e),this._signaling.ready?(yield this._signaling.hangup(e),this._close(new Be(e))):Ii.onHangup(new Be(K.HUNGUP),this._conversation&&this._conversation.id)}))}addParticipant(e,t){return E(this,null,(function*(){if(!this._signaling.ready)return void this._close(new Be(K.UNKNOWN_ERROR),"Unable to add participant");let i=yield this._signaling.addParticipant(e,t),n=null;"error"===i.type&&(n="call-unfeasible"===i.error?i.status:K.UNKNOWN_ERROR);let r=i.participant;yield this._onAddParticipant(it.composeId(r),r,n)}))}removeParticipant(e,t=!1){return E(this,null,(function*(){this._signaling.ready&&(yield this._signaling.removeParticipant(e,t),this._onRemoveParticipant(e))}))}setVolume(e){this._audioOutput.volume=e}updateStatisticsInterval(){this._transport&&this._transport.updateStatisticsInterval()}_openTransport(e,t){var i;if(!this._transport)return;let n=[];for(let i of e)(i.state===Z.CALLED||i.state===Z.ACCEPTED)&&(this._transport.isAllocated(i.id)||this._transport.allocate(i.id,t)),i.state===Z.ACCEPTED&&n.push(i.id);n.length&&this._transport.open(n,null,!(null==(i=this._conversation)||!i.observer))}_close(e,t){t&&Ai.error(t,e),Ai.debug("Close conversation",e),this._signaling.readyToSend(!1),e.error?this._signaling.ready&&this._signaling.hangup(K.FAILED):Ne.log(ce.ERROR,e.hangup),dn._activationMutex=!1;let i=this._conversation&&this._conversation.id;return-1!==[K.CANCELED,K.NOT_FRIENDS,K.CALLEE_IS_OFFLINE,K.CALLER_IS_BLOCKED,K.CALLER_IS_REJECTED].indexOf(e.hangup)||e.hangup===K.REJECTED&&!e.remote?(Ii.onHangup(e,i),void this.destroy()):(e.hangup!==K.HUNGUP||e.remote&&this._participantState!==Z.CALLED)&&(e.hangup!==K.MISSED||e.remote)?(null!==this._cooldownQueueCleanupTimer&&(window.clearInterval(this._cooldownQueueCleanupTimer),this._cooldownQueueCleanupTimer=null),(e.hangup!==K.SOCKET_CLOSED&&e.hangup!==K.NOT_FOUND||!dn._current||this._conversation)&&(e.hangup!==K.BUSY||e.remote)?(this._state="CLOSE",this._participantState=Z.HUNGUP,this._changeFeatureSet(),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),Ne.destroy(),qt.destroy(),this._conversation=null,this._myLastRequestedLayouts={},dn._current=null,dn._delayedHangup=!1,void Ii.onHangup(e||new Be(K.UNKNOWN_ERROR),i)):(this._cleanupSignaling(),void this._cleanupMediaSource())):(Ii.onHangup(e,i),void this.destroy())}destroy(){let e=this._conversation&&this._conversation.id;Ai.debug("Destroy conversation",{conversationId:e}),null!==this._cooldownQueueCleanupTimer&&(window.clearInterval(this._cooldownQueueCleanupTimer),this._cooldownQueueCleanupTimer=null),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),this._cleanupListeners(),Ne.destroy(),qt.destroy(),this._conversation=null,this._myLastRequestedLayouts={},dn._current=null,dn._delayedHangup=!1}_getConversationParams(e){return E(this,null,(function*(){let t=yield this._api.getConversationParams(e);Ai.debug("Api.getConversationParams",t);let i=[],{turn_server:n,stun_server:r}=t;if(r&&i.push(r),n){let e=n.urls.filter(((e,t,i)=>i.indexOf(e)===t));e.push(`${e[e.length-1]}?transport=tcp`),i.push({urls:e,username:n.username,credential:n.credential})}return _i.iceServers=i,_i.wssBase=t.endpoint,_i.wssToken=t.token,t.client_type&&(_i.clientType=t.client_type),_i.externalUserType=t.external_user_type,t}))}_addGeoParamsToEndpoint(e,t){return t.isp_as_no&&(e+=`&ispAsNo=${t.isp_as_no}`),t.isp_as_org&&(e+=`&ispAsOrg=${t.isp_as_org}`),t.loc_cc&&(e+=`&locCc=${t.loc_cc}`),t.loc_reg&&(e+=`&locReg=${t.loc_reg}`),e}_startConversation(e,t,i,n,r="",a=!1,s=!1,o){return E(this,null,(function*(){let c=it.uuid();Ai.debug("Conversation: start",{conversationId:c,opponentIds:e,opponentType:t,direction:i});let l=n.includes(z.VIDEO),u=yield this._api.startConversation(c,e,t,l,r,a,s,{onlyAdminCanShareMovie:o});Ai.debug("Api.startConversation",u);let d=yield this._getConversationParams(u.id);u.endpoint=this._addGeoParamsToEndpoint(u.endpoint,d);let h=yield this._connectSignaling(ie.START,u);return yield this._setConversation(u,h,i),h}))}_joinConversation(e){return E(this,null,(function*(){let{conversationId:t,mediaOptions:i,chatId:n,joinLink:r,observedIds:a,payload:s}=e;Ai.debug("Conversation: join",{conversationId:t,joinLink:r,observedIds:a});let o,c=i.includes(z.VIDEO);if(t)o=yield this._api.joinConversation(t,c,n);else{if(!r)throw new Be(K.UNKNOWN_ERROR);o=yield this._api.joinConversationByLink(r,c,a,s)}Ai.debug("Api.joinConversation",o),yield this._getConversationParams(o.id),this._statFirstMediaReceived.measureSignalingConnection();let l=yield this._connectSignaling(ie.JOIN,o);return this._statFirstMediaReceived.measureSignalingConnection(l),yield this._setConversation(o,l,w.JOINING),l}))}_prepareConversation(e){return E(this,arguments,(function*(e,t=ge.USER,i){Ai.debug("Conversation: push",{conversationId:e,type:t,peerId:i});let n=this._api.getUserId();if(!n)throw new Be(K.UNKNOWN_ERROR);let r=yield this._getConversationParams(e),a=r.device_idx||0,s=`${_i.wssBase}?userId=${n}&entityType=${t}&deviceIdx=${a}&conversationId=${e}&token=${_i.wssToken}`;s=this._addGeoParamsToEndpoint(s,r);let o={id:e,peerId:i,endpoint:s,is_concurrent:!1,p2p_forbidden:!1,device_idx:a},c=yield this._connectSignaling(ie.ACCEPT,o);return!dn._current||dn._current._participantState!==Z.ACCEPTED&&dn._current._participantState!==Z.CALLED?(dn._current&&(dn._current.destroy(),dn._current=null),yield this._setConversation(o,c,w.INCOMING,t),c):(Ai.log("Push rejected (busy)"),Ne.log(ce.PUSH,"busy"),this._signaling.ready&&this._signaling.hangup(K.BUSY),Promise.reject({hangup:K.BUSY}))}))}_createParticipant(e){return E(this,null,(function*(){var t;let i=Object.assign({id:null,externalId:null,mediaSettings:Ue(),participantState:{},state:Z.CALLED,status:null,remoteStream:null,mediaSource:null,platform:null,clientType:null,roles:[],networkRating:1,lastRequestedLayouts:{},muteStates:{},unmuteOptions:[],observedIds:[],isInRoom:!1,markers:null},e);if(e.externalId){let t=it.decomposeParticipantId(i.id).compositeUserId;this._api.cacheExternalId(t,e.externalId)}else i.externalId=yield this._getParticipantId(i.id);return null!=(t=i.observedIds)&&t.length&&(i.externalId.observer=!0),e.markers&&(i.markers=this._denormalizeMarkers(i.id,e.markers)),i}))}_getParticipantId(e){return E(this,null,(function*(){try{return yield this._api.userId(e)}catch(e){throw this._close(new Be(K.NETWORK_ERROR),e),e}}))}_setConversation(e,t,i){return E(this,arguments,(function*(e,t,i,n=ge.USER){yield this._prepareParticipants(t.conversation.participants);let r=this._api.getUserId(),a=e.device_idx||0;if(!r){let e=(t.conversation.participants||[]).find((e=>it.comparePeerId(e.peerId,t.peerId)));if(!e)throw new Be(K.UNKNOWN_ERROR);r=Number(e.id),e.idType&&(n=e.idType),e.deviceIdx&&(a=e.deviceIdx),this._api.setUserId(r)}let s=it.composeParticipantId(r,n,a),o=yield this._getParticipantId(s);this._conversation={userId:r,compositeUserId:s,externalId:o,acceptTime:t.conversation.acceptTime,features:t.conversation.features||[],featuresPerRole:t.conversation.featuresPerRole,id:t.conversation.id||e.id,participantsLimit:t.conversation.participantsLimit||30,topology:t.conversation.topology||"DIRECT",direction:i,concurrent:t.isConcurrent||e.is_concurrent||!1,needRate:!1,chatId:t.conversation.multichatId,roles:[],recordsInfoByRoom:new Map,asrInfoByRoom:new Map,muteStates:new Map,joinLink:e.join_link,pinnedParticipantIdByRoom:new Map,mediaModifiers:t.mediaModifiers,options:[],unmuteOptions:[],networkRating:1,waitingHall:this._isInWaitingHall(t),observer:!1,asrInfo:t.conversation.asrInfo||null,roomId:null,audienceMode:this._isAudienceMode(t),restricted:this._isRestricted(t)},this._signaling.setConversationId(this._conversation.id),e.p2p_forbidden&&(_i.forceRelayPolicy=e.p2p_forbidden),Ne.log(ce.RELAY_POLICY,_i.forceRelayPolicy?"1":"0"),this._changeFeatureSet(),this._logDevices()}))}_updateConversation(e){if(!this._conversation)throw new Be(K.UNKNOWN_ERROR);this._conversation.acceptTime=e.conversation.acceptTime,this._conversation.features=e.conversation.features||[],this._conversation.featuresPerRole=e.conversation.featuresPerRole,this._conversation.participantsLimit=e.conversation.participantsLimit||30,this._conversation.topology=e.conversation.topology||"DIRECT",this._conversation.concurrent=e.isConcurrent||!1,this._conversation.chatId=e.conversation.multichatId,this._conversation.mediaModifiers=e.mediaModifiers,this._conversation.waitingHall=!1}_createMediaSource(){let e=new We;return this.subscribe(e,"SOURCE_CHANGED",this._onLocalMediaStreamChanged.bind(this)),this.subscribe(e,"SCREEN_STATUS",this._onScreenSharingStatus.bind(this)),this._audioFix=new ji(e),e}_connectSignaling(e,t){return E(this,null,(function*(){return this._signaling.setEndpoint(t.endpoint),this.subscribe(this._signaling,re.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._signaling,re.FAILED,this._onSignalingFailed.bind(this)),this.subscribe(this._signaling,re.RECONNECT,this._onSignalingReconnect.bind(this)),this._signaling.connect(e,t)}))}_processConnection(e){return E(this,null,(function*(){yield this._registerConnectionParticipants(e),this._processConnectionData(e)}))}_prepareParticipants(e){return E(this,null,(function*(){let t=e.map((e=>e.id));t.length&&(yield this._api.prepareUserIds(t))}))}_onConversationParticipantListChunk(e){let t=e.participants;t&&Ii.onConversationParticipantListChunk(this._participantListChunkToExternalChunk(this._createParticipantListChunk(t)))}_createParticipantListChunk(e){return y(y({},{participants:[],countBefore:0,countAfter:0,markerFound:!1}),e)}_participantListChunkToExternalChunk(e){let t=it.mapSharedParticipants(e.participants.map((e=>{let t=it.composeId(e);return this._participants[t]})));return T(y({},e),{participants:t})}_registerConnectionParticipants(e){return E(this,null,(function*(){var t,i,n,r,a,s;yield this._registerParticipants(e.conversation.participants),null!=(t=e.participants)&&t.participants&&(yield this._registerParticipants(null==(i=e.participants)?void 0:i.participants));let o=null!=(r=null==(n=null==e?void 0:e.rooms)?void 0:n.rooms)?r:[];for(let e of o)yield this._registerParticipants(null!=(s=null==(a=null==e?void 0:e.participants)?void 0:a.participants)?s:[],!0)}))}_registerParticipants(e,t=!1){return E(this,null,(function*(){if(this._conversation)for(let i of e){let e=it.composeId(i);this._isMe(e)?(this._conversation.roles=i.roles||[],this._conversation.roles.length&&(Ai.debug(`Local roles changed: ${i.roles}`),Ii.onLocalRolesChanged(this._conversation.roles)),yield this._registerParticipantLocalMuteState(i)):i.state!==Z.HUNGUP&&i.state!==Z.REJECTED?(this._registerParticipantInCache(yield this._createParticipant({id:e,externalId:i.externalId&&Ri.fromSignaling(i.externalId,i.deviceIdx||0),mediaSettings:Ue(i.mediaSettings),participantState:it.mapParticipantState(i),state:i.state,roles:i.roles||[],status:"WAITING",muteStates:i.muteStates||{},unmuteOptions:i.unmuteOptions||[],observedIds:i.observedIds||[],markers:this._denormalizeMarkers(e,i.markers),movieShareInfos:i.movieShareInfos,isInRoom:t})),i.roles&&i.roles.length&&(Ai.debug(`Roles for participant [${e}] changed: ${i.roles}`),Ii.onRolesChanged(this._participants[e].externalId,i.roles))):this._participants[i.id]&&this._removeParticipant(this._participants[i.id],K.HUNGUP)}}))}_registerParticipantLocalMuteState(e){return E(this,null,(function*(){if(!e.muteStates)return Promise.resolve();let t=Fi(e.muteStates,Y.MUTE),i=Fi(e.muteStates,Y.MUTE_PERMANENT);for(let n of[t,i])n.length&&(yield this._onMuteParticipant({muteStates:e.muteStates,unmuteOptions:e.unmuteOptions,mediaOptions:n,stateUpdated:!0}))}))}_getStatusByTransportState(e){let t=null;return"CONNECTED"===e?t="CONNECTED":"CONNECTING"===e||"OPENED"===e?t="CONNECTING":"RECONNECTING"===e&&(t="RECONNECT"),t}_registerParticipantInCache(e){return this._participants[e.id]=e}_getExistedParticipantByIdOrCreate(e){return E(this,null,(function*(){return this._participants[e]||this._createParticipant({id:e})}))}_getExternalIdByParticipantId(e){return E(this,null,(function*(){var t,i;if(this._isMe(e))return null==(t=this._conversation)?void 0:t.externalId;if(_i.useParticipantListChunk)return(yield this._getExistedParticipantByIdOrCreate(e)).externalId;if(null!=(i=this._participants[e])&&i.externalId)return this._participants[e].externalId;{let t=yield this._getParticipantId(e);return this._api.cacheExternalId(e,t),t}}))}_registerParticipantAndSetMarkersIfChunkEnabled(e,t){return E(this,null,(function*(){if(_i.useParticipantListChunk){let i=this._registerParticipantInCache(yield this._getExistedParticipantByIdOrCreate(e));return i.markers=this._denormalizeMarkers(i.id,t),i}return this._participants[e]}))}_warnParticipantNotInConversation(e){Ai.warn(`Participant [${e}] isn't in conversation`)}_denormalizeMarkers(e,t){if(!t)return null;let i=Object.values(t).find((e=>"ts"in e&&"rank"in e));return Object.entries(t).reduce(((t,[n,r])=>(t[n]=T(y(y({},i),r),{id:e}),t)),{})}_processConnectionData(e){this._processRooms(e),this._processMuteStates(e),this._processRecordInfos(e),this._onOptionsChanged(e.conversation.options),e.chatRoom&&e.chatRoom.totalCount&&this._onChatRoomUpdated(O.ATTENDEE,e.chatRoom.totalCount,e.chatRoom.firstParticipants,null,null)}_processRooms(e){var t,i;let n=null!=(i=null==(t=e.rooms)?void 0:t.roomId)?i:null;this._onRoomSwitched(n,!0)}_processMuteStates(e){var t,i,n,r;this._setMuteStatesForRoomId(null==(t=e.conversation)?void 0:t.muteStates,null);for(let t of null!=(n=null==(i=e.rooms)?void 0:i.rooms)?n:[])this._setMuteStatesForRoomId(t.muteStates,t.id);let a=this._getMuteStatesForCurrentRoom();this._onMuteParticipant({muteStates:a,unmuteOptions:e.unmuteOptions,mediaOptions:Object.keys(a),muteAll:!0,stateUpdated:!0,roomId:null==(r=this._conversation)?void 0:r.roomId})}_processRecordInfos(e){var t,i,n,r;this._onRecordInfo(null!=(t=e.conversation.recordInfo)?t:null);for(let t of null!=(n=null==(i=e.rooms)?void 0:i.rooms)?n:[])this._onRecordInfo(null!=(r=t.recordInfo)?r:null,t.id)}_processPinnedParticipants(e){var t,i,n,r;e.conversation.pinnedParticipantId?this._onPinParticipant(e.conversation.pinnedParticipantId):null==(t=this._conversation)||t.pinnedParticipantIdByRoom.delete(null);for(let t of null!=(n=null==(i=e.rooms)?void 0:i.rooms)?n:[])t.pinnedParticipantId?this._onPinParticipant(t.pinnedParticipantId,!1,void 0,t.id):null==(r=this._conversation)||r.pinnedParticipantIdByRoom.delete(t.id)}_allocateTransport(){if(!this._conversation||!this._mediaSource)return;this._transport=new tn(this._conversation.topology,this._signaling,this._mediaSource,this._serverSettings),this._debugInfo=new an,this.subscribe(this._transport,"STATE_CHANGED",this._onTransportStateChanged.bind(this)),this.subscribe(this._transport,"LOCAL_STATE_CHANGED",this._onTransportLocalStateChanged.bind(this)),this.subscribe(this._transport,"REMOTE_TRACK_ADDED",this._onRemoteTrackAdded.bind(this)),this.subscribe(this._transport,"REMOTE_TRACK_REMOVED",this._onRemoteTrackRemoved.bind(this)),this.subscribe(this._transport,"AUDIO_MIX_STALL",this._onAudioMixStall.bind(this)),this.subscribe(this._transport,"REMOTE_DATA_STATS",this._onRemoteDataStats.bind(this)),this.subscribe(this._transport,"SIGNALLED_STALLED_PARTICIPANTS",this._onRemoteSignalledStall.bind(this)),this.subscribe(this._transport,"TOPOLOGY_CHANGED",this._onTopologyChanged.bind(this)),this.subscribe(this._transport,"NETWORK_STATUS",this._onNetworkStatus.bind(this)),this.subscribe(this._transport,"REMOTE_STREAM_SECOND",this._onRemoteStreamSecond.bind(this)),this.subscribe(this._transport,"PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this)),this.subscribe(this._transport,"ASR_TRANSCRIPTION",this._onAsrTranscription.bind(this)),this.subscribe(this._transport,"ANIMOJI_STREAM",this._onAnimojiStream.bind(this));let e=this._conversation.direction===w.OUTGOING&&!this._conversation.concurrent;for(let t of Object.values(this._participants))(t.state===Z.ACCEPTED||t.state===Z.CALLED)&&this._transport.allocate(t.id,e)}_createSpeakerDetector(){this._transport&&this._conversation&&(this._volumesDetector=new cn(this._transport),this.subscribe(this._volumesDetector,"VOLUMES_DETECTED",this._onVolumesDetected.bind(this)),this._speakerDetector=new ln(this._volumesDetector,this._transport,this._conversation.topology),this.subscribe(this._speakerDetector,"SPEAKER_CHANGED",this._onSpeakerChanged.bind(this)),this._localVolumeDetector=new on(this._mediaSource))}_createSpecListener(){this._transport&&this._volumesDetector&&(this._specListener=new un(this._transport,this._volumesDetector,this._participants))}_logDevices(){let e=Pt.getCameras().length,t=Pt.getMicrophones().length;Ai.debug("Cameras: "+e+(Pt.hasCameraPermission()?"✔":"✖")+", Microphones: "+t+(Pt.hasMicrophonePermission()?"✔":"✖")),Ne.log(ce.DEVICES,`${e}_${t}`)}_logWithMediaSettings(e,t){Ne.log(e,[(null==t?void 0:t.isAudioEnabled)&&"audio",(null==t?void 0:t.isVideoEnabled)&&"video"].filter(Boolean).join("_"))}_removeParticipant(e,t){var i;if(e.state!==Z.CALLED&&e.state!==Z.ACCEPTED&&"CLOSE"!==this._state&&(e.id===this._lastSignalledActiveSpeakerId&&(this._lastSignalledActiveSpeakerId=null),this._participants[e.id])){t===K.HUNGUP?this._setParticipantsStatus([e],"HANGUP"):this._setParticipantsStatus([e],"ERROR",t),null==(i=e.mediaSource)||i.disconnect(),this._conversation&&this._conversation.pinnedParticipantIdByRoom.get(null)===e.id&&this._conversation.pinnedParticipantIdByRoom.delete(null),this._conversation&&this._conversation.roomId&&this._conversation.pinnedParticipantIdByRoom.get(this._conversation.roomId)===e.id&&this._conversation.pinnedParticipantIdByRoom.delete(this._conversation.roomId);for(let[t,i]of Object.entries(e.lastRequestedLayouts))this._streamIdByStreamDescription.delete(t),this._sequenceNumberByStreamDescription.delete(t),this._cooldownTimestampByStreamDescription.delete(t),this._streamWaitTimerByStreamDescription.has(t)&&(window.clearTimeout(this._streamWaitTimerByStreamDescription.get(t)),this._streamWaitTimerByStreamDescription.delete(t)),this._sendUpdateDisplayLayout({[t]:{stopStream:!0}});delete this._participants[e.id],Ii.onRemoteRemoved(e.externalId,e.markers)}}_cleanupListeners(){this.unsubscribe(),window.removeEventListener("unload",this._onUnload)}_cleanupMediaSource(){this._mediaSource&&(this._mediaSource.destroy(),this._mediaSource=null)}_cleanupParticipants(){Object.values(this._participants).forEach((e=>{var t,i,n;null==(t=e.remoteStream)||t.getTracks().forEach((e=>e.stop())),null==(i=e.secondStream)||i.getTracks().forEach((e=>e.stop())),null==(n=e.mediaSource)||n.disconnect()})),this._participants={},this._audioOutput&&this._audioOutput.destroy()}_cleanupParticipantAgnosticStreams(){Ai.debug("cleaning up participant-agnostic streams"),this._streamByStreamId.forEach((e=>{e.getTracks().forEach((e=>{e.stop()}))})),this._streamByStreamId=new Map,this._streamWaitTimerByStreamDescription.forEach((e=>{window.clearTimeout(e)})),this._streamWaitTimerByStreamDescription=new Map,this._streamIdByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map}_cleanupTransport(){this._transport&&(this._transport.destroy(),this._transport=null),this._debugInfo&&(this._debugInfo=null)}_cleanupSpeakerDetector(){this._speakerDetector&&(this._speakerDetector.destroy(),this._speakerDetector=null),this._volumesDetector&&(this._volumesDetector.destroy(),this._volumesDetector=null),this._localVolumeDetector&&(this._localVolumeDetector.destroy(),this._localVolumeDetector=null)}_cleanupSpecListener(){this._specListener&&(this._specListener.destroy(),this._specListener=null)}_cleanupSignaling(){this._signaling.close(),this._signaling.cleanup()}_onAddParticipant(e,t,i){return E(this,null,(function*(){Ai.debug(`Add new participant [${e}]`);let n=this._participants[e];!n||n.state!==Z.ACCEPTED&&n.state!==Z.CALLED?(n||(n=this._registerParticipantInCache(yield this._createParticipant({id:e,externalId:t.externalId&&Ri.fromSignaling(t.externalId,t.deviceIdx||0),mediaSettings:Ue(t.mediaSettings),state:t.state,roles:t.roles||[],muteStates:t.muteStates||{},unmuteOptions:t.unmuteOptions||[],observedIds:t.observedIds||[]}))),this._setParticipantsStatus([n],"WAITING"),i?(n.state=Z.HUNGUP,this._removeParticipant(n,i)):this._transport&&(n.state=Z.CALLED,this._transport.allocate(n.id,!0),Ne.log(ce.ADD_PARTICIPANT),this._invokeRolesChangedCallbackIfNeeded(n))):Ai.warn(`Participant [${n.id}:${n.state}] is already in conversation`)}))}_onRemoveParticipant(e){Ai.debug(`Remove participant [${e}]`);let t=[];for(let i=0;i<=15;i++){let n=it.compose(e,i),r=this._participants[n];r&&t.push(r)}if(t.length){if(this._transport)for(let e of t)this._transport.close(e.id);Ne.log(ce.REMOVE_PARTICIPANT)}else this._warnParticipantNotInConversation(e)}changeDevice(e){return E(this,null,(function*(){return"audiooutput"===e?this._audioOutput.changeOutput():this._mediaSource?this._mediaSource.changeDevice(e):Promise.reject(W.UNKNOWN)}))}stopVideoTrack(){var e;return null==(e=this._mediaSource)?void 0:e.stopVideoTrack()}toggleScreenCapturing(e){return E(this,null,(function*(){return this._mediaSource?this._mediaSource.toggleScreenCapturing(e):Promise.reject(W.UNKNOWN)}))}disableScreenCapturing(){return E(this,null,(function*(){return this._mediaSource?this._mediaSource.disableScreenCapturing():Promise.reject(W.UNKNOWN)}))}toggleAnimojiCapturing(e){this._mediaSource&&this._mediaSource.toggleAnimojiCapturing(e)}setAnimojiSvg(e,t=null,i=null){if(!this._transport||!this._conversation)return;let n=!t,r=null!=t?t:this._conversation.compositeUserId;if(e instanceof ArrayBuffer){let t=null!=i?i:this._conversation.externalId.id;this._transport.setAnimojiSvg(r,{svg:e,userId:t,isMe:n})}else this._transport.setAnimojiSvg(r,{svg:e,isMe:n})}setVideoStream(e,t=!1){return E(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setVideoStream(e,t)}))}setAudioStream(e){return E(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setAudioStream(e)}))}toggleLocalVideo(e){return E(this,null,(function*(){if(this._mediaSource)return Ne.log(ce.MEDIA_STATUS,e?"video_1":"video_0"),this._mediaSource.toggleVideo(e)}))}toggleLocalAudio(e){return E(this,null,(function*(){if(this._mediaSource)return Ne.log(ce.MEDIA_STATUS,e?"audio_1":"audio_0"),this._mediaSource.toggleAudio(e)}))}changePriorities(e){return E(this,null,(function*(){if(e.length<2||!this._signaling.ready)return;let t={},i={};for(let t of e){let e="object"==typeof t.uid?t.uid:Ri.fromId(t.uid);i[Ri.toString(e)]=t.priority}for(let e of Object.values(this._participants)){let n=Ri.toString(e.externalId);i.hasOwnProperty(n)&&(t[e.id]=i[n])}yield this._signaling.changePriorities(t)}))}changeParticipantState(e){return E(this,null,(function*(){for(let[t,i]of Object.entries(e))if(t.length>5||i.length>5)throw new Error("key/value max length is 5 chars, mappings with empty values (null or empty string) are discarded");yield this._signaling.changeParticipantState(e)}))}requestKeyFrame(e){return E(this,null,(function*(){let t={};return t[Ni(e)]={keyFrameRequested:!0},this._signaling.updateDisplayLayout(t)}))}requestTestMode(e,t){return E(this,null,(function*(){return this._signaling.requestTestMode(e,t)}))}updateDisplayLayout(e){return E(this,null,(function*(){if(e.length<1||!this._signaling.ready)return;Ai.log(`Update display layout request [${this._signaling.getNextCommandSequenceNumber()}]`,e);let t={};for(let i of e){let e="object"==typeof i.uid?i.uid:Ri.fromId(i.uid),n=this._api.getCachedOkIdByExternalId(e);if(!n){let t=Ri.toString(e);Ai.log(`Unknown participant external ID ${t}`);continue}let r=Ni({participantId:n,mediaType:i.mediaType,streamName:i.streamName}),a=this._participants[n];a?a.lastRequestedLayouts[r]=i:this._isMe(n)&&(this._myLastRequestedLayouts[r]=i),Pi(i)?(this._isMe(n)&&delete this._myLastRequestedLayouts[r],this._streamIdByStreamDescription.has(r)&&!this._cooldownTimestampByStreamDescription.has(r)&&this._cooldownTimestampByStreamDescription.set(r,Date.now())):(this._cooldownTimestampByStreamDescription.delete(r),!this._streamIdByStreamDescription.has(r)&&_i.videoTracksCount>0&&this._streamIdByStreamDescription.set(r,null),t[r]=i),"SCREEN"===i.mediaType&&!Pi(i)&&Bt(Gt(n))}let i=this._cooldownTimestampByStreamDescription.keys();for(;this._streamIdByStreamDescription.size>_i.videoTracksCount;){let e=i.next();if(e.done){Ai.error("Cannot accommodate all streaming requests: tracks available "+_i.videoTracksCount+"; requested streams: "+Array.from(this._streamIdByStreamDescription.keys()));break}this._stopStreaming(e.value),t[e.value]={stopStream:!0}}yield this._sendUpdateDisplayLayout(t)}))}feedback(e){return this._signaling.feedback(e)}userFeedbackStats(e,t,i){this._conversation&&this._api.sendUserFeedbackStats(this._conversation.id,e,t,i)}_stopStreaming(e){var t;if(this._cooldownTimestampByStreamDescription.delete(e),this._sequenceNumberByStreamDescription.set(e,this._signaling.getNextCommandSequenceNumber()),this._streamWaitTimerByStreamDescription.has(e)&&(Ai.log("Client asked to stop streaming before stream became available",e),window.clearTimeout(this._streamWaitTimerByStreamDescription.get(e)),this._streamWaitTimerByStreamDescription.delete(e)),this._streamIdByStreamDescription.get(e)){let i=Mi(e),n=this._participants[i.participantId],r=null==(t=this._conversation)?void 0:t.externalId,a=this._isMe(i.participantId);if(n||a){switch(i.mediaType){case"STREAM":case"MOVIE":if(i.streamName){let e={stream:null,streamName:i.streamName,mediaType:i.mediaType};a?Ii.onLocalLive(r,e):Ii.onRemoteLive(n.externalId,e)}break;case"CAMERA":Ii.onRemoteStream(n.externalId,null);break;case"SCREEN":Ii.onRemoteScreenStream(n.externalId,null)}Ne.log(ce.PAT_DEALLOCATED)}else Ai.log(`Cannot find participant to stop streaming: ${i.participantId}`)}this._streamIdByStreamDescription.delete(e)}_sendUpdateDisplayLayout(e){return E(this,null,(function*(){if(0===Object.keys(e).length)return;Ai.log(`Update display layout send [${this._signaling.getNextCommandSequenceNumber()}]`,e);let t=yield this._signaling.updateDisplayLayout(e);if(!t)return;let i=[];for(let[e,n]of Object.entries(t.errorCodeByParticipantId||{})){let t=Mi(e),r=this._participants[t.participantId];if(r){let e;"number"!=typeof n?(Ai.warn(`Unexpected error code ${n} received for participant ${t.participantId}`),e=he.UNKNOWN_ERROR):e=1===n?"no-available-tracks":"unknown-error",i.push({externalId:r.externalId,errorReason:e})}}if(i&&i.length)throw new _n("Could not allocate one or more participants",i)}))}_cleanupCooldownQueue(){let e={},t=this._cooldownTimestampByStreamDescription.entries();for(;;){let i=t.next();if(i.done)break;let n=i.value;if(n[1]+1e4>Date.now())break;let r=n[0];this._stopStreaming(r),e[r]={stopStream:!0}}this._sendUpdateDisplayLayout(e)}_onParticipantSourcesUpdate(e){if(this._conversation){let t=e.participantUpdateInfos;Ai.log("Received participant sources update notification",t);for(let e of t)this._waitForStreamIfNeeded(e)}}_onParticipantPromoted(e){return E(this,null,(function*(){this._conversation&&this._conversation.audienceMode?(Ai.log("Promoted in audience mode",!e.demote),this._conversation.restricted=e.demote,!e.demote&&this._mediaSource&&(yield this._signaling.changeMediaSettings(this._mediaSource.getMediaSettings()))):(Ai.log("Promoted in waiting hall",!e.demote),e.demote?(Ai.log("Kicked from waiting hall"),this._close(new Be(K.REMOVED))):(this._updateConversation(e),yield this._onJoinPart2(e))),Ii.onPromoted(e.demote)}))}_onChatRoomUpdated(e){return E(this,arguments,(function*(e,t=0,i=[],n,r){Ai.log(`Chat room updated: ${e}`);let a=[],s=[],o=[],c=[],l=[];if(i.length&&i.forEach((e=>{if(e.externalId){let t=Ri.fromSignaling(e.externalId);l.push(t),this._api.cacheExternalId(e.id.id,t)}else{let t=it.decomposeId(e.id.id).id;a.push(t),c.push(t)}})),null!=n&&n.length&&n.forEach((e=>{let t=it.decomposeId(e).id;a.push(t),s.push(t)})),null!=r&&r.length&&r.forEach((e=>{let t=it.decomposeId(e).id;a.push(t),o.push(t)})),!a.length)return void Ii.onChatRoomUpdated(e,t,l,[],[]);if(yield this._api.prepareUserIds(a),c.length){let e=yield this._api.getExternalIdsByOkIds(c);l.push(...e)}let u=yield this._api.getExternalIdsByOkIds(s),d=yield this._api.getExternalIdsByOkIds(o);Ii.onChatRoomUpdated(e,t,l,u,d)}))}_onSharedMovieUpdate(e){return E(this,null,(function*(){var t;let i=null==(t=this._conversation)?void 0:t.externalId;for(let t of e.data)if(this._isMe(t.participantId))Ii.onLocalLiveUpdate(i,t);else{let e=yield this._getExternalIdByParticipantId(t.participantId);e&&Ii.onRemoteLiveUpdate(e,t)}}))}_onSharedMovieInfoStarted(e){return E(this,null,(function*(){Ai.log(`Shared movie started data received: ${e.notification}`),yield this._processSharedMovieInfo(e.movieShareInfo,e.roomId)}))}_processSharedMovieInfos(e,t=null){return E(this,null,(function*(){e&&(yield Promise.all(e.map((e=>this._processSharedMovieInfo(e,t)))))}))}_processSharedMovieInfo(e,t=null){return E(this,null,(function*(){var i;if(!e)return;let n=null==(i=this._conversation)?void 0:i.externalId;if(this._isMe(e.initiatorId))Ii.onLocalSharedMovieInfo(n,e,t);else{let i=yield this._getExternalIdByParticipantId(e.initiatorId);i&&Ii.onRemoteSharedMovieInfo(i,e,t)}this._forceOpenTransportForAloneInCall()}))}_processConnectionSharedMovieInfo(e){return E(this,null,(function*(){var t,i;let n=e.conversation.participants.find((e=>this._isMe(it.composeId(e))));yield this._processSharedMovieInfos(null==n?void 0:n.movieShareInfos,null!=(i=null==(t=null==e?void 0:e.rooms)?void 0:t.roomId)?i:null)}))}_processConnectionAsrInfo(e){return E(this,null,(function*(){var t,i,n,r,a,s;if(e.conversation.asrInfo&&(null==(t=this._conversation)||t.asrInfoByRoom.set(null,e.conversation.asrInfo)),null!=(i=e.rooms)&&i.rooms)for(let t of e.rooms.rooms)t.asrInfo&&(null==(n=this._conversation)||n.asrInfoByRoom.set(t.id,t.asrInfo));let o=null!=(a=null==(r=e.rooms)?void 0:r.roomId)?a:null,c=null==(s=this._conversation)?void 0:s.asrInfoByRoom.get(o);if(c){let e=yield this._getExternalIdByParticipantId(c.initiatorId);e&&Ii.onAsrSet({externalId:e,movieId:c.movieId},o)}else o&&Ii.onAsrSet(null,o)}))}_onSharedMovieInfoStopped(e){return E(this,null,(function*(){var t;Ai.log(`Shared movie stopped data received: ${e.notification}`);let i=null==(t=this._conversation)?void 0:t.externalId,{initiatorId:n,movieId:r,source:a,roomId:s=null}=e,o={initiatorId:n,movieId:r,source:a};if(this._isMe(n))Ii.onLocalSharedMovieStoppedInfo(i,o,s);else{let e=yield this._getExternalIdByParticipantId(n);e&&Ii.onRemoteSharedMovieStoppedInfo(e,o,s)}}))}_onFeaturesPerRoleChanged(e){Ai.log(`Features per role changed: ${e.notification}`),Ii.onFeaturesPerRoleChanged(e.featuresPerRole)}_waitForStreamIfNeeded(e){var t,i,n;let r=this._matchStreamDescription(e.participantStreamDescription);if(!r||"ANIMOJI"===r.mediaType)return;let a=r.participantId,s=this._participants[a];if(_i.producerScreenDataChannel&&"SCREEN"===r.mediaType&&!e.fastScreenShare)return void Ai.log("skipping participant-sources-update notification since screenshare will be received over datachannel");let o=Ni(r),c=this._sequenceNumberByStreamDescription.get(o);if(c&&c>e.sequenceNumber)return Ai.warn(`Participant ${r.participantId} received outdated PAT response: sequence number ${e.sequenceNumber}; last sent sequence number for given participant is ${c}`),void Ne.log(ce.PAT_OUTDATED_RESPONSE);if(Ai.debug(`participant-sources-update: suspend=${e.suspend}`),void 0!==e.suspend)switch(r.mediaType){case"CAMERA":Ii.onRemoteStreamSuspended(s.externalId,e.suspend);break;case"SCREEN":Ii.onRemoteScreenStreamSuspended(s.externalId,e.suspend);break;default:Ai.log("Unexpected participant-sources-update notification, skipping",e)}let l=e.streamId,u=e.rtpTimestamp?this._getWaitingTime(l,e.rtpTimestamp):0;if(u<=0){this._streamWaitTimerByStreamDescription.delete(o);let r=null==(t=this._conversation)?void 0:t.externalId,c=this._isMe(a);if(!s&&!c)return Ne.log(ce.PAT_ERROR,"participantMissing"),void Ai.error(`Could not find participant by ID: ${a}`);let u=c?r:s.externalId,d=this._streamByStreamId.get(l);if(!d)return Ne.log(ce.PAT_ERROR,"streamNotFound"),void Ai.error(`Could not find stream by ID: ${l}`);Ne.log(ce.PAT_ALLOCATED),this._streamIdByStreamDescription.set(o,l);let h=null==(i=e.participantStreamDescription)?void 0:i.mediaType;if("STREAM"===h||"MOVIE"===h){if(null!=(n=e.participantStreamDescription)&&n.streamName){let t={streamName:e.participantStreamDescription.streamName,stream:d,mediaType:h};c?Ii.onLocalLive(u,t):Ii.onRemoteLive(u,t)}}else if(_i.producerScreenTrack&&"SCREEN"===h)Ii.onRemoteScreenStream(s.externalId,d);else if(!c){let e=(_i.producerScreenTrack?null:s.secondStream)||d;Ii.onRemoteStream(s.externalId,e)}}else{Ai.debug(`Waiting for ${u} until stream ${l} for ${o} is switched`);let t=window.setTimeout(this._waitForStreamIfNeeded.bind(this,e),u);this._streamWaitTimerByStreamDescription.set(o,t)}}_matchStreamDescription(e){if(!e)return null;if(this._streamIdByStreamDescription.has(Ni(e)))return e;let t=e.participantId;if(e.mediaType){let e={participantId:t,mediaType:null};if(this._streamIdByStreamDescription.has(Ni(e)))return e}else{let e={participantId:t,mediaType:"CAMERA"};if(this._streamIdByStreamDescription.has(Ni(e)))return e;let i={participantId:t,mediaType:"SCREEN"};if(this._streamIdByStreamDescription.has(Ni(i)))return i}return Ai.error("Received unrequested allocation",e),null}_getWaitingTime(e,t){if(this._transport)return this._transport.getStreamWaitingTimeMs(e,t);throw new Error("transport is not initialized")}_isCallAdmin(){return!!this._conversation&&it.includesOneOf(this._conversation.roles,[_e.ADMIN,_e.CREATOR])}_checkAdminRole(){if(this._conversation&&!it.includesOneOf(this._conversation.roles,[_e.ADMIN,_e.CREATOR]))throw new Error("You don't have the required permission")}grantRoles(e,t,i){return E(this,null,(function*(){this._checkAdminRole(),yield this._signaling.grantRoles(e,t,i)}))}startAsr(e){return E(this,null,(function*(){yield this._signaling.startAsr(e)}))}stopAsr(e){return E(this,null,(function*(){yield this._signaling.stopAsr(e)}))}requestAsr(e){return E(this,null,(function*(){yield this._signaling.requestAsr(e)}))}muteParticipant(){return E(this,arguments,(function*(e=null,t,i=[],n=null){this._checkAdminRole(),yield this._signaling.muteParticipant(e,t,i,n)}))}enableFeatureForRoles(e,t){return E(this,null,(function*(){yield this._signaling.enableFeatureForRoles(e,t)}))}pinParticipant(e,t){return E(this,arguments,(function*(e,t,i=null){var n;this._checkAdminRole(),yield this._signaling.pinParticipant(e,t,i),null==(n=this._conversation)||n.pinnedParticipantIdByRoom.set(i,t?null:e)}))}updateMediaModifiers(e){return E(this,null,(function*(){this._signaling.ready&&this._conversation&&(this._conversation.mediaModifiers=e,yield this._signaling.updateMediaModifiers(e))}))}changeOptions(e){return E(this,null,(function*(){if(this._signaling.ready&&this._conversation){this._checkAdminRole(),yield this._signaling.changeOptions(e);let t=function(e,t){let i=new Set(e);for(let[e,n]of Object.entries(t))n?i.add(e):i.delete(e);return Array.from(i)}(this._conversation.options,e);this._onOptionsChanged(t)}}))}getWaitingHall(e,t,i){return E(this,null,(function*(){if(!this._signaling)return Promise.reject();let n=null;e&&(n=function(e){try{return JSON.parse(atob(e))}catch(t){Ai.warn("WaitingParticipant: failed convert from string",e,t)}return null}(e));let r=yield this._signaling.getWaitingHall(n,t,i);if(r.error)return Promise.reject(r.message);let a=r.participants||[],s=yield this._resolveExternalIds(a),o=null;return a.length&&r.hasMore&&(o=function(e){try{return btoa(JSON.stringify(e))}catch(t){Ai.warn("WaitingParticipant: failed convert to string",e,t)}return null}(a[a.length-1].id)),{participants:s,pageMarker:o,totalCount:r.totalCount||0}}))}_resolveExternalIds(e){return E(this,null,(function*(){let t=[];if(e.length){let i=[];e.forEach((e=>{if(e.externalId){let i=Ri.fromSignaling(e.externalId);t.push(i),this._api.cacheExternalId(e.id.id,i)}else i.push(it.decomposeId(e.id.id).id)})),i.length&&!t.length&&(t=yield this._api.getExternalIdsByOkIds(i))}return t}))}getAudienceModeHands(){return E(this,null,(function*(){if(!this._signaling.ready)throw new Error("Signaling is not ready");let e=yield this._signaling.getHandQueue();if(e.error)return Promise.reject(e.message);let t=e.participants||[];return{participants:yield this._resolveExternalIds(t),totalCount:e.totalCount||0}}))}promoteParticipant(e,t){return E(this,null,(function*(){this._signaling&&(yield this._signaling.promoteParticipant(e,t))}))}requestPromotion(e=!1){return E(this,null,(function*(){this._signaling.ready&&(yield this._signaling.requestPromotion(e))}))}acceptPromotion(e=!1){return E(this,null,(function*(){this._signaling.ready&&(yield this._signaling.acceptPromotion(e))}))}chatMessage(e,t=null){return E(this,null,(function*(){this._signaling.ready&&(yield this._signaling.chatMessage(e,t))}))}chatHistory(e){return E(this,null,(function*(){if(this._signaling.ready){let t=yield this._signaling.chatHistory(e);for(let e=t.messages.length-1;e>=0;e--){let i=t.messages[e];yield this._onChatMessage(i)}}}))}customData(e,t=null){return E(this,null,(function*(){this._signaling.ready&&(yield this._signaling.customData(e,t))}))}createJoinLink(){return E(this,null,(function*(){if(this._conversation){let e=(yield this._api.createJoinLink(this._conversation.id)).join_link;if(e)return this._conversation.joinLink=e,e}return Promise.reject()}))}removeJoinLink(){return E(this,null,(function*(){if(!this._conversation||!(yield this._api.removeJoinLink(this._conversation.id)).success)return Promise.reject();delete this._conversation.joinLink}))}addMovie(e){return E(this,arguments,(function*({movieId:e,gain:t,metadata:i}){let n={movieId:e};(t||0===t)&&(n.gain=t),i&&(n.metadata=i);let r=yield this._signaling.addMovie(n);if(r.error)throw new Error(r.error);return{movieId:r.movieId,streamType:r.streamType}}))}updateMovie(e){return E(this,null,(function*(){let t=yield this._signaling.updateMovie(e);if(t.error)throw new Error(t.error)}))}removeMovie(e){return E(this,null,(function*(){let t={movieId:e},i=yield this._signaling.removeMovie(t);if(i.error)throw new Error(i.error)}))}updateRooms(e,t){return E(this,null,(function*(){let i=yield this._signaling.updateRooms(e,t);if(i.error)throw new Error(i.error)}))}activateRooms(e,t){return E(this,null,(function*(){let i=yield this._signaling.activateRooms(e,t);if(i.error)throw new Error(i.error)}))}switchRoom(e,t){return E(this,null,(function*(){let i=yield this._signaling.switchRoom(e,t);if(i.error)throw new Error(i.error)}))}removeRooms(e){return E(this,null,(function*(){let t=yield this._signaling.removeRooms(e);if(t.error)throw new Error(t.error)}))}startStream(){return E(this,arguments,(function*(e=!1,t=null,i=null,n="DIRECT_LINK",r=null,a=null){let s={movieId:i,name:t,privacy:n,groupId:r,roomId:a,streamMovie:!e},o=yield this._signaling.startStream(s);if(o.error)return Promise.reject(o.message)}))}stopStream(){return E(this,arguments,(function*(e=null){if((yield this._signaling.stopStream({roomId:e})).error)return Promise.reject()}))}publishStream(){return E(this,arguments,(function*(e=null){if((yield this._signaling.publishStream({roomId:e})).error)return Promise.reject()}))}recordSetConf(e,t){return E(this,arguments,(function*(e,t,i=!1,n=null){let r=yield this._signaling.recordSetConf({king:e,pawns:t,hideParticipantCount:i,roomId:n});if(r.error)throw new Error(r.error)}))}getStreamInfo(){return E(this,null,(function*(){let e=yield this._signaling.getRecordStatus();return{movieId:e.recordMovieId,preview:e.recordMoviePreviewUrl}}))}setLocalResolution(e){return E(this,arguments,(function*({video:e,effect:t}){var i;if(e.width<_i.videoMinWidth||e.height<_i.videoMinHeight)throw new Error("Sizes received are less than the `videoMinWidth` or `videoMinHeight`");if(t){if(t.width<_i.videoMinWidth||t.height<_i.videoMinHeight)throw new Error("Sizes of effect received are less than the `videoMinWidth` or `videoMinHeight`");_i.videoEffectMaxHeight=t.height,_i.videoEffectMaxWidth=t.width}return _i.videoMaxWidth=e.width,_i.videoMaxHeight=e.height,Ai.debug("Set local video resolution:",`video ${e.width}x${e.height}`+(t?`, effect ${t.width}x${t.height}`:"")),null==(i=this._mediaSource)?void 0:i.setResolution({video:e,effect:t})}))}videoEffect(e){return E(this,null,(function*(){var t;return null==(t=this._mediaSource)?void 0:t.videoEffect(e)}))}getParticipants(e){return E(this,null,(function*(){var t;let i=e.externalIds.map((e=>({id:e.id,type:_i.externalUserType}))),n=yield this._signaling.getParticipants(i);if(n.error)throw new Error(n.error);let r=n.participants,a=null==(t=this._transport)?void 0:t.getState();return Promise.all(r.map((e=>E(this,null,(function*(){var t;let i=it.composeId(e);return this._createParticipant({id:i,externalId:e.externalId&&Ri.fromSignaling(e.externalId,e.deviceIdx||0),mediaSettings:Ue(e.mediaSettings),participantState:it.mapParticipantState(e),state:e.state,roles:e.roles||[],status:null!=(t=this._getStatusByTransportState(a))?t:"WAITING",muteStates:e.muteStates||{},unmuteOptions:e.unmuteOptions||[],observedIds:e.observedIds||[],markers:this._denormalizeMarkers(i,e.markers)})}))))).then(it.mapSharedParticipants)}))}getParticipantListChunk(e){return E(this,null,(function*(){var t;Ai.log("Request participant list chunk",e);let i=yield this._signaling.getParticipantListChunk(e);if(i.error)throw new Error(i.error);let n=this._createParticipantListChunk(i.chunk),r=n.participants.filter((e=>{let t=it.composeId(e);return!this._participants[t]}));yield this._registerParticipants(r);let a=null==(t=this._transport)?void 0:t.getState();return n.participants.forEach((e=>{var t,i;let n=it.composeId(e),r=this._participants[n];r.status=null!=(t=this._getStatusByTransportState(a))?t:"WAITING",r.movieShareInfos=e.movieShareInfos,Object.assign(r.mediaSettings,Ue(e.mediaSettings)),Object.assign(r.muteStates,e.muteStates),r.unmuteOptions=null!=(i=e.unmuteOptions)?i:r.unmuteOptions,this._openTransport([r],!0)})),this._participantListChunkToExternalChunk(n)}))}_getInitialParticiapntListChunk(){return E(this,null,(function*(){let e=_i.participantListChunkInitIndex,t=_i.participantListChunkInitCount,i=yield this._signaling.getParticipantListChunk({listType:"GRID",fromIdx:e,count:t});return Ai.debug("Get initial participant list chunk",i.chunk),i.chunk}))}_onLocalMediaStreamChanged(e){return E(this,null,(function*(){var t,i;this._conversation&&(Ai.debug("Local media stream changed",e.mediaSettings),"audio"===e.kind&&this._mediaSource&&(this._audioFix=new ji(this._mediaSource)),Ii.onLocalStreamUpdate(e.mediaSettings,e.kind),this._signaling.ready&&(null==(t=this._conversation)||!t.waitingHall)&&(null==(i=this._conversation)||!i.observer)&&!this._isAudienceModeListener()&&(yield this._signaling.changeMediaSettings(e.mediaSettings)))}))}_onScreenSharingStatus(e){return E(this,null,(function*(){var t,i;if(Ai.log("Screen sharing changed",e.track,e.mediaSettings),_i.consumerScreenTrack){let n=e.track?new MediaStream([e.track]):null;Ii.onScreenStream(n,e.mediaSettings),this._signaling.ready&&(null==(t=this._conversation)||!t.waitingHall)&&(null==(i=this._conversation)||!i.observer)&&(yield this._signaling.changeMediaSettings(e.mediaSettings))}}))}_changeRemoteMediaSettings(e,t){var i;Ai.debug(`Remote media settings changed [${e}]`,t);let n=null==(i=this._conversation)?void 0:i.externalId;if(this._isMe(e)&&n)return void Ii.onLocalMediaSettings(n,t);let r=this._participants[e];r?(r.mediaSettings=t,"ACTIVE"===this._state&&Ii.onRemoteMediaSettings(r.externalId,t,r.markers),this._specListener&&this._specListener.onChangeRemoteMediaSettings(e,t)):this._warnParticipantNotInConversation(e)}_changeRemoteParticipantState(e,t){Ai.debug(`Remote participant state changed [${e}]`,t);let i=this._participants[e];i?(i.participantState=t||{},"ACTIVE"===this._state&&Ii.onRemoteParticipantState(i.externalId,i.participantState,i.markers)):this._warnParticipantNotInConversation(e)}_invokeRolesChangedCallbackIfNeeded(e){"ACTIVE"===this._state&&e.roles&&e.roles.length&&(Ai.debug(`Roles for participant [${e.id}] changed: ${e.roles}`),Ii.onRolesChanged(e.externalId,e.roles))}_onSignalingNotification(e){switch(e.notification){case se.ACCEPTED_CALL:return this._onAcceptedCall(e);case se.HUNGUP:return this._onHungup(e);case se.PARTICIPANT_ADDED:return this._onAddedParticipant(e);case se.PARTICIPANT_JOINED:return this._onJoinedParticipant(e);case se.CLOSED_CONVERSATION:return this._onClosedConversation(e);case se.MEDIA_SETTINGS_CHANGED:return this._onMediaSettingsChanged(e);case se.PARTICIPANT_STATE_CHANGED:return this._onParticipantStateChanged(e);case se.RATE_CALL_DATA:return this._onNeedRate();case se.FEATURE_SET_CHANGED:return this._onFeatureSetChanged(e);case se.MULTIPARTY_CHAT_CREATED:return this._onMultipartyChatCreated(e);case se.FORCE_MEDIA_SETTINGS_CHANGE:return this._onForceMediaSettingsChange(e);case se.SETTINGS_UPDATE:return this._onSettingsUpdate(e);case se.VIDEO_QUALITY_UPDATE:return this._onVideoQualityUpdate(e);case se.REGISTERED_PEER:return this._onPeerRegistered(e);case se.SWITCH_MICRO:return this._onMicSwitched(e);case se.CHAT_MESSAGE:return this._onChatMessage(e);case se.CUSTOM_DATA:return this._onCustomData(e);case se.RECORD_STARTED:return this._onRecordInfo(e.recordInfo,e.roomId);case se.RECORD_STOPPED:return this._onRecordInfo(null,e.roomId);case se.ROLES_CHANGED:return this._onRolesChanged(e.participantId,e.roles||[]);case se.MUTE_PARTICIPANT:return this._onMuteParticipant(e);case se.PIN_PARTICIPANT:return this._onPinParticipant(e.participantId,e.unpin,e.markers,e.roomId);case se.OPTIONS_CHANGED:return this._onOptionsChanged(e.options||[]);case se.PARTICIPANT_SOURCES_UPDATE:return this._onParticipantSourcesUpdate(e);case se.PROMOTE_PARTICIPANT:return this._onParticipantPromoted(e);case se.CHAT_ROOM_UPDATED:return this._onChatRoomUpdated(e.eventType,e.totalCount,e.firstParticipants,e.addedParticipantIds,e.removedParticipantIds);case se.JOIN_LINK_CHANGED:return this._onJoinLinkChanged(e);case se.FEEDBACK:return this._onFeedback(e);case se.MOVIE_UPDATE_NOTIFICATION:return this._onSharedMovieUpdate(e);case se.MOVIE_SHARE_STARTED:return this._onSharedMovieInfoStarted(e);case se.MOVIE_SHARE_STOPPED:return this._onSharedMovieInfoStopped(e);case se.ROOMS_UPDATED:return this._onRoomsUpdated(e);case se.ROOM_UPDATED:return this._onRoomUpdated(e);case se.ROOM_PARTICIPANTS_UPDATED:return this._onRoomParticipantsUpdated(e);case se.FEATURES_PER_ROLE_CHANGED:return this._onFeaturesPerRoleChanged(e);case se.PARTICIPANT_ANIMOJI_CHANGED:return this._onParticipantAnimojiChanged(e);case se.ASR_STARTED:return this._onAsrStart(e);case se.ASR_STOPPED:return this._onAsrStop(e);case se.PROMOTION_APPROVED:return this._onPromotionApproved(e)}}_onPromotionApproved(e){return E(this,null,(function*(){let t=yield this._getParticipantId(e.adminId);Ii.onPromotionApproved(t)}))}_onSignalingReconnect(e){return E(this,null,(function*(){if(!this._conversation)return;e.conversation.acceptTime&&(this._conversation.acceptTime=e.conversation.acceptTime),e.conversation.participantsLimit&&(this._conversation.participantsLimit=e.conversation.participantsLimit),e.conversation.features&&(this._conversation.features=e.conversation.features,this._conversation.featuresPerRole=e.conversation.featuresPerRole,this._changeFeatureSet()),this._processPinnedParticipants(e),e.conversation.state;let t=null;if(e.conversation.participants){let i=Object.keys(this._participants),n=[];for(let i of e.conversation.participants){let e=it.composeId(i),r=i.roles||[];if(this._isMe(e)){t=Ue(i.mediaSettings),me(this._conversation.roles,r)||this._onRolesChanged(e,r);continue}n.push(e);let a=this._participants[e];if(a){let t=Ue(i.mediaSettings);xe(t,a.mediaSettings)||this._changeRemoteMediaSettings(e,t);let n=it.mapParticipantState(i),s=a.participantState;it.isEqualParticipantState(n,s)||this._changeRemoteParticipantState(e,n),me(r,a.roles)||this._onRolesChanged(a.id,r)}else yield this._onJoinedParticipant({participantId:i.id,participant:i,mediaSettings:i.mediaSettings})}for(let e of i)n.indexOf(e)<0&&this._removeParticipant(this._participants[e],K.HUNGUP)}this._onMuteParticipant({muteStates:e.conversation.muteStates||{},unmuteOptions:e.unmuteOptions,mediaOptions:[]},t),this._processRecordInfos(e),this._onOptionsChanged(e.conversation.options)}))}_onSignalingFailed(e){Ai.error("Signaling failed",e),this._close(e)}_onAcceptedCall(e){return E(this,null,(function*(){var t;let i=it.composeMessageId(e),n=it.getPeerIdString(e.peerId);if(Ai.debug(`Participant accepted call [${i}]`),this._statFirstMediaReceived.markAcceptedCall(null==(t=this._transport)?void 0:t.getTopology()),this._conversation&&this._isMe(i))return void this._close(new Be(K.MISSED),"Call accepted on other device");let r=this._participants[i];r||(r=this._registerParticipantInCache(yield this._createParticipant({id:i,mediaSettings:Ue(e.mediaSettings)}))),r.state=Z.ACCEPTED,r.mediaSettings=Ue(e.mediaSettings),this._logWithMediaSettings(ce.ACCEPTED_OUTGOING,r.mediaSettings),this._conversation&&this._conversation.direction===w.OUTGOING&&("IDLE"===this._state||"PROCESSING"===this._state)&&(this._state="ACTIVE",this._changeFeatureSet()),"ACTIVE"===this._state&&this._transport&&this._transport.open([r.id],n),this._changeRemoteMediaSettings(i,r.mediaSettings),this._changeRemoteParticipantState(i)}))}_onHungup(e){return E(this,null,(function*(){Ai.debug(`Participant hungup [${e.participantId}]`,{reason:e.reason});let t=it.composeMessageId(e);if(this._conversation&&this._isMe(t))return void this._close(new Be(e.reason,{remote:!0}));yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers);let i=this._participants[t];i?(this._transport&&this._transport.close(t),i.state=e.reason===K.REJECTED?Z.REJECTED:Z.HUNGUP,"CLOSE"!==this._state&&this._removeParticipant(i,K.HUNGUP)):this._warnParticipantNotInConversation(t)}))}_onAddedParticipant(e){return E(this,null,(function*(){var t,i;Ai.debug(`Participant added [${e.participantId}]`);let n=it.composeMessageId(e),r=this._participants[n];r&&r.state!==Z.HUNGUP&&r.state!==Z.REJECTED?Ai.debug(`Participant [${n}] is already in conversation and is active`):(r||(r=this._registerParticipantInCache(yield this._createParticipant({id:n,externalId:e.participant.externalId&&Ri.fromSignaling(e.participant.externalId,e.participant.deviceIdx||0),mediaSettings:Ue(e.participant.mediaSettings),state:e.participant.state,participantState:it.mapParticipantState(e.participant),roles:e.participant.roles||[],muteStates:e.participant.muteStates||{},unmuteOptions:e.participant.unmuteOptions||[],observedIds:e.participant.observedIds||[]}))),r.state=Z.CALLED,r.mediaSettings=Ue(null==(t=e.participant)?void 0:t.mediaSettings),r.participantState=it.mapParticipantState(e.participant),r.roles=(null==(i=e.participant)?void 0:i.roles)||[],this._setParticipantsStatus([r],"WAITING"),"IDLE"!==this._state&&this._transport&&this._transport.allocate(r.id,!0),Ii.onParticipantAdded(r.externalId,r.markers),this._changeRemoteMediaSettings(n,r.mediaSettings),this._changeRemoteParticipantState(n,r.participantState),this._invokeRolesChangedCallbackIfNeeded(r))}))}_onJoinedParticipant(e){return E(this,null,(function*(){var t,i,n;Ai.debug(`Participant joined [${e.participantId}]`),this._statFirstMediaReceived.markParticipantJoined(null==(t=this._transport)?void 0:t.getTopology());let r=it.composeMessageId(e),a=this._participants[r];a&&a.state===Z.ACCEPTED?Ai.warn(`Participant [${r}] is already in conversation and is active`):(a||(a=this._registerParticipantInCache(yield this._createParticipant({id:r,externalId:e.participant.externalId&&Ri.fromSignaling(e.participant.externalId,e.participant.deviceIdx||0),mediaSettings:Ue(e.participant.mediaSettings),state:e.participant.state,participantState:it.mapParticipantState(e.participant),roles:e.participant.roles||[],muteStates:e.participant.muteStates||{},movieShareInfos:e.participant.movieShareInfos,unmuteOptions:e.participant.unmuteOptions||[],observedIds:e.participant.observedIds||[],markers:this._denormalizeMarkers(r,e.participant.markers)}))),this._conversation&&this._conversation.direction===w.OUTGOING&&("IDLE"===this._state||"PROCESSING"===this._state)&&(this._state="ACTIVE",this._changeFeatureSet()),a.state=Z.ACCEPTED,a.mediaSettings=Ue(e.mediaSettings),a.participantState=it.mapParticipantState(e.participant),a.roles=e.participant.roles||[],null!=(i=this._transport)&&i.isAllocated(a.id)?this._setParticipantsStatus([a],"CONNECTED"):this._setParticipantsStatus([a],"WAITING"),"IDLE"!==this._state&&this._transport&&(this._transport.isAllocated(a.id)||this._transport.allocate(a.id,!0),this._transport.open([a.id],null,!(null==(n=this._conversation)||!n.observer))),Ii.onParticipantJoined(a.externalId,a.markers),this._changeRemoteMediaSettings(r,a.mediaSettings),this._changeRemoteParticipantState(r,a.participantState),this._invokeRolesChangedCallbackIfNeeded(a),Ii.onMuteStates(a.muteStates,a.unmuteOptions,Object.keys(a.muteStates),!1,!1,a.externalId,void 0,!0),yield this._processSharedMovieInfos(a.movieShareInfos))}))}_onClosedConversation(e){this._toggleJoinAvailability(),this._close(new Be(e.reason,{remote:!0}))}_onMediaSettingsChanged(e){return E(this,null,(function*(){let t=it.composeMessageId(e);yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers),this._changeRemoteMediaSettings(t,Ue(e.mediaSettings))}))}_onParticipantStateChanged(e){return E(this,null,(function*(){let t=it.composeMessageId(e);this._isMe(t)||(yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers),this._changeRemoteParticipantState(t,it.mapParticipantState(e)))}))}_onNeedRate(){this._conversation&&(this._conversation.needRate=!0,this._changeNeedRate())}_onFeatureSetChanged(e){this._conversation&&(this._conversation.features=e.features,this._conversation.featuresPerRole=e.featuresPerRole,this._changeFeatureSet())}_onMultipartyChatCreated(e){this._conversation&&(this._conversation.chatId=e.chatId,this._toggleJoinAvailability(),Ii.onMultipartyChatCreated(this._conversation))}_onForceMediaSettingsChange(e){return E(this,null,(function*(){if(!this._mediaSource)return;let t=this._mediaSource.getMediaSettings(),i=Ue(e.mediaSettings);t.isAudioEnabled!==i.isAudioEnabled&&(yield this._mediaSource.toggleAudio(i.isAudioEnabled)),t.isVideoEnabled!==i.isVideoEnabled&&(yield this._mediaSource.toggleVideo(i.isVideoEnabled)),_i.consumerScreenTrack&&t.isScreenSharingEnabled!==i.isScreenSharingEnabled&&(yield this._mediaSource.toggleScreenCapturing({captureScreen:i.isScreenSharingEnabled,fastScreenSharing:i.isFastScreenSharingEnabled,captureAudio:i.isAudioSharingEnabled}))}))}_onSettingsUpdate(e){Ai.debug("Got settings update notification",e);let t={camera:e.camera,screenSharing:e.screenSharing};this._serverSettings=Vi(this._serverSettings,t),this._transport&&this._transport.updateSettings(this._serverSettings)}_onVideoQualityUpdate(e){Ai.debug("Got video quality update notification",e);let t=Math.round(e.quality.maxBitrate/1024),i=e.quality.maxDimension,n={camera:Object.assign({},this._serverSettings.camera,{maxBitrateK:t,maxDimension:i}),screenSharing:null};this._serverSettings=Vi(this._serverSettings,n),this._transport&&this._transport.updateSettings(this._serverSettings)}_onPeerRegistered(e){let t=it.composeMessageId(e);this._participants[t]&&(this._participants[t].clientType=e.clientType,this._participants[t].platform=e.platform)}_onMicSwitched(e){return E(this,null,(function*(){Ii.onDeviceSwitched(z.AUDIO,!e.mute),yield this.toggleLocalAudio(!e.mute)}))}_onChatMessage(e){return E(this,null,(function*(){let t,i=it.composeMessageId(e);t=this._participants[i]?this._participants[i].externalId:yield this._getParticipantId(i),Ii.onChatMessage(e.message,t,e.direct)}))}_onCustomData(e){return E(this,null,(function*(){if(e.data.hasOwnProperty("sdk"))return;let t,i=it.composeMessageId(e);t=this._participants[i]?this._participants[i].externalId:yield this._getParticipantId(i),Ii.onCustomData(e.data,t,e.direct)}))}_onRecordInfo(e){return E(this,arguments,(function*(e,t=null){if(!this._conversation)return;let i=this._conversation.recordsInfoByRoom.get(t),n=!1;if(!i!=!e?n=!0:i&&e&&(n=i.recordMovieId!==e.recordMovieId||i.recordStartTime!==e.recordStartTime),n)if(this._conversation.recordsInfoByRoom.set(t,e),e){let i=yield this._getParticipantId(e.initiator);Ii.onRecordStarted(i,e.recordMovieId,e.recordStartTime,e.recordType,e.recordExternalMovieId,e.recordExternalOwnerId,t)}else Ii.onRecordStopped(t);e&&this._forceOpenTransportForAloneInCall()}))}_changePinnedParticipantForRoom(){return E(this,null,(function*(){if(!this._conversation)return;let e=this._conversation.roomId,t=this._conversation.pinnedParticipantIdByRoom.get(e);if(t&&!this._isMe(t)){let i=yield this._getExternalIdByParticipantId(t);i&&Ii.onPinnedParticipant(i,!1,null,e)}}))}_changeRecordInfoForRoom(){return E(this,null,(function*(){if(!this._conversation)return;let e=this._conversation.roomId,t=this._conversation.recordsInfoByRoom.get(e);if(t){let i=yield this._getParticipantId(t.initiator);Ii.onRecordStarted(i,t.recordMovieId,t.recordStartTime,t.recordType,t.recordExternalMovieId,t.recordExternalOwnerId,e)}else Ii.onRecordStopped(e)}))}_changeAsrInfoForRoom(){return E(this,null,(function*(){if(!this._conversation)return;let e=this._conversation.roomId,t=this._conversation.asrInfoByRoom.get(e);if(t){let i=yield this._getExternalIdByParticipantId(t.initiatorId);i&&Ii.onAsrSet({externalId:i,movieId:t.movieId},e)}else Ii.onAsrSet(null,e)}))}_onParticipantAnimojiChanged(e){return E(this,null,(function*(){if(this._conversation){let t=yield this._getParticipantId(e.participantId);Ii.onParticipantVmojiUpdate(t)}}))}_onAsrStart(e){return E(this,null,(function*(){if(!this._conversation)return;let t=e.asrInfo,i=e.roomId||null;this._conversation.asrInfoByRoom.set(i,t);let n=yield this._getParticipantId(t.initiatorId);Ii.onAsrStarted(n,t.movieId,i),this._forceOpenTransportForAloneInCall()}))}_onAsrStop(e){if(!this._conversation)return;let t=e.roomId||null;this._conversation.asrInfoByRoom.delete(t),Ii.onAsrStopped(t)}_onAsrTranscription(e){return E(this,null,(function*(){if(!this._conversation)return;let t=yield this._getParticipantId(e.participantId);Ii.onAsrTranscription(t,e.text,e.timestamp,e.duration)}))}_onRolesChanged(e,t){if(this._conversation&&this._isMe(e)&&!me(this._conversation.roles,t))return Ai.debug(`Local roles changed: ${t}`),this._conversation.roles=t,Ii.onLocalRolesChanged(t),this._processMuteState({mediaOptions:Fi(this._getMuteStatesForCurrentRoom(),Y.MUTE_PERMANENT),stateUpdated:!0}),void(it.includesOneOf(t,[_e.ADMIN,_e.CREATOR])?this._refreshRooms(!0):t.length||this._onRoomSwitched(null));let i=this._participants[e];i&&!me(i.roles,t)&&(Ai.debug(`Roles for participant [${e}] changed: ${t}`),i.roles=t,Ii.onRolesChanged(i.externalId,t))}_onMuteParticipant(e,t=null){return E(this,null,(function*(){var i;if(!this._conversation)return;let n=null!=(i=e.roomId)?i:null,r=e.muteStates||{},a=e.unmuteOptions||[],s=e.mediaOptions||[],o=e.adminId?this._participants[e.adminId]:null;if(e.participantId&&!this._isMe(e.participantId)){if(!this._isCallAdmin())return void Ai.warn(`Not admin got mute states for participant [${e.participantId}]`);let t=this._participants[e.participantId];return void(t&&(Ai.debug(`Mute states for participant [${e.participantId}] changed`,r),Ii.onMuteStates(r,a,s,e.muteAll,e.unmute,t.externalId,null==o?void 0:o.externalId,e.stateUpdated,e.requestedMedia,e.roomId)))}let c=this._getMuteStatesForRoomId(n);if(!it.isObjectsEquals(c,r)||!it.isArraysEquals(this._conversation.unmuteOptions,a)||s.length){if(this._setMuteStatesForRoomId(r,n),this._conversation.unmuteOptions=a,e.adminId&&this._isMe(e.adminId))return void(e.muteAll&&Ii.onMuteStates(r,a,s,e.muteAll,e.unmute,null,this._conversation.externalId,e.stateUpdated,e.requestedMedia,e.roomId));yield this._processMuteState({mediaOptions:s,muteAll:e.muteAll,unmute:e.unmute,serverSettings:t,admin:o,stateUpdated:e.stateUpdated,requestedMedia:e.requestedMedia,roomId:e.roomId})}}))}_changeMuteStatesForRoom(e,t){if(!this._conversation)return;this._conversation.unmuteOptions=[];let i=this._getMuteStatesForRoomId(t),n=this._getMuteStatesForRoomId(e),r=Object.keys(i),a=Object.keys(n);this._processMuteState({mediaOptions:Array.from(new Set([...r,...a])),roomId:e,muteAll:!0,stateUpdated:!0})}_processMuteState(e){return E(this,arguments,(function*({mediaOptions:e=[],muteAll:t=!1,unmute:i=!1,serverSettings:n=null,admin:r=null,stateUpdated:a,requestedMedia:s,roomId:o=null}){if(!this._conversation||!this._mediaSource||this._participantState!==Z.ACCEPTED)return;let c=Object.assign({},this._getMuteStatesForRoomId(o)),l=this._conversation.unmuteOptions,u=this._mediaSource.getMediaSettings(),d=Object.entries(c);for(let[r,a]of d){let s=_i.newMuteRules&&this._isCallAdmin()&&t;if(!(a!==Y.MUTE&&a!==Y.MUTE_PERMANENT||s)&&(this._isCallAdmin()&&a===Y.MUTE_PERMANENT&&!t&&(c[r]=Y.MUTE),e.includes(r)&&!i))switch(r){case z.VIDEO:u.isVideoEnabled&&(null==n||!n.isVideoEnabled)&&(Ii.onDeviceSwitched(z.VIDEO,!1),yield this.toggleLocalVideo(!1));break;case z.AUDIO:u.isAudioEnabled&&(null==n||!n.isAudioEnabled)&&(Ii.onDeviceSwitched(z.AUDIO,!1),yield this.toggleLocalAudio(!1));break;case z.SCREEN_SHARING:u.isScreenSharingEnabled&&(null==n||!n.isScreenSharingEnabled)&&(Ii.onDeviceSwitched(z.SCREEN_SHARING,!1),yield this.disableScreenCapturing());break;case z.AUDIO_SHARING:u.isAudioSharingEnabled&&(null==n||!n.isAudioSharingEnabled)&&(Ii.onDeviceSwitched(z.AUDIO_SHARING,!1),yield this.toggleScreenCapturing({captureScreen:u.isScreenSharingEnabled,fastScreenSharing:u.isFastScreenSharingEnabled,captureAudio:!1}))}}Ii.onMuteStates(c,l,e,t,i,null,null==r?void 0:r.externalId,a,s,o)}))}_onPinParticipant(e){return E(this,arguments,(function*(e,t=!1,i,n=null){if(!this._conversation)return;let r=this._conversation.pinnedParticipantIdByRoom.get(n);if(r&&r!==e)if(this._isMe(r))Ii.onLocalPin(!0,n);else{let t=yield this._getExternalIdByParticipantId(r);t&&Ii.onPinnedParticipant(t,!0,this._denormalizeMarkers(e,i),n)}if(this._isMe(e))Ii.onLocalPin(t,n);else{let r=yield this._getExternalIdByParticipantId(e);r&&Ii.onPinnedParticipant(r,t,this._denormalizeMarkers(e,i),n)}this._conversation.pinnedParticipantIdByRoom.set(n,t?null:e)}))}_onOptionsChanged(e){this._conversation&&!function(e,t){if(e.length!==t.length)return!1;for(let i of e)if(!t.includes(i))return!1;return!0}(this._conversation.options,e)&&(this._conversation.options=e,Ii.onOptionsChanged(e))}_onNetworkStatus(e){if(this._conversation){let t=[];for(let[i,n]of Object.entries(e)){let e;if(this._isMe(i)||""===i)e=this._conversation.networkRating;else{if(!this._participants[i])continue;e=this._participants[i].networkRating}if(e!==n)if(this._isMe(i)||""===i)this._conversation.networkRating=n,Ii.onLocalNetworkStatusChanged(n);else{let e=this._participants[i];e.networkRating=n,t.push({uid:e.externalId,rating:n})}}if(0===t.length)return;Ai.log("Received network status update: ",e),Ii.onNetworkStatusChanged(t)}}_onRemoteStreamSecond(e,t){let i=this._participants[e];if(i){if(_i.producerScreenTrack)return void Ii.onRemoteScreenStream(i.externalId,t);if(i.secondStream=t,_i.videoTracksCount>0){let t=e;if(!this._streamIdByStreamDescription.has(t))return void Ai.error("Received remote stream notification for a participant that has no track associated with it",t);let n=this._streamIdByStreamDescription.get(t);if(!n||this._streamWaitTimerByStreamDescription.has(t))return void Ai.log("Delaying secondary stream start/stop until main stream becomes available",t);let r=this._streamByStreamId.get(n);if(!r)return Ne.log(ce.PAT_ERROR,"streamNotFound"),void Ai.error(`Could not find stream by ID: ${n}`);Ii.onRemoteStream(i.externalId,i.secondStream||r)}else{let e=t||i.remoteStream;e&&Ii.onRemoteStream(i.externalId,e)}}}_onAnimojiStream(e,t){if(this._isMe(e)&&this._mediaSource)return void Ii.onVmojiStream(t,this._mediaSource.getMediaSettings());let i=this._participants[e];i&&Ii.onRemoteVmojiStream(i.externalId,t)}_onPeerConnectionClosed(e){"SERVER"===e&&this._cleanupParticipantAgnosticStreams()}_changeFeatureSet(){if(this._conversation){let e="ACTIVE"===this._state,t=this._conversation.features.includes(M.ADD_PARTICIPANT);Ii.onCallState(e,t,this._conversation)}}_changeNeedRate(){this._conversation&&this._conversation.needRate&&Ii.onRateNeeded()}_onVolumesDetected(e){let t=[];for(let[i,n]of Object.entries(e)){let e=this._participants[i];e&&e.externalId&&t.push({uid:e.externalId,volume:n.real})}Ii.onVolumesDetected(t)}_onSpeakerChanged(e){this._activeSpeakerId=e,this._participants[e]&&this._lastSignalledActiveSpeakerId!==e&&(Ii.onSpeakerChanged(this._participants[e].externalId),this._lastSignalledActiveSpeakerId=e)}_onTransportStateChanged(e,t){return E(this,null,(function*(){Ai.debug(`Transport state has changed: ${t}`,e);let i=this._getStatusByTransportState(t);if(!i)return;let n=e.reduce(((e,i)=>{if(i in this._participants){let n=this._participants[i];e.push(n),"CONNECTED"===t&&(n.remoteStream||(n.mediaSettings&&this._changeRemoteMediaSettings(i,n.mediaSettings),this._changeRemoteParticipantState(i,n.participantState)),this._updateDisplayLayoutFromCache(i))}else this._warnParticipantNotInConversation(i);return e}),[]);n.length&&this._setParticipantsStatus(n,i)}))}_onTransportLocalStateChanged(e){return E(this,null,(function*(){var t;if(Ai.debug(`Local transport state has changed: ${e}`),"CONNECTED"===e&&(Ii.onLocalStatus("CONNECTED"),"SERVER"===(null==(t=this._transport)?void 0:t.getTopology()))){let e=Object.values(this._myLastRequestedLayouts);yield this.updateDisplayLayout(e)}"CONNECTING"===e&&Ii.onLocalStatus("CONNECTING"),"RECONNECTING"===e&&Ii.onLocalStatus("RECONNECT"),"FAILED"===e&&this._transport&&0===this._transport.allocated().length&&(this._signaling.ready&&(yield this._signaling.hangup(K.FAILED)),this._close(new Be(K.FAILED),"Transport failed"))}))}_onRemoteTrackAdded(e,t,i){return E(this,null,(function*(){if(e.endsWith(ue.AUDIO_MIX))Ai.debug("Remote audio mix track added"),this._audioOutput.add(i),Ii.onRemoteMixedAudioStream(t);else if(e.startsWith(ue.PARTICIPANT_AGNOSTIC_TRACK_PREFIX))Ai.debug(`Participant-agnostic track added: ${e}`),this._streamByStreamId.set(e,t);else{Ai.debug(`Remote track added on the participant [${e}]`,{kind:i.kind});let n=this._participants[e];if(n||(Ai.warn(`Conversation: track added before participant [${e}]`),n=this._registerParticipantInCache(yield this._createParticipant({id:e})),this._setParticipantsStatus([n],"WAITING"),this._activeSpeakerId===e&&this._lastSignalledActiveSpeakerId!==e&&(Ii.onSpeakerChanged(n.externalId),this._lastSignalledActiveSpeakerId=e)),this._transport&&!this._transport.isAllocated(n.id)&&this._transport.allocate(n.id,!1),"audio"===i.kind&&(this._audioOutput.add(i),_i.preserveAudioTracks||t.removeTrack(i)),n.remoteStream!==t){if(n.remoteStream=t,n.secondStream)return;Ii.onRemoteStream(n.externalId,t)}n.mediaSettings&&this._changeRemoteMediaSettings(e,n.mediaSettings)}}))}_onRemoteTrackRemoved(e,t,i){switch(Ai.debug(`[${e}] remote track (removed)`,{track:i}),i.kind){case"audio":this._removeAudioTrack(e,t,i);break;case"video":case"screen":this._removeVideoTrack(e,t,i)}}_removeAudioTrack(e,t,i){if(e!==ue.AUDIO_MIX){let i=this._participants[e];if(!i||i.remoteStream&&i.remoteStream!==t)return}this._audioOutput.remove(i)}_removeVideoTrack(e,t,i){}_onTopologyChanged(e){"DIRECT"===e&&(this._onRemoteSignalledStall([]),this._onAudioMixStall(!1)),this._conversation&&(this._conversation.topology=e,this._changeFeatureSet())}_onAudioMixStall(e){this._audioMixStalled!==e&&(this._audioMixStalled=e,Ai.debug("Audio mix stalled:",e),Ii.onLocalStatus(e?"RECONNECT":"CONNECTED"))}_onRemoteSignalledStall(e){let t={},i=[],n=[];Ai.debug("Participants stalled:",e);for(let n of e){if(t[n]=!0,!this._lastStalled[n]){let e=this._participants[n];e&&i.push(e)}delete this._lastStalled[n]}for(let e of Object.keys(this._lastStalled)){let t=this._participants[e];t&&n.push(t)}i.length&&this._setParticipantsStatus(i,"RECONNECT"),n.length&&this._setParticipantsStatus(n,"CONNECTED"),this._lastStalled=t}_onRemoteDataStats(e){this._debugInfo&&this._debugInfo.onRemoteDataStats(e,this._participants),this._fixAudioDevice(e.outbound.rtps)}_fixAudioDevice(e){var t;!Pt.hasMicrophone()||!this._audioFix||null==(t=this._mediaSource)||!t.getMediaSettings().isAudioEnabled||this._audioFix.fix(e)}_toggleJoinAvailability(){let e=this._conversation&&this._conversation.chatId,t=e&&"CLOSE"!==this._state||!1;e&&(Ai.debug("Toggle join availability",{available:t,chatId:e}),Ii.onJoinStatus(t,e))}_updateDisplayLayoutFromCache(e){return E(this,null,(function*(){var t;if("SERVER"!==(null==(t=this._transport)?void 0:t.getTopology()))return;let i=this._participants[e];i&&i.lastRequestedLayouts&&Object.keys(i.lastRequestedLayouts).length&&(yield this.updateDisplayLayout(Object.values(i.lastRequestedLayouts)))}))}_setParticipantsStatus(e,t,i=null){if(!e.length)return;let n=e.reduce(((e,i)=>(i.status!==t&&(i.status=t,e.push(i.externalId)),e)),[]);n.length&&Ii.onRemoteStatus(n,t,i)}_onJoinLinkChanged(e){Ii.onJoinLinkChanged(e.joinLink)}_onRoomsUpdated(e){return E(this,null,(function*(){var t,i;let n={};for(let r of Object.keys(ee)){let a=e.updates[r];a&&(n[r]={rooms:yield Promise.all((null==(i=null==(t=null==a?void 0:a.rooms)?void 0:t.map)?void 0:i.call(t,this._convertRoomToExternal.bind(this)))||[]),roomIds:null==a?void 0:a.roomIds,deactivated:null==a?void 0:a.deactivated})}Ii.onRoomsUpdated(n)}))}_onRoomUpdated(e){return E(this,null,(function*(){var t,i;let n=yield this._convertRoomToExternal(e.room||null);e.events.some((e=>e===ee.UPDATE))&&(void 0!==e.muteStates&&this._setMuteStatesForRoomId(e.muteStates,e.roomId),void 0!==e.recordInfo&&(null==(t=this._conversation)||t.recordsInfoByRoom.set(e.roomId,e.recordInfo)),void 0!==e.asrInfo&&(null==(i=this._conversation)||i.asrInfoByRoom.set(e.roomId,e.asrInfo))),Ii.onRoomUpdated(e.events,e.roomId,n,e.deactivate||null)}))}_convertRoomToExternal(e){return E(this,null,(function*(){var t,i,n,r,a;if(!e)return null;let s=yield Promise.all((null==(t=e.participantIds)?void 0:t.map((e=>this._getExternalIdByParticipantId(e))))||[]),o=yield Promise.all((null==(i=e.addParticipantIds)?void 0:i.map((e=>this._getExternalIdByParticipantId(e))))||[]),c=yield Promise.all((null==(r=null==(n=e.removeParticipantIds)?void 0:n.map)?void 0:r.call(n,(e=>this._getExternalIdByParticipantId(e))))||[]),l=e.pinnedParticipantId?yield this._getExternalIdByParticipantId(e.pinnedParticipantId):void 0;return{id:e.id,name:e.name,participantCount:e.participantCount,participantIds:s,addParticipantIds:o,removeParticipantIds:c,participants:null!=(a=null==e?void 0:e.participants)&&a.participants?this._participantListChunkToExternalChunk(e.participants):void 0,active:e.active,muteStates:e.muteStates,pinnedParticipantId:l}}))}_onRoomParticipantsUpdated(e){return E(this,null,(function*(){var t,i,n,r,a,s,o,c;let l=null==(t=this._transport)?void 0:t.getState(),u=null!=(i=e.roomId)?i:null,d=(null==(n=e.addedParticipantIds)?void 0:n.map((e=>it.decomposeId(e).id)))||[],h=yield this._api.getExternalIdsByOkIds(d),p=yield Promise.all((null==(r=e.addedParticipants)?void 0:r.map((e=>E(this,null,(function*(){var t;let i=it.composeId(e);return this._createParticipant({id:i,externalId:e.externalId&&Ri.fromSignaling(e.externalId,e.deviceIdx||0),mediaSettings:Ue(e.mediaSettings),participantState:it.mapParticipantState(e),state:e.state,roles:e.roles||[],status:null!=(t=this._getStatusByTransportState(l))?t:"WAITING",muteStates:e.muteStates||{},unmuteOptions:e.unmuteOptions||[],observedIds:e.observedIds||[],markers:this._denormalizeMarkers(i,e.markers)})})))))||[]),_=!1;for(let e of p)e.id===(null==(a=this._conversation)?void 0:a.compositeUserId)&&(_=!0),this._registerParticipantInCache(e);this._openTransport(p,!0);let m=[],f=[];if(null!=e&&e.removedParticipantMarkers){for(let t of e.removedParticipantMarkers)if(null!=(s=t.GRID)&&s.id){let e=this._getExternalIdByParticipantId(t.GRID.id);f.push(e)}m=yield Promise.all(f)}if(_&&(yield this._onRoomSwitched(u)),m){let e=null==(o=this._conversation)?void 0:o.pinnedParticipantIdByRoom.get(u);if(e){let t=yield this._getExternalIdByParticipantId(e);if(t)for(let e of m)if(Ri.compare(t,e)){null==(c=this._conversation)||c.pinnedParticipantIdByRoom.delete(u);break}}}let g={roomId:u,participantCount:e.participantCount,addedParticipantIds:h,addedParticipants:it.mapSharedParticipants(p),removedParticipantMarkers:null==e?void 0:e.removedParticipantMarkers,removedParticipantIds:m};Ii.onRoomParticipantsUpdated(g)}))}_onRoomSwitched(e,t=!1){return E(this,null,(function*(){if(!this._conversation||this._conversation.roomId===e)return;let i=this._conversation.roomId;this._conversation.roomId=e,t?Ii.onRoomStart(e):(Ii.onRoomSwitched(e),null!==e&&!this._isCallAdmin()&&(yield this._refreshRooms(!1)),this._changePinnedParticipantForRoom(),this._changeRecordInfoForRoom(),this._changeMuteStatesForRoom(e,i),this._changeAsrInfoForRoom())}))}_refreshRooms(e){return E(this,null,(function*(){var t,i,n,r,a;let s=null!=(i=null==(t=(yield this._signaling.getRooms(e)).rooms)?void 0:t.rooms)?i:[],o=[];for(let t of s)if(this._setMuteStatesForRoomId(t.muteStates,t.id),null==(n=this._conversation)||n.recordsInfoByRoom.set(t.id,t.recordInfo),null==(r=this._conversation)||r.pinnedParticipantIdByRoom.set(t.id,t.pinnedParticipantId),t.asrInfo&&(null==(a=this._conversation)||a.asrInfoByRoom.set(t.id,t.asrInfo)),e){let e=yield this._convertRoomToExternal(t);e&&o.push(e)}o.length&&Ii.onRoomsUpdated({[ee.UPDATE]:{rooms:o}})}))}_onFeedback(e){return E(this,null,(function*(){let t=[];for(let i of e.feedback){let e=T(y({},i),{items:[]});for(let t of i.items){let i=yield this._getParticipantId(t.participantId);e.items.push(T(y({},t),{participantId:i}))}t.push(e)}Ii.onFeedback(t,e.roomId)}))}_isMe(e){var t;return e===(null==(t=this._conversation)?void 0:t.compositeUserId)}_getMuteStatesForRoomId(e=null){var t,i;return null!=(i=null==(t=this._conversation)?void 0:t.muteStates.get(e))?i:{}}_getMuteStatesForCurrentRoom(){var e;return this._getMuteStatesForRoomId(null==(e=this._conversation)?void 0:e.roomId)}_setMuteStatesForRoomId(e={},t=null){var i;null==(i=this._conversation)||i.muteStates.set(t,e)}_forceOpenTransportForAloneInCall(){var e,t,i;"SERVER"===(null==(e=this._transport)?void 0:e.getTopology())&&"IDLE"===(null==(t=this._transport)?void 0:t.getState())&&this._participantState!==Z.CALLED&&this._transport.open(this._transport.allocated(),null,!(null==(i=this._conversation)||!i.observer),!0)}constructor(e,t,i){super(),this._mediaSource=null,this._conversation=null,this._myLastRequestedLayouts={},this._state="IDLE",this._participantState=Z.CALLED,this._participants={},this._transport=null,this._debugInfo=null,this._volumesDetector=null,this._speakerDetector=null,this._localVolumeDetector=null,this._specListener=null,this._activeSpeakerId=null,this._lastSignalledActiveSpeakerId=null,this._serverSettings={camera:null,screenSharing:null},this._lastStalled={},this._audioMixStalled=!1,this._audioFix=null,this._streamByStreamId=new Map,this._streamIdByStreamDescription=new Map,this._streamWaitTimerByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map,this._cooldownQueueCleanupTimer=null,Ne.create(e,i),qt.create(),this._api=e,this._signaling=t,this._onUnload=()=>{this._conversation&&this._api&&this._api.hangupConversation(this._conversation.id),Ne.destroy(),qt.destroy()},window.addEventListener("unload",this._onUnload),this._audioOutput=new class{add(e){this.destroy(),this._output={},this._output.audioTrack=e,this._initAudioElement()}remove(e){!this._output||this._output.audioTrack!==e||this.destroy()}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this._output&&this._output.audioElement&&(this._output.audioElement.volume=this._volume)}_initAudioElement(){var e,t,i;if(_i.muteMode||null==(e=this._output)||!e.audioTrack)return;let n="Safari"!==Pt.browserName()||Pt.isMobile(),r=document.createElement(n?"audio":"video");r.muted=!1,r.volume=this._volume,r.preload="auto",r.onloadeddata=()=>rn.measure();let a=()=>{Ai.warn("[audio] Error on play audio"),Ii.onAutoplayError()},s=e=>{r.srcObject=new MediaStream([e]),r.load();let t=r.play();t&&t.catch(a)},o=()=>{var e;Ai.debug("[audio] Recover audio playback");let t=null==(e=this._output)?void 0:e.audioTrack;t?s(t):Ai.warn("[audio] Broken audio track")};r.onpause=o,r.onstalled=o,r.onerror=o,s(this._output.audioTrack),this._output.audioElement=r;let c=null==(t=Pt.getSavedOutput())?void 0:t.deviceId;c&&(null==(i=r.setSinkId)||i.call(r,c).catch((e=>{Ai.warn(`[audio] Failed to set output device '${c}'`,e)})))}_stopAudioElement(){var e,t,i;null!=(e=this._output)&&e.audioElement&&(this._output.audioElement.pause(),this._output.audioElement.srcObject=null),null==(i=null==(t=this._output)?void 0:t.audioTrack)||i.stop()}destroy(){this._output&&(this._stopAudioElement(),this._output=null)}changeOutput(){return E(this,null,(function*(){var e,t,i;try{if(!this._features.setSinkId)throw new Error('Feature "setSinkId" is not supported');if(null==(e=this._output)||!e.audioElement)return;let n=Pt.getSavedOutput();n&&(yield null==(i=(t=this._output.audioElement).setSinkId)?void 0:i.call(t,n.deviceId))}catch(e){throw Ne.log(ce.ERROR,"change_output"),Ai.error("[audio] Output change failed",e),e}}))}constructor(){this._output=null,this._volume=1,this._features={setSinkId:!!Audio.prototype.setSinkId}}},_i.videoTracksCount>0&&(this._cooldownQueueCleanupTimer=window.setInterval(this._cleanupCooldownQueue.bind(this),1e3)),this._statFirstMediaReceived=new rn}},hn=dn;hn._delayedHangup=!1;var pn,_n=class extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,_n.prototype),this.participantErrors=t}},mn=null;function fn(e){return E(this,null,(function*(){var t;if("AUTO"!==(null!=e?e:_i.apiEnv))return _i.apiEndpoint(e);try{let e=atob("aHR0cHM6Ly9kbnMuZ29vZ2xlL3Jlc29sdmU/bmFtZT12aWRlby5fZW5kcG9pbnQub2sucnUmdHlwZT1UWFQ="),i=yield(yield fetch(e,{method:"GET",mode:"cors",cache:"no-cache"})).json(),n=null==(t=null==i?void 0:i.Answer[0])?void 0:t.data;if(!n)throw new Error("Wrong DNS response");return Ai.debug("Resolved API endpoint",n),n}catch(t){return Ai.warn("Failed to resolve API endpoint using DNS, default is used",t),_i.apiEndpoint(e)}}))}function gn(){return E(this,null,(function*(){return pn||mn||(mn=fn(),pn=yield mn,mn=null,pn)}))}function vn(e){return E(this,arguments,(function*(e,t={},i=!1){if(!window.Blob||!window.navigator.sendBeacon)return;yield gn();let n=yn(e,t,i),r=new window.Blob([n],{type:"application/x-www-form-urlencoded"});window.navigator.sendBeacon(`${pn}/fb.do`,r)}))}function Sn(e){return E(this,arguments,(function*(e,t={},i=!1,n){return yield gn(),function(e,t){return E(this,null,(function*(){return new Promise(((i,n)=>{let r=new XMLHttpRequest;r.open("POST",`${null!=t?t:pn}/fb.do`,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=()=>{if(r.readyState!==XMLHttpRequest.DONE)return;let e;try{e=JSON.parse(r.responseText)}catch(t){e={result:r.responseText}}200!==r.status||e.hasOwnProperty("error_msg")?n(e):i(e)},r.send(e)}))}))}(yn(e,t,i),n)}))}function yn(e,t={},i=!1){t.method=e,t.format="JSON",t.application_key||(t.application_key=_i.apiKey),i||(hi.sessionKey?t.session_key=hi.sessionKey:hi.accessToken&&(t.access_token=hi.accessToken));for(let[e,i]of Object.entries(t))"object"==typeof i&&(t[e]=JSON.stringify(i));let n="";for(let[e,i]of Object.entries(t))n&&(n+="&"),n+=`${e}=${encodeURIComponent(i)}`;return n}var Tn,En=class extends C{_callUnsafe(e){return E(this,arguments,(function*(e,t={},i=!1){let n=r=>E(this,null,(function*(){try{return yield Sn(e,t,i)}catch(t){if(!t.hasOwnProperty("error_msg")&&(r++,Ai.debug(`${e} network error, attempt ${r}...`),r<10))return yield it.delay(Math.min(700*r,3e3)),n(r);throw Ai.warn(e,"error",t),t}}));return n(0)}))}_call(e){return E(this,arguments,(function*(e,t={},i=!1){try{return yield this._callUnsafe(e,t,i)}catch(n){Ai.warn("Api call error",n);let r=W.API;switch(n.error_code){case 102:case 103:case 104:return yield this.authorize(),this._callUnsafe(e,t,i);case 1101:r=K.SERVICE_DISABLED;break;case 300:r=K.NOT_FOUND;break;case 1102:r=K.CALLEE_IS_OFFLINE;break;case 1103:r=K.NOT_FRIENDS;break;case 1104:case 1106:r=K.EXTERNAL_API_ERROR;break;case 1113:r=K.CALLER_IS_REJECTED}throw new Be(r,{message:n.error_msg,code:n.error_code})}}))}userId(e){return E(this,null,(function*(){let t=it.decomposeParticipantId(e).compositeUserId,i=it.decomposeId(t).id;return hi.isEmpty()?Ri.fromId(String(i)):(this._externalUidsCache.has(i)||(yield this._getExternalIdsByOkIds([i])),Ri.fromString(this._externalUidsCache.get(i)))}))}prepareUserIds(e){return E(this,null,(function*(){if(hi.isEmpty())return;let t=[];for(let i of e)this._externalUidsCache.has(i)||t.push(i);t.length&&(yield this._getExternalIdsByOkIds(t))}))}authorize(){return E(this,null,(function*(){this._ensureUuid();let e={session_data:{version:2,device_id:this._uuid,client_version:_i.appVersion,client_type:"SDK_JS"}};return _i.authToken&&(e.session_data.auth_token=_i.authToken,e.session_data.version=3),this._callUnsafe("auth.anonymLogin",e,!0).then((e=>{e.uid&&(this._userId=Number(e.uid)),hi.sessionKey=e.session_key,hi.sessionSecretKey=e.session_secret_key})).catch((e=>{throw 401===e.error_code&&Ii.onTokenExpired(),new Be(W.AUTH,{message:e.error_msg,code:e.error_code})}))}))}log(e){vn("log.externalLog",{collector:"ok.mobile.apps.video",data:JSON.stringify({application:`${_i.appName}:${_i.sdkVersion}`,platform:_i.platform,items:e})})}init(){!function(){if(!_i.apiKey)throw new Be(W.API,{message:"Required argument apiAppKey not passed"})}()}joinConversation(e,t=!1,i){return E(this,null,(function*(){let n={conversationId:e,isVideo:t,protocolVersion:_i.protocolVersion};return i&&(n.chatId=i),this._call("vchat.joinConversation",n)}))}createConversation(e){return E(this,arguments,(function*(e,t="",i=!1,{onlyAdminCanShareMovie:n,audienceMode:r}={},a){let s=this._preareStartConversationData({conversationId:e,isVideo:!1,joiningAllowed:!0,payload:t,requireAuthToJoin:i,onlyAdminCanShareMovie:n,audienceMode:r,speakerIds:a});return this._startConversation(s)}))}startConversation(e,t,i){return E(this,arguments,(function*(e,t,i,n=!1,r="",a=!1,s=!1,{onlyAdminCanShareMovie:o}={}){let c=this._preareStartConversationData({conversationId:e,isVideo:n,joiningAllowed:a,payload:r,requireAuthToJoin:s,onlyAdminCanShareMovie:o});if(t&&t.length)switch(i){case k.USER:c.uids=t.join(",");break;case k.GROUP:c.gid=t[0];break;case k.CHAT:c.chatId=t[0]}return this._startConversation(c)}))}_ensureUuid(){if(!this._uuid){let e=qe.get("uuid");e||(e=it.uuid(),qe.set("uuid",e)),this._uuid=String(e)}}_preareStartConversationData({conversationId:e,isVideo:t,payload:i="",joiningAllowed:n=!1,requireAuthToJoin:r=!1,onlyAdminCanShareMovie:a,audienceMode:s=!1,speakerIds:o=[]}){let c={conversationId:e,isVideo:t,protocolVersion:_i.protocolVersion};if(n&&(c.createJoinLink=!0),i&&(c.payload=i),_i.domain&&(c.domainId=_i.domain),_i.externalDomain&&(c.externalDomain=_i.externalDomain),r&&(c.requireAuthToJoin=!0),void 0!==a&&(c.onlyAdminCanShareMovie=a),s&&(c.audienceMode=s),o.length){let e=o.map((e=>it.composeUserId(e,ge.USER)));c.speakerIds=e.join(",")}return c}_startConversation(e){return E(this,null,(function*(){return this._call("vchat.startConversation",e)}))}createJoinLink(e){return E(this,null,(function*(){return this._call("vchat.createJoinLink",{conversationId:e})}))}removeJoinLink(e){return E(this,null,(function*(){return this._call("vchat.removeJoinLink",{conversationId:e})}))}getAnonymTokenByLink(e,t){return E(this,null,(function*(){let i={joinLink:e};t&&(i.anonymName=t);let n=yield this._call("vchat.getAnonymTokenByLink",i);return this._userId=Number(n.uid),n.token}))}joinConversationByLink(e,t=!1,i,n){return E(this,null,(function*(){let r={joinLink:e,isVideo:t,protocolVersion:_i.protocolVersion};return null!=i&&i.length&&(r.observedIds=i.join(",")),_i.anonymToken&&(r.anonymToken=_i.anonymToken),n&&(r.payload=n),this._call("vchat.joinConversationByLink",r)}))}getOkIdsByExternalIds(e){return E(this,null,(function*(){let t=[],i=[],n=new Map,r=Array.from(this._externalUidsCache.keys()),a=Array.from(this._externalUidsCache.values());for(let s of e){let e=Ri.toString(s),o=a.indexOf(e);o>-1?t.push(Number(r[o])):(n.set(s.id,e),i.push({id:s.id,ok_anonym:"ANONYM"===s.type}))}return i.length&&(yield this._call("vchat.getOkIdsByExternalIds",{externalIds:i})).ids.forEach(((e,i)=>{let r=Number(e.ok_user_id),a=String(e.external_user_id.id);n.has(a)&&(this._externalUidsCache.set(r,n.get(a)),t.push(r))})),t}))}getParticipantIdsByExternalIds(e){return E(this,null,(function*(){yield this.getOkIdsByExternalIds(e);let t=new Map,i=Array.from(this._externalUidsCache.keys()),n=Array.from(this._externalUidsCache.values());for(let r of e){let e=Ri.toString(r),a=n.indexOf(e);a>-1&&t.set(r,it.composeParticipantId(i[a],ge.USER,r.deviceIdx))}return t}))}getExternalIdsByOkIds(e){return E(this,null,(function*(){let t=[],i=[];for(let n of e)this._externalUidsCache.has(n)?t.push(Ri.fromString(this._externalUidsCache.get(n))):i.push(n);return i.length&&(yield this._getExternalIdsByOkIds(i)).forEach((e=>{t.push(Ri.fromString(e))})),t}))}getCachedOkIdByExternalId(e){let t=Array.from(this._externalUidsCache.keys()),i=Array.from(this._externalUidsCache.values()),n=Ri.toString(e),r=i.indexOf(n);return r>-1?it.composeParticipantId(t[r],ge.USER,e.deviceIdx):null}cacheExternalId(e,t){let i=it.decomposeId(e).id;this._externalUidsCache.set(i,Ri.toString(t))}getConversationParams(e){return E(this,null,(function*(){let t={};return _i.anonymToken&&(t.anonymToken=_i.anonymToken),e&&(t.conversationId=e),this._call("vchat.getConversationParams",t)}))}getUserId(){return this._userId}setUserId(e){this._userId=e}hangupConversation(e){let t={conversationId:e,reason:K.HUNGUP};_i.anonymToken&&(t.anonymToken=_i.anonymToken),vn("vchat.hangupConversation",t)}sendUserFeedbackStats(e,t,i,n){vn("log.externalLog",{collector:"app.vchat.events.product",data:JSON.stringify({application:`${_i.appName}:${_i.sdkVersion}`,platform:_i.platform,items:[{type:1,operation:"UserFeedbackReceived",timestamp:Date.now(),custom:{vcid:e,user_response:t,reason:i,group_call_users_count:n}}]})})}removeHistoryRecords(e){return E(this,null,(function*(){yield this._call("vchat.removeHistoryRecords",{recordIds:e.join(",")})}))}cleanup(){}_getExternalIdsByOkIds(e){return E(this,null,(function*(){let t=new Map;try{let i=yield this._call("vchat.getExternalIdsByOkIds",{uids:e.join(",")}),n=(e,i)=>{for(let[n,r]of Object.entries(e)){let e=Number(n),a=Ri.fromIdToString(r,i);t.set(e,a),this._externalUidsCache.set(e,a)}};i.external_ids&&n(i.external_ids,"USER"),i.anonym_ids&&n(i.anonym_ids,"ANONYM");for(let i of e){let e=Number(i);if(!t.has(e)){let i=Ri.fromId(String(e)),n=Ri.toString(i);t.set(e,n),this._externalUidsCache.set(e,n)}}return t}catch(e){return t}}))}constructor(){super(...arguments),this._userId=null,this._externalUidsCache=new Map}},Cn=((Tn=Cn||{}).RECOVER="recover",Tn.ACCEPT_CALL="accept-call",Tn.ADD_PARTICIPANT="add-participant",Tn.REMOVE_PARTICIPANT="remove-participant",Tn.HANGUP="hangup",Tn.TRANSMIT_DATA="transmit-data",Tn.ACCEPT_PRODUCER="accept-producer",Tn.ALLOCATE_CONSUMER="allocate-consumer",Tn.CHANGE_MEDIA_SETTINGS="change-media-settings",Tn.CHANGE_PARTICIPANT_STATE="change-participant-state",Tn.CHANGE_STREAM_PRIORITIES="change-streams-priorities",Tn.UPDATE_DISPLAY_LAYOUT="update-display-layout",Tn.REPORT_PERF_STAT="report-perf-stat",Tn.REPORT_SHARING_STAT="report-sharing-stat",Tn.RECORD_START="record-start",Tn.RECORD_STOP="record-stop",Tn.RECORD_PUBLISH="record-publish",Tn.RECORD_SET_CONF="record-set-conf",Tn.RECORD_GET_STATUS="record-get-status",Tn.SWITCH_MICRO="switch-micro",Tn.SWITCH_TOPOLOGY="switch-topology",Tn.REQUEST_REALLOC="request-realloc",Tn.CHAT_MESSAGE="chat-message",Tn.CHAT_HISTORY="chat-history",Tn.CUSTOM_DATA="custom-data",Tn.GRANT_ROLES="grant-roles",Tn.MUTE_PARTICIPANT="mute-participant",Tn.ENABLE_FEATURE_FOR_ROLES="enable-feature-for-roles",Tn.PIN_PARTICIPANT="pin-participant",Tn.UPDATE_MEDIA_MODIFIERS="update-media-modifiers",Tn.CHANGE_OPTIONS="change-options",Tn.GET_WAITING_HALL="get-waiting-hall",Tn.GET_PARTICIPANT_LIST_CHUNK="get-participant-list-chunk",Tn.GET_PARTICIPANTS="get-participants",Tn.PROMOTE_PARTICIPANT="promote-participant",Tn.REQUEST_TEST_MODE="request-test-mode",Tn.ADD_MOVIE="add-movie",Tn.UPDATE_MOVIE="update-movie",Tn.REMOVE_MOVIE="remove-movie",Tn.GET_ROOMS="get-rooms",Tn.UPDATE_ROOMS="update-rooms",Tn.ACTIVATE_ROOMS="activate-rooms",Tn.REMOVE_ROOMS="remove-rooms",Tn.SWITCH_ROOM="switch-room",Tn.FEEDBACK="feedback",Tn.ASR_START="asr-start",Tn.ASR_STOP="asr-stop",Tn.REQUEST_ASR="request-asr",Tn.REQUEST_PROMOTION="request-promotion",Tn.ACCEPT_PROMOTION="accept-promotion",Tn.GET_HAND_QUEUE="get-hand-queue",Tn),In=Cn;function bn(){let e=new DataView(new ArrayBuffer(64)),t=0;function i(i){if(t+i>e.byteLength){let n=new Uint8Array(Math.max(t+i,e.byteLength+64));n.set(new Uint8Array(e.buffer.slice(0,t))),e=new DataView(n.buffer)}}return{put(n){if(i(n.byteLength),function(e){return void 0!==e.buffer}(n)){let i=n.buffer;new Uint8Array(e.buffer).set(new Uint8Array(i),t)}else new Uint8Array(e.buffer).set(new Uint8Array(n),t);t+=n.byteLength},putI8(n){i(1),e.setInt8(t,n),++t},putI16(n){i(2),e.setInt16(t,n),t+=2},putI32(n){i(4),e.setInt32(t,n),t+=4},putI64(n){i(8);let r=n<0;r&&(n=-n);let a=n/4294967296|0,s=n%4294967296|0;r&&(s=1+~s|0,a=0===s?1+~a|0:~a),e.setUint32(t,a),e.setUint32(t+4,s),t+=8},putUi8(n){i(1),e.setUint8(t,n),++t},putUi16(n){i(2),e.setUint16(t,n),t+=2},putUi32(n){i(4),e.setUint32(t,n),t+=4},putUi64(n){i(8),e.setUint32(t,n/4294967296|0),e.setUint32(t+4,n%4294967296),t+=8},putF(n){i(8),e.setFloat64(t,n),t+=8},ui8array:()=>new Uint8Array(e.buffer.slice(0,t))}}function Rn(e){let t=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),i=0;return{peek:()=>t.getUint8(i),get(e){i+=e;let n=t.byteOffset;return t.buffer.slice(n+i-e,n+i)},getI8:()=>t.getInt8(i++),getI16:()=>(i+=2,t.getInt16(i-2)),getI32:()=>(i+=4,t.getInt32(i-4)),getI64:()=>(i+=8,4294967296*t.getInt32(i-8)+t.getUint32(i-4)),getUi8:()=>t.getUint8(i++),getUi16:()=>(i+=2,t.getUint16(i-2)),getUi32:()=>(i+=4,t.getUint32(i-4)),getUi64:()=>(i+=8,4294967296*t.getUint32(i-8)+t.getUint32(i-4)),getF32:()=>(i+=4,t.getFloat32(i-4)),getF64:()=>(i+=8,t.getFloat64(i-8))}}var An="open",wn=[()=>_i.producerScreenTrack,()=>_i.videoTracksCount>0,()=>!0,()=>!0,()=>_i.consumerScreenTrack,()=>!0,()=>_i.movieShare,()=>_i.useParticipantListChunk,()=>_i.useRooms,()=>!!_i.vmoji],Pn=["service-unavailable","conversation-ended","invalid-token"],kn=class extends R{static _getCapabilityFlags(){let e=0;for(let t=0;t<wn.length;t++)wn[t]()&&(e|=1<<t);return e.toString(16).toUpperCase()}get ready(){return null!==this.socket}setEndpoint(e){this.endpoint=e}setConversationId(e){this.conversationId=e}setParticipantIdRegistry(e){this.participantIdRegistry=e,this.producerCommandSerializationService.setParticipantIdRegistry(e)}setProducerNotificationDataChannel(e){this.producerNotificationDataChannel=e,this.producerNotificationDataChannel.onmessage=e=>{var t;let i=null==(t=this.participantIdRegistry)?void 0:t.handleMessage(e.data);i&&this._handleMessage(i)}}setProducerCommandDataChannel(e){this.producerCommandDataChannel=e,this.producerCommandDataChannel.onmessage=e=>{this.producerCommandSerializationService.deserializeCommandResponse(e.data).then((e=>{e&&this._handleMessage(e)})).catch((e=>{Ai.warn("[signaling] cannot parse message at producerCommandDataChannel",e)}))},this._handleCommandsQueue(this.datachannelCommandsQueue)}useCommandDataChannel(e){this.producerCommandDataChannelEnabled=e}cleanup(){this.datachannelCommandsQueue=[],this.incomingCache=[]}connect(e){return E(this,null,(function*(){return this.postfix+=`&clientType=${_i.clientType}`,new Promise(((t,i)=>{if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return Ne.log(ce.SOCKET_ACTION,"already_opened"),void i(Error("Socket already opened"));this.conversationResolve=e=>{t(e),this.conversationResolve=null,this.conversationReject=null},this.conversationReject=e=>{i(e),this.conversationResolve=null,this.conversationReject=null},this._connect(e)}))}))}_send(e){return E(this,arguments,(function*(e,t={},i=!0,n=0){if(t.participantId){let e=it.decomposeParticipantId(t.participantId),i=it.decomposeId(e.compositeUserId);t=Object.assign({},t,{participantId:i.id,participantType:i.type}),e.deviceIdx&&(t.deviceIdx=e.deviceIdx)}return this._sendRaw(e,t,i,n)}))}_sendRaw(e){return E(this,arguments,(function*(e,t={},i=!0,n=0){let r=t=>{var i;if(this._isDataChannelCommand(e))this.datachannelCommandsQueue.push(t),(null==(i=this.producerCommandDataChannel)?void 0:i.readyState)===An&&this._handleCommandsQueue(this.datachannelCommandsQueue);else{if(!this.socket)return Ne.log(ce.SOCKET_ACTION,"not_opened"),Ai.warn("[signaling] socket is not opened"),void t.reject(new Error(`Socket not opened [${e}]`),!0);this.socket.readyState>WebSocket.OPEN&&(Ne.log(ce.SOCKET_ACTION,"invalid_state"),Ai.warn(`[signaling] socket is not opened, state ${this.socket.readyState}`)),this.websocketCommandsQueue.push(t),this.socket&&this.socket.readyState===WebSocket.OPEN&&this._handleCommandsQueue(this.websocketCommandsQueue)}};return new Promise(((a,s)=>{let o={sequence:this.sequence++,name:e,params:t,responseTimer:0,needResponse:i,resolve:a,reject:(t,i=!1)=>{!n||i?s(t):(Ai.debug("[signaling] resending a signaling message",e,o.sequence),n--,r(o))}};r(o)}))}))}_isDataChannelCommand(e){return!!this.producerCommandDataChannelEnabled&&(e===In.UPDATE_DISPLAY_LAYOUT||e===In.REPORT_PERF_STAT||e===In.REPORT_SHARING_STAT||e===In.REQUEST_ASR)}getNextCommandSequenceNumber(){return this.sequence}hangup(e){return E(this,null,(function*(){return this._send(In.HANGUP,{reason:e}).catch((()=>{}))}))}sendCandidate(e,t){return E(this,null,(function*(){return this._send(In.TRANSMIT_DATA,{participantId:e,data:{candidate:t}},!1)}))}requestTestMode(e,t){return E(this,null,(function*(){return this._send(In.REQUEST_TEST_MODE,{consumer:e,producer:t})}))}sendSdp(e,t){return E(this,null,(function*(){return this._send(In.TRANSMIT_DATA,{participantId:e,data:{sdp:t}})}))}acceptCall(e){return E(this,null,(function*(){return this._send(In.ACCEPT_CALL,{mediaSettings:e})}))}changeMediaSettings(e){return E(this,null,(function*(){return this._send(In.CHANGE_MEDIA_SETTINGS,{mediaSettings:e},!1,10)}))}changeParticipantState(e){return E(this,null,(function*(){return this._send(In.CHANGE_PARTICIPANT_STATE,{participantState:{state:e}})}))}addParticipant(e,t){return E(this,null,(function*(){return this._send(In.ADD_PARTICIPANT,y({participantId:e},t))}))}removeParticipant(e,t=!1){return E(this,null,(function*(){return this._send(In.REMOVE_PARTICIPANT,{participantId:e,ban:t})}))}allocateConsumer(e,t){return E(this,null,(function*(){let i={capabilities:t};return e&&(i.description=e.sdp),this._send(In.ALLOCATE_CONSUMER,i)}))}acceptProducer(e,t){return E(this,null,(function*(){let i={description:e.sdp};return t&&(i.ssrcs=t),this._send(In.ACCEPT_PRODUCER,i)}))}changePriorities(e){return E(this,null,(function*(){return this._send(In.CHANGE_STREAM_PRIORITIES,{typedPriorities:e}).catch((()=>{}))}))}updateDisplayLayout(e){return E(this,null,(function*(){return this._send(In.UPDATE_DISPLAY_LAYOUT,e)}))}addMovie(e){return E(this,null,(function*(){return this._send(In.ADD_MOVIE,e)}))}updateMovie(e){return E(this,null,(function*(){return this._send(In.UPDATE_MOVIE,e)}))}removeMovie(e){return E(this,null,(function*(){return this._send(In.REMOVE_MOVIE,e)}))}updateRooms(e,t){return E(this,null,(function*(){return this._send(In.UPDATE_ROOMS,{rooms:e,assignRandomly:t})}))}activateRooms(e,t){return E(this,null,(function*(){return this._send(In.ACTIVATE_ROOMS,{roomIds:e,deactivate:t})}))}switchRoom(e,t){return E(this,null,(function*(){return this._sendRaw(In.SWITCH_ROOM,{toRoomId:e,participantId:t})}))}getRooms(e){return E(this,null,(function*(){return this._sendRaw(In.GET_ROOMS,{withParticipants:e})}))}removeRooms(e){return E(this,null,(function*(){return this._send(In.REMOVE_ROOMS,{roomIds:e})}))}startStream(e){return E(this,null,(function*(){return this._send(In.RECORD_START,e)}))}stopStream(){return E(this,arguments,(function*(e={roomId:null}){return this._send(In.RECORD_STOP,e)}))}publishStream(){return E(this,arguments,(function*(e={roomId:null}){return this._send(In.RECORD_PUBLISH,e)}))}recordSetConf(){return E(this,arguments,(function*(e={hideParticipantCount:!1,roomId:null}){var t;let i={options:{hideParticipantCount:e.hideParticipantCount},roomId:e.roomId};return e.king&&(i.king=e.king),null!=(t=e.pawns)&&t.length&&(i.pawns=e.pawns.join(",")),this._send(In.RECORD_SET_CONF,i)}))}getRecordStatus(){return E(this,null,(function*(){return this._send(In.RECORD_GET_STATUS)}))}switchTopology(e,t=!1){return E(this,null,(function*(){return this._send(In.SWITCH_TOPOLOGY,{topology:e,force:t})}))}requestRealloc(){return E(this,null,(function*(){return this._send(In.REQUEST_REALLOC)}))}reportPerfStat(e){return E(this,null,(function*(){return this._send(In.REPORT_PERF_STAT,e)}))}reportSharingStat(e){return E(this,null,(function*(){return this._send(In.REPORT_SHARING_STAT,e,!1)}))}chatMessage(e,t=null){return E(this,null,(function*(){return this._send(In.CHAT_MESSAGE,{message:e,participantId:t})}))}chatHistory(e){return E(this,null,(function*(){return this._send(In.CHAT_HISTORY,{count:e})}))}customData(e,t){return E(this,null,(function*(){return this._send(In.CUSTOM_DATA,{data:e,participantId:t})}))}grantRoles(e,t,i){return E(this,null,(function*(){let n={participantId:e,roles:t};return i&&(n.revoke=!0),this._sendRaw(In.GRANT_ROLES,n)}))}muteParticipant(e,t,i,n=null){return E(this,null,(function*(){return this._sendRaw(In.MUTE_PARTICIPANT,{participantId:e,muteStates:t,requestedMedia:i,roomId:n})}))}enableFeatureForRoles(e,t){return E(this,null,(function*(){return this._sendRaw(In.ENABLE_FEATURE_FOR_ROLES,{feature:e,roles:t})}))}pinParticipant(e,t,i){return E(this,null,(function*(){let n={participantId:e,roomId:i};return t&&(n.unpin=!0),this._sendRaw(In.PIN_PARTICIPANT,n)}))}updateMediaModifiers(e){return E(this,null,(function*(){return this._send(In.UPDATE_MEDIA_MODIFIERS,{mediaModifiers:e})}))}changeOptions(e){return E(this,null,(function*(){return this._send(In.CHANGE_OPTIONS,{options:e})}))}getWaitingHall(e=null,t,i=!1){return E(this,null,(function*(){let n={};return e&&(n.fromId=e),t&&(n.count=t),i&&(n.backward=i),this._send(In.GET_WAITING_HALL,n)}))}promoteParticipant(e,t=!1){return E(this,null,(function*(){let i={participantId:e};return t&&(i.demote=t),this._sendRaw(In.PROMOTE_PARTICIPANT,i)}))}requestPromotion(e=!1){return E(this,null,(function*(){let t={};return e&&(t.demote=e),this._send(In.REQUEST_PROMOTION,t)}))}acceptPromotion(e=!1){return E(this,null,(function*(){let t={};return e&&(t.reject=e),this._send(In.ACCEPT_PROMOTION,t)}))}feedback(e){return E(this,null,(function*(){return this._sendRaw(In.FEEDBACK,{key:e})}))}getHandQueue(){return E(this,null,(function*(){return this._send(In.GET_HAND_QUEUE)}))}close(){this.socket&&this.socket.readyState<WebSocket.CLOSING&&this._closeSocket(),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}readyToSend(e=!0){this.listenersReady=e,this._handleCachedMessages()}getParticipantListChunk(e){return E(this,null,(function*(){return this._send(In.GET_PARTICIPANT_LIST_CHUNK,e)}))}getParticipants(e){return E(this,null,(function*(){return this._send(In.GET_PARTICIPANTS,{externalIds:e})}))}startAsr(e){return E(this,null,(function*(){return this._send(In.ASR_START,e)}))}stopAsr(e){return E(this,null,(function*(){return this._send(In.ASR_STOP,e)}))}requestAsr(e){return E(this,null,(function*(){return this._send(In.REQUEST_ASR,{request:e},!1)}))}_connect(e){if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return;let t="";e&&(t+=`&tgt=${e}`),e===ie.RETRY&&this.lastStamp&&(t+=`&recoverTs=${this.lastStamp}`),t=function(e){if(!_i.useParticipantListChunk)return e;let t=_i.participantListChunkInitIndex;e+=`&partIdx=${t}`;let i=_i.participantListChunkInitCount;return null!==i&&(e+=`&partCount=${i}`),e}(t),Ai.debug("[signaling] connecting to "+this.endpoint+this.postfix+t),Bt(ce.SIGNALING_CONNECTED),this.socket=new WebSocket(this.endpoint+this.postfix+t),this.socket.onopen=this._onOpen.bind(this),this.socket.onmessage=this._onMessage.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this._startDoctor()}_disconnect(e){this.socket&&this.socket.readyState<WebSocket.CLOSING&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.close(e),this.socket=null),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}_onOpen(){Ai.debug("[signaling] socket opened"),Ne.log(ce.SOCKET_ACTION,"opened"),qt.logEventualStat({name:ce.SIGNALING_CONNECTED}),this._waitConnectionMessage(),this._startDoctor()}_onMessage(e){if(this._startDoctor(),"ping"===e.data)return Ii.onSignalingMessage(e.data),void(this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send("pong"));try{let t=JSON.parse(e.data);Ii.onSignalingMessage(t),this._handleMessage(t)}catch(t){Ne.log(ce.SOCKET_ACTION,"parse_error"),Ai.error("[signaling] unable to parse message",t,e.data)}}_handleMessage(e){var t;switch(e.type){case"notification":"connection"===e.notification?(Ai.debug("[signaling] signaling connected",e),this.connected=!0,this.reconnectCount=0,this.endpoint=e.endpoint,e.peerId&&this.peerId!==e.peerId.id&&(this.postfix+=`&peerId=${e.peerId.id}`,this.peerId=e.peerId.id),this._stopWaitConnectionMessage(),this.conversationResolve?this.conversationResolve(e):(this._triggerEvent(re.RECONNECT,e),e.conversation.topology&&this._triggerEvent(re.NOTIFICATION,{type:"notification",notification:se.TOPOLOGY_CHANGED,topology:e.conversation.topology})),this.lastStamp&&this._handleCachedMessages(),null==(t=e.recoverMessages)||t.forEach((e=>this._handleMessage(e))),this._handleCommandsQueue(this.websocketCommandsQueue)):this.connected&&this.listenersReady?this._triggerEvent(re.NOTIFICATION,e):this.incomingCache.push(e);break;case"response":this._handleCommandResponse(!0,e);break;case"error":this._handleErrorMessage(e);break;default:Ne.log(ce.SOCKET_ACTION,"unknown_message"),Ai.warn("[signaling] unhandled message",e)}this.lastStamp=e.stamp||this.lastStamp}_handleErrorMessage(e){var t;Ne.log(ce.SOCKET_ACTION,`error-${e.error}`);let i=!!e.error&&Pn.includes(e.error);switch(Ai.debug(`[signaling] error message [${e.sequence}]`,e),e.sequence&&this.responseHandlers[e.sequence]&&this._handleCommandResponse(!1,e),e.error){case"service-unavailable":this._reconnect();break;case"conversation-ended":this.conversationReject?this.conversationReject(new Be(e.reason||W.SIGNALING_FAILED,{message:`Conversation ended: ${e.error}`,remote:!0})):this._triggerEvent(re.NOTIFICATION,{notification:se.CLOSED_CONVERSATION,reason:e.reason});break;case"invalid-token":this._throwError(new Error(`Signaling error: ${e.error}`));break;default:if(!i)break;this.connected?this._throwError(new Error(`Signaling error: ${e.error}`)):e.sequence||(null==(t=this.conversationReject)||t.call(this,new Be(e.reason||W.SIGNALING_FAILED,{message:`Unable to connect to the signaling: ${e.error}`,remote:!0})),this._closeSocket())}}_handleCachedMessages(){let e=[...this.incomingCache];for(this.incomingCache=[];e.length>0;){let t=e.shift();this._handleMessage(t)}}_throwError(e){this._triggerEvent(re.FAILED,e)}_onError(e){Ne.log(ce.SOCKET_ACTION,"error"),Ai.error("[signaling] signaling error",e)}_onClose(e){Ne.log(ce.SOCKET_ACTION,"closed"),Ai.debug("[signaling] connection closed",{code:e.code,reason:e.reason}),this.connected=!1,this._stopDoctor(),this.socket&&this.reconnectCount++<kn.RECONNECT_MAX_COUNT?this._reconnect():this.socket&&this._closeSocket(new Error("Connection closed"))}_closeSocket(e=null){this.socket&&(this._disconnect(),Object.values(this.responseHandlers).forEach((t=>{window.clearTimeout(t.responseTimer),e&&t.reject(new Error("Connection closed"),!0)})),this.websocketCommandsQueue=[],this.responseHandlers={},this.lastStamp=0,e&&this._throwError(new Error("Connection closed")))}_reconnect(){let e=Math.min(kn.RECONNECT_MAX_DELAY,kn.RECONNECT_DELAY*Math.pow(2,this.reconnectCount-1));Ai.log(`[signaling] reconnect websocket after ${e}ms (${this.reconnectCount})`),Ne.log(ce.SOCKET_ACTION,"reconnect"),this.reconnectTimer=window.setTimeout(this._connect.bind(this,ie.RETRY),e)}_handleCommandResponse(e,t){var i;if(!this.responseHandlers.hasOwnProperty(t.sequence))return;let n=this.responseHandlers[t.sequence];window.clearTimeout(n.responseTimer),Ai.debug(`[signaling] command response [${t.sequence}]`,t),e?(delete this.responseHandlers[t.sequence],n.resolve(t)):"error"===t.type?(delete this.responseHandlers[t.sequence],Ne.log(ce.SOCKET_ACTION,"response-error"),n.reject(new Error(t.error||`Response error [${n.name}]`),!0)):(null==(i=this.socket)?void 0:i.readyState)===WebSocket.OPEN?(delete this.responseHandlers[t.sequence],Ne.log(ce.SOCKET_ACTION,"response-timeout"),n.reject(new Error(t.error||`Response timeout [${n.name}]`))):n.responseTimer=window.setTimeout((()=>this._handleCommandResponse(e,t)),kn.WAIT_RESPONSE_DELAY)}_handleCommandsQueue(e){for(var t,i;e.length>0;){let n=e.shift();if(Ai.debug(`[signaling] command send [${n.sequence}]`,`'${n.name}'`,n.params),this._isDataChannelCommand(n.name)){if((null==(t=this.producerCommandDataChannel)?void 0:t.readyState)!==An)return void n.reject(new Error(`Invalid data channel state: ${null==(i=this.producerCommandDataChannel)?void 0:i.readyState}`));this._startResponseTimer(n);let e=this._serializeBinary(n);null!==e&&this.producerCommandDataChannel.send(e)}else{if(!this.socket||this.socket.readyState!==WebSocket.OPEN){n.reject(new Error("Invalid state or socket already closed"));continue}this._startResponseTimer(n),this.socket.send(this._serializeJson(n))}}}_startResponseTimer(e){e.needResponse&&(e.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,{response:e.name,sequence:e.sequence,type:"timeout"})),kn.WAIT_RESPONSE_DELAY),this.responseHandlers[e.sequence]=e)}_serializeBinary(e){switch(e.name){case In.UPDATE_DISPLAY_LAYOUT:return this.producerCommandSerializationService.serializeUpdateDisplayLayout(e.sequence,e.params);case In.REPORT_PERF_STAT:return this.producerCommandSerializationService.serializePerfStatReport(e.sequence,e.params);case In.REPORT_SHARING_STAT:return this.producerCommandSerializationService.serializeSharingStatReport(e.sequence,e.params);case In.REQUEST_ASR:return this.producerCommandSerializationService.serializeRequestAsr(e.sequence,e.params)}return Ai.warn("[signaling] cannot get binary data for data channel command: "+e.name),null}_serializeJson(e){let t;t=e.name===In.UPDATE_DISPLAY_LAYOUT?this._convertDisplayLayout(e.params):e.params;let i=Object.assign({command:e.name,sequence:e.sequence},t);return JSON.stringify(i)}_convertDisplayLayout(e){let t=e,i={};for(let e in t)t.hasOwnProperty(e)&&(i[e]=Di(t[e]));return{layouts:i}}_waitConnectionMessage(){this.connectionMessageWaitTimer=window.setTimeout((()=>{this.conversationReject&&this.conversationReject(new Be(W.SIGNALING_FAILED,{message:"Unable to connect to the signaling: connection timeout",remote:!0}))}),kn.WAIT_CONNECTION_DELAY)}_stopWaitConnectionMessage(){window.clearTimeout(this.connectionMessageWaitTimer),this.connectionMessageWaitTimer=0}_startDoctor(){this._stopDoctor(),this.doctorTimer=window.setTimeout((()=>{Ai.warn("[signaling] socket is dead, trying to reconnect"),this._disconnect(4e3),this._connect(ie.RETRY)}),kn.WAIT_MESSAGE_DELAY)}_stopDoctor(){window.clearTimeout(this.doctorTimer),this.doctorTimer=0}constructor(){super(...arguments),this.socket=null,this.sequence=1,this.lastStamp=0,this.websocketCommandsQueue=[],this.datachannelCommandsQueue=[],this.incomingCache=[],this.responseHandlers={},this.reconnectCount=0,this.conversationResolve=null,this.conversationReject=null,this.connected=!1,this.listenersReady=!1,this.postfix="&platform="+_i.platform+"&appVersion="+_i.appVersion+"&version="+_i.protocolVersion+"&device="+_i.device+"&capabilities="+kn._getCapabilityFlags(),this.peerId=null,this.conversationId=null,this.reconnectTimer=0,this.connectionMessageWaitTimer=0,this.doctorTimer=0,this.participantIdRegistry=null,this.producerNotificationDataChannel=null,this.producerCommandDataChannel=null,this.producerCommandDataChannelEnabled=!1,this.producerCommandSerializationService=new class{setParticipantIdRegistry(e){this.participantIdRegistry=e}serializeUpdateDisplayLayout(e,t){let i=bn();d.Int.enc(i,0),d.Int.enc(i,0),d.Int.enc(i,e),d.Nil.enc(i,null);let n=[];for(let e in t)t.hasOwnProperty(e)&&this.writeLayout(t,e,n);return d.Arr.enc(i,n),d.Nil.enc(i,null),i.ui8array()}writeLayout(e,t,i){let n=e[t],r=bn();if(this.writeStreamDesc(t,r),Pi(n))d.Int.enc(r,1);else if(ki(n))d.Int.enc(r,2);else if(d.Int.enc(r,0),void 0!==n.priority?d.Int.enc(r,n.priority):d.Nil.enc(r,null),void 0!==n.width&&void 0!==n.height?(d.Int.enc(r,Math.round(n.width)),d.Int.enc(r,Math.round(n.height))):(d.Nil.enc(r,null),d.Nil.enc(r,null)),void 0!==n.fit)switch(n.fit){case"cv":d.Int.enc(r,0);break;case"cn":d.Int.enc(r,1);break;default:d.Nil.enc(r,null)}else d.Nil.enc(r,null);i.push(r.ui8array())}writeStreamDesc(e,t){if(this.participantIdRegistry){let i=this.participantIdRegistry.getCompactId(e);if(void 0!==i)return void d.Int.enc(t,i)}d.Str.enc(t,e)}serializePerfStatReport(e,t){let i=bn();return d.Int.enc(i,1),d.Int.enc(i,0),d.Int.enc(i,e),d.Int.enc(i,t.framesDecoded),d.Int.enc(i,t.framesReceived),i.ui8array()}serializeSharingStatReport(e,t){let i=bn();return d.Int.enc(i,2),d.Int.enc(i,0),d.Int.enc(i,e),d.Int.enc(i,t.minDelay),d.Int.enc(i,t.maxDelay),d.Int.enc(i,t.avgDelay),d.Int.enc(i,t.largeDelayDuration),i.ui8array()}serializeRequestAsr(e,t){let i=bn();return d.Int.enc(i,3),d.Int.enc(i,0),d.Int.enc(i,e),d.Bool.enc(i,t.request),i.ui8array()}deserializeCommandResponse(e){return E(this,null,(function*(){let t;if(e instanceof Blob){let i="arrayBuffer"in Blob.prototype?yield e.arrayBuffer():yield function(e){return E(this,null,(function*(){return new Promise(((t,i)=>{let n=new FileReader;n.onload=e=>{var i;t(null==(i=e.target)?void 0:i.result)},n.onerror=i,n.readAsArrayBuffer(e)}))}))}(e);t=Rn(i)}else t=Rn(e);let i=d.Int.dec(t),n=d.Int.dec(t);if(0===n)if(0===d.Int.dec(t))switch(i){case 0:return this.deserializeUpdateDisplayLayoutResponse(t);case 1:return this.deserializeReportPerfStatResponse(t);default:return void Ai.warn("unsupported command response commandType: "+i)}else Ai.warn("Error code: "+i+"received for command type: "+i+", version "+n);else Ai.warn("Unsupported version for command type: "+i+", version "+n)}))}deserializeUpdateDisplayLayoutResponse(e){let t=d.Int.dec(e),i=d.Arr.dec(e),n={};return i.forEach((e=>{var t;let i=Rn(e),r=d.Any.dec(i);if("string"==typeof r)n[r]=d.Int.dec(i);else{let e=r,a=Ni(null==(t=this.participantIdRegistry)?void 0:t.getStreamDescription(e));n[a]=d.Int.dec(i)}})),{type:"response",sequence:t,response:In.UPDATE_DISPLAY_LAYOUT.toString(),errorCodeByParticipantId:n}}deserializeReportPerfStatResponse(e){let t=d.Int.dec(e),i=d.Int.dec(e);return{type:"response",sequence:t,response:In.REPORT_PERF_STAT.toString(),estimatedPerformanceIndex:i}}constructor(){this.participantIdRegistry=null}}}},Dn=kn;Dn.RECONNECT_DELAY=_i.signalingReconnectDelay,Dn.RECONNECT_MAX_DELAY=_i.signalingReconnectMaxDelay,Dn.RECONNECT_MAX_COUNT=_i.signalingReconnectMaxCount,Dn.WAIT_CONNECTION_DELAY=_i.waitConnectionDelay,Dn.WAIT_RESPONSE_DELAY=_i.waitResponseDelay,Dn.WAIT_MESSAGE_DELAY=_i.waitMessageDelay;var On,Nn,Mn=(e=>(e.KING="KING",e.PAWN="PAWN",e))(Mn||{}),Ln=Mn,xn=class{get length(){return this._queue.length}get left(){return this._left}toArray(){return Array.from(this._queue)}add(e){this._moveReadCursor&&(this._readCursor=this.nextCursor(this._readCursor)),null===this._queue[this._writeCursor]&&(this._left+=1),this._queue[this._writeCursor]=e,this._writeCursor=this.nextCursor(this._writeCursor),this._moveReadCursor=this._writeCursor===this._readCursor}nextCursor(e){return(e+1)%this._queue.length}next(){let e=this._queue[this._readCursor];return e&&(this._moveReadCursor=!1,this._queue[this._readCursor]=null,this._readCursor=this.nextCursor(this._readCursor),this._left-=1),e}constructor(e){this._queue=new Array(e).fill(null),this._readCursor=this._writeCursor=this._left=0,this._moveReadCursor=!1}},Un=class{authorize(){return E(this,null,(function*(){let e={session_data:{device_id:this._uuid,client_version:_i.appVersion,client_type:"SDK_JS",auth_token:this._callToken,version:3},application_key:this._apiKey},t=yield fn(this._apiEnv),i=yield Sn("auth.anonymLogin",e,!0,t);return!(!it.isObject(i)||"error_msg"in i)&&(this._sessionKey=i.session_key,!0)}))}hangupConversation(e){return E(this,null,(function*(){let t={conversationId:e,reason:K.HUNGUP,application_key:this._apiKey,session_key:this._sessionKey},i=yield fn(this._apiEnv);yield Sn("vchat.hangupConversation",t,!0,i)}))}constructor(e,t,i){this._uuid=it.uuid(),this._apiKey=t,this._callToken=i,this._apiEnv=e}},Vn=null,Fn={getCameras:Pt.getCameras,getMicrophones:Pt.getMicrophones,getOutput:Pt.getOutput,getVideoFacingMode:Pt.getVideoFacingMode,hasCamera:Pt.hasCamera,hasMicrophone:Pt.hasMicrophone,getSavedCamera:Pt.getSavedCamera,getSavedMicrophone:Pt.getSavedMicrophone,getSavedOutput:Pt.getSavedOutput,hasCameraPermission:Pt.hasCameraPermission,hasMicrophonePermission:Pt.hasMicrophonePermission,hasPermissions:Pt.hasPermissions,getUserMedia:Pt.getUserMedia,getUserVideo:Pt.getUserVideo,getUserAudio:Pt.getUserAudio,setResolution:Pt.setResolution,isBrowserSupported:Pt.isBrowserSupported,isScreenCapturingSupported:Pt.isScreenCapturingSupported,os:Pt.os,isMobile:Pt.isMobile,browserName:Pt.browserName,browserVersion:Pt.browserVersion,baseChromeVersion:Pt.baseChromeVersion,getAudioContext:Pt.getAudioContext,isAudioShareSupported:Pt.isAudioShareSupported},jn={participantMarkerCompare:it.participantMarkerCompare};function $n(e){Nn=e}function Bn(e){On=e}function Hn(e){Vn=e}function Wn(e){_i.videoEffects=e,e.setLogger(((e,...t)=>Ai.send(e,...t)))}function Gn(e,t=null,i=null){_i.vmoji=e,_i.vmojiRenderingOptions=i,t&&e.setSDK(t)}function Kn(e){return E(this,null,(function*(){if(_i.set(e),"Sferum"===Pt.browserName()&&(_i.platform=`SFERUM:${Pt.browserVersion()}`),Nn||$n(new En),On||Bn((()=>new Dn)),_i.debug&&(s.default.disableLog(!1),Ai.toggle(!0)),Ai.log(`Calls SDK ${_i.sdkVersion}`,e),yield Pt.init(),!Pt.isBrowserSupported())throw new Be(W.UNSUPPORTED);Ai.log("UserAgent:",navigator.userAgent),Ai.log("Screen resolution:",`${window.screen.width}x${window.screen.height}`),Ai.log("Permissions:",`Camera: ${Pt.hasCameraPermission()}, Mic: ${Pt.hasMicrophonePermission()}`),Nn.init()}))}function qn(e){return E(this,arguments,(function*(e,t=[z.AUDIO],i="",n=!1,r=!1,a){let s=[],o=[];if(Array.isArray(e)?s=e.length?e:[]:e&&(s=[e]),s.length&&(o=yield Nn.getOkIdsByExternalIds(s),!o.length))throw new Be(K.CALLEE_IS_OFFLINE);return zn(o,k.USER,t,i,n,r,a)}))}function zn(e){return E(this,arguments,(function*(e,t=k.USER,i,n="",r=!1,a=!1,s){if(hn.current())throw Ai.error("There is already active call"),new Be(K.FAILED);return new hn(Nn,On(),Vn).onStart(e,t,i,n,r,a,s)}))}function Jn(e){return E(this,null,(function*(){return Yn(e)}))}function Yn(e){return E(this,arguments,(function*(e,t=ge.USER,i){if(e===hn.id())throw new Error("Push has already been processed");return new hn(Nn,On(),Vn).onPush(e,t,i)}))}function Qn(e){return E(this,null,(function*(){return e&&(_i.authToken=e),Nn.authorize()}))}function Zn(){return E(this,arguments,(function*(e=[z.AUDIO]){return ha().accept(e)}))}function Xn(){return E(this,null,(function*(){let e=hn.current();if(e)return e.decline()}))}function er(e){return E(this,arguments,(function*(e,t=[z.AUDIO]){return tr(e,t)}))}function tr(e,t,i){return E(this,null,(function*(){if(hn.current())throw Ai.error("There is already active call"),new Be(K.FAILED);return new hn(Nn,On(),Vn).onJoin({conversationId:e,mediaOptions:t,chatId:i})}))}function ir(e){return E(this,arguments,(function*(e,t=[z.AUDIO],i,n,r){if(hn.current())throw Ai.error("There is already active call"),new Be(K.FAILED);return i&&(_i.anonymToken=i),new hn(Nn,On(),Vn).onJoin({joinLink:e,mediaOptions:t,observedIds:n,payload:r})}))}function nr(){return E(this,null,(function*(){let e=hn.current();if(e)return e.hangup();hn.hangupAfterInit()}))}function rr(e,t){return E(this,null,(function*(){let i=yield Nn.getOkIdsByExternalIds([e]);if(!i.length)throw new Error("User not found");return ar(i[0],t)}))}function ar(e,t){return E(this,null,(function*(){let i=hn.current();i&&(yield i.addParticipant(it.composeUserId(e,ge.USER),t))}))}function sr(e,t=!1){return E(this,null,(function*(){return or((yield Nn.getOkIdsByExternalIds([e]))[0],t)}))}function or(e,t=!1){return E(this,null,(function*(){let i=hn.current();i&&(yield i.removeParticipant(it.composeUserId(e,ge.USER),t))}))}function cr(e,t){return E(this,null,(function*(){let i=hn.current();if("videoinput"===e&&Tt.contains(t))return _i.videoFacingMode=t,i?(Pt.isMobile()&&i.stopVideoTrack(),i.changeDevice(e)):void 0;if(!(yield Pt._saveDeviceId(e,t)))throw new Error(`Device not found: ${t}`);return i?i.changeDevice(e):void 0}))}function lr(e){return E(this,null,(function*(){let t="object"==typeof e?T(y({},e),{fastScreenSharing:e.captureScreen&&e.fastScreenSharing,captureAudio:e.captureScreen&&e.captureAudio&&_i.audioShare}):{captureScreen:e,fastScreenSharing:!1,captureAudio:!1},i=hn.current();return i?i.toggleScreenCapturing(t):Promise.reject()}))}function ur(e){let t=hn.current();t&&t.toggleAnimojiCapturing(e)}function dr(e,t=!1){return E(this,null,(function*(){let i=hn.current();i&&(yield i.setVideoStream(e,t))}))}function hr(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.toggleLocalVideo(e))}))}function pr(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.toggleLocalAudio(e))}))}function _r(e){return E(this,null,(function*(){let t=hn.current();if(t)return t.setLocalResolution(e)}))}function mr(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.changePriorities(e))}))}function fr(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.changeParticipantState(e))}))}function gr(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.updateDisplayLayout(e))}))}function vr(e,t,i=!1){return E(this,null,(function*(){return Sr((yield Nn.getOkIdsByExternalIds([e]))[0],Ri.getDeviceIdx(e),t,i)}))}function Sr(e,t,i,n=!1){return E(this,null,(function*(){let r=hn.current();r&&(yield r.grantRoles(it.composeParticipantId(e,ge.USER,t),i,n))}))}function yr(e){return E(this,arguments,(function*({externalId:e=null,muteStates:t,requestedMedia:i=[],roomId:n=null}){let r=null;return e&&(r=(yield Nn.getOkIdsByExternalIds([e]))[0]),Tr({uid:r,muteStates:t,requestedMedia:i,deviceIdx:Ri.getDeviceIdx(e),roomId:n})}))}function Tr(e){return E(this,arguments,(function*({uid:e=null,muteStates:t,requestedMedia:i=[],deviceIdx:n=0,roomId:r=null}){let a=hn.current();if(a){let s=e?it.composeParticipantId(e,ge.USER,n):null;yield a.muteParticipant(s,t,i,r)}}))}function Er(e,t=!1,i=null){return E(this,null,(function*(){return Cr((yield Nn.getOkIdsByExternalIds([e]))[0],t,Ri.getDeviceIdx(e),i)}))}function Cr(e,t=!1,i=0,n=null){return E(this,null,(function*(){let r=hn.current();r&&(yield r.pinParticipant(it.composeParticipantId(e,ge.USER,i),t,n))}))}function Ir(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.updateMediaModifiers(e))}))}function br(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.changeOptions(e))}))}function Rr(e,t=null){return E(this,null,(function*(){let i=null;return t&&(i=(yield Nn.getOkIdsByExternalIds([t]))[0]),Ar(e,i)}))}function Ar(e,t=null){return E(this,null,(function*(){let i=hn.current();if(i){let n=t?it.composeUserId(t,ge.USER):null;yield i.chatMessage(e,n)}}))}function wr(e=10){return E(this,null,(function*(){let t=hn.current();if(t)return t.chatHistory(e)}))}function Pr(e,t=null){return E(this,null,(function*(){let i=null;return t&&(i=(yield Nn.getOkIdsByExternalIds([t]))[0]),kr(e,i,Ri.getDeviceIdx(t))}))}function kr(e,t=null,i=0){return E(this,null,(function*(){let n=hn.current();if(n){let r=t?it.composeParticipantId(t,ge.USER,i):null;yield n.customData(e,r)}}))}function Dr(){return E(this,arguments,(function*(e="",t=!1,{onlyAdminCanShareMovie:i=!1}={}){return(yield Nn.createConversation(it.uuid(),e,t,{onlyAdminCanShareMovie:i})).join_link}))}function Or(){return E(this,arguments,(function*(e="",t=!1,{onlyAdminCanShareMovie:i=!1}={},n){let r=Ri.fromIds(n),a=yield Nn.getOkIdsByExternalIds(r);return(yield Nn.createConversation(it.uuid(),e,t,{onlyAdminCanShareMovie:i,audienceMode:!0},a)).join_link}))}function Nr(){return E(this,null,(function*(){let e=hn.current();return e?e.createJoinLink():Promise.reject()}))}function Mr(){return E(this,null,(function*(){let e=hn.current();return e?e.removeJoinLink():Promise.reject()}))}function Lr(e,t){return E(this,null,(function*(){return Nn.getAnonymTokenByLink(e,t)}))}function xr(e){let t=hn.current();t&&t.setVolume(e)}function Ur(e){_i.forceRelayPolicy=e}function Vr(e=!1,t=null,i=null,n="DIRECT_LINK",r=null,a=null){return E(this,null,(function*(){let s=hn.current();return s?s.startStream(e,t,i,n,r,a):Promise.reject()}))}function Fr(e=null){return E(this,null,(function*(){let t=hn.current();return t?t.stopStream(e):Promise.reject()}))}function jr(e=null){return E(this,null,(function*(){let t=hn.current();return t?t.publishStream(e):Promise.reject()}))}function $r(e,t,i=!1,n=null){return E(this,null,(function*(){let r=hn.current();if(!r)return Promise.reject();let a,s,o=[];if(null!=t&&t.length&&o.push(...t),e&&o.push(e),o.length){let t=yield Nn.getParticipantIdsByExternalIds(o);e&&(a=t.get(e),t.delete(e)),s=Array.from(t.values())}return r.recordSetConf(a,s,i,n)}))}function Br(){return E(this,null,(function*(){let e=hn.current();return e?e.getStreamInfo():Promise.reject()}))}function Hr(e){return E(this,null,(function*(){let t=hn.current();return t?t.addMovie(e):Promise.reject()}))}function Wr(e){return E(this,null,(function*(){let t=hn.current();return t?t.updateMovie(e):Promise.reject()}))}function Gr(e){return E(this,null,(function*(){let t=hn.current();return t?t.removeMovie(e):Promise.reject()}))}function Kr(e,t){return E(this,null,(function*(){let i=hn.current();if(i){let n=[];for(let t of e){let e,i;t.addParticipantIds&&(e=(yield Nn.getOkIdsByExternalIds(t.addParticipantIds)).map((e=>it.composeUserId(e,ge.USER)))),t.removeParticipantIds&&(i=(yield Nn.getOkIdsByExternalIds(t.removeParticipantIds)).map((e=>it.composeUserId(e,ge.USER)))),n.push({id:t.id,name:t.name,participantCount:t.participantCount,addParticipantIds:e,removeParticipantIds:i})}return i.updateRooms(n,t)}return Promise.reject()}))}function qr(e,t){return E(this,null,(function*(){let i=hn.current();return i?i.activateRooms(e,t):Promise.reject()}))}function zr(e=null,t=null){return E(this,null,(function*(){let i,n=hn.current();if(!n)return Promise.reject();if(t){let e=yield Nn.getOkIdsByExternalIds([t]),n=Ri.getDeviceIdx(t);i=it.composeParticipantId(e[0],ge.USER,n)}return n.switchRoom(e,i)}))}function Jr(e){return E(this,null,(function*(){let t=hn.current();return t?t.removeRooms(e):Promise.reject()}))}function Yr(e){_i.statisticsInterval=e;let t=hn.current();if(t)return t.updateStatisticsInterval()}function Qr(e){s.default.disableLog(!e),Ai.toggle(e)}function Zr(e,...t){_i.debugLog&&Ai.send(e,"[external]",...t)}function Xr(e){return E(this,null,(function*(){let t=hn.current();if(t)return t.videoEffect(e)}))}function ea(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.setAudioStream(e))}))}function ta(e,t=null,i=null){return E(this,null,(function*(){let n=hn.current();if(!n)return;let r=null!=i?i:null==t?void 0:t.id,a=null;if(t){let e=(yield Nn.getOkIdsByExternalIds([t]))[0];if(!e)throw new Error("Could not get user id to set animoji svg");a=it.composeParticipantId(e,ge.USER,Ri.getDeviceIdx(t))}n.setAnimojiSvg(e,a,r)}))}function ia(e=null,t,i=!1){return E(this,null,(function*(){return ha().getWaitingHall(e,t,i)}))}function na(){return E(this,null,(function*(){return ha().getAudienceModeHands()}))}function ra(e,t=!1){return E(this,null,(function*(){let i=ha(),n=yield Nn.getOkIdsByExternalIds([e]);return i.promoteParticipant(it.composeUserId(n[0],ge.USER),t)}))}function aa(e=!1){return E(this,null,(function*(){return ha().requestPromotion(e)}))}function sa(e=!1){return E(this,null,(function*(){return ha().acceptPromotion(e)}))}function oa(e){return E(this,null,(function*(){return ha().getParticipantListChunk(e)}))}function ca(e){return E(this,null,(function*(){return ha().getParticipants(e)}))}function la(e){return E(this,null,(function*(){return ha().feedback(e)}))}function ua(e,t,i){return ha().userFeedbackStats(e,t,i)}function da(e,t){return E(this,null,(function*(){return ha().enableFeatureForRoles(e,t)}))}function ha(){let e=hn.current();if(!e)throw new Error("Conversation not found");return e}function pa(e){return E(this,null,(function*(){yield Nn.removeHistoryRecords(e)}))}function _a(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.startAsr(e))}))}function ma(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.stopAsr(e))}))}function fa(e){return E(this,null,(function*(){let t=hn.current();t&&(yield t.requestAsr(e))}))}function ga(){return _i.sdkVersion}},1437:function(e,t,i){"use strict";function n(e,t,i,n){return new(i||(i=Promise))((function(r,a){function s(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}c((n=n.apply(e,t||[])).next())}))}var r;i.r(t),i.d(t,{AnimojiPreviewGenerator:function(){return b},AnimojiReceiver:function(){return w},AnimojiSender:function(){return O},isBrowserSupported:function(){return u},setSDK:function(){return l}}),function(e){e.DEBUG="DEBUG",e.LOG="LOG",e.WARN="WARN",e.ERROR="ERROR"}(r||(r={}));const a={},s="[🙎‍♂️ Vmoji]";var o;!function(e){function t(e){const t=new Map([[/id for ssrc/,{lock:!1,cooldown:5e3}],[/no svg/,{lock:!1,cooldown:5e3}],[/_send failed/,{lock:!1,cooldown:5e3}],[/failed to increase/,{lock:!1,cooldown:15e3}],[/No available/,{lock:!1,cooldown:15e3}]]);return function(...i){for(const e of Array.from(t.keys()))if(i.filter((e=>"string"==typeof e)).some((t=>e.test(t)))){const{cooldown:i,lock:n}=t.get(e);if(n)return;t.set(e,{cooldown:i,lock:!0}),window.setTimeout((()=>{t.set(e,{cooldown:i,lock:!1})}),i)}e(...i)}}e.debug=()=>{},e.log=()=>{},e.warn=()=>{},e.error=()=>{},e.setDebugMessageFunction=function(i){e.debug=t(i.bind(null,r.DEBUG,s)),e.log=t(i.bind(null,r.LOG,s)),e.warn=t(i.bind(null,r.WARN,s)),e.error=t(i.bind(null,r.ERROR,s))}}(o||(o={}));let c=null;function l(e){c=e,o.setDebugMessageFunction(e.debugMessage)}const u=()=>{try{const e=window,t=e.WebAssembly&&e.Worker&&(e.CanvasCaptureMediaStream||e.CanvasCaptureMediaStreamTrack)&&e.OffscreenCanvas&&(e.AudioContext||e.webkitAudioContext)&&e.AudioWorkletNode&&!0,i="Safari"===(null==c?void 0:c.browser.browserName())&&15===Number(null==c?void 0:c.browser.browserVersion());return t&&!i}catch(e){return!1}},d=(e,t=[])=>{const i=t.join(","),n=new Blob([`(${e})(${i});`],{type:"application/javascript; charset=utf-8"});return window.URL.createObjectURL(n)};var h,p,_="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:{},m=(h=function(e,t){var i=("undefined"!=typeof document&&document.currentScript&&document.currentScript.src,function(e={}){var t,i,n=void 0!==e?e:{};n.ready=new Promise((function(e,n){t=e,i=n}));var r=Object.assign({},n),a="object"==typeof window,s="function"==typeof importScripts;"object"==typeof process&&"object"==typeof process.versions&&process.versions.node;var o,c="";(a||s)&&(s?c=self.location.href:"undefined"!=typeof document&&document.currentScript&&(c=document.currentScript.src),c=0!==c.indexOf("blob:")?c.substr(0,c.replace(/[?#].*/,"").lastIndexOf("/")+1):"",s&&(o=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)})),n.print||console.log.bind(console);var l,u,d=n.printErr||console.warn.bind(console);Object.assign(n,r),r=null,n.arguments&&n.arguments,n.thisProgram&&n.thisProgram,n.quit&&n.quit,n.wasmBinary&&(l=n.wasmBinary),n.noExitRuntime,"object"!=typeof WebAssembly&&P("no native wasm support detected");var h,p,m,f,g,v,S,y,T,E=!1;function C(){var e=u.buffer;n.HEAP8=h=new Int8Array(e),n.HEAP16=m=new Int16Array(e),n.HEAP32=g=new Int32Array(e),n.HEAPU8=p=new Uint8Array(e),n.HEAPU16=f=new Uint16Array(e),n.HEAPU32=v=new Uint32Array(e),n.HEAPF32=S=new Float32Array(e),n.HEAPF64=y=new Float64Array(e)}var I=[],b=[],R=[],A=0,w=null;function P(e){n.onAbort&&n.onAbort(e),d(e="Aborted("+e+")"),E=!0,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}var k,D;function O(e){return e.startsWith("data:application/octet-stream;base64,")}function N(e){try{if(e==k&&l)return new Uint8Array(l);if(o)return o(e);throw"both async and sync fetching of the wasm failed"}catch(e){P(e)}}function M(e,t,i){return function(e){return l||!a&&!s||"function"!=typeof fetch?Promise.resolve().then((function(){return N(e)})):fetch(e,{credentials:"same-origin"}).then((function(t){if(!t.ok)throw"failed to load wasm binary file at '"+e+"'";return t.arrayBuffer()})).catch((function(){return N(e)}))}(e).then((function(e){return WebAssembly.instantiate(e,t)})).then((function(e){return e})).then(i,(function(e){d("failed to asynchronously prepare wasm: "+e),P(e)}))}function L(e){for(;e.length>0;)e.shift()(n)}function x(e){this.excPtr=e,this.ptr=e-24,this.set_type=function(e){v[this.ptr+4>>2]=e},this.get_type=function(){return v[this.ptr+4>>2]},this.set_destructor=function(e){v[this.ptr+8>>2]=e},this.get_destructor=function(){return v[this.ptr+8>>2]},this.set_refcount=function(e){g[this.ptr>>2]=e},this.set_caught=function(e){e=e?1:0,h[this.ptr+12>>0]=e},this.get_caught=function(){return 0!=h[this.ptr+12>>0]},this.set_rethrown=function(e){e=e?1:0,h[this.ptr+13>>0]=e},this.get_rethrown=function(){return 0!=h[this.ptr+13>>0]},this.init=function(e,t){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(t),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){var e=g[this.ptr>>2];g[this.ptr>>2]=e+1},this.release_ref=function(){var e=g[this.ptr>>2];return g[this.ptr>>2]=e-1,1===e},this.set_adjusted_ptr=function(e){v[this.ptr+16>>2]=e},this.get_adjusted_ptr=function(){return v[this.ptr+16>>2]},this.get_exception_ptr=function(){if(lt(this.get_type()))return v[this.excPtr>>2];var e=this.get_adjusted_ptr();return 0!==e?e:this.excPtr}}O(k="vmoji.wasm")||(D=k,k=n.locateFile?n.locateFile(D,c):c+D);var U={};function V(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function F(e){return this.fromWireType(g[e>>2])}var j={},$={},B={},H=48,W=57;function G(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=H&&t<=W?"_"+e:e}function K(e,t){return{[e=G(e)]:function(){return t.apply(this,arguments)}}[e]}function q(e,t){var i=K(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var z=void 0;function J(e){throw new z(e)}function Y(e,t,i){function n(t){var n=i(t);n.length!==e.length&&J("Mismatched type converter count");for(var r=0;r<e.length;++r)ie(e[r],n[r])}e.forEach((function(e){B[e]=t}));var r=new Array(t.length),a=[],s=0;t.forEach(((e,t)=>{$.hasOwnProperty(e)?r[t]=$[e]:(a.push(e),j.hasOwnProperty(e)||(j[e]=[]),j[e].push((()=>{r[t]=$[e],++s===a.length&&n(r)})))})),0===a.length&&n(r)}function Q(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var Z=void 0;function X(e){for(var t="",i=e;p[i];)t+=Z[p[i++]];return t}var ee=void 0;function te(e){throw new ee(e)}function ie(e,t,i={}){if(!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var n=t.name;if(e||te('type "'+n+'" must have a positive integer typeid pointer'),$.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;te("Cannot register type '"+n+"' twice")}if($[e]=t,delete B[e],j.hasOwnProperty(e)){var r=j[e];delete j[e],r.forEach((e=>e()))}}function ne(e){te(e.$$.ptrType.registeredClass.name+" instance already deleted")}var re=!1;function ae(e){}function se(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function oe(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var n=oe(e,t,i.baseClass);return null===n?null:i.downcast(n)}var ce={};var le=[];function ue(){for(;le.length;){var e=le.pop();e.$$.deleteScheduled=!1,e.delete()}}var de=void 0;var he={};function pe(e,t){return t.ptrType&&t.ptr||J("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!=!!t.smartPtr&&J("Both smartPtrType and smartPtr must be specified"),t.count={value:1},_e(Object.create(e,{$$:{value:t}}))}function _e(e){return"undefined"==typeof FinalizationRegistry?(_e=e=>e,e):(re=new FinalizationRegistry((e=>{se(e.$$)})),_e=e=>{var t=e.$$;if(t.smartPtr){var i={$$:t};re.register(e,i,e)}return e},ae=e=>re.unregister(e),_e(e))}function me(){}function fe(e,t,i){if(void 0===e[t].overloadTable){var n=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||te("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[n.argCount]=n}}function ge(e,t,i,n,r,a,s,o){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=n,this.baseClass=r,this.getActualType=a,this.upcast=s,this.downcast=o,this.pureVirtualFunctions=[]}function ve(e,t,i){for(;t!==i;)t.upcast||te("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Se(e,t){if(null===t)return this.isReference&&te("null is not a valid "+this.name),0;t.$$||te('Cannot pass "'+Le(t)+'" as a '+this.name),t.$$.ptr||te("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return ve(t.$$.ptr,i,this.registeredClass)}function ye(e,t){var i;if(null===t)return this.isReference&&te("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||te('Cannot pass "'+Le(t)+'" as a '+this.name),t.$$.ptr||te("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&te("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var n=t.$$.ptrType.registeredClass;if(i=ve(t.$$.ptr,n,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&te("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:te("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var r=t.clone();i=this.rawShare(i,Me.toHandle((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:te("Unsupporting sharing policy")}return i}function Te(e,t){if(null===t)return this.isReference&&te("null is not a valid "+this.name),0;t.$$||te('Cannot pass "'+Le(t)+'" as a '+this.name),t.$$.ptr||te("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&te("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return ve(t.$$.ptr,i,this.registeredClass)}function Ee(e,t,i,n,r,a,s,o,c,l,u){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=n,this.isSmartPointer=r,this.pointeeType=a,this.sharingPolicy=s,this.rawGetPointee=o,this.rawConstructor=c,this.rawShare=l,this.rawDestructor=u,r||void 0!==t.baseClass?this.toWireType=ye:n?(this.toWireType=Se,this.destructorFunction=null):(this.toWireType=Te,this.destructorFunction=null)}var Ce=[];function Ie(e){var t=Ce[e];return t||(e>=Ce.length&&(Ce.length=e+1),Ce[e]=t=T.get(e)),t}function be(e,t,i){return e.includes("j")?function(e,t,i){var r=n["dynCall_"+e];return i&&i.length?r.apply(null,[t].concat(i)):r.call(null,t)}(e,t,i):Ie(t).apply(null,i)}function Re(e,t){var i,n,r,a=(e=X(e)).includes("j")?(i=e,n=t,r=[],function(){return r.length=0,Object.assign(r,arguments),be(i,n,r)}):Ie(t);return"function"!=typeof a&&te("unknown function pointer with signature "+e+": "+t),a}var Ae=void 0;function we(e){var t=ot(e),i=X(t);return st(t),i}function Pe(e,t){var i=[],n={};throw t.forEach((function e(t){n[t]||$[t]||(B[t]?B[t].forEach(e):(i.push(t),n[t]=!0))})),new Ae(e+": "+i.map(we).join([", "]))}function ke(e,t){for(var i=[],n=0;n<e;n++)i.push(v[t+4*n>>2]);return i}function De(e,t,i,n,r,a){var s=t.length;s<2&&te("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var o=null!==t[1]&&null!==i,c=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){c=!0;break}var u="void"!==t[0].name,d=s-2,h=new Array(d),p=[],_=[];return function(){var i;arguments.length!==d&&te("function "+e+" called with "+arguments.length+" arguments, expected "+d+" args!"),_.length=0,p.length=o?2:1,p[0]=r,o&&(i=t[1].toWireType(_,this),p[1]=i);for(var a=0;a<d;++a)h[a]=t[a+2].toWireType(_,arguments[a]),p.push(h[a]);return function(e){if(c)V(_);else for(var n=o?1:2;n<t.length;n++){var r=1===n?i:h[n-2];null!==t[n].destructorFunction&&t[n].destructorFunction(r)}if(u)return t[0].fromWireType(e)}(n.apply(null,p))}}var Oe=new function(){this.allocated=[void 0],this.freelist=[],this.get=function(e){return this.allocated[e]},this.allocate=function(e){let t=this.freelist.pop()||this.allocated.length;return this.allocated[t]=e,t},this.free=function(e){this.allocated[e]=void 0,this.freelist.push(e)}};function Ne(e){e>=Oe.reserved&&0==--Oe.get(e).refcount&&Oe.free(e)}var Me={toValue:e=>(e||te("Cannot use deleted val. handle = "+e),Oe.get(e).value),toHandle:e=>{switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:return Oe.allocate({refcount:1,value:e})}}};function Le(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function xe(e,t){switch(t){case 2:return function(e){return this.fromWireType(S[e>>2])};case 3:return function(e){return this.fromWireType(y[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function Ue(e,t,i){switch(t){case 0:return i?function(e){return h[e]}:function(e){return p[e]};case 1:return i?function(e){return m[e>>1]}:function(e){return f[e>>1]};case 2:return i?function(e){return g[e>>2]}:function(e){return v[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Ve(e,t,i){return function(e,t,i,n){if(!(n>0))return 0;for(var r=i,a=i+n-1,s=0;s<e.length;++s){var o=e.charCodeAt(s);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++s)),o<=127){if(i>=a)break;t[i++]=o}else if(o<=2047){if(i+1>=a)break;t[i++]=192|o>>6,t[i++]=128|63&o}else if(o<=65535){if(i+2>=a)break;t[i++]=224|o>>12,t[i++]=128|o>>6&63,t[i++]=128|63&o}else{if(i+3>=a)break;t[i++]=240|o>>18,t[i++]=128|o>>12&63,t[i++]=128|o>>6&63,t[i++]=128|63&o}}return t[i]=0,i-r}(e,p,t,i)}function Fe(e){for(var t=0,i=0;i<e.length;++i){var n=e.charCodeAt(i);n<=127?t++:n<=2047?t+=2:n>=55296&&n<=57343?(t+=4,++i):t+=3}return t}var je="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function $e(e,t){return e?function(e,t,i){for(var n=t+i,r=t;e[r]&&!(r>=n);)++r;if(r-t>16&&e.buffer&&je)return je.decode(e.subarray(t,r));for(var a="";t<r;){var s=e[t++];if(128&s){var o=63&e[t++];if(192!=(224&s)){var c=63&e[t++];if((s=224==(240&s)?(15&s)<<12|o<<6|c:(7&s)<<18|o<<12|c<<6|63&e[t++])<65536)a+=String.fromCharCode(s);else{var l=s-65536;a+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else a+=String.fromCharCode((31&s)<<6|o)}else a+=String.fromCharCode(s)}return a}(p,e,t):""}var Be="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function He(e,t){for(var i=e,n=i>>1,r=n+t/2;!(n>=r)&&f[n];)++n;if((i=n<<1)-e>32&&Be)return Be.decode(p.subarray(e,i));for(var a="",s=0;!(s>=t/2);++s){var o=m[e+2*s>>1];if(0==o)break;a+=String.fromCharCode(o)}return a}function We(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var n=t,r=(i-=2)<2*e.length?i/2:e.length,a=0;a<r;++a){var s=e.charCodeAt(a);m[t>>1]=s,t+=2}return m[t>>1]=0,t-n}function Ge(e){return 2*e.length}function Ke(e,t){for(var i=0,n="";!(i>=t/4);){var r=g[e+4*i>>2];if(0==r)break;if(++i,r>=65536){var a=r-65536;n+=String.fromCharCode(55296|a>>10,56320|1023&a)}else n+=String.fromCharCode(r)}return n}function qe(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var n=t,r=n+i-4,a=0;a<e.length;++a){var s=e.charCodeAt(a);if(s>=55296&&s<=57343&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++a)),g[t>>2]=s,(t+=4)+4>r)break}return g[t>>2]=0,t-n}function ze(e){for(var t=0,i=0;i<e.length;++i){var n=e.charCodeAt(i);n>=55296&&n<=57343&&++i,t+=4}return t}function Je(e,t){var i=$[e];return void 0===i&&te(t+" has unknown type "+we(e)),i}var Ye={};function Qe(e){var t=Ye[e];return void 0===t?X(e):t}var Ze=[];function Xe(){if("object"==typeof globalThis)return globalThis;function e(e){e.$$$embind_global$$$=e;var t="object"==typeof $$$embind_global$$$&&e.$$$embind_global$$$==e;return t||delete e.$$$embind_global$$$,t}if("object"==typeof $$$embind_global$$$)return $$$embind_global$$$;if("object"==typeof _&&e(_)?$$$embind_global$$$=_:"object"==typeof self&&e(self)&&($$$embind_global$$$=self),"object"==typeof $$$embind_global$$$)return $$$embind_global$$$;throw Error("unable to get global object.")}var et,tt=[],it={};function nt(e){var t=u.buffer;try{return u.grow(e-t.byteLength+65535>>>16),C(),1}catch(e){}}et=()=>performance.now(),z=n.InternalError=q(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);Z=e}(),ee=n.BindingError=q(Error,"BindingError"),me.prototype.isAliasOf=function(e){if(!(this instanceof me))return!1;if(!(e instanceof me))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,n=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;n.baseClass;)r=n.upcast(r),n=n.baseClass;return t===n&&i===r},me.prototype.clone=function(){if(this.$$.ptr||ne(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=_e(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t},me.prototype.delete=function(){this.$$.ptr||ne(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&te("Object already scheduled for deletion"),ae(this),se(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)},me.prototype.isDeleted=function(){return!this.$$.ptr},me.prototype.deleteLater=function(){return this.$$.ptr||ne(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&te("Object already scheduled for deletion"),le.push(this),1===le.length&&de&&de(ue),this.$$.deleteScheduled=!0,this},n.getInheritedInstanceCount=function(){return Object.keys(he).length},n.getLiveInheritedInstances=function(){var e=[];for(var t in he)he.hasOwnProperty(t)&&e.push(he[t]);return e},n.flushPendingDeletes=ue,n.setDelayFunction=function(e){de=e,le.length&&de&&de(ue)},Ee.prototype.getPointee=function(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e},Ee.prototype.destructor=function(e){this.rawDestructor&&this.rawDestructor(e)},Ee.prototype.argPackAdvance=8,Ee.prototype.readValueFromPointer=F,Ee.prototype.deleteObject=function(e){null!==e&&e.delete()},Ee.prototype.fromWireType=function(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=function(e,t){return t=function(e,t){for(void 0===t&&te("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),he[t]}(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var n=i.clone();return this.destructor(e),n}function r(){return this.isSmartPointer?pe(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):pe(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var a,s=this.registeredClass.getActualType(t),o=ce[s];if(!o)return r.call(this);a=this.isConst?o.constPointerType:o.pointerType;var c=oe(t,this.registeredClass,a.registeredClass);return null===c?r.call(this):this.isSmartPointer?pe(a.registeredClass.instancePrototype,{ptrType:a,ptr:c,smartPtrType:this,smartPtr:e}):pe(a.registeredClass.instancePrototype,{ptrType:a,ptr:c})},Ae=n.UnboundTypeError=q(Error,"UnboundTypeError"),Oe.allocated.push({value:void 0},{value:null},{value:!0},{value:!1}),Oe.reserved=Oe.allocated.length,n.count_emval_handles=function(){for(var e=0,t=Oe.reserved;t<Oe.allocated.length;++t)void 0!==Oe.allocated[t]&&++e;return e};var rt={j:function(e,t,i){throw new x(e).init(t,i),e},I:function(e){var t=U[e];delete U[e];var i=t.rawConstructor,n=t.rawDestructor,r=t.fields;Y([e],r.map((e=>e.getterReturnType)).concat(r.map((e=>e.setterArgumentType))),(e=>{var a={};return r.forEach(((t,i)=>{var n=t.fieldName,s=e[i],o=t.getter,c=t.getterContext,l=e[i+r.length],u=t.setter,d=t.setterContext;a[n]={read:e=>s.fromWireType(o(c,e)),write:(e,t)=>{var i=[];u(d,e,l.toWireType(i,t)),V(i)}}})),[{name:t.name,fromWireType:function(e){var t={};for(var i in a)t[i]=a[i].read(e);return n(e),t},toWireType:function(e,t){for(var r in a)if(!(r in t))throw new TypeError('Missing field:  "'+r+'"');var s=i();for(r in a)a[r].write(s,t[r]);return null!==e&&e.push(n,s),s},argPackAdvance:8,readValueFromPointer:F,destructorFunction:n}]}))},w:function(e,t,i,n,r){},E:function(e,t,i,n,r){var a=Q(i);ie(e,{name:t=X(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?n:r},argPackAdvance:8,readValueFromPointer:function(e){var n;if(1===i)n=h;else if(2===i)n=m;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);n=g}return this.fromWireType(n[e>>a])},destructorFunction:null})},C:function(e,t,i,r,a,s,o,c,l,u,d,h,p){d=X(d),s=Re(a,s),c&&(c=Re(o,c)),u&&(u=Re(l,u)),p=Re(h,p);var _=G(d);!function(e,t,i){n.hasOwnProperty(e)?(te("Cannot register public name '"+e+"' twice"),fe(n,e,e),n.hasOwnProperty(i)&&te("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),n[e].overloadTable[i]=t):n[e]=t}(_,(function(){Pe("Cannot construct "+d+" due to unbound types",[r])})),Y([e,t,i],r?[r]:[],(function(t){var i,a;t=t[0],a=r?(i=t.registeredClass).instancePrototype:me.prototype;var o=K(_,(function(){if(Object.getPrototypeOf(this)!==l)throw new ee("Use 'new' to construct "+d);if(void 0===h.constructor_body)throw new ee(d+" has no accessible constructor");var e=h.constructor_body[arguments.length];if(void 0===e)throw new ee("Tried to invoke ctor of "+d+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(h.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),l=Object.create(a,{constructor:{value:o}});o.prototype=l;var h=new ge(d,o,l,p,i,s,c,u),m=new Ee(d,h,!0,!1,!1),f=new Ee(d+"*",h,!1,!1,!1),g=new Ee(d+" const*",h,!1,!0,!1);return ce[e]={pointerType:f,constPointerType:g},function(e,t,i){n.hasOwnProperty(e)||J("Replacing nonexistant public symbol"),n[e].overloadTable,n[e]=t,n[e].argCount=i}(_,o),[m,f,g]}))},v:function(e,t,i,n,r,a){t>0||P(undefined);var s=ke(t,i);r=Re(n,r),Y([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ee("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=()=>{Pe("Cannot construct "+e.name+" due to unbound types",s)},Y([],s,(function(n){return n.splice(1,0,null),e.registeredClass.constructor_body[t-1]=De(i,n,null,r,a),[]})),[]}))},e:function(e,t,i,n,r,a,s,o,c){var l=ke(i,n);t=X(t),a=Re(r,a),Y([],[e],(function(e){var n=(e=e[0]).name+"."+t;function r(){Pe("Cannot call "+n+" due to unbound types",l)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),o&&e.registeredClass.pureVirtualFunctions.push(t);var c=e.registeredClass.instancePrototype,u=c[t];return void 0===u||void 0===u.overloadTable&&u.className!==e.name&&u.argCount===i-2?(r.argCount=i-2,r.className=e.name,c[t]=r):(fe(c,t,n),c[t].overloadTable[i-2]=r),Y([],l,(function(r){var o=De(n,r,e,a,s);return void 0===c[t].overloadTable?(o.argCount=i-2,c[t]=o):c[t].overloadTable[i-2]=o,[]})),[]}))},D:function(e,t){ie(e,{name:t=X(t),fromWireType:function(e){var t=Me.toValue(e);return Ne(e),t},toWireType:function(e,t){return Me.toHandle(t)},argPackAdvance:8,readValueFromPointer:F,destructorFunction:null})},q:function(e,t,i){var n=Q(i);ie(e,{name:t=X(t),fromWireType:function(e){return e},toWireType:function(e,t){return t},argPackAdvance:8,readValueFromPointer:xe(t,n),destructorFunction:null})},f:function(e,t,i,n,r){t=X(t);var a=Q(i),s=e=>e;if(0===n){var o=32-8*i;s=e=>e<<o>>>o}var c=t.includes("unsigned");ie(e,{name:t,fromWireType:s,toWireType:c?function(e,t){return this.name,t>>>0}:function(e,t){return this.name,t},argPackAdvance:8,readValueFromPointer:Ue(t,a,0!==n),destructorFunction:null})},b:function(e,t,i){var n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=v,i=t[e>>=2],r=t[e+1];return new n(t.buffer,r,i)}ie(e,{name:i=X(i),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},p:function(e,t){var i="std::string"===(t=X(t));ie(e,{name:t,fromWireType:function(e){var t,n=v[e>>2],r=e+4;if(i)for(var a=r,s=0;s<=n;++s){var o=r+s;if(s==n||0==p[o]){var c=$e(a,o-a);void 0===t?t=c:(t+=String.fromCharCode(0),t+=c),a=o+1}}else{var l=new Array(n);for(s=0;s<n;++s)l[s]=String.fromCharCode(p[r+s]);t=l.join("")}return st(e),t},toWireType:function(e,t){var n;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||te("Cannot pass non-string to std::string"),n=i&&r?Fe(t):t.length;var a=at(4+n+1),s=a+4;if(v[a>>2]=n,i&&r)Ve(t,s,n+1);else if(r)for(var o=0;o<n;++o){var c=t.charCodeAt(o);c>255&&(st(s),te("String has UTF-16 code units that do not fit in 8 bits")),p[s+o]=c}else for(o=0;o<n;++o)p[s+o]=t[o];return null!==e&&e.push(st,a),a},argPackAdvance:8,readValueFromPointer:F,destructorFunction:function(e){st(e)}})},o:function(e,t,i){var n,r,a,s,o;i=X(i),2===t?(n=He,r=We,s=Ge,a=()=>f,o=1):4===t&&(n=Ke,r=qe,s=ze,a=()=>v,o=2),ie(e,{name:i,fromWireType:function(e){for(var i,r=v[e>>2],s=a(),c=e+4,l=0;l<=r;++l){var u=e+4+l*t;if(l==r||0==s[u>>o]){var d=n(c,u-c);void 0===i?i=d:(i+=String.fromCharCode(0),i+=d),c=u+t}}return st(e),i},toWireType:function(e,n){"string"!=typeof n&&te("Cannot pass non-string to C++ string type "+i);var a=s(n),c=at(4+a+t);return v[c>>2]=a>>o,r(n,c+4,a+t),null!==e&&e.push(st,c),c},argPackAdvance:8,readValueFromPointer:F,destructorFunction:function(e){st(e)}})},K:function(e,t,i,n,r,a){U[e]={name:X(t),rawConstructor:Re(i,n),rawDestructor:Re(r,a),fields:[]}},t:function(e,t,i,n,r,a,s,o,c,l){U[e].fields.push({fieldName:X(t),getterReturnType:i,getter:Re(n,r),getterContext:a,setterArgumentType:s,setter:Re(o,c),setterContext:l})},F:function(e,t){ie(e,{isVoid:!0,name:t=X(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},z:function(){return true},u:function(e,t,i){e=Me.toValue(e),t=Je(t,"emval::as");var n=[],r=Me.toHandle(n);return v[i>>2]=r,t.toWireType(n,e)},r:function(e,t,i,n,r){return(e=Ze[e])(t=Me.toValue(t),i=Qe(i),function(e){var t=[];return v[e>>2]=Me.toHandle(t),t}(n),r)},g:function(e,t,i,n){(e=Ze[e])(t=Me.toValue(t),i=Qe(i),null,n)},a:Ne,m:function(e){return 0===e?Me.toHandle(Xe()):(e=Qe(e),Me.toHandle(Xe()[e]))},c:function(e,t){var i=function(e,t){for(var i=new Array(e),n=0;n<e;++n)i[n]=Je(v[t+4*n>>2],"parameter "+n);return i}(e,t),n=i[0],r=n.name+"_$"+i.slice(1).map((function(e){return e.name})).join("_")+"$",a=tt[r];if(void 0!==a)return a;var s,o,c=new Array(e-1);return s=(t,r,a,s)=>{for(var o=0,l=0;l<e-1;++l)c[l]=i[l+1].readValueFromPointer(s+o),o+=i[l+1].argPackAdvance;var u=t[r].apply(t,c);for(l=0;l<e-1;++l)i[l+1].deleteObject&&i[l+1].deleteObject(c[l]);if(!n.isVoid)return n.toWireType(a,u)},o=Ze.length,Ze.push(s),a=o,tt[r]=a,a},s:function(e,t){return e=Me.toValue(e),t=Me.toValue(t),Me.toHandle(e[t])},i:function(e){e>4&&(Oe.get(e).refcount+=1)},G:function(e,t,i,n){e=Me.toValue(e);var r=it[t];return r||(r=function(e){var t=new Array(e+1);return function(i,n,r){t[0]=i;for(var a=0;a<e;++a){var s=Je(v[n+4*a>>2],"parameter "+a);t[a+1]=s.readValueFromPointer(r),r+=s.argPackAdvance}var o=new(i.bind.apply(i,t));return Me.toHandle(o)}}(t),it[t]=r),r(e,i,n)},H:function(){return Me.toHandle([])},J:function(e){e=Me.toValue(e);for(var t=new Array(e.length),i=0;i<e.length;i++)t[i]=e[i];return Me.toHandle(t)},d:function(e){return Me.toHandle(Qe(e))},l:function(e){V(Me.toValue(e)),Ne(e)},h:function(e,t,i){e=Me.toValue(e),t=Me.toValue(t),i=Me.toValue(i),e[t]=i},k:function(e,t){var i=(e=Je(e,"_emval_take_value")).readValueFromPointer(t);return Me.toHandle(i)},n:function(){P("")},A:function(){return Date.now()},y:et,B:function(e,t,i){p.copyWithin(e,t,t+i)},x:function(e){var t,i=p.length,n=2147483648;if((e>>>=0)>n)return!1;for(var r=1;r<=4;r*=2){var a=i*(1+.2/r);if(a=Math.min(a,e+100663296),nt(Math.min(n,(t=Math.max(e,a))+(65536-t%65536)%65536)))return!0}return!1}};!function(){var e,t,r,a,s={a:rt};function o(e,t){var i,r=e.exports;return n.asm=r,u=n.asm.L,C(),T=n.asm.O,i=n.asm.M,b.unshift(i),function(e){if(A--,n.monitorRunDependencies&&n.monitorRunDependencies(A),0==A&&w){var t=w;w=null,t()}}(),r}if(A++,n.monitorRunDependencies&&n.monitorRunDependencies(A),n.instantiateWasm)try{return n.instantiateWasm(s,o)}catch(e){d("Module.instantiateWasm callback failed with error: "+e),i(e)}(e=l,t=k,r=s,a=function(e){o(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||O(t)||"function"!=typeof fetch?M(t,r,a):fetch(t,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,r).then(a,(function(e){return d("wasm streaming compile failed: "+e),d("falling back to ArrayBuffer instantiation"),M(t,r,a)}))}))).catch(i)}();var at=n._malloc=function(){return(at=n._malloc=n.asm.N).apply(null,arguments)},st=n._free=function(){return(st=n._free=n.asm.P).apply(null,arguments)},ot=n.___getTypeName=function(){return(ot=n.___getTypeName=n.asm.Q).apply(null,arguments)};n.__embind_initialize_bindings=function(){return(n.__embind_initialize_bindings=n.asm.R).apply(null,arguments)};var ct,lt=function(){return(lt=n.asm.S).apply(null,arguments)};function ut(){function e(){ct||(ct=!0,n.calledRun=!0,E||(L(b),t(n),n.onRuntimeInitialized&&n.onRuntimeInitialized(),function(){if(n.postRun)for("function"==typeof n.postRun&&(n.postRun=[n.postRun]);n.postRun.length;)e=n.postRun.shift(),R.unshift(e);var e;L(R)}()))}A>0||(function(){if(n.preRun)for("function"==typeof n.preRun&&(n.preRun=[n.preRun]);n.preRun.length;)e=n.preRun.shift(),I.unshift(e);var e;L(I)}(),A>0||(n.setStatus?(n.setStatus("Running..."),setTimeout((function(){setTimeout((function(){n.setStatus("")}),1),e()}),1)):e()))}if(n.stringToUTF8=Ve,n.lengthBytesUTF8=Fe,w=function e(){ct||ut(),ct||(w=e)},n.preInit)for("function"==typeof n.preInit&&(n.preInit=[n.preInit]);n.preInit.length>0;)n.preInit.pop()();return ut(),e.ready});e.exports=i,i.getUrl=function(e){return"https://st.mycdn.me/static/vmoji/1-2-3/"+e}},h(p={exports:{}}),p.exports);const f=65534;function g(e,t,i,n=null,r=null,a=null){if(e<=0||t<=0)throw new RangeError("animojiWidth and animojiHeight must be greater than 0");null!=n||(n=1.3),null!=r||(r=a?a.width/a.height:16/9);let s=0,o=0,c=0,l=0,u=1;if(t>=e?(s=t*r/n,o=t/n):(s=e/n,o=e/r/n),c=(s-e)/2,l=o/2-i,a){const{width:e,height:t}=a;u=Math.max(e/s,t/o),s=e,o=t,c*=u,l*=u}return{canvasWidth:Math.round(s),canvasHeight:Math.round(o),posX:Math.floor(c),posY:Math.floor(l),scale:u}}function v(e,t){let i;if(t){const t=Number.isNaN(e)?250:e>15?e:16;i=10-5*Math.log((t-15)/75)}else{const t=Number.isNaN(e)?250:e>9?e:9.1;i=10-3*Math.log((t-9)/75)}return i>24?i=24:i<10&&(i=10),Math.floor(i)}function S(e,t,i,n,r,a){const s="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,o=s?self:null==a?void 0:a.messagePort,c="animojiCtxStorage",l={width:1280,height:720};let u=null;const d={};let h,p,_=[];const m=Object.assign(Object.assign({},{useFrameBatching:!1,useLowResolution:!1,isFpsLimitCalculated:!1,fpsLimit:10}),JSON.parse(r)),{useLowResolution:f,useFrameBatching:g}=m;let{fpsLimit:v,isFpsLimitCalculated:S}=m,y=!0,T=250,E=0,C=0,I=0,b=0;self[c]||(self[c]={});let R=!0;function A(){var e;const t=["A6EDBD","A1DDF0","AACCF2","B5AAF2","F2AAB5","F2D983","F2C0A5"];return null!==(e=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:null}(t[Math.floor(Math.random()*t.length)]))&&void 0!==e?e:[0,0,0]}function w(e){var t,i,n;if(!u)return o.postMessage({type:"frame",error:"Fatal initialization error"}),null;let r=d[e];return r||(r={participantId:e,illustration:new u.Illustration,fill:A(),hasSvg:!1,toUpdateTransformation:!1,eyesPosY:0,outImgSize:null,positioningParams:null,canvas:null!==(t=null==a?void 0:a.animojiCanvasStorage[e])&&void 0!==t?t:null,ctx:null!==(n=null===(i=null===self||void 0===self?void 0:self[c])||void 0===i?void 0:i[e])&&void 0!==n?n:null},d[e]=r,D(),o.postMessage({type:"debug",message:`AnimojiDecoderWorker: new illustration created for participantId ${e}`})),r}function P(e,t){const{illustration:n}=e;let{outImgSize:r,eyesPosY:a,positioningParams:s}=e,o=t&&r&&((null==r?void 0:r.width)!==(null==t?void 0:t.width)||(null==r?void 0:r.height)!==(null==t?void 0:t.height));r||(r=n.getOutImgSize(),e.outImgSize=r,o=!0),a||(a=n.getEyesPosY(),e.eyesPosY=a,o=!0);const{width:c,height:l}=r;return s&&!o||(s=i(c,l,a,null,null,t),e.positioningParams=s,e.toUpdateTransformation=!0),s}function k(){v=n(T,s),T<=(s?10:5)&&(y=f),o.postMessage({type:"debug",message:`AnimojiDecoderWorker: calculated fpsLimit: ${v}, normalizedTimeToRender: ${T.toFixed(2)}, useLowResolution: ${y}`}),o.postMessage({type:"fps_limit",fpsLimit:v,normalizedTimeToRender:T})}function D(){_=Object.keys(d).sort(),R=!0}function O({participantId:e,svg:t}){var i;const n=w(e);if(n&&t){if(!n.illustration.checkSVGData(t))return void o.postMessage({type:"frame",error:"Svg provided for a new participantId is not valid"});n.hasSvg&&u&&(null===(i=n.illustration)||void 0===i||i.delete(),n.illustration=new u.Illustration,n.outImgSize=null,n.eyesPosY=0,n.positioningParams=null,o.postMessage({type:"debug",message:`AnimojiDecoderWorker: updated vmoji SVG for participantId ${e}`})),n.illustration.initFromData(t),n.hasSvg=!0}}function N(e=(y?null:l)){g?function(e){for(const t of _){const i=d[t];if(!i||!i.hasSvg){o.postMessage({type:"frame",error:`Trying to draw frame with no svg attached to participantId ${t}`,participantId:t});continue}const{illustration:n,fill:[r,a,s]}=i,{canvasWidth:l,canvasHeight:u,posX:m,posY:f,scale:g}=P(i,e);(i.canvas||i.ctx)&&(i.canvas=null,i.ctx=null),h||(h=new OffscreenCanvas(l,u),p=h.getContext("2d",{alpha:!1,willReadFrequently:!0}),self[c][c]=p);const v=_.indexOf(t);R&&(h.width=l*_.length,h.height=u,R=!1),p&&(p.setTransform(1,0,0,1,l*v,0),p.fillStyle=`rgb(${r},${a},${s})`,p.fillRect(0,0,l,u),p.setTransform(g,0,0,g,l*v+m,f),n.renderOnCanvas(c,c))}if(h&&p){const e=s?p.getImageData(0,0,h.width,h.height).data.buffer:c;o.postMessage({type:"frame",image:e,participantIds:_,width:h.width,height:h.height},e instanceof ArrayBuffer?[e]:[])}}(e):function(e){for(const t of _){const i=d[t];if(!i||!i.hasSvg){o.postMessage({type:"frame",error:`Trying to draw frame with no svg attached to participantId ${t}`,participantId:t});continue}const n=M(i,e);n&&i.canvas&&o.postMessage({type:"frame",image:n,participantIds:t,width:i.canvas.width,height:i.canvas.height},n instanceof ArrayBuffer?[n]:[])}}(e)}function M(e,t){if(!u)return null;let{canvas:i,ctx:n}=e;const{illustration:r,participantId:a,fill:[o,l,d]}=e,{canvasWidth:h,canvasHeight:p,posX:_,posY:m,scale:f}=P(e,t);let g=null;return i||(i=new OffscreenCanvas(h,p),e.canvas=i,n=e.canvas.getContext("2d",{alpha:!1,willReadFrequently:!0}),e.ctx=n,n.setTransform(f,0,0,f,_,m),self[c][a]=n),n&&(e.toUpdateTransformation&&(i.width=h,i.height=p,n.setTransform(f,0,0,f,_,m),e.toUpdateTransformation=!1),n.fillStyle=`rgb(${o},${l},${d})`,n.fillRect(-_,-m,h,p),r.renderOnCanvas(c,a),g=s?n.getImageData(0,0,i.width,i.height).data.buffer:a),g}e({locateFile:t}).then((e=>u=e)).then((()=>{o.onmessage=({data:e})=>{switch(e.type){case"set_bg_fill":!function({participantId:e,fill:t}){const i=w(e);i&&t&&(i.fill=t)}(e);break;case"set_svg":O(e);break;case"set_svg_ecnrypted":!function({participantId:e,svgEncrypted:t,userId:i}){if(!u)return void o.postMessage({type:"frame",error:"Fatal initialization error"});const n=w(e);if(!n)return;const r=u._malloc(t.byteLength);let a;u.HEAPU8.set(new Uint8Array(t),r);try{a=n.illustration.decryptSVG(i,r,t.byteLength)}catch(e){o.postMessage({type:"frame",error:"Error decrypting SVG: "+String(e)})}finally{u._free(r)}a&&O({type:"set_svg",participantId:e,svg:a})}(e);break;case"frame":!function({participantId:e,data:t,targetDimensions:i=(y?null:l)}){if(!u)return void o.postMessage({type:"frame",error:"Fatal initialization error"});const n=performance.now(),r=d[e];if(!r||!r.hasSvg)return void o.postMessage({type:"frame",error:`Trying to draw frame with no svg attached to participantId ${e}`,participantId:e});const a=u.HEAPF32.BYTES_PER_ELEMENT,s=u._malloc(t.byteLength),c=t.byteLength/a/2,h=new Float32Array(t);if(u.HEAPF32.set(h,s/a),r.illustration.update(s,c),u._free(s),S)return void(I||(I=self.setInterval(N,1e3/v)));const p=M(r,i);!function(e){C+=e,E+=1,T=C/E}(performance.now()-n),b||(b=self.setTimeout(k,1e3)),p&&r.canvas&&o.postMessage({type:"frame",participantIds:e,image:p,width:r.canvas.width,height:r.canvas.height},p instanceof ArrayBuffer?[p]:[])}(e);break;case"remove_participant":t=e.participantId,d.hasOwnProperty(t)&&(null===(i=d[t].illustration)||void 0===i||i.delete(),delete d[t],D(),o.postMessage({type:"debug",message:`AnimojiDecoderWorker: illustration removed for participantId ${t}`}));break;case"set_fps_limit":!function(e){if(!(S&&v<=e.fpsLimit)){if(v=e.fpsLimit,S=!0,v>=24){R=!0;for(const e of _){const t=d[e];t&&(t.positioningParams=null)}}I>0&&self.clearInterval(I),I=self.setInterval(N,1e3/v),o.postMessage({type:"debug",message:`AnimojiDecoderWorker: force set fpsLimit command received: ${v}`})}}(e)}var t,i},o.postMessage({type:"init"})})).catch((e=>{o.postMessage({type:"error",error:String(e)})}))}class y{}class T extends y{init(e,t,i,r={}){return n(this,void 0,void 0,(function*(){o.debug("AnimojiDecoder started"),yield this._createWorker(S,(i=>{if(i.error)o.warn("AnimojiDecoder",i.error),t(i.participantIds);else{const t=i,n=new ImageData(new Uint8ClampedArray(t.image),t.width,t.height);e(Object.assign(t,{image:n}))}}),(e=>i(e.fpsLimit,e.normalizedTimeToRender)),[m,m.getUrl,g,v,`'${JSON.stringify(r)}'`])}))}sendTask(e){switch(e.type){case"frame":this._sendToWorker(e,[e.data]);break;case"set_svg_ecnrypted":case"set_bg_fill":case"set_svg":case"remove_participant":case"set_fps_limit":this._sendToWorker(e)}}destroy(){this._removeWorker(),o.debug("AnimojiDecoder destroyed")}_removeWorker(){var e;null===(e=this._worker)||void 0===e||e.terminate(),this._worker=null}_sendToWorker(e,t=[]){var i;null===(i=this._worker)||void 0===i||i.postMessage(e,t)}_createWorker(e,t,i,r=[],a={},s=[]){return n(this,void 0,void 0,(function*(){return new Promise(((n,a)=>{this._worker=new Worker(d(e,r)),this._worker.onmessage=({data:e})=>{switch(e.type){case"init":n();break;case"error":a(e.error);break;case"frame":t(e);break;case"fps_limit":i(e);break;case"debug":o.debug(e.message)}}}))}))}constructor(){super(...arguments),this._worker=null}}class E extends y{init(e,t,i,n={}){return o.debug("AnimojiDecoder started"),new Promise(((r,s)=>{const c=new MessageChannel;this.messagePort=c.port1,S(m,m.getUrl,g,v,JSON.stringify(n),{animojiCanvasStorage:a,messagePort:c.port2}),this.messagePort.onmessage=({data:n})=>{switch(n.type){case"init":r();break;case"error":s(n.error);break;case"frame":const a=n;if(a.error)o.warn("AnimojiDecoder",a.error),t(a.participantIds);else{const t=n;e(Object.assign(t,{image:t.image}))}break;case"fps_limit":{const e=n;i(e.fpsLimit,e.normalizedTimeToRender);break}case"debug":o.debug(n.message)}}}))}sendTask(e){switch(e.type){case"frame":this._sendToWorker(e,[e.data]);break;case"set_svg_ecnrypted":case"set_bg_fill":case"set_svg":case"remove_participant":case"set_fps_limit":this._sendToWorker(e)}}destroy(){this.messagePort=null,o.debug("AnimojiDecoder destroyed")}_sendToWorker(e,t=[]){var i;null===(i=this.messagePort)||void 0===i||i.postMessage(e,t)}constructor(){super(...arguments),this.messagePort=null}}class C{clearReportInterval(){window.clearInterval(this._reportIntervalId),this._reportIntervalId=0}clearResumeTimeout(){window.clearTimeout(this._resumeTimeoutId),this._resumeTimeoutId=0}setCountIn(e){this._countIn=e}incIn(){this._countIn+=1}incOut(){this._countOut+=1}resetCounters(){this._countIn=0,this._countOut=0}report(){let e=this._countOut/this._countIn;e=Number.isNaN(e)?1:e,this.resetCounters(),this._debug&&o.debug(`RatioReporter: Decoding ratio for the last ${this._reportRateMs} ms: ${e.toFixed(2)}`),e>=this._ratioThreshold?this._countThresholdReached=0:(this._countThresholdReached+=1,o.debug(`RatioReporter: Ratio threshold reached, ${this._countThresholdReached} in sequence`),this._countThresholdReached>=this._controlSequenceCount&&(o.warn(`RatioReporter: ${this._countThresholdReached} total threshold reaches in sequence, calling onThrottling callback...`),this._countThresholdReached=0,this.onThrottling()))}pause(e){this.clearReportInterval(),e&&(this.clearResumeTimeout(),this._resumeTimeoutId=window.setTimeout((()=>{this._resumeTimeoutId=0,this.resume()}),e))}resume(){this._reportIntervalId||(this.clearResumeTimeout(),this.resetCounters(),this._reportIntervalId=window.setInterval(this.report.bind(this),this._reportRateMs))}destroy(){window.clearInterval(this._reportIntervalId),window.clearTimeout(this._resumeTimeoutId)}constructor(e,t,i,n=!1){this._countIn=0,this._countOut=0,this._countThresholdReached=0,this._reportIntervalId=0,this._resumeTimeoutId=0,this._debug=!1,this.onThrottling=()=>{},this._reportRateMs=e,this._ratioThreshold=t,this._controlSequenceCount=i,this._debug=n,this.resume()}}class I{get size(){return this._decodersLoad.size}get load(){return Array.from(this._decodersLoad.values()).reduce(((e,t)=>e+t),0)}get capacity(){return this._decoderCapacity*this.maxPoolSize}get tasksQueueLength(){return this._tasksQueue.length}_updateThrottledTaskSender(){this._useTaskThrottling&&(this._throttledTaskSender=this._fpsLimit<24?function(e,t){let i,n,r=!1;return function a(...s){if(r)return i=s,void(n=this);e.apply(this,s),r=!0,setTimeout((function(){r=!1,i&&(a.apply(n,i),i=null,n=null)}),t)}}(this._sendTask,1e3/this._fpsLimit/this.load):null,o.debug("AnimojiDecoderPool: updated throttled task sender",this._throttledTaskSender?{_fpsLimit:this._fpsLimit,load:this.load}:null))}_sendTask(e,t){var i;this._ratioReporter&&(this._useTaskThrottling?"frame"===t.type&&(null===(i=this._ratioReporter)||void 0===i||i.incIn()):this._ratioReporter.setCountIn(this._fpsLimit*this.load*1.5)),e.sendTask(t)}_sendTaskThrottled(e,t){this._fpsLimit<24&&!this._throttledTaskSender&&this._updateThrottledTaskSender(),"frame"===t.type&&this._throttledTaskSender?this._throttledTaskSender(e,t):this._sendTask(e,t)}_removeDecoder(e){var t;const i=this._availableDecoders.indexOf(e);-1!==i&&this._availableDecoders.splice(i,1),e instanceof E&&(this._isMainThreadDecoderUsed=!1),this._decodersIsReady.delete(e),this._decodersLoad.delete(e),e.destroy(),0===this.size&&(null===(t=this._ratioReporter)||void 0===t||t.pause()),this._updateThrottledTaskSender(),o.debug(`AnimojiDecoderPool: decoder removed, pool size: ${this.size+1} -> ${this.size}`)}_runNext(){const e=[];this._tasksQueue.forEach((t=>{const i=this._decoderByParticipantId[t.participantId];this._decodersIsReady.get(i)?this._sendTaskThrottled(i,t):e.push(t)})),this._tasksQueue=e}_sendSetFPSLimit(e){this._decodersLoad.forEach(((t,i)=>{this._sendTask(i,{type:"set_fps_limit",participantId:"",fpsLimit:e})}))}_addNewDecoder(){var e;if(this.size===this.maxPoolSize)return null;let t;return this._useMainThreadRendering&&!this._isMainThreadDecoderUsed?(t=new E,this._isMainThreadDecoderUsed=!0):t=new T,this._decodersIsReady.set(t,!1),this._decodersLoad.set(t,0),this._availableDecoders.push(t),t.init((e=>{var t;null===(t=this._ratioReporter)||void 0===t||t.incOut(),this._onFrame(e)}),(e=>{var t;null===(t=this._ratioReporter)||void 0===t||t.incOut(),e&&(Array.isArray(e)?e:[e]).forEach((e=>this._onParticipantRemoved(e)))}),((e,t)=>{this._onTimeToRender(t),!this._useInitialFPSLimiting||this._decoderOptions.isFpsLimitCalculated&&e>=this._fpsLimit||(o.debug(`AnimojiDecoderPool: received fpsLimit from decoder, setting FPS limit: ${this._fpsLimit} -> ${e}`),this._fpsLimit=e,this._updateThrottledTaskSender(),this._sendSetFPSLimit(e))}),this._decoderOptions).then((()=>{this._decodersIsReady.set(t,!0),this._runNext()})),1===this.size&&(null===(e=this._ratioReporter)||void 0===e||e.resume()),o.debug(`AnimojiDecoderPool: new decoder allocated, pool size: ${this.size-1} -> ${this.size}`),t}_forceAvailableDecoder(){var e;const t=null===(e=Object.keys(this._decoderByParticipantId))||void 0===e?void 0:e[0];t&&this.removeParticipant(t)}_increaseDecoderCapacity(e=1){this._maxDecoderCapacity&&this._decoderCapacity+e>this._maxDecoderCapacity?o.warn(`AnimojiDecoderPool: failed to increase decoder capacity\n                ${this._decoderCapacity} -> ${this._decoderCapacity+e}.\n                Max capacity reached: ${this._maxDecoderCapacity}.\n            `):(this._decoderCapacity+=e,this._decodersLoad.forEach(((e,t)=>{this._availableDecoders.push(t)})),o.log(`AnimojiDecoderPool: increased decoder capacity ${this._decoderCapacity-e} -> ${this._decoderCapacity}`))}_decreaseDecoderCapacity(e=1){return!(this._decoderCapacity-e<1||(this._decoderCapacity-=e,this._maxDecoderCapacity=this._decoderCapacity,this._rebalanceDecoders(),o.warn(`AnimojiDecoderPool: decreased decoder capacity ${this._decoderCapacity+e} -> ${this._decoderCapacity}`),0))}_rebalanceDecoders(){var e;null===(e=this._ratioReporter)||void 0===e||e.pause(5e3),this._decodersLoad.forEach(((e,t)=>{var i;if(this._maxDecoderCapacity&&e>this._maxDecoderCapacity){let n=e-this._maxDecoderCapacity;const r=Object.entries(this._decoderByParticipantId);for(;n;){const e=null===(i=r.find((([e,i])=>i===t)))||void 0===i?void 0:i[0];if(!e)break;this.removeParticipant(e),n-=1}}this._maxDecoderCapacity&&e===this._maxDecoderCapacity&&this._availableDecoders.includes(t)&&this._availableDecoders.splice(this._availableDecoders.indexOf(t),1)}))}_updateDecoderLoad(e,t){0!==t?(this._decodersLoad.set(e,t),this._updateThrottledTaskSender(),this._availableDecoders.includes(e)?this._maxDecoderCapacity&&t>=this._maxDecoderCapacity&&this._availableDecoders.splice(this._availableDecoders.indexOf(e),1):(!this._maxDecoderCapacity||t<this._maxDecoderCapacity)&&this._availableDecoders.unshift(e)):this._removeDecoder(e)}_getAvailableDecoder(){return this._availableDecoders.length>0?this._availableDecoders[0]:this._addNewDecoder()}_addTaskExistingParticipant(e,t){this._decodersIsReady.get(e)?this._sendTaskThrottled(e,t):this._tasksQueue.push(t)}_addTaskNewParticipant(e){var t;if("frame"!==e.type)return void this._tasksQueue.push(e);this.load===this.capacity&&this._increaseDecoderCapacity();let i=this._getAvailableDecoder();if(!i){if("frame"!==e.type||!e.isMe)return void o.warn("AnimojiDecoderPool: No available decoders found for a new participant task",e);if(o.warn("AnimojiDecoderPool: Forcing participant removal to serve own animoji rendering",e),this._forceAvailableDecoder(),i=this._getAvailableDecoder(),!i)return void o.warn("AnimojiDecoderPool: Failed to get available decoder after force freeing",e);this._onParticipantRemoved(e.participantId)}this._decoderByParticipantId[e.participantId]=i,o.debug(`AnimojiDecoderPool: new participant added, participantId ${e.participantId}`);const n=(null!==(t=this._decodersLoad.get(i))&&void 0!==t?t:0)+1;n===this._decoderCapacity&&this._availableDecoders.splice(this._availableDecoders.indexOf(i),1),this._decodersLoad.set(i,n),this._updateThrottledTaskSender(),this._decodersIsReady.get(i)?this._sendTaskThrottled(i,e):this._tasksQueue.push(e),this._runNext()}addTask(e){const t=this._decoderByParticipantId[e.participantId];return t?this._addTaskExistingParticipant(t,e):this._addTaskNewParticipant(e),this}removeParticipant(e){var t;const i=this._decoderByParticipantId[e];if(i){delete this._decoderByParticipantId[e],o.debug(`AnimojiDecoderPool: participant removed, participantId ${e}`),this._tasksQueue=this._tasksQueue.filter((t=>t.participantId!==e||["set_svg","set_svg_ecnrypted"].includes(t.type))),this._sendTask(i,{type:"remove_participant",participantId:e});const n=(null!==(t=this._decodersLoad.get(i))&&void 0!==t?t:this._decoderCapacity)-1;this._updateDecoderLoad(i,n),this._onParticipantRemoved(e)}return this}destroy(){var e;o.debug("AnimojiDecoderPool: destroy"),null===(e=this._ratioReporter)||void 0===e||e.destroy(),this._decodersLoad.forEach(((e,t)=>{t.destroy()}))}constructor(e=(()=>{}),t=(()=>{}),i=(()=>{}),n=!1,r=!1,a=!1,s=!1,c=null,l=null,u=null){if(this._maxDecoderCapacity=null,this._tasksQueue=[],this._fpsLimit=24,this._useTaskThrottling=!1,this._useInitialFPSLimiting=!1,this._useMainThreadRendering=!1,this._isMainThreadDecoderUsed=!1,this._throttledTaskSender=null,this._onFrame=()=>{},this._onParticipantRemoved=()=>{},this._onTimeToRender=()=>{},this._decoderByParticipantId={},this._availableDecoders=[],this._decodersIsReady=new Map,this._decodersLoad=new Map,this._ratioReporter=null,o.debug("AnimojiDecoderPool: started"),null!==l&&l<1)throw new RangeError("Max pool size must be greater than 0");if(null!==u&&u<1)throw new RangeError("Decoder capacity must be greater than 0");this._decoderOptions=null!=c?c:{},this.maxPoolSize=null!=l?l:navigator.hardwareConcurrency-1||2,this._decoderCapacity=null!=u?u:1,this._onFrame=e,this._onParticipantRemoved=t,this._onTimeToRender=i,this._useTaskThrottling=a,this._useInitialFPSLimiting=r,this._useMainThreadRendering=s,n&&(this._ratioReporter=new C(1500,.94,3),this._ratioReporter.pause(5e3),this._ratioReporter.onThrottling=()=>{if(!this._decreaseDecoderCapacity()){const e=Math.floor(this._fpsLimit/1.25)||1;o.warn(`AnimojiDecoderPool: throttling detected, lowering FPS limit: ${this._fpsLimit} -> ${e}`),this._fpsLimit=e,this.load>0&&(this._updateThrottledTaskSender(),this._sendSetFPSLimit(e))}})}}class b{static setSvgData(e){b.svgData=e}static getPreview(e=null,t=720,i=720){return n(this,void 0,void 0,(function*(){const n=e||b.svgData;if(!n)throw new Error("No svg");const r="preview";return new Promise(((e,a)=>{let s=0;const o=new I((t=>{e(t),window.clearTimeout(s),o.destroy()}),(()=>{}));if(s=window.setTimeout((()=>{o.destroy(),a("Timeout")}),3e3),n.svg instanceof ArrayBuffer){const{svg:e,userId:t}=n;o.addTask({type:"set_svg_ecnrypted",participantId:r,svgEncrypted:e,userId:t})}else o.addTask({type:"set_svg",participantId:r,svg:n.svg});const c=new Uint8Array(248);o.addTask({type:"frame",participantId:r,isMe:!0,data:c.buffer,targetDimensions:{width:t,height:i}})}))}))}}b.timeToRender=0,b.onTimeToRender=null;const R="animojiCtxStorage";class A{_createCanvas(e,t){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=e,this._canvas.height=t,this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="0",this._canvas.style.zIndex="5000",document.body.appendChild(this._canvas),this._useImageBitmap?this._canvasContext=this._canvas.getContext("bitmaprenderer"):this._canvasContext=this._canvas.getContext("2d",{alpha:!1}),a[this._participantId]=this._canvas,self[R]||(self[R]={}),self[R][this._participantId]=this._canvasContext)}_removeStream(){this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._canvasContext=null;try{this._canvas&&document.body.removeChild(this._canvas)}catch(e){}this._canvas=null}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}drawImage({image:e,width:t,height:i,index:r}){var a;return n(this,void 0,void 0,(function*(){const n=void 0!==r;this._track||(this._stream=null===(a=this._canvas)||void 0===a?void 0:a.captureStream(0),this._track=this._stream.getVideoTracks()[0],this._stream&&this._onStream(this._stream));const s=this._canvas;if(s){if(s.width!==t&&(s.width=t,s.height=i),e instanceof ImageData)if(n)if(this._useImageBitmap){const n=yield createImageBitmap(e,t*r,0,t,i);this._canvasContext.transferFromImageBitmap(n),n.close()}else this._canvasContext.putImageData(e,-t*r,0,t*r,0,t,i);else if(this._useImageBitmap){const n=yield createImageBitmap(e,0,0,t,i);this._canvasContext.transferFromImageBitmap(n),n.close()}else this._canvasContext.putImageData(e,0,0);this._requestCanvasFrame()}}))}destroy(){this._removeStream(),o.debug("AnimojiRenderer destroyed")}constructor(e,t,i){this._canvas=null,this._canvasContext=null,this._stream=null,this._track=null,this._onStream=()=>{},this._useImageBitmap="ImageBitmap"in window,this._onStream=e,this._participantId=t,this._useImageBitmap=i,this._createCanvas(1280,720),o.debug("AnimojiRenderer started")}}class w{_onFrame(e){const t=Array.isArray(e.participantIds),i=t?e.participantIds:[e.participantIds],{width:n,height:r,image:a}=e;for(const e of i){const s=this._renderers[e],c={width:Math.floor(n/i.length),height:r,image:a};t&&(c.index=i.indexOf(e)),s?s.drawImage(c):o.warn(`AnimojiReceiver: No renderer found for participant id ${e}`)}}_onDataChannelMessage(e){var t,i,n;const r=function(e){const t=new DataView(e),i=t.getUint8(0),n=t.getUint16(1),r=t.getUint32(3),a=t.getUint16(7),s=!!(1&t.getUint8(9));return{version:i,sequence:n,timestamp:r,ssrc:a,eos:s,data:s?null:e.slice(10)}}(e);let a;a=r.ssrc===f?this._myParticipantId:null!==(n=null===(i=null===(t=this._participantIdRegistry)||void 0===t?void 0:t.getStreamDescription(r.ssrc))||void 0===i?void 0:i.participantId)&&void 0!==n?n:this._participantId,a?this._onAnimojiPacket(a,r):o.warn(`AnimojiReceiver: Participant id for ssrc ${r.ssrc} not found in registry`)}_onAnimojiPacket(e,t){var i,n;if(t.eos)return void this.close(e);this._lastFrameReceivedByParticipantId[e]=Date.now();let r=this._renderers[e];r||(r=new A((t=>this._onStream(e,t)),e,this._useImageBitmap),this._renderers[e]=r),(null===(i=this._svgCache[e])||void 0===i?void 0:i.svgData)&&!this._svgCache[e].isSet&&this.setParticipantSvg(e,this._svgCache[e].svgData),t.data&&(null===(n=this._animojiDecoderPool)||void 0===n||n.addTask({type:"frame",participantId:e,isMe:this._myParticipantId===e,data:t.data}))}_onParticipantRemoved(e){this._svgCache[e]&&(this._svgCache[e].isSet=!1),this._destroyRenderer(e),this._onEos(e)}_clearIdleParticipants(){for(const[e,t]of Object.entries(this._lastFrameReceivedByParticipantId))Date.now()-t>=3e3&&(o.warn(`AnimojiReceiver: Participant ${e} timed out after idling for 3000 ms, freeing resources...`),this.close(e))}receive(e){this._onDataChannelMessage(e)}setDataChannel(e){this._datachannel&&(this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null),e&&(e.onmessage=e=>this._onDataChannelMessage(e.data)),this._datachannel=e}setParticipantId(e){this._participantId=e}setParticipantIdRegistry(e){this._participantIdRegistry=e}setParticipantSvg(e,t){var i,n;if(t.isMe&&(this._myParticipantId=e),this._svgCache[e]={svgData:t,isSet:!0},t.svg instanceof ArrayBuffer){const{svg:n,userId:r}=t;null===(i=this._animojiDecoderPool)||void 0===i||i.addTask({type:"set_svg_ecnrypted",participantId:e,svgEncrypted:n,userId:r})}else null===(n=this._animojiDecoderPool)||void 0===n||n.addTask({type:"set_svg",participantId:e,svg:t.svg})}close(e){var t;delete this._lastFrameReceivedByParticipantId[e],this._destroyRenderer(e),null===(t=this._animojiDecoderPool)||void 0===t||t.removeParticipant(e)}_destroyRenderer(e){const t=this._renderers[e];t&&(t.destroy(),delete this._renderers[e])}destroy(){var e;this._datachannel&&(this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null),window.clearInterval(this._clearIdleParticipantsInterval),this._onStream=()=>{},Object.values(this._renderers).forEach((e=>e.destroy())),null===(e=this._animojiDecoderPool)||void 0===e||e.destroy(),this._renderers={},this._animojiDecoderPool=null,this._participantId=null,this._participantIdRegistry=null,this._svgCache={},o.debug("AnimojiReceiver destroyed")}constructor(e,t,i={}){this._datachannel=null,this._participantIdRegistry=null,this._participantId=null,this._myParticipantId=null,this._renderers={},this._svgCache={},this._lastFrameReceivedByParticipantId={},this._clearIdleParticipantsInterval=0,this._animojiDecoderPool=null,this._onStream=()=>{},this._onEos=()=>{},o.debug("AnimojiReceiver started"),this._onStream=e,this._onEos=t;const{useImageBitmapIfAvailable:n,useFPSControl:r,useMainThreadRendering:a,useInitialFPSLimiting:s,useTaskThrottling:c,maxPoolSize:l,decoderCapacity:u,decoderOptions:d}=Object.assign({useImageBitmapIfAvailable:!1,useFPSControl:!1,useInitialFPSLimiting:!1,useTaskThrottling:!1,useMainThreadRendering:!1,useFullClientRendering:!1,maxPoolSize:null,decoderCapacity:null,decoderOptions:{}},i);this._useImageBitmap=n&&"ImageBitmap"in window,this._animojiDecoderPool=new I(this._onFrame.bind(this),this._onParticipantRemoved.bind(this),(e=>{var t;b.timeToRender=e,null===(t=b.onTimeToRender)||void 0===t||t.call(b,e)}),r,s,c,a,d,l,u),this._datachannel&&(this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)),this._clearIdleParticipantsInterval=window.setInterval(this._clearIdleParticipants.bind(this),1e3)}}function P(){class e extends AudioWorkletProcessor{process(e){var t;const i=Date.now();let n=0;const r=null===(t=null==e?void 0:e[0])||void 0===t?void 0:t[0];if((null==r?void 0:r.length)&&(n=r.reduce(((e,t)=>e+Math.abs(t)),0)/r.length),this.frameSampleAverage=(this.frameSampleAverage*this.frameSampleCount+n)/(this.frameSampleCount+1),this.frameSampleCount+=1,i-this.lastTimestamp>40){const e=[];for(let t=0;t<62;t+=1)e.push(0);this.frameSampleAverage>.015&&(e[59]=this.frameSampleAverage/this.maxInputVolume>.5&&this.sequence%2==0?this.frameSampleAverage/2:this.frameSampleAverage,e[0]=this.maxInputVolume/.432),this.sequence+=1,this.frameSampleCount=1,this.maxInputVolume=Math.max(this.maxInputVolume,this.frameSampleAverage),this.lastTimestamp=i;const t=new Float32Array(e).buffer;this.port.postMessage({type:"frame",timestamp:Math.round(i),data:t},[t])}return!0}constructor(){super(),this.lastTimestamp=0,this.frameSampleCount=0,this.frameSampleAverage=0,this.maxInputVolume=.3,this.sequence=0,this.port.postMessage({type:"init"})}}registerProcessor("animoji-processor",e)}class k{init(e,t){return n(this,void 0,void 0,(function*(){o.debug("AnimojiEncoder started"),yield this._createWorklet((t=>{t.error?o.warn("AnimojiEncoder",t.error):e(t)}),t)}))}setStream(e){var t;if(this._audioContext&&this._worklet){const i=e?this._audioContext.createMediaStreamSource(e):null;null===(t=this._streamSource)||void 0===t||t.disconnect(this._worklet),null==i||i.connect(this._worklet),this._streamSource=i}}destroy(){var e;null===(e=this._audioContext)||void 0===e||e.close(),this._worklet=null,this._streamSource=null,this._audioContext=null,o.debug("AnimojiEncoder destroyed")}resume(){var e;null===(e=this._audioContext)||void 0===e||e.resume()}pause(){var e;null===(e=this._audioContext)||void 0===e||e.suspend()}_createWorklet(e,t){return n(this,void 0,void 0,(function*(){return new Promise(((i,n)=>{const r=new(window.AudioContext||window.webkitAudioContext);this._audioContext=r,r.resume().then((()=>r.audioWorklet.addModule(d(P)))).then((()=>{const a=new AudioWorkletNode(r,"animoji-processor");this._worklet=a,t||r.suspend(),a.port.onmessage=({data:t})=>{switch(t.type){case"init":i();break;case"error":n(t.error);break;case"frame":e(t);break;case"debug":o.debug(t.message)}}})).catch((e=>o.warn("Error constructing audio worklet node",e)))}))}))}constructor(){this._audioContext=null,this._worklet=null,this._streamSource=null}}let D=0;class O{setStream(e){this._stream=e,this._workletReady&&this._encoder.setStream(e)}setDataChannel(e){this._datachannel=e}resume(){this._encoder.resume(),this._isPaused=!1}pause(){this._isPaused=!0,this._encoder.pause(),this._sendStopPacket()}_onFrame(e,t){if(this._destroyed||this._isPaused)return;if(!e)return void o.warn("Animoji encoding failed: ",t);const i=this._wrapHeader(f,e.timestamp,e.data);this.onLocalData(i),this._send(e)}_wrapHeader(e,t,i=null,n=!1){const r=function(e,t,i,n=null,r=!1){let a=0;r&&(a|=1);const s=new ArrayBuffer(10),o=new DataView(s);if(o.setUint8(0,1),o.setUint16(1,t),o.setUint32(3,i),o.setUint16(7,e),o.setUint8(9,a),!n)return s;const c=new Uint8Array(s.byteLength+n.byteLength);return c.set(new Uint8Array(s),0),c.set(new Uint8Array(n),s.byteLength),c.buffer}(e,t,D,i,n);return D=(D+1)%65536,r}_createStopPacket(e){return this._wrapHeader(e,Date.now(),null,!0)}_send({timestamp:e,data:t}){if(null===this._datachannel)return;if(!this._datachannel||"open"!==this._datachannel.readyState)return void o.warn("AnimojiSender: _send failed, DataChannel is not available");const i=this._wrapHeader(0,e,t);try{this._datachannel.send(i)}catch(e){return void o.warn("AnimojiSender: error sending data to DataChannel",e)}}_sendStopPacket(){var e;if("open"===(null===(e=this._datachannel)||void 0===e?void 0:e.readyState)){const e=this._createStopPacket(0);this._datachannel.send(e)}const t=this._createStopPacket(f);this.onLocalData(t)}destroy(){this._sendStopPacket(),this.onLocalData=()=>{},this._destroyed=!0,this._encoder.destroy(),o.debug("AnimojiSender destroyed")}constructor(e=null,t){this._datachannel=null,this._stream=null,this._workletReady=!1,this._destroyed=!1,this._isPaused=!1,this.onLocalData=()=>{},o.debug("AnimojiSender started"),this._encoder=new k,this._encoder.init(this._onFrame.bind(this),t).then((()=>{this._workletReady=!0,this._stream&&this._encoder.setStream(this._stream)})).catch((e=>o.warn("AnimojiEncoder failed to init:",e))),e&&this.setStream(e)}}},778:function(e){var t=function(){"undefined"!=typeof document&&document.currentScript&&document.currentScript.src;return function(e){var t,i,n=void 0!==(e=e||{})?e:{};n.ready=new Promise((function(e,n){t=e,i=n}));var r,a={};for(r in n)n.hasOwnProperty(r)&&(a[r]=n[r]);var s,o=[],c=!0,l=!1,u="";(c||l)&&(l?u=self.location.href:"undefined"!=typeof document&&document.currentScript&&(u=document.currentScript.src),u=0!==u.indexOf("blob:")?u.substr(0,u.lastIndexOf("/")+1):"",function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},l&&(s=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),function(e,t,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){200==n.status||0==n.status&&n.response?t(n.response):i()},n.onerror=i,n.send(null)});var d=n.print||console.log.bind(console),h=n.printErr||console.warn.bind(console);for(r in a)a.hasOwnProperty(r)&&(n[r]=a[r]);a=null,n.arguments&&(o=n.arguments),n.thisProgram&&n.thisProgram,n.quit&&n.quit;var p,_=0;n.wasmBinary&&(p=n.wasmBinary);var m;n.noExitRuntime;"object"!=typeof WebAssembly&&W("no native wasm support detected");var f=!1;var g="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function v(e,t,i){for(var n=t+i,r=t;e[r]&&!(r>=n);)++r;if(r-t>16&&e.subarray&&g)return g.decode(e.subarray(t,r));for(var a="";t<r;){var s=e[t++];if(128&s){var o=63&e[t++];if(192!=(224&s)){var c=63&e[t++];if((s=224==(240&s)?(15&s)<<12|o<<6|c:(7&s)<<18|o<<12|c<<6|63&e[t++])<65536)a+=String.fromCharCode(s);else{var l=s-65536;a+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else a+=String.fromCharCode((31&s)<<6|o)}else a+=String.fromCharCode(s)}return a}function S(e,t){return e?v(E,e,t):""}var y,T,E,C,I,b,R,A,w,P="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function k(e,t){for(var i=e,n=i>>1,r=n+t/2;!(n>=r)&&I[n];)++n;if((i=n<<1)-e>32&&P)return P.decode(E.subarray(e,i));for(var a="",s=0;!(s>=t/2);++s){var o=C[e+2*s>>1];if(0==o)break;a+=String.fromCharCode(o)}return a}function D(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var n=t,r=(i-=2)<2*e.length?i/2:e.length,a=0;a<r;++a){var s=e.charCodeAt(a);C[t>>1]=s,t+=2}return C[t>>1]=0,t-n}function O(e){return 2*e.length}function N(e,t){for(var i=0,n="";!(i>=t/4);){var r=b[e+4*i>>2];if(0==r)break;if(++i,r>=65536){var a=r-65536;n+=String.fromCharCode(55296|a>>10,56320|1023&a)}else n+=String.fromCharCode(r)}return n}function M(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var n=t,r=n+i-4,a=0;a<e.length;++a){var s=e.charCodeAt(a);if(s>=55296&&s<=57343)s=65536+((1023&s)<<10)|1023&e.charCodeAt(++a);if(b[t>>2]=s,(t+=4)+4>r)break}return b[t>>2]=0,t-n}function L(e){for(var t=0,i=0;i<e.length;++i){var n=e.charCodeAt(i);n>=55296&&n<=57343&&++i,t+=4}return t}function x(e){y=e,n.HEAP8=T=new Int8Array(e),n.HEAP16=C=new Int16Array(e),n.HEAP32=b=new Int32Array(e),n.HEAPU8=E=new Uint8Array(e),n.HEAPU16=I=new Uint16Array(e),n.HEAPU32=R=new Uint32Array(e),n.HEAPF32=A=new Float32Array(e),n.HEAPF64=w=new Float64Array(e)}n.INITIAL_MEMORY;var U,V=[],F=[],j=[];var $=0,B=null,H=null;function W(e){n.onAbort&&n.onAbort(e),h(e+=""),f=!0,1,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}n.preloadedImages={},n.preloadedAudios={};var G,K,q="data:application/octet-stream;base64,";function z(e){return e.startsWith(q)}function J(e){try{if(e==G&&p)return new Uint8Array(p);if(s)return s(e);throw"both async and sync fetching of the wasm failed"}catch(e){W(e)}}function Y(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var i=t.func;"number"==typeof i?void 0===t.arg?U.get(i)():U.get(i)(t.arg):i(void 0===t.arg?null:t.arg)}else t(n)}}function Q(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}z(G="libvpx.wasm")||(K=G,G=n.locateFile?n.locateFile(K,u):u+K);var Z=void 0;function X(e){for(var t="",i=e;E[i];)t+=Z[E[i++]];return t}var ee={},te={},ie={},ne=48,re=57;function ae(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=ne&&t<=re?"_"+e:e}function se(e,t){return e=ae(e),function(){return t.apply(this,arguments)}}function oe(e,t){var i=se(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var ce=void 0;function le(e){throw new ce(e)}var ue=void 0;function de(e){throw new ue(e)}function he(e,t,i){function n(t){var n=i(t);n.length!==e.length&&de("Mismatched type converter count");for(var r=0;r<e.length;++r)pe(e[r],n[r])}e.forEach((function(e){ie[e]=t}));var r=new Array(t.length),a=[],s=0;t.forEach((function(e,t){te.hasOwnProperty(e)?r[t]=te[e]:(a.push(e),ee.hasOwnProperty(e)||(ee[e]=[]),ee[e].push((function(){r[t]=te[e],++s===a.length&&n(r)})))})),0===a.length&&n(r)}function pe(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var n=t.name;if(e||le('type "'+n+'" must have a positive integer typeid pointer'),te.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;le("Cannot register type '"+n+"' twice")}if(te[e]=t,delete ie[e],ee.hasOwnProperty(e)){var r=ee[e];delete ee[e],r.forEach((function(e){e()}))}}function _e(e){if(!(this instanceof Ae))return!1;if(!(e instanceof Ae))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,n=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;n.baseClass;)r=n.upcast(r),n=n.baseClass;return t===n&&i===r}function me(e){le(e.$$.ptrType.registeredClass.name+" instance already deleted")}var fe=!1;function ge(e){}function ve(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function Se(e){return"undefined"==typeof FinalizationGroup?(Se=function(e){return e},e):(fe=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?ve(i):console.warn("object already deleted: "+i.ptr)}})),Se=function(e){return fe.register(e,e.$$,e.$$),e},ge=function(e){fe.unregister(e.$$)},Se(e))}function ye(){if(this.$$.ptr||me(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=Se(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t}function Te(){this.$$.ptr||me(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&le("Object already scheduled for deletion"),ge(this),ve(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function Ee(){return!this.$$.ptr}var Ce=void 0,Ie=[];function be(){for(;Ie.length;){var e=Ie.pop();e.$$.deleteScheduled=!1,e.delete()}}function Re(){return this.$$.ptr||me(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&le("Object already scheduled for deletion"),Ie.push(this),1===Ie.length&&Ce&&Ce(be),this.$$.deleteScheduled=!0,this}function Ae(){}var we={};function Pe(e,t,i){if(void 0===e[t].overloadTable){var n=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||le("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[n.argCount]=n}}function ke(e,t,i){n.hasOwnProperty(e)?((void 0===i||void 0!==n[e].overloadTable&&void 0!==n[e].overloadTable[i])&&le("Cannot register public name '"+e+"' twice"),Pe(n,e,e),n.hasOwnProperty(i)&&le("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),n[e].overloadTable[i]=t):(n[e]=t,void 0!==i&&(n[e].numArguments=i))}function De(e,t,i,n,r,a,s,o){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=n,this.baseClass=r,this.getActualType=a,this.upcast=s,this.downcast=o,this.pureVirtualFunctions=[]}function Oe(e,t,i){for(;t!==i;)t.upcast||le("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Ne(e,t){if(null===t)return this.isReference&&le("null is not a valid "+this.name),0;t.$$||le('Cannot pass "'+ut(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return Oe(t.$$.ptr,i,this.registeredClass)}function Me(e,t){var i;if(null===t)return this.isReference&&le("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||le('Cannot pass "'+ut(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&le("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var n=t.$$.ptrType.registeredClass;if(i=Oe(t.$$.ptr,n,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&le("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:le("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var r=t.clone();i=this.rawShare(i,ot((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:le("Unsupporting sharing policy")}return i}function Le(e,t){if(null===t)return this.isReference&&le("null is not a valid "+this.name),0;t.$$||le('Cannot pass "'+ut(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&le("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return Oe(t.$$.ptr,i,this.registeredClass)}function xe(e){return this.fromWireType(R[e>>2])}function Ue(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function Ve(e){this.rawDestructor&&this.rawDestructor(e)}function Fe(e){null!==e&&e.delete()}function je(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var n=je(e,t,i.baseClass);return null===n?null:i.downcast(n)}function $e(){return Object.keys(We).length}function Be(){var e=[];for(var t in We)We.hasOwnProperty(t)&&e.push(We[t]);return e}function He(e){Ce=e,Ie.length&&Ce&&Ce(be)}var We={};function Ge(e,t){return t=function(e,t){for(void 0===t&&le("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),We[t]}function Ke(e,t){return t.ptrType&&t.ptr||de("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!==!!t.smartPtr&&de("Both smartPtrType and smartPtr must be specified"),t.count={value:1},Se(Object.create(e,{$$:{value:t}}))}function qe(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=Ge(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var n=i.clone();return this.destructor(e),n}function r(){return this.isSmartPointer?Ke(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Ke(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var a,s=this.registeredClass.getActualType(t),o=we[s];if(!o)return r.call(this);a=this.isConst?o.constPointerType:o.pointerType;var c=je(t,this.registeredClass,a.registeredClass);return null===c?r.call(this):this.isSmartPointer?Ke(a.registeredClass.instancePrototype,{ptrType:a,ptr:c,smartPtrType:this,smartPtr:e}):Ke(a.registeredClass.instancePrototype,{ptrType:a,ptr:c})}function ze(e,t,i,n,r,a,s,o,c,l,u){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=n,this.isSmartPointer=r,this.pointeeType=a,this.sharingPolicy=s,this.rawGetPointee=o,this.rawConstructor=c,this.rawShare=l,this.rawDestructor=u,r||void 0!==t.baseClass?this.toWireType=Me:n?(this.toWireType=Ne,this.destructorFunction=null):(this.toWireType=Le,this.destructorFunction=null)}function Je(e,t,i){return e.includes("j")?function(e,t,i){var r=n["dynCall_"+e];return i&&i.length?r.apply(null,[t].concat(i)):r.call(null,t)}(e,t,i):U.get(t).apply(null,i)}function Ye(e,t){var i,n,r,a=(e=X(e)).includes("j")?(i=e,n=t,r=[],function(){r.length=arguments.length;for(var e=0;e<arguments.length;e++)r[e]=arguments[e];return Je(i,n,r)}):U.get(t);return"function"!=typeof a&&le("unknown function pointer with signature "+e+": "+t),a}var Qe=void 0;function Ze(e){var t=St(e),i=X(t);return gt(t),i}function Xe(e,t){var i=[],n={};throw t.forEach((function e(t){n[t]||te[t]||(ie[t]?ie[t].forEach(e):(i.push(t),n[t]=!0))})),new Qe(e+": "+i.map(Ze).join([", "]))}function et(e,t){for(var i=[],n=0;n<e;n++)i.push(b[(t>>2)+n]);return i}function tt(e,t,i,n,r){var a=t.length;a<2&&le("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var s=null!==t[1]&&null!==i,o=!1,c=1;c<t.length;++c)if(null!==t[c]&&void 0===t[c].destructorFunction){o=!0;break}var l="void"!==t[0].name,u=a-2,d=new Array(u),h=[],p=[];return function(){var i;arguments.length!==u&&le("function "+e+" called with "+arguments.length+" arguments, expected "+u+" args!"),p.length=0,h.length=s?2:1,h[0]=r,s&&(i=t[1].toWireType(p,this),h[1]=i);for(var a=0;a<u;++a)d[a]=t[a+2].toWireType(p,arguments[a]),h.push(d[a]);return function(e){if(o)!function(e){for(;e.length;){var t=e.pop();e.pop()(t)}}(p);else for(var n=s?1:2;n<t.length;n++){var r=1===n?i:d[n-2];null!==t[n].destructorFunction&&t[n].destructorFunction(r)}if(l)return t[0].fromWireType(e)}(n.apply(null,h))}}var it=[],nt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function rt(e){e>4&&0==--nt[e].refcount&&(nt[e]=void 0,it.push(e))}function at(){for(var e=0,t=5;t<nt.length;++t)void 0!==nt[t]&&++e;return e}function st(){for(var e=5;e<nt.length;++e)if(void 0!==nt[e])return nt[e];return null}function ot(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=it.length?it.pop():nt.length;return nt[t]={refcount:1,value:e},t}}function ct(e,t,i){switch(t){case 0:return function(e){var t=i?T:E;return this.fromWireType(t[e])};case 1:return function(e){var t=i?C:I;return this.fromWireType(t[e>>1])};case 2:return function(e){var t=i?b:R;return this.fromWireType(t[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function lt(e,t){var i=te[e];return void 0===i&&le(t+" has unknown type "+Ze(e)),i}function ut(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function dt(e,t){switch(t){case 2:return function(e){return this.fromWireType(A[e>>2])};case 3:return function(e){return this.fromWireType(w[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ht(e,t,i){switch(t){case 0:return i?function(e){return T[e]}:function(e){return E[e]};case 1:return i?function(e){return C[e>>1]}:function(e){return I[e>>1]};case 2:return i?function(e){return b[e>>2]}:function(e){return R[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function pt(e){try{return m.grow(e-y.byteLength+65535>>>16),x(m.buffer),1}catch(e){}}var _t={mappings:{},buffers:[null,[],[]],printChar:function(e,t){var i=_t.buffers[e];0===t||10===t?((1===e?d:h)(v(i,0)),i.length=0):i.push(t)},varargs:void 0,get:function(){return _t.varargs+=4,b[_t.varargs-4>>2]},getStr:function(e){return S(e)},get64:function(e,t){return e}};!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);Z=e}(),ce=n.BindingError=oe(Error,"BindingError"),ue=n.InternalError=oe(Error,"InternalError"),Ae.prototype.isAliasOf=_e,Ae.prototype.clone=ye,Ae.prototype.delete=Te,Ae.prototype.isDeleted=Ee,Ae.prototype.deleteLater=Re,ze.prototype.getPointee=Ue,ze.prototype.destructor=Ve,ze.prototype.argPackAdvance=8,ze.prototype.readValueFromPointer=xe,ze.prototype.deleteObject=Fe,ze.prototype.fromWireType=qe,n.getInheritedInstanceCount=$e,n.getLiveInheritedInstances=Be,n.flushPendingDeletes=be,n.setDelayFunction=He,Qe=n.UnboundTypeError=oe(Error,"UnboundTypeError"),n.count_emval_handles=at,n.get_first_emval=st;var mt,ft={y:function(e,t,i,n,r){},H:function(e,t,i,n,r){var a=Q(i);pe(e,{name:t=X(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?n:r},argPackAdvance:8,readValueFromPointer:function(e){var n;if(1===i)n=T;else if(2===i)n=C;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);n=b}return this.fromWireType(n[e>>a])},destructorFunction:null})},t:function(e,t,i,r,a,s,o,c,l,u,d,h,p){d=X(d),s=Ye(a,s),c&&(c=Ye(o,c)),u&&(u=Ye(l,u)),p=Ye(h,p);var _=ae(d);ke(_,(function(){Xe("Cannot construct "+d+" due to unbound types",[r])})),he([e,t,i],r?[r]:[],(function(t){var i,a;t=t[0],a=r?(i=t.registeredClass).instancePrototype:Ae.prototype;var o=se(_,(function(){if(Object.getPrototypeOf(this)!==l)throw new ce("Use 'new' to construct "+d);if(void 0===h.constructor_body)throw new ce(d+" has no accessible constructor");var e=h.constructor_body[arguments.length];if(void 0===e)throw new ce("Tried to invoke ctor of "+d+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(h.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),l=Object.create(a,{constructor:{value:o}});o.prototype=l;var h=new De(d,o,l,p,i,s,c,u),m=new ze(d,h,!0,!1,!1),f=new ze(d+"*",h,!1,!1,!1),g=new ze(d+" const*",h,!1,!0,!1);return we[e]={pointerType:f,constPointerType:g},function(e,t,i){n.hasOwnProperty(e)||de("Replacing nonexistant public symbol"),void 0!==n[e].overloadTable&&void 0!==i?n[e].overloadTable[i]=t:(n[e]=t,n[e].argCount=i)}(_,o),[m,f,g]}))},p:function(e,t,i,n,r,a){var s;t>0||W("Assertion failed: "+s);var o=et(t,i);r=Ye(n,r),he([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ce("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){Xe("Cannot construct "+e.name+" due to unbound types",o)},he([],o,(function(n){return n.splice(1,0,null),e.registeredClass.constructor_body[t-1]=tt(i,n,null,r,a),[]})),[]}))},e:function(e,t,i,n,r,a,s,o){var c=et(i,n);t=X(t),a=Ye(r,a),he([],[e],(function(e){var n=(e=e[0]).name+"."+t;function r(){Xe("Cannot call "+n+" due to unbound types",c)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),o&&e.registeredClass.pureVirtualFunctions.push(t);var l=e.registeredClass.instancePrototype,u=l[t];return void 0===u||void 0===u.overloadTable&&u.className!==e.name&&u.argCount===i-2?(r.argCount=i-2,r.className=e.name,l[t]=r):(Pe(l,t,n),l[t].overloadTable[i-2]=r),he([],c,(function(r){var o=tt(n,r,e,a,s);return void 0===l[t].overloadTable?(o.argCount=i-2,l[t]=o):l[t].overloadTable[i-2]=o,[]})),[]}))},G:function(e,t){pe(e,{name:t=X(t),fromWireType:function(e){var t=nt[e].value;return rt(e),t},toWireType:function(e,t){return ot(t)},argPackAdvance:8,readValueFromPointer:xe,destructorFunction:null})},L:function(e,t,i,n){var r=Q(i);function a(){}t=X(t),a.values={},pe(e,{name:t,constructor:a,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:ct(t,r,n),destructorFunction:null}),ke(t,a)},x:function(e,t,i){var n=lt(e,"enum");t=X(t);var r=n.constructor,a=Object.create(n.constructor.prototype,{value:{value:i},constructor:{value:se(n.name+"_"+t,(function(){}))}});r.values[i]=a,r[t]=a},r:function(e,t,i){var n=Q(i);pe(e,{name:t=X(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+ut(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:dt(t,n),destructorFunction:null})},h:function(e,t,i,n,r){t=X(t),-1===r&&(r=4294967295);var a=Q(i),s=function(e){return e};if(0===n){var o=32-8*i;s=function(e){return e<<o>>>o}}var c=t.includes("unsigned");pe(e,{name:t,fromWireType:s,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+ut(i)+'" to '+this.name);if(i<n||i>r)throw new TypeError('Passing a number "'+ut(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+n+", "+r+"]!");return c?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:ht(t,a,0!==n),destructorFunction:null})},g:function(e,t,i){var n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=R,i=t[e>>=2],r=t[e+1];return new n(y,r,i)}pe(e,{name:i=X(i),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},s:function(e,t){var i="std::string"===(t=X(t));pe(e,{name:t,fromWireType:function(e){var t,n=R[e>>2];if(i)for(var r=e+4,a=0;a<=n;++a){var s=e+4+a;if(a==n||0==E[s]){var o=S(r,s-r);void 0===t?t=o:(t+=String.fromCharCode(0),t+=o),r=s+1}}else{var c=new Array(n);for(a=0;a<n;++a)c[a]=String.fromCharCode(E[e+4+a]);t=c.join("")}return gt(e),t},toWireType:function(e,t){var n;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||le("Cannot pass non-string to std::string"),n=i&&r?function(){return function(e){for(var t=0,i=0;i<e.length;++i){var n=e.charCodeAt(i);n>=55296&&n<=57343&&(n=65536+((1023&n)<<10)|1023&e.charCodeAt(++i)),n<=127?++t:t+=n<=2047?2:n<=65535?3:4}return t}(t)}:function(){return t.length};var a=n(),s=vt(4+a+1);if(R[s>>2]=a,i&&r)(function(e,t,i,n){if(!(n>0))return 0;for(var r=i,a=i+n-1,s=0;s<e.length;++s){var o=e.charCodeAt(s);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++s)),o<=127){if(i>=a)break;t[i++]=o}else if(o<=2047){if(i+1>=a)break;t[i++]=192|o>>6,t[i++]=128|63&o}else if(o<=65535){if(i+2>=a)break;t[i++]=224|o>>12,t[i++]=128|o>>6&63,t[i++]=128|63&o}else{if(i+3>=a)break;t[i++]=240|o>>18,t[i++]=128|o>>12&63,t[i++]=128|o>>6&63,t[i++]=128|63&o}}t[i]=0})(t,E,s+4,a+1);else if(r)for(var o=0;o<a;++o){var c=t.charCodeAt(o);c>255&&(gt(s),le("String has UTF-16 code units that do not fit in 8 bits")),E[s+4+o]=c}else for(o=0;o<a;++o)E[s+4+o]=t[o];return null!==e&&e.push(gt,s),s},argPackAdvance:8,readValueFromPointer:xe,destructorFunction:function(e){gt(e)}})},m:function(e,t,i){var n,r,a,s,o;i=X(i),2===t?(n=k,r=D,s=O,a=function(){return I},o=1):4===t&&(n=N,r=M,s=L,a=function(){return R},o=2),pe(e,{name:i,fromWireType:function(e){for(var i,r=R[e>>2],s=a(),c=e+4,l=0;l<=r;++l){var u=e+4+l*t;if(l==r||0==s[u>>o]){var d=n(c,u-c);void 0===i?i=d:(i+=String.fromCharCode(0),i+=d),c=u+t}}return gt(e),i},toWireType:function(e,n){"string"!=typeof n&&le("Cannot pass non-string to C++ string type "+i);var a=s(n),c=vt(4+a+t);return R[c>>2]=a>>o,r(n,c+4,a+t),null!==e&&e.push(gt,c),c},argPackAdvance:8,readValueFromPointer:xe,destructorFunction:function(e){gt(e)}})},I:function(e,t){pe(e,{isVoid:!0,name:t=X(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},F:function(){throw"longjmp"},k:rt,l:function(e){e>4&&(nt[e].refcount+=1)},j:function(e,t){return ot((e=lt(e,"_emval_take_value")).readValueFromPointer(t))},E:function(){W()},C:function(e,t,i){E.copyWithin(e,t,t+i)},D:function(e){var t,i,n=E.length,r=2147483648;if((e>>>=0)>r)return!1;for(var a=1;a<=4;a*=2){var s=n*(1+.2/a);if(s=Math.min(s,e+100663296),pt(Math.min(r,((t=Math.max(e,s))%(i=65536)>0&&(t+=i-t%i),t))))return!0}return!1},q:function(e,t,i,n){for(var r=0,a=0;a<i;a++){for(var s=b[t+8*a>>2],o=b[t+(8*a+4)>>2],c=0;c<o;c++)_t.printChar(e,E[s+c]);r+=o}return b[n>>2]=r,0},a:function(){return _},f:function(e){var t=Date.now();return b[e>>2]=t/1e3|0,b[e+4>>2]=t%1e3*1e3|0,0},d:function(e,t,i){var n=yt();try{return U.get(e)(t,i)}catch(e){if(Tt(n),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},n:function(e,t,i,n){var r=yt();try{return U.get(e)(t,i,n)}catch(e){if(Tt(r),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},o:function(e,t,i,n,r){var a=yt();try{return U.get(e)(t,i,n,r)}catch(e){if(Tt(a),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},u:function(e,t,i,n,r,a){var s=yt();try{return U.get(e)(t,i,n,r,a)}catch(e){if(Tt(s),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},K:function(e,t,i,n,r,a,s,o,c){var l=yt();try{return U.get(e)(t,i,n,r,a,s,o,c)}catch(e){if(Tt(l),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},B:function(e,t,i,n,r,a,s,o){var c=yt();try{return Ct(e,t,i,n,r,a,s,o)}catch(e){if(Tt(c),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},z:function(e,t,i,n){var r=yt();try{return bt(e,t,i,n)}catch(e){if(Tt(r),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},i:function(e,t){var i=yt();try{U.get(e)(t)}catch(e){if(Tt(i),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},w:function(e,t,i){var n=yt();try{U.get(e)(t,i)}catch(e){if(Tt(n),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},c:function(e,t,i,n,r){var a=yt();try{U.get(e)(t,i,n,r)}catch(e){if(Tt(a),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},J:function(e,t,i,n,r,a,s){var o=yt();try{U.get(e)(t,i,n,r,a,s)}catch(e){if(Tt(o),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},v:function(e,t,i,n,r,a,s,o,c){var l=yt();try{U.get(e)(t,i,n,r,a,s,o,c)}catch(e){if(Tt(l),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},A:function(e,t,i,n,r,a,s,o,c,l){var u=yt();try{It(e,t,i,n,r,a,s,o,c,l)}catch(e){if(Tt(u),e!==e+0&&"longjmp"!==e)throw e;Et(1,0)}},b:function(e){_=e}},gt=(function(){var e={a:ft};function t(e,t){var i,r=e.exports;n.asm=r,x((m=n.asm.M).buffer),U=n.asm.Q,i=n.asm.N,F.unshift(i),function(e){if($--,n.monitorRunDependencies&&n.monitorRunDependencies($),0==$&&(null!==B&&(clearInterval(B),B=null),H)){var t=H;H=null,t()}}()}function r(e){t(e.instance)}function a(t){return(p||!c&&!l||"function"!=typeof fetch?Promise.resolve().then((function(){return J(G)})):fetch(G,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+G+"'";return e.arrayBuffer()})).catch((function(){return J(G)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){h("failed to asynchronously prepare wasm: "+e),W(e)}))}if($++,n.monitorRunDependencies&&n.monitorRunDependencies($),n.instantiateWasm)try{return n.instantiateWasm(e,t)}catch(e){return h("Module.instantiateWasm callback failed with error: "+e),!1}(p||"function"!=typeof WebAssembly.instantiateStreaming||z(G)||"function"!=typeof fetch?a(r):fetch(G,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(r,(function(e){return h("wasm streaming compile failed: "+e),h("falling back to ArrayBuffer instantiation"),a(r)}))}))).catch(i)}(),n.___wasm_call_ctors=function(){return(n.___wasm_call_ctors=n.asm.N).apply(null,arguments)},n._free=function(){return(gt=n._free=n.asm.O).apply(null,arguments)}),vt=n._malloc=function(){return(vt=n._malloc=n.asm.P).apply(null,arguments)},St=n.___getTypeName=function(){return(St=n.___getTypeName=n.asm.R).apply(null,arguments)},yt=(n.___embind_register_native_and_builtin_types=function(){return(n.___embind_register_native_and_builtin_types=n.asm.S).apply(null,arguments)},n.stackSave=function(){return(yt=n.stackSave=n.asm.T).apply(null,arguments)}),Tt=n.stackRestore=function(){return(Tt=n.stackRestore=n.asm.U).apply(null,arguments)},Et=n._setThrew=function(){return(Et=n._setThrew=n.asm.V).apply(null,arguments)},Ct=n.dynCall_iiiijj=function(){return(Ct=n.dynCall_iiiijj=n.asm.W).apply(null,arguments)},It=(n.dynCall_iiijiii=function(){return(n.dynCall_iiijiii=n.asm.X).apply(null,arguments)},n.dynCall_vijjjid=function(){return(It=n.dynCall_vijjjid=n.asm.Y).apply(null,arguments)}),bt=n.dynCall_iij=function(){return(bt=n.dynCall_iij=n.asm.Z).apply(null,arguments)};n.dynCall_jiji=function(){return(n.dynCall_jiji=n.asm._).apply(null,arguments)};function Rt(e){function i(){mt||(mt=!0,n.calledRun=!0,f||(!0,Y(F),t(n),n.onRuntimeInitialized&&n.onRuntimeInitialized(),function(){if(n.postRun)for("function"==typeof n.postRun&&(n.postRun=[n.postRun]);n.postRun.length;)e=n.postRun.shift(),j.unshift(e);var e;Y(j)}()))}e=e||o,$>0||(!function(){if(n.preRun)for("function"==typeof n.preRun&&(n.preRun=[n.preRun]);n.preRun.length;)e=n.preRun.shift(),V.unshift(e);var e;Y(V)}(),$>0||(n.setStatus?(n.setStatus("Running..."),setTimeout((function(){setTimeout((function(){n.setStatus("")}),1),i()}),1)):i()))}if(H=function e(){mt||Rt(),mt||(H=e)},n.run=Rt,n.preInit)for("function"==typeof n.preInit&&(n.preInit=[n.preInit]);n.preInit.length>0;)n.preInit.pop()();return Rt(),e.ready}}();e.exports=t,t.getUrl=function(e){return"https://st.mycdn.me/static/libvpx/2-0-9/"+e}},777:function(e,t,i){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}i.d(t,{Config:function(){return de},Connect:function(){return He},User:function(){return it},UserEvents:function(){return Qe}});var r=["vk.com","vk.ru"],a=["agreements","promo","vkc_behavior","vkc_auth_action","vkc_brand","vkc_display_mode","service_groups","external_device_id"],s=!("undefined"==typeof window||!window.document||!window.document.createElement),o=s&&!!window.addEventListener;function c(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function l(e,t){return e(t={exports:{}},t.exports),t.exports}var u=c(l((function(e){function t(i){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?(e.exports=t=function(e){return typeof e},e.exports.default=e.exports,e.exports.__esModule=!0):(e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.default=e.exports,e.exports.__esModule=!0),t(i)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0}))),d=function(){};if(o)try{var h=Object.defineProperty({},"passive",{get:function(){}});window.addEventListener("test",d,h),window.removeEventListener("test",d,h)}catch(n){}!function(){if(!s)return!1;try{document.createElement("div").scrollTo({top:0,get behavior(){return!0,"smooth"}})}catch(e){}}();var p=l((function(e){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n},e.exports.default=e.exports,e.exports.__esModule=!0}));c(p);var _=l((function(e){e.exports=function(e){if(Array.isArray(e))return p(e)},e.exports.default=e.exports,e.exports.__esModule=!0}));c(_);var m=l((function(e){e.exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.default=e.exports,e.exports.__esModule=!0}));c(m);var f=l((function(e){e.exports=function(e,t){if(e){if("string"==typeof e)return p(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?p(e,t):void 0}},e.exports.default=e.exports,e.exports.__esModule=!0}));c(f);var g=l((function(e){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.default=e.exports,e.exports.__esModule=!0}));c(g),c(l((function(e){e.exports=function(e){return _(e)||m(e)||f(e)||g()},e.exports.default=e.exports,e.exports.__esModule=!0})));var v=c(l((function(e){e.exports=function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e},e.exports.default=e.exports,e.exports.__esModule=!0})));function S(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}var y={parse:function(e){if("string"!=typeof e)return{};if(!(e=e.trim().replace(/^[?#&]/,"")))return{};var t=/\?(.+)$/gi.exec(e);return(t?t[1]:e).split("&").reduce((function(e,t){var i=t.split("=");return i[1]&&(e[i[0]]=decodeURIComponent(i[1])),e}),{})},stringify:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("object"!==u(e)||null===e)return"";t=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?S(Object(i),!0).forEach((function(t){v(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):S(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({encode:!0},t);var i=function(e){return t.encode?encodeURIComponent(e):String(e)};return Object.keys(e).reduce((function(n,r){var a=e[r];return void 0===a?n:null===a?(t.skipNull||n.push([i(r),""].join("=")),n):Array.isArray(a)?(a.map((function(e){n.push("".concat(i(r),"[]=").concat(i(e)))})).join(),n):(n.push([i(r),i(a)].join("=")),n)}),[]).join("&")}};function T(e){return y.stringify(e,{skipNull:!0})}function E(e){return Object.keys(e).filter((function(e){return a.includes(e)}))}function C(e){var t;return Boolean(null===(t=E(e))||void 0===t?void 0:t.length)}function I(e){var t=function(e){return E(e).reduce((function(t,i){return t[i]=e[i],t}),{})}(e);return btoa(JSON.stringify(t))}function b(e,t){var i,n,r=document.createElement("iframe");for(var a in e&&(r.src=e),r.style.cssText=null!==(i=null==t?void 0:t.cssText)&&void 0!==i?i:"",r.width="100%",r.height="100%",r.style.border="none",null==t?void 0:t.properties)t&&t.properties.hasOwnProperty(a)&&(r[a]=null!==(n=t.properties[a])&&void 0!==n?n:"");return r}function R(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=function(e){return e&&"object"===n(e)};return e.reduce((function(e,t){return Object.keys(t).forEach((function(n){var r=e[n],a=t[n];Array.isArray(r)&&Array.isArray(a)?e[n]=r.concat.apply(r,a):i(r)&&i(a)?e[n]=R(r,a):e[n]=a})),e}),{})}function A(e,t){return void 0===e?t:"number"!=typeof e?e?1:0:e}function w(e,t){return e&&"object"===n(e)?Object.keys(e).reduce((function(i,n){return t.includes(n)?(i[n]=e[n],i):i}),{}):e}c(l((function(e){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.default=e.exports,e.exports.__esModule=!0}))),c(l((function(e){function t(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.exports=function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e},e.exports.default=e.exports,e.exports.__esModule=!0})));var P,k,D,O=new(function(){function e(){this.savedStyles=[],this.bodyScrollYValue=0,this.isFreezed=!1}return e.prototype.freezeBodyOverflow=function(){if(!this.isFreezed){this.isFreezed=!0;var e=(i=window.document.documentElement.clientWidth,Math.abs(window.innerWidth-i)),t=parseInt(window.getComputedStyle(window.document.body).paddingRight,10)||0;this.bodyScrollYValue=window.pageYOffset||window.scrollY,this.savedStyles=[],this.savedStyles.push({value:window.document.body.style.paddingRight,property:"padding-right"},{value:window.document.body.style.overflow,property:"overflow"},{value:window.document.body.style.overflowX,property:"overflow-x"},{value:window.document.body.style.overflowY,property:"overflow-y"}),window.document.body.style.setProperty("overflow","hidden"),window.document.body.style.setProperty("padding-right",e+t+"px")}var i},e.prototype.restoreBodyOverflow=function(){this.isFreezed&&(this.savedStyles.forEach((function(e){var t=e.value,i=e.property;t?window.document.body.style.setProperty(i,t):window.document.body.style.removeProperty(i)})),window.scrollTo(0,this.bodyScrollYValue),this.isFreezed=!1)},e}());!function(e){e.OPEN="VKSDKOpen",e.CLOSE="VKSDKClose",e.LOGOUT="VKSDKLogout",e.GET_CAPTCHA="VKSDKGetCaptcha",e.CAPTCHA_SUCCESS="VKSDKGetCaptchaSuccess",e.CAPTCHA_FAILED="VKSDKGetCaptchaFail",e.AUTH_NEEDED="VKSDKAuthNeeded",e.UPDATE_PARAMS="VKSDKUpdateParams",e.REQUEST_SUPERAPP_TOKEN="VKSDKRequestSuperAppToken",e.ERROR="VKSDKError"}(P||(P={})),function(e){e.INIT="VKSDKInit"}(k||(k={})),function(e){e[e.UNKNOWN=1]="UNKNOWN",e[e.MISSING_PARAM=2]="MISSING_PARAM",e[e.CONNECTION_LOST=3]="CONNECTION_LOST",e[e.USER_DENIED=4]="USER_DENIED",e[e.INVALID_PARAMS=5]="INVALID_PARAMS",e[e.CUSTOM=6]="CUSTOM",e[e.LOADING_ERROR=7]="LOADING_ERROR",e[e.CONNECT_WINDOW_CLOSED=7]="CONNECT_WINDOW_CLOSED",e[e.CONNECT_WINDOW_NOT_OPENED=8]="CONNECT_WINDOW_NOT_OPENED",e[e.CONNECT_DOMAIN_NOT_ALLOWED=9]="CONNECT_DOMAIN_NOT_ALLOWED",e[e.CONNECT_UNKNOWN_SDK_MESSAGE=10]="CONNECT_UNKNOWN_SDK_MESSAGE",e[e.CONNECT_CLIENT_SDK_ERROR=11]="CONNECT_CLIENT_SDK_ERROR",e[e.VALIDATE_ERROR=12]="VALIDATE_ERROR",e[e.CAPTCHA_ERROR=14]="CAPTCHA_ERROR",e[e.OLD_MISSING_PARAM=100]="OLD_MISSING_PARAM"}(D||(D={}));var N=function(e,t){return'Wrong "'+e+'" param. '+(t||"")},M=function(e){return"The "+e+" parameter must be a string"},L=function(e){return"The "+e+" is required parameter"},x=function(e){return"The "+e+" parameter must be а function"},U=function(e,t){return(U=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)};function V(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}U(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var F,j,$,B,H=function(){return(H=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function W(e){return e=e||Object.create(null),{on:function(t,i){(e[t]||(e[t]=[])).push(i)},off:function(t,i){e[t]&&e[t].splice(e[t].indexOf(i)>>>0,1)},emit:function(t,i){(e[t]||[]).slice().map((function(e){e(i)})),(e["*"]||[]).slice().map((function(e){e(t,i)}))}}}function G(e){return"number"==typeof e}function K(e){return"string"==typeof e}function q(e){return void 0!==e&&""!==e&&null!==e}function z(e){return"function"==typeof e}function J(e,t,i,n){return{type:e,code:t,message:i,params:n}}function Y(e,t){return{type:D[D.VALIDATE_ERROR],code:D.VALIDATE_ERROR,message:e,params:t}}function Q(e){return e.message?{code:e.code,reason:e.message,data:e.params}:{code:e.code,data:e.params}}!function(e){e.GET_CAPTCHA="VKSDKGetCaptcha",e.APP_CLOSE="VKWebAppClose",e.APP_READY="VKSDKMiniAppReady",e.RESIZE="VKSDKMiniAppResize",e.APP_INIT_CONFIG="VKSDKMiniAppInitConfig",e.OPEN_APP="VKWebAppOpenApp",e.OPEN_PAY_FORM="VKWebAppOpenPayForm",e.ACTION_DONE="VKWebAppActionDone",e.SET_TITLE="VKWebAppSetTitle",e.AUTH_BY_EXCHANGE_TOKEN="VKWebAppAuthByExchangeToken",e.FORCE_LOGOUT="VKWebAppForceLogout"}(F||(F={})),function(e){e.OPEN="open",e.HIDE="hide",e.CLOSE="close",e.SHOW="show",e.MESSAGE="message",e.CREATE_APP="createapp"}(j||(j={})),function(e){e.SUPERAPP_TOKEN="VKSDKGeneralSuperAppToken",e.AUTH_NEEDED="VKSDKGeneralAuthNeeded",e.OPEN_APP="VKSDKGeneralOpenApp"}($||($={})),function(e){e.SUPERAPP_TOKEN_CHANGE_V2="superAppTokenV2",e.SUPERAPP_TOKEN_CHANGE="superAppToken"}(B||(B={}));var Z,X=function(){function e(e,t,i){void 0===e&&(e="Parameter validation error"),this.errorText=e,this.params=t,this.valid=i}return e.prototype.isValid=function(){return Boolean(this.valid)},e.prototype.error=function(e){return this.isValid()?null:e?Q(Y(this.errorText,this.params)):Y(this.errorText,this.params)},e}(),ee=function(){function e(e){this.rules=e}return e.prototype.validate=function(e){for(var t in this.rules)if(this.rules.hasOwnProperty(t))for(var i=0;i<this.rules[t].length;i++){var n=this.rules[t][i];if(!n.rule(e[t]))return new X(n.errorText,e,!1)}return new X("",e,!0)},e}(),te=(new ee({params:[{rule:q,errorText:L("params")}]}),new ee({token:[{rule:K,errorText:M("token")}]})),ie=new ee({event:[{rule:K,errorText:M("event")},{rule:q,errorText:L("event")}],handler:[{rule:q,errorText:L("handler")}]}),ne=new ee({app:[{rule:function(e){return G(e)||K(e)},errorText:function(e){return"The "+e+" parameter must be a number or a string"}("app")},{rule:q,errorText:L("app")}]}),re=new ee({message:[{rule:q,errorText:L("message")}]}),ae=new ee({handler:[{rule:q,errorText:L("handler")},{rule:z,errorText:x("handler")}]}),se=new ee({handler:[{rule:q,errorText:L("handler")},{rule:z,errorText:x("handler")}]}),oe=new ee({handler:[{rule:q,errorText:L("handler")},{rule:z,errorText:x("handler")}]}),ce=new ee({appId:[{rule:G,errorText:function(e){return"The "+e+" parameter must be a number"}("appId")}]}),le={appId:0,superAppToken:"",superAppTokenV2:"",loginDomain:"login.vk.com",oauthDomain:"oauth.vk.com",connectDomain:"id.vk.com",_debug:!1,_localhost:!1},ue={},de=function(){function e(){}return e.init=function(e){if(!e.appId)throw new Error("appId required");var t=ce.validate({appId:e.appId});!t.isValid()&&console.error(t.error()),le.appId=e.appId,le.superAppToken=e.superAppToken||"",le.superAppTokenV2=e.superAppTokenV2||"",le.loginDomain=e.loginDomain||"login.vk.com",le.oauthDomain=e.oauthDomain||"oauth.vk.com",le.connectDomain=e.connectDomain||"id.vk.com",le.appSettings=e.appSettings,le._debug=!!e._debug,le._localhost=!!e._localhost},e.get=function(){return le},e.setSuperAppToken=function(t,i){void 0===i&&(i={});var n=te.validate({token:t});!n.isValid()&&console.error(n.error()),2===i.version?(le.superAppTokenV2=t,e.events.emit(B.SUPERAPP_TOKEN_CHANGE_V2,t)):(le.superAppToken=t,e.events.emit(B.SUPERAPP_TOKEN_CHANGE,t))},e.onRequestSuperAppToken=function(e){var t=ae.validate({handler:e});!t.isValid()&&console.error(t.error()),ue.requestSuperAppToken=e},e._requestSuperAppToken=function(t,i){var n;void 0===i&&(i={}),ue.requestSuperAppToken&&(n=ue.requestSuperAppToken(t,i)),n&&n.then((function(t){return e.setSuperAppToken(t,i)})).catch(console.error)},e.onAuth=function(e){var t=se.validate({handler:e});!t.isValid()&&console.error(t.error()),ue.auth=e},e._auth=function(t){var i;void 0===t&&(t={}),ue.auth&&(i=ue.auth()),i&&i.then((function(i){e.setSuperAppToken(i,t)})).catch(console.error)},e.onOpenApp=function(e){ue.openApp=e},e._openApp=function(e){ue.openApp&&ue.openApp(e.app)},e.onLogout=function(e){var t=oe.validate({handler:e});!t.isValid()&&console.error(t.error()),ue.logout=e},e._logout=function(){ue.logout&&ue.logout()},e.fetchDomain=function(){return Boolean(Z)||(Z=new Promise((function(e){fetch("https://vk.ru/domain.txt").then((function(e){return e.text()})).then((function(e){return e.trim()})).then((function(e){le.loginDomain=le.loginDomain.replace("vk.com",e),le.oauthDomain=le.oauthDomain.replace("vk.com",e),le.connectDomain=le.connectDomain.replace("vk.com",e)})).then(e).catch((function(t){e(),console.warn(t)}))}))),Z},e.events=W(),e}(),he=new ee({iframe:[{rule:q,errorText:L("iframe")}],origin:[{rule:K,errorText:M("origin")},{rule:q,errorText:L("origin")}]}),pe=new ee({event:[{rule:q,errorText:L("event")}]}),_e=new ee({handler:[{rule:q,errorText:L("handler")},{rule:z,errorText:x("handler")}]}),me=new ee({handler:[{rule:q,errorText:L("handler")}],params:[{rule:q,errorText:L("params")}]}),fe=function(e){var t=this;this.handler=function(){return{}},this.destroy=function(){delete t.config,window.removeEventListener("message",t.handleMessage)},this.onMessage=function(e){var i=_e.validate({handler:e});!i.isValid()&&console.error(i.error()),t.handler=e},this.sendMessage=function(e){var i,n=me.validate(e);!n.isValid()&&console.error(n.error()),null===(i=t.config.iframe.contentWindow)||void 0===i||i.postMessage(H({type:"vk-sak-sdk"},e),t.config.origin)},this.handleMessage=function(e){var i=pe.validate({event:e});!i.isValid()&&console.error(i.error()),t.config.origin&&e.origin===t.config.origin&&e.source===t.config.iframe.contentWindow&&e.data&&"vk-sak-sdk"===e.data.type&&t.handler(e.data)};var i=he.validate(e);!i.isValid()&&console.error(i.error()),this.config=e,window.addEventListener("message",this.handleMessage)},ge=function(){function e(){var e=this;this.resolve=function(t){if(Boolean(e.promise))return e.finished=!0,e.active=!1,e.resolveHandler(t)},this.reject=function(t){if(Boolean(e.promise))return e.finished=!0,e.active=!1,e.rejectHandler(t)}}return e.prototype.start=function(){var e=this;this.active=!0,this.finished=!1,this.promise=new Promise((function(t,i){e.resolveHandler=t,e.rejectHandler=i}))},e.prototype.get=function(){return this.promise},e}(),ve=["extend_token","login_with_user","login_silent_user","__sferum_invite_link","registration_with_phone","registration_with_email","validate_phone","bind_ok_account","no_password_flow","confirm_service_action","login_with_eljour","login_with_multi_user","auth_validation_phone","qr_auth","multi_account_flow"];function Se(e){return e&&ve.includes(e.name)?btoa(JSON.stringify(e)):""}function ye(e){return e?btoa(JSON.stringify(e)):""}function Te(e,t){return void 0===t&&(t="auth"),de.fetchDomain().then((function(){var i=de.get(),n=i.appId,r=i.connectDomain,a=i.appSettings,s=i._debug,o=i._localhost,c=H({app_id:n,response_type:"silent_token",v:"1.58.6",debug:s?1:null,localhost:o?1:null},e);a&&C(a)&&(c.app_settings=I(a));var l=T(c);return Promise.resolve("https://"+r+"/"+t+"?"+l)}))}var Ee,Ce=[0,1,3,4,6,15,16,82];!function(e){e.Default="default",e.NamePhone="name_phone",e.PhoneName="phone_name"}(Ee||(Ee={}));var Ie,be=[Ee.Default,Ee.NamePhone,Ee.PhoneName];!function(e){e.Primary="primary",e.Flat="flat"}(Ie||(Ie={}));var Re,Ae=[Ie.Primary,Ie.Flat];!function(e){e.CAPTCHA_SUCCESS="VKSDKAuthCaptchaSuccess",e.CAPTCHA_FAIL="VKSDKAuthCaptchaFail"}(Re||(Re={}));var we,Pe=function(e,t,i){var n=this;this.events=W(),this.showReadyPromiseTask=new ge,this.init=function(){de.fetchDomain().then((function(){Te(H(H({origin:location.protocol+"//"+location.host,uuid:n.uuid},n.captchaData),{scheme:n.scheme}),"auth_captcha").then(n.handleCaptcha)}))},this.createFrame=function(){return n.iframe=b("",{cssText:"\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100vh;\n      min-height: 100vh;\n      border: none;\n      z-index: 99999;\n     "}),n},this.handleError=function(e){var t=Q(J(D[D.CUSTOM],D.CUSTOM,"",e));n.events.emit(P.ERROR,t)},this.onMessage=function(e){switch(e.handler){case P.ERROR:n.handleError(e.params);break;case Re.CAPTCHA_SUCCESS:n.showReadyPromiseTask.resolve(e.params),n.destroy();break;default:n.showReadyPromiseTask.reject(),n.destroy()}},this.handleCaptcha=function(e){n.iframe.src=e,document.body.appendChild(n.iframe),n.bridge=new fe({iframe:n.iframe,origin:"https://"+de.get().connectDomain}),n.bridge.onMessage(n.onMessage)},this.destroy=function(){n.iframe&&document.body.removeChild(n.iframe),n.bridge&&n.bridge.destroy()},this.show=function(){return n.iframe.style.display="block",new Promise((function(e){n.showReadyPromiseTask.start(),n.showReadyPromiseTask.get().then(e)}))},this.uuid=e,this.captchaData=t,this.scheme=i||"bright_light",this.createFrame().init()},ke=function(){function e(t){var i=this;this.readyPromiseResolve=null,this.readyPromise=null,this.child=null,this.initialTitle=window.document.title,this.open=function(e,t){return de.fetchDomain().then((function(){return i.loading?(i.getMiniAppUrl(e,t).then((function(e){i.iframe.src=e})),i.loading=new Promise((function(e){i.iframe.onload=function(){i.iframe.onload=null,e()}})),i.readyPromise=new Promise((function(e){return i.readyPromiseResolve=e})),i.eventOpenSettings(),i.readyPromise):i.preload(e,t).catch(console.error)}))},this.eventOpenSettings=function(){i.iframe.style.display="block",i.params.stackMode||O.freezeBodyOverflow(),i.loading.then(i.handleResize).catch(console.error),i.events.emit(j.OPEN)},this.hide=function(){i.iframe.style.display="none",i.params.stackMode||O.restoreBodyOverflow(),i.events.emit(j.HIDE)},this.close=function(e){window.document.title!==i.initialTitle&&(window.document.title=i.initialTitle),i.params.stackMode||O.restoreBodyOverflow(),i.iframe&&i.iframe.remove(),i.bridge&&i.bridge.destroy(),delete i.iframe,delete i.bridge,de.events.off(B.SUPERAPP_TOKEN_CHANGE,i.onSuperAppToken),window.removeEventListener("resize",i.handleResize),i.events.emit(j.CLOSE,e)},this.show=function(){if(!i.loading)throw new Error('App is not loaded, use "open" or "preload" methods');i.iframe.style.display="block",i.params.stackMode||O.freezeBodyOverflow(),i.events.emit(j.SHOW)},this.preload=function(e,t){return de.fetchDomain().then((function(){var n=document.createElement("iframe"),r=window.innerHeight,a=isFinite(i.params.zIndex)?i.params.zIndex:999999;return i.getMiniAppUrl(e,t).then((function(e){n.src=e})),n.setAttribute("allow","geolocation"),n.style.cssText="\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: "+r+"px;\n      min-height: "+r+"px;\n      border: none;\n      z-index: "+a+";\n    ",i.iframe=n,document.body.appendChild(i.iframe),i.bridge=new fe({iframe:i.iframe,origin:"https://"+de.get().connectDomain}),i.loading=new Promise((function(e){n.onload=function(){n.onload=null,e()}})),i.readyPromise=new Promise((function(e){return i.readyPromiseResolve=e})),i.bridge.onMessage(i.handleMessage),de.events.on(B.SUPERAPP_TOKEN_CHANGE,i.onSuperAppToken),window.addEventListener("resize",i.handleResize),i.eventOpenSettings(),i.loading}))},this.sendMessage=function(e){var t=re.validate({message:e});!t.isValid()&&console.error(t.error()),i.bridge.sendMessage(e)},this.onSuperAppToken=function(e){i.bridge.sendMessage({handler:$.SUPERAPP_TOKEN,params:{result:e}})},this.handleError=function(e){var t=Q(J(D[D.CUSTOM],D.CUSTOM,"",e));i.events.emit(P.ERROR,t)},this.handleMessage=function(e){switch(e.handler){case P.GET_CAPTCHA:var t=e.params.uuid,n=new Pe(t,{captcha_sid:e.params.captcha_sid,captcha_img:e.params.captcha_img});n.show().then((function(e){i.bridge.sendMessage({handler:P.CAPTCHA_SUCCESS,params:H({uuid:t},e)})})).catch((function(){i.bridge.sendMessage({handler:P.CAPTCHA_FAILED,params:{uuid:t}}),n.destroy()}));break;case F.APP_CLOSE:i.hide();break;case P.ERROR:i.handleError(e.params);break;case F.APP_READY:i.resolveReadyPromise(),i.handleUpdateConfig();break;case F.OPEN_APP:i.openMiniapp(e.params);break;case F.OPEN_PAY_FORM:i.openPayForm(e.params);break;case F.SET_TITLE:i.setTitle(e.params);break;case F.AUTH_BY_EXCHANGE_TOKEN:i.onAuthByExchangeToken();break;case F.FORCE_LOGOUT:i.onForceLogout();break;case $.SUPERAPP_TOKEN:de._requestSuperAppToken(e.params);break;case $.AUTH_NEEDED:de._auth();break;default:i.events.emit(j.MESSAGE,e)}},this.handleResize=function(){if(i.iframe){var e=innerWidth,t=innerHeight;i.iframe.style.height=t+"px",i.iframe.style.minHeight=t+"px",i.bridge.sendMessage({handler:F.RESIZE,params:{viewport_width:e,viewport_height:t}})}},this.handleUpdateConfig=function(){i.bridge.sendMessage({handler:F.APP_INIT_CONFIG,params:{fullMode:i.params.fullMode,hideMenu:i.params.hideMenu,scheme:i.params.scheme}})},this.update=function(e){e&&(i.params=R(i.params,e||{}),i.sendUpdateParamsMessage())},this.getMiniAppUrl=function(e,t){return de.fetchDomain().then((function(){var n=de.get(),r=n.connectDomain,a=n.appId,s=n.superAppToken,o=n._debug,c=n._localhost;return"https://"+r+"/mini_app?"+T({app:i.params.app,host_app_id:a,superapp_token:s,app_query:e?JSON.stringify(e):"",app_hash:t||"",debug:o?1:null,localhost:c?1:null})}))},this.resolveReadyPromise=function(){i.readyPromise&&i.readyPromiseResolve&&(i.readyPromiseResolve(),i.readyPromise=null,i.readyPromiseResolve=null)},this.openMiniapp=function(t){i.child=new e({app:t.app_id,stackMode:i.params.stackMode}),i.events.emit(j.CREATE_APP,{app:i.child,location:t.location})},this.openPayForm=function(t){var n=H({},t.params);n.data&&(n.data=JSON.stringify(n.data));var r=H(H({},n),{app_id:t.app_id,action:t.action}),a=new e({app:6217559,stackMode:i.params.stackMode});a.open(r).then((function(){return i.hide()})).catch(console.error),a.events.on(j.MESSAGE,(function(e){i.handleVKPayFormMessage(e),a.close(),i.show()})),a.events.on(j.HIDE,(function(){a.close(),i.close()}))},this.setTitle=function(e){window.document.title=e.title},this.onAuthByExchangeToken=function(){i.close({closedByExchangeToken:!0})},this.onForceLogout=function(){i.close({closedByForceLogout:!0})},this.handleVKPayFormMessage=function(e){e.handler===F.ACTION_DONE&&i.sendMessage(e),e.handler===P.ERROR&&i.handleError(e.params)};var n=ne.validate(t);!n.isValid()&&console.error(n.error()),this.params=H(H({},t),{app:"number"==typeof t.app?"app"+t.app:t.app,scheme:"string"==typeof t.scheme?t.scheme:"bright_light"}),this.events=W()}return e.prototype.on=function(e,t){var i=ie.validate({event:e,handler:t});!i.isValid()&&console.error(i.error()),this.events.on(e,t)},e.prototype.off=function(e,t){var i=ie.validate({event:e,handler:t});!i.isValid()&&console.error(i.error()),this.events.off(e,t)},e.prototype.sendUpdateParamsMessage=function(){this.bridge&&this.bridge.sendMessage({params:this.params,handler:P.UPDATE_PARAMS})},e}(),De=(function(){function e(){this.stack=[]}e.prototype.removeMiniApp=function(e){var t=e.app,i=this.stack.lastIndexOf(t);if(i>-1&&i===this.stack.length-1)if(this.stack.splice(i,1),this.stack.length){this.stack[this.stack.length-1].show();var n=this.stack[this.stack.length-2];setTimeout((function(){return null==n?void 0:n.hide()}),0)}else O.restoreBodyOverflow()},e.prototype.makeHandleMiniAppClose=function(e){var t=this,i=e.app;return function(){t.removeMiniApp({app:i})}},e.prototype.makeHandleMiniAppHide=function(e){var t=this,i=e.app;return function(){var e=t.stack.lastIndexOf(i);e>-1&&e===t.stack.length-1&&setTimeout((function(){return i.close()}),0)}},e.prototype.handleMiniAppCreate=function(e){var t=e.app,i=e.query,n=e.hash;this.stack.push(t),t.open(i,n).catch(console.error),t.events.on(j.CREATE_APP,this.handleMiniAppCreate.bind(this)),t.events.on(j.HIDE,this.makeHandleMiniAppHide({app:t})),t.events.on(j.CLOSE,this.makeHandleMiniAppClose({app:t})),O.freezeBodyOverflow();var r=this.stack[this.stack.length-2];return setTimeout((function(){null==r||r.hide()}),0),t},Object.defineProperty(e.prototype,"length",{get:function(){return this.stack.length},enumerable:!1,configurable:!0}),e.prototype.open=function(e){var t=ne.validate(e);!t.isValid()&&console.error(t.error());var i=e.app,n=e.query,r=e.hash,a=new ke({app:i,stackMode:!0});return this.handleMiniAppCreate({app:a,query:n,hash:r}),a},e.prototype.close=function(){var e=this.stack;this.stack.splice(0),e.reverse().forEach((function(e){return e.close()})),O.restoreBodyOverflow()}}(),function(){for(var e="",t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;t--;)e+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[64*Math.random()|0];return e});!function(e){e.STATIC_MAP="VKSDKRequestToGeoservice:staticmap/png/",e.SEARCH="VKSDKRequestToGeoservice:search",e.OVERALL="VKSDKRequestToGeoservice:overall",e.DIRECTIONS="VKSDKRequestToGeoservice:directions",e.ISO="VKSDKRequestToGeoservice:iso"}(we||(we={}));var Oe,Ne,Me,Le,xe,Ue;!function(){function e(e){var t=this;this.apiKey=e.apiKey,this.requestMap={};var i=document.createElement("iframe");this.iframe=i,de.fetchDomain().then((function(){var e=de.get().appId;t.getGeoserviceProxyUrl({app_id:e}).then((function(e){i.src=e})),i.style.cssText="\n      display: none;\n    ",document.body.appendChild(t.iframe),t.bridge=new fe({iframe:t.iframe,origin:"https://"+de.get().connectDomain}),t.bridge.onMessage((function(e){var i=e.params,n=i.requestID,r=i.response;t.requestMap[n].resolve(r),delete t.requestMap[n]}))}))}e.prototype.setApiKey=function(e){this.apiKey=e},e.prototype.getGeoserviceProxyUrl=function(e){return de.fetchDomain().then((function(){var t=de.get(),i=t.connectDomain,n=t._debug,r=t._localhost;return"https://"+i+"/geoservice?"+T(H(H({},e||{}),{origin:location.protocol+"//"+location.host,debug:n?1:null,localhost:r?1:null}))}))},e.prototype.prepareAnswer=function(e,t,i){var n=this,r=De();return this.bridge.sendMessage({handler:"VKSDKRequestToGeoservice:"+e,params:H(H({},t),{api_key:this.apiKey,wrapRequestInJSON:i,requestID:r})}),new Promise((function(e,t){n.requestMap[r]={resolve:e,reject:t}}))},e.prototype.getStaticMap=function(e){return this.prepareAnswer("staticmap/png/",e)},e.prototype.encodeCoords=function(e){return this.prepareAnswer("search",e)},e.prototype.decodeCoords=function(e){return this.prepareAnswer("overall",e)},e.prototype.getDirections=function(e){return this.prepareAnswer("directions",e,!0)},e.prototype.getISO=function(e){return this.prepareAnswer("iso",e,!0)}}();!function(e){e.SHOW_DATA_POLICY="VKSDKOneTapAuthConnectDataPolicy",e.HIDE_DATA_POLICY="VKSDKOneTapAuthDataPolicyClose",e.DATA_POLICY_RESULT="VKSDKOneTapAuthDataPolicyResult",e.SHOW_CAPTCHA="VKSDKOneTapAuthDataPolicyShowCaptcha"}(Oe||(Oe={})),function(e){e.SHOW_POLICY_AGREEMENTS="VKSDKOneTapAuthPolicyAgreementsShow",e.HIDE_POLICY_AGREEMENTS="VKSDKOneTapAuthPolicyAgreementsHide",e.ACCEPT_POLICY_AGREEMENTS="VKSDKOneTapAuthPolicyAgreementsAccept",e.DECLINE_POLICY_AGREEMENTS="VKSDKOneTapAuthPolicyAgreementsDecline",e.POLICY_AGREEMENTS_ERROR="VKSDKOneTapAuthPolicyAgreementsError",e.SHOW_DATA_POLICY="VKSDKOneTapAuthPolicyAgreementsShowDataPolicy",e.GET_CAPTCHA="VKSDKGetCaptcha",e.CAPTCHA_SUCCESS="VKSDKGetCaptchaSuccess",e.CAPTCHA_FAIL="VKSDKGetCaptchaFail"}(Ne||(Ne={})),function(e){e.PHONE_VALIDATION_NEEDED="VKSDKOneTapAuthPhoneValidationNeeded",e.FULL_AUTH_NEEDED="VKSDKOneTapAuthFullAuthNeeded",e.AUTH_DATA_LOADED="VKSDKOneTapAuthDataLoaded",e.NOT_AUTHORIZED="VKSDKOneTapAuthNotAuthorized",e.LOGIN_SUCCESS="VKSDKOneTapAuthLoginSuccess",e.RESIZE_FRAME="VKSDKOneTapResizeFrame",e.SHOW_CAPTCHA="VKSDKOneTapShowCaptcha",e.VALIDATE_CAPTCHA="VKSDKOneTapValidateCaptcha",e.UPDATE_PARAMS="VKSDKUpdateParams"}(Me||(Me={})),function(e){e.CLOSE_AUTH="VKSDKOneTapAuthClose",e.ADAPTIVITY_CHANGE="VKSDKFloatingOneTapAdaptivityChange",e.ADAPTIVITY_CHANGED="VKSDKFloatingOneTapAdaptivityChanged",e.UPDATE_PARAMS="VKSDKUpdateParams"}(Le||(Le={})),function(e){e.SHOW_LOGIN="VKSDKButtonOneTapAuthShowLogin",e.SHOW_LOGIN_OPTIONS="VKSDKButtonOneTapAuthShowLoginOptions",e.SHOW_AGREEMENTS_DIALOG="VKSDKButtonOneTapAuthShowAgreementsDialog",e.START_AUTHORIZE="VKSDKButtonOneTapAuthStartAuthorize",e.UPDATE_PARAMS="VKSDKUpdateParams"}(xe||(xe={})),function(e){e.WRONG_TOKEN="VKSDKBindAccountErrorWrongToken",e.ALREADY_BIND="VKSDKBindAccountErrorAlreadyBind"}(Ue||(Ue={}));var Ve,Fe,je=new ee({url:[{rule:K,errorText:M("url")},{rule:q,errorText:L("url")}]}),$e=new ee({uuid:[{rule:K,errorText:M("uuid")},{rule:q,errorText:L("uuid")}]}),Be=(new ee({params:[{rule:q,errorText:L("params")}]}),new ee({callback:[{rule:q,errorText:L("callback")}]})),He=function(){function e(){}var t;return e.on=function(e,t){var i=ie.validate({event:e,handler:t});!i.isValid()&&console.error(i.error()),this.events.on(e,t)},e.off=function(e,t){var i=ie.validate({event:e,handler:t});!i.isValid()&&console.error(i.error()),this.events.off(e,t)},t=e,e.flags=null,e.events=W(),e.handleError=function(e){var i=Q(J(D[D.CUSTOM],D.CUSTOM,"",e));t.events.emit(P.ERROR,i)},e.silentAuth=function(){return de.fetchDomain().then((function(){var e=de.get(),t=e.loginDomain,i=e.appId,n=new ge,r=De(),a="https://"+t+"/?act=connect&app_id="+i+"&response_type=silent_token&uuid="+r+"&v=1.58.6",s=new XMLHttpRequest;return s.open("GET",a,!0),s.responseType="json",s.withCredentials=!0,n.start(),s.onload=function(){var e,t=s.response,i=s.status>=200&&s.status<300;if(t&&(null===(e=t.error)||void 0===e?void 0:e.error_code)===D.CAPTCHA_ERROR){var o=t.error,c=o.captcha_sid,l=o.captcha_img;new Pe(r,{captcha_sid:c,captcha_img:l}).show().then((function(e){var t=a+"&captcha_key="+e.captcha_key+"&captcha_sid="+e.captcha_sid;s.open("GET",t,!0),s.send()}))}else t&&i?n.resolve({provider:"vk",payload:s.response}):n.reject()},s.onerror=function(){n.reject()},s.send(),n.get()}))},e.oneTapAuth=function(t,i){if(console.warn("Connect.oneTapAuth method is deprecated. Use Connect.floatingOneTapAuth and Connect.buttonOneTapAuth methods."),!["floating","button"].includes(t))return null;switch(t){case"button":return e.buttonOneTapAuth(i);case"floating":return e.floatingOneTapAuth(i);default:return null}},e.floatingOneTapAuth=function(i){var n=Be.validate({callback:i.callback});!n.isValid()&&console.error(n.error());var r=function(){var e,t=window.innerWidth,i=t<=768;return{destroy:function(){return window.removeEventListener("resize",e)},isAdaptive:function(){return i},observe:function(n){e=function(){var e=window.innerWidth;t>768&&e<=768?n(i=!0):t<=768&&e>768&&n(i=!1),t=e},window.addEventListener("resize",e)}}}(),a=function(e,t){var i,n,r,a={},s=e?"314px":"334px",o=e?"\n      display: none;\n      position: fixed;\n      bottom: 0;\n      right: 50%;\n      transform: translate(50%, 0);\n      max-width: 468px;\n      width: 100%;\n      height: "+s+";\n    ":"\n        display: none;\n        position: fixed;\n        top: 0;\n        right: 0;\n        max-width: 400px;\n        width: 100%;\n        height: "+s+";\n      ";return(null===(i=null==t?void 0:t.styles)||void 0===i?void 0:i.zIndex)&&isFinite(null===(n=null==t?void 0:t.styles)||void 0===n?void 0:n.zIndex)&&(o+="z-index: "+(null===(r=null==t?void 0:t.styles)||void 0===r?void 0:r.zIndex)+";"),t&&(a.skip_success=A(t.skipSuccess,0),void 0!==t.scheme&&["bright_light","space_gray"].includes(t.scheme)&&(a.scheme=t.scheme)),{pageUrl:"floating_one_tap_auth",pageUrlParams:H({adaptive:e?1:0},a),frameStyles:o,scheme:(null==t?void 0:t.scheme)||"bright_light"}}(r.isAdaptive(),i.options);if(!a)throw new Error("options were not set");var s,o,c,l=De(),u=H({origin:location.protocol+"//"+location.host,uuid:l},a.pageUrlParams),d=a.pageUrl,h=new ge,p=function(){o&&o.sendMessage({handler:Me.RESIZE_FRAME,params:{uuid:l}})},_=function(){s&&(s.remove(),s=null),window.removeEventListener("resize",p),r&&r.destroy(),o&&o.destroy()};c=new Promise((function(e){h.start(),h.get().then((function(t){e(t)}))}));var m=function(n){if(n.params.uuid===l)switch(n.handler){case P.ERROR:t.handleError(n.params);break;case Me.NOT_AUTHORIZED:i.callback({type:n.handler,payload:{uuid:l,error:"not_authorized"}}),_(),h.resolve(n.handler);break;case Me.RESIZE_FRAME:s.style.height=n.params.height+"px";break;case Le.CLOSE_AUTH:i.callback({type:n.handler,payload:{uuid:l}}),_();break;case Le.ADAPTIVITY_CHANGED:s.style.display="block";break;case Me.AUTH_DATA_LOADED:s.style.display="block",h.resolve(n.handler);default:e.handleOneTapEvents(n,o,i)}};return s=b("",{cssText:null==a?void 0:a.frameStyles}),document.body.appendChild(s),de.fetchDomain().then((function(){return Te(u,d).then((function(e){s.src=e,(o=new fe({iframe:s,origin:"https://"+de.get().connectDomain})).onMessage(m),r.observe((function(e){o.sendMessage({handler:Le.ADAPTIVITY_CHANGE,params:{uuid:l,is_adaptive:e}}),e?(s.style.maxWidth="468px",s.style.top="auto",s.style.bottom="0",s.style.right="50%",s.style.transform="translate(50%, 0)"):(s.style.maxWidth="400px",s.style.top="0",s.style.bottom="auto",s.style.right="0",s.style.transform="none"),s.style.display="none"})),window.addEventListener("resize",p)}))})),{getFrame:function(){return s},destroy:_,authReadyPromise:c,update:function(e){a=R(a||{},e),o&&a&&o.sendMessage({handler:Le.UPDATE_PARAMS,params:a})}}},e.buttonOneTapAuth=function(t){var i=Be.validate({callback:t.callback});!i.isValid()&&console.error(i.error());var n=function(e){var t,i,n,r,a,s,o={},c=44,l=56;return e&&(o.display=e.displayMode&&be.includes(e.displayMode)?e.displayMode:Ee.Default,o.button_skin=e.buttonSkin&&Ae.includes(e.buttonSkin)?e.buttonSkin:Ie.Primary,o.show_agreements=A(e.showAgreements,0),o.show_alternative_login=A(e.showAlternativeLogin,0),void 0!==e.scheme&&["bright_light","space_gray"].includes(e.scheme)&&(o.scheme=e.scheme),void 0!==(null===(t=e.buttonStyles)||void 0===t?void 0:t.height)&&(c=Number(null===(i=e.buttonStyles)||void 0===i?void 0:i.height),l=Number(null===(n=e.buttonStyles)||void 0===n?void 0:n.height)+12,o.style_height=null===(r=e.buttonStyles)||void 0===r?void 0:r.height),void 0!==(null===(a=e.buttonStyles)||void 0===a?void 0:a.borderRadius)&&(o.style_border_radius=null===(s=e.buttonStyles)||void 0===s?void 0:s.borderRadius),void 0!==e.langId&&(o.lang_id=Ce.includes(e.langId)?e.langId:0),c+=o.show_alternative_login?l:0,c+=o.show_agreements?80:0),{pageUrl:"button_one_tap_auth",pageUrlParams:o,frameStyles:"\n        height: "+c+"px;\n      ",scheme:(null==e?void 0:e.scheme)||"bright_light"}}(t.options);if(!n)throw new Error("options were not set");var r,a,s,o=De(),c=H({origin:location.protocol+"//"+location.host,uuid:o},n.pageUrlParams),l=n.pageUrl,u=new ge;s=new Promise((function(e){u.start(),u.get().then((function(t){e(t)}))}));var d=function(){a&&a.sendMessage({handler:Me.RESIZE_FRAME,params:{uuid:o}})},h=function(i){if(i.params.uuid===o)switch(i.handler){case Me.RESIZE_FRAME:r.style.height=i.params.height+"px";break;case Me.NOT_AUTHORIZED:u.resolve(i.handler);break;case xe.SHOW_LOGIN:case xe.SHOW_LOGIN_OPTIONS:t.callback({type:i.handler,payload:{uuid:o}});break;case xe.SHOW_AGREEMENTS_DIALOG:e.userPolicyAgreements(o,null==n?void 0:n.scheme).show().then((function(e){e&&e.accepted&&a.sendMessage({handler:xe.START_AUTHORIZE,params:{uuid:o}})})).catch((function(){a.sendMessage({handler:Ne.DECLINE_POLICY_AGREEMENTS,params:{uuid:o}})}));break;case Me.AUTH_DATA_LOADED:u.resolve(i.handler);default:e.handleOneTapEvents(i,a,t)}};r=b("",{cssText:null==n?void 0:n.frameStyles});var p=t.container;return p&&p.appendChild(r),de.fetchDomain().then((function(){return Te(c,l).then((function(e){r.src=e,(a=new fe({iframe:r,origin:"https://"+de.get().connectDomain})).onMessage(h),window.addEventListener("resize",d)}))})),{getFrame:function(){return r},destroy:function(){r&&(r.remove(),r=null),window.removeEventListener("resize",d),a&&a.destroy()},authReadyPromise:s,update:function(e){n=R(n||{},e),a&&n&&a.sendMessage({handler:xe.UPDATE_PARAMS,params:n})}}},e.handleOneTapEvents=function(i,n,r){var a,s,o=i.params.uuid;switch(i.handler){case P.ERROR:t.handleError(i.params);break;case Me.AUTH_DATA_LOADED:n.sendMessage({handler:Me.RESIZE_FRAME,params:{uuid:o}});break;case Me.LOGIN_SUCCESS:r.callback({type:i.handler,provider:"vk",payload:i.params});break;case Me.SHOW_CAPTCHA:var c=new Pe(o,{captcha_sid:i.params.captcha_sid,captcha_img:i.params.captcha_img},null===(a=r.options)||void 0===a?void 0:a.scheme);c.show().then((function(e){n.sendMessage({handler:Re.CAPTCHA_SUCCESS,params:H({uuid:o},e)})})).catch((function(){n.sendMessage({handler:Re.CAPTCHA_FAIL,params:{uuid:o}}),c.destroy()}));break;case Oe.SHOW_DATA_POLICY:e.userDataPolicy(o,null===(s=r.options)||void 0===s?void 0:s.scheme).show().then((function(){r.callback({type:Oe.DATA_POLICY_RESULT,payload:{uuid:o,policyAccepted:!0}})})).catch((function(){r.callback({type:Oe.DATA_POLICY_RESULT,payload:{uuid:o,policyAccepted:!1}})}));break;case Me.FULL_AUTH_NEEDED:case Me.PHONE_VALIDATION_NEEDED:r.callback({type:i.handler,payload:{uuid:o}})}},e.userDataPolicy=function(e,i){var n,r=$e.validate({uuid:e});!r.isValid()&&console.error(r.error());var a,s=window.innerHeight,o=function(){n&&(n.style.display="none")},c=new ge,l=function(){n&&n.remove(),a&&a.destroy()};n=b("",{properties:{height:s+"px"},cssText:"\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100vh;\n      min-height: 100vh;\n      border: none;\n      z-index: 99999;\n    "}),document.body.appendChild(n);var u=function(r){switch(r.handler){case P.ERROR:t.handleError(r.params);break;case Oe.HIDE_DATA_POLICY:o(),c.resolve(void 0),l();break;case Oe.SHOW_CAPTCHA:var s=new Pe(e,{captcha_sid:r.params.captcha_sid,captcha_img:r.params.captcha_img},i);s.show().then((function(t){a.sendMessage({handler:Re.CAPTCHA_SUCCESS,params:H({uuid:e},t)}),n.style.display="block"})).catch((function(){a.sendMessage({handler:Re.CAPTCHA_FAIL,params:{uuid:e}}),s.destroy()})),o();break;default:o(),c.reject(),l()}};return de.fetchDomain().then((function(){Te({origin:location.protocol+"//"+location.host,uuid:e,scheme:i||"bright_light"},"user_data_policy").then((function(e){n.src=e})),(a=new fe({iframe:n,origin:"https://"+de.get().connectDomain})).onMessage(u)})),{show:function(){return n.style.display="block",new Promise((function(e){c.start(),c.get().then((function(t){e(t)}))}))},hide:o,destroy:l}},e.userPolicyAgreements=function(i,n){var r,a,s,o=new ge;s=window.innerHeight,r=b("",{properties:{height:s+"px"},cssText:"\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: "+s+"px;\n      min-height: "+s+"px;\n      border: none;\n      z-index: 99999;\n    "}),document.body.appendChild(r);var c=function(){r&&(r.remove(),r=null),a&&a.destroy()},l=function(){r&&(r.style.display="none")},u=function(s){switch(s.handler){case P.ERROR:t.handleError(s.params);break;case Ne.ACCEPT_POLICY_AGREEMENTS:l(),o.resolve({accepted:!0}),c();break;case Ne.DECLINE_POLICY_AGREEMENTS:l(),o.resolve({accepted:!1}),c();break;case Ne.GET_CAPTCHA:var u=new Pe(i,{captcha_sid:s.params.captcha_sid,captcha_img:s.params.captcha_img},n);u.show().then((function(e){a.sendMessage({handler:Ne.CAPTCHA_SUCCESS,params:H({uuid:i},e)}),r.style.display="block"})).catch((function(){a.sendMessage({handler:Ne.CAPTCHA_FAIL,params:{uuid:i}}),u.destroy()})),l();break;case Ne.SHOW_DATA_POLICY:l();var d=function(){r.style.display="block"};e.userDataPolicy(i,n).show().then(d).catch(d);break;case Ne.POLICY_AGREEMENTS_ERROR:case Ne.HIDE_POLICY_AGREEMENTS:default:o.reject(),c()}};return de.fetchDomain().then((function(){Te({origin:location.protocol+"//"+location.host,uuid:i,scheme:n||"bright_light"},"user_policy_agreements").then((function(e){r.src=e,(a=new fe({iframe:r,origin:"https://"+de.get().connectDomain})).onMessage(u)}))})),{show:function(){return r.style.display="block",new Promise((function(e){o.start(),o.get().then((function(t){e(t)}))}))},hide:l,destroy:c}},e.userVisibleAuth=function(t){return de.fetchDomain().then((function(){var i=De(),n=de.get(),a=H(H({origin:location.protocol+"//"+location.host,uuid:i,debug:n._debug?1:null,localhost:n._localhost?1:null},w(t,["screen","source"])),{scheme:null==t?void 0:t.scheme}),s=Se(null==t?void 0:t.action);s&&(a.action=s);var o=ye(null==t?void 0:t.entry);return o&&(a.initial_stats_info=o),Te(a).then((function(t){e.flags&&(t=t+"#"+T(e.flags));var n=screen.height/2-280,a=screen.width/2-410,s=window.open(t,"_blank","top="+n+",left="+a+",width=820,height=560,location");if(!s){var o=Q(J(D[D.CONNECT_WINDOW_NOT_OPENED],D.CONNECT_WINDOW_NOT_OPENED,"Connect window was not opened."));return Promise.reject(o)}return new Promise((function(e,t){var n=setInterval((function(){if(!s||s.closed){window.removeEventListener("message",a),clearInterval(n);var e=Q(J(D[D.CONNECT_WINDOW_CLOSED],D.CONNECT_WINDOW_CLOSED,"Connect window was closed."));t(e)}}),1e3);function a(o){if(o.source===s&&s)if(window.removeEventListener("message",a),clearInterval(n),function(e){for(var t=0;t<r.length;t++){var i=r[t];if(e.slice(e.length-i.length)===i)return!0}return!1}(o.origin))if(o.data.action==="vk_connect_response"+i){var c=o.data.payload;s.close(),c.error?(u=Q(J(D[D.CONNECT_CLIENT_SDK_ERROR],D.CONNECT_CLIENT_SDK_ERROR,function(e){return e.error+";"+e.errorCode}(c.error))),t(u)):e({provider:"vk",payload:c})}else if(o.data.action==="oauth_callback"+i)e({provider:o.data.payload.name}),s.close();else if(o.data.action==="skip_callback"+i){var l=o.data.payload.redirectURL;l&&(window.location.href=l),s.close()}else o.data.action==="bind_ok_account"+i?(e(o.data.payload),s.close()):(s.close(),u=Q(J(D[D.CONNECT_UNKNOWN_SDK_MESSAGE],D.CONNECT_UNKNOWN_SDK_MESSAGE,function(e){return"This SDK message is unknown: "+e}(JSON.stringify(o.data)))),t(u));else{s.close();var u=Q(J(D[D.CONNECT_DOMAIN_NOT_ALLOWED],D.CONNECT_DOMAIN_NOT_ALLOWED,function(e){return'URL domain "'+e+'" is not allowed.'}(o.origin)));t(u)}}window.addEventListener("message",a)}))}))}))},e.redirectAuth=function(e){var t=je.validate(e);!t.isValid()&&console.error(t.error());var i=De(),n=H(H({redirect_uri:e.url,uuid:i},w(e,["screen","source"])),{scheme:null==e?void 0:e.scheme}),r=Se(null==e?void 0:e.action);r&&(n.action=r);var a=ye(null==e?void 0:e.entry);a&&(n.initial_stats_info=a),(null==e?void 0:e.state)&&(n.redirect_state=e.state),Te(n).then((function(e){location.assign(e)}))},e.logout=function(){return de.fetchDomain().then((function(){var e=de.get(),t=e.connectDomain,i=e.appId,n=e.superAppTokenV2;if(!n)return Promise.reject(N("superappToken","SuperappToken is undefined"));var r=T({origin:location.protocol+"//"+location.host,host_app_id:i,superapp_token:n}),a=fetch("https://"+t+"/logout?"+r,{credentials:"include"});return de.events.emit(P.LOGOUT),de.setSuperAppToken(""),de.setSuperAppToken("",{version:2}),a}))},e}(),We=["open_account"];!function(){function e(){}e.open=function(e){var t=te.validate({token:e.action.token});return!t.isValid()&&console.error(t.error()),de.fetchDomain().then((function(){var t,i=De(),n=de.get(),r=H({origin:location.protocol+"//"+location.host,uuid:i,debug:A(n._debug,0),localhost:A(n._localhost,0)},w(e,["screen","source"])),a=(t=null==e?void 0:e.action)&&We.includes(t.name)?btoa(JSON.stringify(t)):"";return a&&(r.action=a),function(e){return de.fetchDomain().then((function(){var t=de.get(),i=t.appId,n=t.connectDomain,r=t.appSettings,a=t._debug,s=t._localhost,o=H({app_id:i,response_type:"silent_token",v:"1.58.6",debug:a?1:null,localhost:s?1:null},e);r&&C(r)&&(o.app_settings=I(r));var c=T(o);return Promise.resolve("https://"+n+"/open_account?"+c)}))}(r).then((function(e){if(!window.open(e,"_blank")){var t=Q(J(D[D.CONNECT_WINDOW_NOT_OPENED],D.CONNECT_WINDOW_NOT_OPENED,"Connect window was not opened."));return Promise.reject(t)}return Promise.resolve()}))}))}}();!function(e){e.INTERNAL_RESIZE="VKSDKMessengerInternalResize",e.INTERNAL_LOGOUT="VKSDKMessengerInternalLogout"}(Ve||(Ve={})),function(e){e.CLOSE_CHAT="VKSDKMessengerCloseChat"}(Fe||(Fe={}));var Ge,Ke=function(){function e(){}return e.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},e}(),qe=new ee({params:[{rule:q,errorText:L("params")}]}),ze=function(){function e(){var e=this;this.config={},this.params={},this.loadingTask=new ge,this.initTask=new ge,this.cssText="",this.handleError=function(t){var i=Q(J(D[D.CUSTOM],D.CUSTOM,"",t));e.events.emit(P.ERROR,i)},this.events=W(),this.handleBridgeMessage=this.handleBridgeMessage.bind(this),this.handleChangeSuperAppToken=this.handleChangeSuperAppToken.bind(this),this.close=this.close.bind(this),this.handleLogout=this.handleLogout.bind(this)}return e.prototype.preload=function(e){var t=this;return de.fetchDomain().then((function(){return t.validateParams(e).then((function(){return t.updateParams(e),t.createIframe().then((function(){return t.initTask.start(),t.loadingTask.start(),t.timeoutTimer=setTimeout((function(){if(!t.initTask.finished){var e=Q(J(D[D.LOADING_ERROR],D.LOADING_ERROR,"Loading timeout"));t.initTask.reject(e)}}),5e3),t.iframe.onload=function(){t.iframe.onload=null,t.loadingTask.resolve()},t.bridge=new fe({iframe:t.iframe,origin:"https://"+de.get().connectDomain}),t.bridge.onMessage(t.handleBridgeMessage),de.events.on(B.SUPERAPP_TOKEN_CHANGE_V2,t.handleChangeSuperAppToken),de.events.on(P.LOGOUT,t.close),t.getIframeContainer().appendChild(t.iframe),t.loadingTask.get()}))}))}))},e.prototype.open=function(e){var t=this;return this.validateParams(e).then((function(){return t.initTask.finished?(t.updateParams(e),Promise.resolve()):t.initTask.active||t.initTask.finished?(t.updateParams(e),t.initTask.get()):t.preload(e).then((function(){return t.initTask.get()}))}))},e.prototype.update=function(e,t){e&&this.updateParams(e),t&&this.updateConfig(t)},e.prototype.close=function(){this.iframe&&(this.iframe.onload=null,this.iframe.remove()),this.bridge&&this.bridge.destroy(),de.events.off(B.SUPERAPP_TOKEN_CHANGE_V2,this.handleChangeSuperAppToken),de.events.off(P.LOGOUT,this.close),delete this.iframe,delete this.bridge,this.loadingTask=new ge,this.initTask=new ge,this.events.emit(P.CLOSE)},e.prototype.sendMessage=function(e){var t=re.validate({message:e});!t.isValid()&&console.error(t.error()),this.bridge.sendMessage(e)},e.prototype.on=function(e,t){var i=ie.validate({event:e,handler:t});!i.isValid()&&console.error(i.error()),this.events.on(e,t)},e.prototype.off=function(e,t){var i=ie.validate({event:e,handler:t});!i.isValid()&&console.error(i.error()),this.events.off(e,t)},e.prototype.handleInit=function(){this.initTask.finished||(clearTimeout(this.timeoutTimer),this.initTask.resolve()),this.sendUpdateParamsMessage(),this.iframe.style.display="block"},e.prototype.handleRequestAuth=function(){de._auth({version:2})},e.prototype.handleRequestSuperAppToken=function(e){de._requestSuperAppToken(e,{version:2})},e.prototype.handleChangeSuperAppToken=function(e){this.bridge.sendMessage({handler:P.REQUEST_SUPERAPP_TOKEN+"Success",params:{result:e}})},e.prototype.handleBridgeMessage=function(e){switch(Ke.log(e),e.handler){case k.INIT:this.handleInit();break;case P.REQUEST_SUPERAPP_TOKEN:this.handleRequestSuperAppToken(e.params);break;case P.AUTH_NEEDED:this.handleRequestAuth();break;case P.CLOSE:this.close();break;case P.ERROR:this.handleError(e.params);break;default:return}},e.prototype.handleLogout=function(){de._logout()},e.prototype.handleAfterUpdateParams=function(){this.sendUpdateParamsMessage()},e.prototype.handleAfterUpdateConfig=function(){},e.prototype.handleAfterCreateIframe=function(){},e.prototype.validateParams=function(e){var t=qe.validate({params:e});return!t.isValid()&&console.error(t.error()),Promise.resolve(e)},e.prototype.createIframe=function(){var e=this;return this.getIframeUrl().then((function(t){return e.iframe=b(t,{cssText:e.cssText}),e.handleAfterCreateIframe(),Promise.resolve()}))},e.prototype.getIframeUrl=function(){return new Promise((function(e){return e("")}))},e.prototype.getIframeContainer=function(){return window.document.body},e.prototype.getIframeUrlParams=function(){var e=this;return de.fetchDomain().then((function(){var t=de.get(),i=t.superAppTokenV2,n=t.appId,r=t._debug,a=t._localhost;return Promise.resolve(T(H(H({},e.params),{host_app_id:n,superapp_token:i,origin:location.protocol+"//"+location.host,debug:r?1:null,localhost:a?1:null})))}))},e.prototype.updateConfig=function(e){this.config=R(this.config,e),this.handleAfterUpdateConfig()},e.prototype.updateParams=function(e){this.params=R(this.params,e||{}),this.handleAfterUpdateParams()},e.prototype.sendUpdateParamsMessage=function(){this.bridge&&this.initTask.finished&&this.bridge.sendMessage({params:this.params,handler:P.UPDATE_PARAMS})},e}(),Je=new ee({config:[{rule:q,errorText:L("config")}]}),Ye={styles:{bottom:"0",right:"0",zIndex:99999}};!function(e){function t(t){var i=e.call(this)||this;i.config=Ye,i.cssText="\n    border: none;\n    display: none;\n    position: fixed;\n    color-scheme: auto;\n  ",i.updateStyles=function(){if(i.iframe){var e=i.config.styles,t=isFinite(e.zIndex)?e.zIndex:999999;i.iframe.style.zIndex=""+t,i.iframe.style.bottom=e.bottom,i.iframe.style.right=e.right}};var n=Je.validate({config:t});return!n.isValid()&&console.error(n.error()),i.updateConfig(t),i}V(t,e),t.prototype.handleBridgeMessage=function(t){var i=this;switch(e.prototype.handleBridgeMessage.call(this,t),t.handler){case P.GET_CAPTCHA:var n=t.params.uuid,r=new Pe(n,{captcha_sid:t.params.captcha_sid,captcha_img:t.params.captcha_img});r.show().then((function(e){i.bridge.sendMessage({handler:P.GET_CAPTCHA+"Success",params:H({uuid:n},e)})})).catch((function(){i.bridge.sendMessage({handler:P.GET_CAPTCHA+"Fail",params:{uuid:n}}),r.destroy()}));break;case Ve.INTERNAL_RESIZE:this.handleInternalIframeResize(t);break;case Ve.INTERNAL_LOGOUT:this.handleLogout();break;case Fe.CLOSE_CHAT:this.events.emit(Fe.CLOSE_CHAT,t.params);break;default:return}},t.prototype.handleInternalIframeResize=function(e){var t=e.params;this.iframe.width=t.width+"px",this.iframe.height=t.height+"px"},t.prototype.handleAfterUpdateConfig=function(){this.updateStyles()},t.prototype.handleAfterCreateIframe=function(){this.updateStyles()},t.prototype.validateParams=function(e){return e.peer_id>=0?Promise.reject(N("peer_id","Peer id can`t be positive")):Promise.resolve(e)},t.prototype.getIframeUrl=function(){var e=this;return de.fetchDomain().then((function(){return e.getIframeUrlParams().then((function(e){var t=de.get().connectDomain;return Promise.resolve("https://"+t+"/messenger?"+e)}))}))}}(ze);!function(e){e.SCANNED="VKSDKQRScaned",e.CLICKED="VKSDKQRClicked"}(Ge||(Ge={}));var Qe,Ze=new ee({container:[{rule:q,errorText:L("container")}]});!function(e){function t(t){var i=e.call(this)||this;i.getIframeContainer=function(){return i.config.container?i.config.container:window.document.body};var n=Ze.validate(t);return!n.isValid()&&console.error(n.error()),(null==t?void 0:t.langId)&&!Ce.includes(null==t?void 0:t.langId)&&console.error(N("lang_id","This lang id is not allowed")),i.updateConfig(t),i}V(t,e),t.prototype.getIframeUrl=function(){return this.getIframeUrlParams().then((function(e){var t=de.get().connectDomain;return Promise.resolve("https://"+t+"/qr_auth?"+e)}))},t.prototype.getIframeUrlParams=function(){var e=this;return de.fetchDomain().then((function(){var t,i=de.get(),n=i.appId,r=i._debug,a=i._localhost;return Promise.resolve(T({scheme:(null===(t=e.params)||void 0===t?void 0:t.scheme)||"bright_light",app_id:n,origin:location.protocol+"//"+location.host,lang_id:e.config.langId||null,initial_stats_info:ye(e.config.entry)||null,debug:r?1:null,localhost:a?1:null}))}))},t.prototype.handleBridgeMessage=function(t){var i=this;switch(e.prototype.handleBridgeMessage.call(this,t),t.handler){case Ge.CLICKED:this.events.emit(Ge.CLICKED);break;case Ge.SCANNED:this.events.emit(Ge.SCANNED,t.params.token);break;case P.GET_CAPTCHA:var n=t.params.uuid,r=new Pe(n,{captcha_sid:t.params.captcha_sid,captcha_img:t.params.captcha_img});r.show().then((function(e){i.bridge.sendMessage({handler:P.GET_CAPTCHA+"Success",params:H({uuid:n},e)})})).catch((function(){i.bridge.sendMessage({handler:P.GET_CAPTCHA+"Fail",params:{uuid:n}}),r.destroy()}));break;default:return}}}(ze);!function(e){e.CONTENT_IN_HEIGHT="VKSDKUserContentInHeight",e.VALIDATION_PHONE_CLOSE="VKSDKUserValidationPhoneClose"}(Qe||(Qe={}));var Xe,et=new ee({container:[{rule:q,errorText:L("container")}]}),tt=new ee({canSkip:[{rule:q,errorText:L("canSkip")}],origin:[{rule:q,errorText:L("origin")}]}),it=function(e){function t(t){var i=e.call(this)||this;i.getIframeContainer=function(){return i.config.container?i.config.container:window.document.body};var n=et.validate(t);return!n.isValid()&&console.error(n.error()),i.updateConfig(t),i}return V(t,e),t.prototype.getIframeUrl=function(){var e=H(H({redirect_uri:this.params.url,uuid:De()},w(this.params,["screen","source"])),{scheme:this.params.scheme}),t=Se(this.params.action);t&&(e.action=t);var i=ye(this.params.entry);return i&&(e.initial_stats_info=i),this.params.state&&(e.redirect_state=this.params.state),Te(e)},t.prototype.handleBridgeMessage=function(t){switch(e.prototype.handleBridgeMessage.call(this,t),t.handler){case Qe.CONTENT_IN_HEIGHT:this.events.emit(Qe.CONTENT_IN_HEIGHT,t.params);break;case Qe.VALIDATION_PHONE_CLOSE:this.events.emit(Qe.VALIDATION_PHONE_CLOSE,t.params);break;default:return}},t.prototype.validatePhone=function(e){var t=tt.validate(e);!t.isValid()&&console.error(t.error());var i={name:"auth_validation_phone",params:{status:e.canSkip?"1":"0"}};e.sid&&(i.params.sid=e.sid),this.open({url:e.origin,scheme:e.scheme,action:i})},t}(ze);!function(e){e.SUCCESS="VKSDKVerificationProfileSuccess",e.CLOSE="VKSDKVerificationProfileClose"}(Xe||(Xe={}));var nt=new ee({config:[{rule:q,errorText:L("config")}],provider:[{rule:K,errorText:M("provider")},{rule:q,errorText:L("provider")}]});!function(e){function t(t){var i=e.call(this)||this;i.cssText="\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    z-index: 9999;\n    border: none;\n    display: none;\n  ";var n=nt.validate({config:t,provider:t.provider});return!n.isValid()&&console.error(n.error()),i.updateConfig(t),i}V(t,e),t.prototype.handleBridgeMessage=function(t){switch(e.prototype.handleBridgeMessage.call(this,t),t.handler){case Xe.SUCCESS:this.events.emit(Xe.SUCCESS);break;case Xe.CLOSE:this.close();break;default:return}},t.prototype.handleAfterUpdateConfig=function(){this.updateZIndex()},t.prototype.handleAfterCreateIframe=function(){this.updateZIndex()},t.prototype.getIframeUrlParams=function(){var e=this;return de.fetchDomain().then((function(){var t=de.get(),i=t.superAppTokenV2,n=t.appId,r=t._debug,a=t._localhost;return Promise.resolve(T(H(H({},e.params),{app:n,superapp_token:i,origin:location.protocol+"//"+location.host,debug:r?1:null,localhost:a?1:null,provider:e.config.provider})))}))},t.prototype.getIframeUrl=function(){var e=this;return de.fetchDomain().then((function(){return e.getIframeUrlParams().then((function(e){var t=de.get().connectDomain;return Promise.resolve("https://"+t+"/verification_profile?"+e)}))}))},t.prototype.updateZIndex=function(){if(this.iframe){var e=this.config.zIndex;this.iframe.style.zIndex=""+e}}}(ze)},1695:function(e,t,i){"use strict";i.d(t,{VideoUploadService:function(){return P}});var n,r=Object.defineProperty,a=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,c=(e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,l=(e,t)=>{for(var i in t||(t={}))s.call(t,i)&&c(e,i,t[i]);if(a)for(var i of a(t))o.call(t,i)&&c(e,i,t[i]);return e},u=(e,t,i)=>new Promise(((n,r)=>{var a=e=>{try{o(i.next(e))}catch(e){r(e)}},s=e=>{try{o(i.throw(e))}catch(e){r(e)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,s);o((i=i.apply(e,t)).next())})),d=class{},h=((n=h||{})[n.NONE=0]="NONE",n[n.INFO=2]="INFO",n[n.WARN=4]="WARN",n[n.ERROR=8]="ERROR",n[n.DEBUG=16]="DEBUG",n),p=1048576;function _(){}function m(e){return new Promise(((t,i)=>{let n=Math.floor(e.size/2)-p/2,r=new Blob([e.slice(0,p),e.slice(n,n+p),e.slice(e.size-p,e.size)]),a=new FileReader;a.onload=function(e){t(function(e){let t=65535,i=65535,n=e.length,r=0;for(;n;){let a=n>359?359:n;n-=a;do{i+=t+=e[r++]}while(--a);t=((65535&t)>>>0)+(t>>>16),i=((65535&i)>>>0)+(i>>>16)}return t=((65535&t)>>>0)+(t>>>16),i=((65535&i)>>>0)+(i>>>16),((i<<16>>>0|t)>>>0).toString(16)}(new Uint8Array(e.target.result)))},a.onerror=()=>{i(new Error("Could not read binary data"))},a.readAsArrayBuffer(r)}))}function f(e,t){return["upload",e,t].join("_")}function g(e){return e.split("?").pop().split("&").map((e=>e.split("="))).findIndex((e=>"expires"===e[0]&&+e[1]>Date.now()))>-1}var v={chunkSize:4194304,threadNumber:4,maxRetryNumber:10,debugMode:!1,logLevel:0,logger:null,headers:{},onRestored:_,onPrepared:_,onStart:_,onStop:_,onFail:_,onCancel:_,onSuccess:_,onChunkUploadSuccess:_,onChunkUploadError:_,onProgress:()=>{}},S={maxRetryNumber:10,headers:{},fileName:"",fileType:"",fileSize:0},y=class{start(){return 1===this.state||(this.state=1,this.tick()),Promise.resolve()}stop(e=!1){return 0===this.state?Promise.resolve():new Promise((t=>{this.currentRequest&&e?(this.currentRequest.addEventListener("abort",(()=>{this.logger.debug(`Thread #${this.$uid}: Halted.`),this.state=0,this.currentRequest=null,t()})),this.currentRequest.abort()):(this.logger.debug(`Thread #${this.$uid}: Halted.`),this.state=0,t())}))}onFail(e){this.failCallback=e}onOffline(e){this.offlineCallback=e}onUploadSuccess(e){this.chunkUploadSuccessCallback=e}onUploadError(e){this.chunkUploadErrorCallback=e}tick(){if(1!==this.state)return;this.lastTickStart=Date.now(),this.currentTry=0;let e=this.uploadManager.getNextPayload();e?this.tryLoadChunk(e):this.state=0}tryLoadChunk(e){if(1!==this.state)return;let t=new XMLHttpRequest;this.currentRequest=t,t.open("POST",this.uploadUrl,!0);let i={};for(let e in this.options.headers)i[e]=this.options.headers[e];i["Content-Type"]=this.options.fileType||"application/octet-stream",i["X-Uploading-Mode"]="parallel",i["Content-Range"]=`bytes ${e.startByte}-${e.endByte}/${this.options.fileSize}`,this.options.fileName&&(i["Content-Disposition"]="attachment; filename="+encodeURIComponent(this.options.fileName));for(let e in i)t.setRequestHeader(e,i[e]);t.onload=this.handleLoad.bind(this,e,t,i),t.onerror=this.handleNetworkError.bind(this,e,t),t.ontimeout=this.handleNetworkError.bind(this,e,t),t.send(e.data)}retryLoadChunk(e,t){setTimeout((()=>{this.currentTry++,this.tryLoadChunk(e)}),t)}handleLoad(e,t,i){return u(this,null,(function*(){if(this.currentRequest=null,this.lastChunkUploadTime=Date.now()-this.lastTickStart,t.status>=200&&t.status<300)this.logger.debug(`Thread #${this.$uid}: Chunk ${e.index} (${e.startByte} - ${e.endByte} from ${this.options.fileSize}) uploaded`),this.uploadManager.processChunkUploaderResponse(e,t,i),this.chunkUploadSuccessCallback(l({},e)),1===this.state&&this.tick();else{this.chunkUploadErrorCallback(l({},e),t.status,t.responseText);let n=this.options.maxRetryNumber>0,r=this.currentTry>=this.options.maxRetryNumber,a={chunk:{index:e.index,size:e.endByte-e.startByte,uploadTime:this.lastChunkUploadTime},request:{requestHeaders:i},response:{status:t.status,statusText:t.statusText,responseHeaders:t.getAllResponseHeaders(),responseText:t.responseText}};n&&r?(this.logger.error(`Thread #${this.$uid}: Failed to upload chunk ${e.index} - Max retry number exceeded (${this.options.maxRetryNumber})`,a),yield this.stop(),this.failCallback()):(this.logger.error(`Thread #${this.$uid}: Failed to upload chunk ${e.index}. Retrying in 500ms`,a),this.retryLoadChunk(e,500))}}))}handleNetworkError(e,t){return u(this,null,(function*(){this.chunkUploadErrorCallback(e,t.status,t.responseText),yield this.stop(),this.offlineCallback(this)}))}normalizeOptions(e={}){let t=l({},S);return Number.isInteger(e.maxRetryNumber)&&(t.maxRetryNumber=e.maxRetryNumber),e.headers&&(t.headers=l({},e.headers)),"string"==typeof e.fileName&&(t.fileName=e.fileName),"string"==typeof e.fileType&&(t.fileType=e.fileType),Number.isInteger(e.fileSize)&&(t.fileSize=e.fileSize),t}constructor(e,t,i,n){this.failCallback=_,this.offlineCallback=_,this.chunkUploadSuccessCallback=_,this.chunkUploadErrorCallback=_,this.state=0,this.currentRequest=null,this.currentTry=0,this.lastTickStart=0,this.lastChunkUploadTime=0,this.$uid=y.instanceCount++,this.uploadUrl=e,this.uploadManager=t,this.options=this.normalizeOptions(i),this.logger=n}},T=y;T.instanceCount=0;var E=class extends d{constructor(){super(...arguments),this.info=console.log.bind(console),this.warn=console.warn.bind(console),this.error=console.error.bind(console),this.debug=console.debug.bind(console)}},C=()=>{},I=class extends d{constructor(){super(...arguments),this.info=C,this.warn=C,this.error=C,this.debug=C}},b=class{static createLogger(e){return e?new E:new I}},R=class{setUploadInfo(e){this.uploadInfo=e}info(e,t=null){2&this.logLevel&&this.logger.info(e,t,this.uploadInfo)}warn(e,t=null){4&this.logLevel&&this.logger.warn(e,t,this.uploadInfo)}error(e,t=null){8&this.logLevel&&this.logger.error(e,t,this.uploadInfo)}debug(e,t=null){16&this.logLevel&&this.logger.debug(e,t,this.uploadInfo)}constructor(e,t){this.uploadInfo=null,this.logger=e,this.logLevel=t}},A=class{get timerName(){return`${this.dataSource.getName()} uploaded in`}upload(){return u(this,null,(function*(){return 0===this.state&&(yield this.prepare()),1===this.state&&(yield this.start()),this.uploadPromise}))}start(){return u(this,null,(function*(){switch(0===this.state&&(yield this.prepare()),this.state){case 1:this.logger.info("UploadSession: Starting uploading process"),window.console.time(this.timerName);break;case 3:this.logger.info("UploadSession: Resuming uploading process");break;default:return this}return this.onProgressCallback(this.uploadManager.getProgress()),this.state=2,yield Promise.all(this.chunkUploaderPool.map((e=>e.start()))),this.onStartCallback(),this}))}stop(e=!1){return u(this,null,(function*(){return 2!==this.state||(yield Promise.all(this.chunkUploaderPool.map((t=>t.stop(e)))),this.state=3,this.uploadManager.clearUploadingState(),this.onStopCallback()),this}))}cancel(){return u(this,null,(function*(){return 4===this.state||5===this.state||6===this.state||(this.logger.info("UploadSession: Cancelling uploading process..."),yield this.stop(!0),this.onCancelCallback(),this.uploadRejectHandler(new Error("Uploading was cancelled"))),this}))}destroy(){this.stop(!0),this.uploadUrlObject="",this.logger=new R(b.createLogger(!1),0),this.uploadPromise&&this.uploadPromise,this.uploadResolveHandler=_,this.uploadRejectHandler=_,this.uploadPromise=Promise.reject(),this.onRestoredCallback=_,this.onPreparedCallback=_,this.onStartCallback=_,this.onStopCallback=_,this.onFailCallback=_,this.onCancelCallback=_,this.onProgressCallback=_,this.onSuccessCallback=_,this.onChunkUploadSuccessCallback=_,this.onChunkUploadErrorCallback=_,this.uploadManager.onProgressChange(_)}onRestored(e){return this.onRestoredCallback=e,this}onPrepared(e){return this.onPreparedCallback=e,this}onStart(e){return this.onStartCallback=e,this}onStop(e){return this.onStopCallback=e,this}onFail(e){return this.onFailCallback=e,this}onCancel(e){return this.onCancelCallback=e,this}onProgress(e){return this.onProgressCallback=e,this}onSuccess(e){return this.onSuccessCallback=e,this}onChunkUploadSuccess(e){return this.onChunkUploadSuccessCallback=e,this}onChunkUploadError(e){return this.onChunkUploadErrorCallback=e,this}getUploadUrl(){return this.uploadUrl}getChunkLeftNumber(){return this.uploadManager.getChunkLeftNumber()}getChunkLoadedNumber(){return this.uploadManager.getChunkLoadedNumber()}getLoadedRangesStr(){return this.uploadManager.getUploadedDataRangesStr()}prepare(){return u(this,null,(function*(){this.key=yield this.createUploadSessionKey(),this.logger.info("UploadSession: UploadSession calculated key",this.key);let e=function(e){try{let t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return null}}(this.key);e&&g(e.url)?(this.logger.info("UploadSession: Found stored session for this file",e),this.uploadUrl=e.url,this.uploadManager.setUploadedBytes(e.loaded)):(this.uploadUrl=yield this.resolveUploadUrl(this.uploadUrlObject),this.logger.info("UploadSession: Resolved upload url",this.uploadUrl));let t={};new URL(this.uploadUrl).searchParams.forEach(((e,i)=>{t[i]=e})),this.logger.setUploadInfo({uploadParams:t,progress:this.uploadManager.getProgress(),video:{id:`${t.vkUserId}_${t.vkVideoId}`,name:this.dataSource.getName(),type:this.dataSource.getType(),size:this.dataSource.getSize()}});for(let e=0;e<this.options.threadNumber;e++)this.chunkUploaderPool.push(this.createChunkUploader(this.uploadUrl));this.saveSessionData(),this.state=1,this.onPreparedCallback()}))}resolveUploadUrl(e){switch(typeof e){case"string":return Promise.resolve(e);case"function":return e();default:throw new Error("UploadSession: Unsupported upload url object")}}createUploadSessionKey(){return u(this,null,(function*(){return f(yield this.dataSource.getHash(),this.dataSource.getSize())}))}saveSessionData(){let e={url:this.uploadUrl,loaded:this.uploadManager.getUploadedDataRangesStr()};try{localStorage.setItem(this.key,JSON.stringify(e))}catch(e){this.logger.error("UploadSession: Could not save session data")}}clearSessionData(){try{localStorage.removeItem(this.key)}catch(e){this.logger.error("UploadSession: Could not remove session data")}}createChunkUploader(e){let t={maxRetryNumber:this.options.maxRetryNumber,headers:this.options.headers,fileSize:this.dataSource.getSize(),fileName:this.dataSource.getName(),fileType:this.dataSource.getType()},i=new T(e,this.uploadManager,t,this.logger);return i.onOffline(this.onThreadOfflineHandler.bind(this)),i.onFail(this.onThreadFailedHandler.bind(this)),i.onUploadSuccess(this.onChunkUploadSuccessHandler.bind(this)),i.onUploadError(this.onChunkUploadErrorHandler.bind(this)),i}onThreadOfflineHandler(e){return u(this,null,(function*(){this.logger.warn(`UploadSession: Thread #${e.$uid} went offline: Switching to ping mode...`),yield this.stop(!0),yield this.ping(),this.logger.warn("UploadSession: Connection renewed: Proceed upload process"),yield this.start()}))}onThreadFailedHandler(){return u(this,null,(function*(){yield this.stop(!0),this.onFailCallback(),this.uploadRejectHandler()}))}onChunkUploadErrorHandler(e,t,i){return u(this,null,(function*(){this.onChunkUploadErrorCallback(e,t,i)}))}onChunkUploadSuccessHandler(e){return u(this,null,(function*(){this.onChunkUploadSuccessCallback(e)}))}onProgressChangeHandler(e){if(this.onProgressCallback(e),this.saveSessionData(),100===e){window.console.timeEnd(this.timerName);let e=this.uploadManager.getUploadedFileObject();this.onSuccessCallback(e),this.uploadResolveHandler(e),this.clearSessionData()}}getUploadedRanges(){return u(this,null,(function*(){return new Promise(((e,t)=>{let i=new XMLHttpRequest;i.open("GET",this.uploadUrl,!0),i.onload=()=>{i.status>=200&&i.status<300?e(i.responseText):t()},i.onerror=t,i.ontimeout=t,i.send(null)}))}))}ping(){return 6===this.state?Promise.reject():new Promise((e=>{this.getUploadedRanges().then((()=>{e()})).catch((()=>{this.retryPing(e)}))}))}retryPing(e){setTimeout((()=>{this.ping().then(e).catch((()=>{this.retryPing(e)}))}),1e4)}normalizeOptions(e={}){let t=l({},v);if(Number.isInteger(e.chunkSize)&&(t.chunkSize=e.chunkSize),Number.isInteger(e.threadNumber)&&(t.threadNumber=e.threadNumber),Number.isInteger(e.maxRetryNumber)&&(t.maxRetryNumber=e.maxRetryNumber),e.headers&&(t.headers=l({},e.headers)),"function"==typeof e.onRestored&&(t.onRestored=e.onRestored),"function"==typeof e.onPrepared&&(t.onPrepared=e.onPrepared),"function"==typeof e.onStart&&(t.onStart=e.onStart),"function"==typeof e.onStop&&(t.onStop=e.onStop),"function"==typeof e.onCancel&&(t.onCancel=e.onCancel),"function"==typeof e.onFail&&(t.onFail=e.onFail),"function"==typeof e.onProgress&&(t.onProgress=e.onProgress),"function"==typeof e.onSuccess&&(t.onSuccess=e.onSuccess),"function"==typeof e.onChunkUploadSuccess&&(t.onChunkUploadSuccess=e.onChunkUploadSuccess),"function"==typeof e.onChunkUploadError&&(t.onChunkUploadError=e.onChunkUploadError),Number.isInteger(e.logLevel)&&(t.logLevel=e.logLevel),e.logger){if(!(e.logger.info&&"function"==typeof e.logger.info&&e.logger.warn&&"function"==typeof e.logger.warn&&e.logger.error&&"function"==typeof e.logger.error&&e.logger.debug&&"function"==typeof e.logger.debug))throw new Error("Invalid logger provided. Logger MUST implement 4 methods: info(), warn(), error(), debug()");t.logger=e.logger}return!0===e.debugMode&&(t.logLevel=16),Object.hasOwnProperty.call(e,"debugMode")&&window.console.warn('Config property "debugMode" is deprecated and will be removed. Use "logLevel" property'),t}constructor(e,t,i){this.onRestoredCallback=_,this.onPreparedCallback=_,this.onStartCallback=_,this.onStopCallback=_,this.onFailCallback=_,this.onCancelCallback=_,this.onProgressCallback=_,this.onSuccessCallback=_,this.onChunkUploadSuccessCallback=_,this.onChunkUploadErrorCallback=_,this.state=0,this.key="",this.$uid=A.instanceCount++,this.chunkUploaderPool=[],this.uploadUrlObject=e,this.options=this.normalizeOptions(i),this.logger=new R(this.options.logger||b.createLogger(this.options.debugMode),this.options.logLevel),this.options.onRestored!==_&&this.onRestored(this.options.onRestored),this.options.onPrepared!==_&&this.onPrepared(this.options.onPrepared),this.options.onStart!==_&&this.onStart(this.options.onStart),this.options.onStop!==_&&this.onStop(this.options.onStop),this.options.onCancel!==_&&this.onCancel(this.options.onCancel),this.options.onFail!==_&&this.onFail(this.options.onFail),this.options.onProgress!==_&&this.onProgress(this.options.onProgress),this.options.onSuccess!==_&&this.onSuccess(this.options.onSuccess),this.options.onChunkUploadSuccess!==_&&this.onChunkUploadSuccess(this.options.onChunkUploadSuccess),this.options.onChunkUploadError!==_&&this.onChunkUploadError(this.options.onChunkUploadError),this.dataSource=new class{getChunk(e,t){return this.file.slice(e,t+1)}getName(){return this.file.name}getSize(){return this.file.size}getType(){return this.file.type}getHash(){return u(this,null,(function*(){if(this.hash)return Promise.resolve(this.hash);let e=yield m(this.file);return this.hash=e,e}))}constructor(e){this.hash="",this.file=e}}(t),this.uploadManager=new class{get fileSize(){return this.dataSource.getSize()}getNextPayload(){let e=this.chunkUploadMap.findIndex((e=>0===e));return-1===e?null:this.getChunkPayload(e)}processChunkUploaderResponse(e,t,i){this.chunkUploadMap[e.index]=2;let n={status:t.status,statusText:t.statusText,requestHeaders:i,responseHeaders:t.getAllResponseHeaders(),responseText:t.responseText};switch(t.status){case 200:try{this.uploadedFileObject=JSON.parse(t.response)}catch(e){this.logger.error("Could not parse final chunk upload server response",n)}this.updateProgress();break;case 201:this.uploadedDataRangesStr=t.responseText||t.getResponseHeader("Range")||"";try{this.setUploadedBytes(this.uploadedDataRangesStr)}catch(t){this.logger.error(`Could not parse chunk #${e.index} upload server response`,n)}break;default:this.logger.warn(`Unsupported request status code ${t.status}`,{request:t})}}getProgress(){return this.progress}getChunkLeftNumber(){return this.chunkUploadMap.filter((e=>0===e)).length}getChunkLoadedNumber(){return this.chunkUploadMap.filter((e=>2===e)).length}getUploadedFileObject(){return this.uploadedFileObject}getUploadedDataRangesStr(){return this.uploadedDataRangesStr}setUploadedBytes(e=""){let t=this.parseStatString(e);this.updateChunkUploadMap(t),this.updateProgress()}onProgressChange(e){this.progressChangeCallback=e}clearUploadingState(){for(let e=0;e<this.chunkUploadMap.length;e++)1===this.chunkUploadMap[e]&&(this.chunkUploadMap[e]=0)}getChunkPayload(e){let t=e*this.chunkSize,i=(e+1)*this.chunkSize-1;i=Math.min(i,this.fileSize-1);let n=this.dataSource.getChunk(t,i);return this.chunkUploadMap[e]=1,{index:e,startByte:t,endByte:i,data:n}}updateChunkUploadMap(e){this.chunkUploadMap=this.chunkUploadMap.map(((t,i)=>1===t?1:e.find((e=>{let t=i*this.chunkSize,n=Math.min((i+1)*this.chunkSize,this.fileSize)-1;return t>=e[0]&&n<=e[1]}))?2:0))}updateProgress(){let e=this.chunkUploadMap.filter((e=>2===e)).length/this.chunkUploadMap.length*100;if(this.progress!==e){this.progress=e;try{this.progressChangeCallback(this.progress)}catch(e){this.logger.warn("Failed to execute onProgress callback",e)}}}parseStatString(e){return e.split(",").map((e=>{let t=e.split("/")[0].split("-");return[parseInt(t[0]),parseInt(t[1])]}))}constructor(e,t,i){this.uploadedDataRangesStr="",this.progress=0,this.progressChangeCallback=_,this.dataSource=e,this.chunkSize=t,this.logger=i,this.chunkUploadMap=[];let n=Math.ceil(this.fileSize/this.chunkSize);for(let e=0;e<n;e++)this.chunkUploadMap.push(0)}}(this.dataSource,this.options.chunkSize,this.logger),this.uploadManager.onProgressChange(this.onProgressChangeHandler.bind(this)),this.uploadPromise=new Promise(((e,t)=>{this.uploadResolveHandler=e,this.uploadRejectHandler=t})),this.logger.info("UploadSession: instance created and configured with following options:",this.options)}},w=A;w.instanceCount=0;var P=new class{createUploadSession(e,t,i){let n=new w(e,t,i);return this.sessionList.push(n),n}getFileUploadSession(e){return u(this,null,(function*(){let t=f(yield m(e),e.size);return this.sessionList.find((e=>e.key===t))}))}startAllUploadSessions(){return u(this,null,(function*(){yield Promise.all(this.sessionList.map((e=>e.start())))}))}stopAllUploadSessions(e=!1){return u(this,null,(function*(){yield Promise.all(this.sessionList.map((t=>t.stop(e))))}))}getStoredUploadSessionDataList(){try{return Object.keys(localStorage).filter((e=>/^upload_[A-Za-z0-9]+_\d+$/.test(e))).map((e=>JSON.parse(localStorage.getItem(e))))}catch(e){return[]}}clearExpiredUploadSessionsData(){try{Object.keys(localStorage).filter((e=>/^upload_[A-Za-z0-9]+_\d+$/.test(e))).map((e=>{let t=JSON.parse(localStorage.getItem(e));g(t.url)||localStorage.removeItem(t.lsKey)}))}catch(e){}}constructor(){this.sessionList=[],window.addEventListener("online",(()=>{this.startAllUploadSessions()})),window.addEventListener("offline",(()=>{this.stopAllUploadSessions(!0)}))}}},692:function(e,t){!function(e){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function i(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;var n=Array(e),r=0;for(t=0;t<i;t++)for(var a=arguments[t],s=0,o=a.length;s<o;s++,r++)n[r]=a[s];return n}function n(e,i){var n,r,a=(n={current:0,next:function(){return++this.current}},r={},{add:function(e,t){var i=null!=t?t:n.next();return r[i]=e,i},resolve:function(e,t,i){var n=r[e];n&&(i(t)?n.resolve(t):n.reject(t),r[e]=null)}});return i((function(e){if(e.detail&&e.detail.data&&"object"==typeof e.detail.data&&"request_id"in e.detail.data){var t=e.detail.data,i=t.request_id,n=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(i[n[r]]=e[n[r]])}return i}(t,["request_id"]);i&&a.resolve(i,n,(function(e){return!("error_type"in e)}))}})),function(i,n){return void 0===n&&(n={}),new Promise((function(r,s){var o=a.add({resolve:r,reject:s},n.request_id);e(i,t(t({},n),{request_id:o}))}))}}var r,a,s,o,c="undefined"!=typeof window,l=Boolean(c&&window.AndroidBridge),u=Boolean(c&&window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.VKWebAppClose),d=c&&!l&&!u,h=d&&/(^\?|&)vk_platform=mobile_web(&|$)/.test(location.search),p=d?"message":"VKWebAppEvent",_=i(["VKWebAppInit","VKWebAppGetCommunityAuthToken","VKWebAppAddToCommunity","VKWebAppAddToHomeScreenInfo","VKWebAppClose","VKWebAppCopyText","VKWebAppCreateHash","VKWebAppGetUserInfo","VKWebAppSetLocation","VKWebAppSendToClient","VKWebAppGetClientVersion","VKWebAppGetPhoneNumber","VKWebAppGetEmail","VKWebAppGetGroupInfo","VKWebAppGetGeodata","VKWebAppGetCommunityToken","VKWebAppGetConfig","VKWebAppGetLaunchParams","VKWebAppSetTitle","VKWebAppGetAuthToken","VKWebAppCallAPIMethod","VKWebAppJoinGroup","VKWebAppLeaveGroup","VKWebAppAllowMessagesFromGroup","VKWebAppDenyNotifications","VKWebAppAllowNotifications","VKWebAppOpenPayForm","VKWebAppOpenApp","VKWebAppShare","VKWebAppShowWallPostBox","VKWebAppScroll","VKWebAppShowOrderBox","VKWebAppShowLeaderBoardBox","VKWebAppShowInviteBox","VKWebAppShowRequestBox","VKWebAppAddToFavorites","VKWebAppShowCommunityWidgetPreviewBox","VKWebAppShowStoryBox","VKWebAppStorageGet","VKWebAppStorageGetKeys","VKWebAppStorageSet","VKWebAppFlashGetInfo","VKWebAppSubscribeStoryApp","VKWebAppOpenWallPost","VKWebAppCheckAllowedScopes","VKWebAppShowNativeAds","VKWebAppRetargetingPixel","VKWebAppConversionHit"],d&&!h?["VKWebAppResizeWindow","VKWebAppAddToMenu","VKWebAppShowSubscriptionBox","VKWebAppShowInstallPushBox","VKWebAppGetFriends"]:["VKWebAppShowImages"]),m=c?window.AndroidBridge:void 0,f=u?window.webkit.messageHandlers:void 0;function g(e,t){var i=t||{bubbles:!1,cancelable:!1,detail:void 0},n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!!i.bubbles,!!i.cancelable,i.detail),n}(r=e.EGrantedPermission||(e.EGrantedPermission={})).CAMERA="camera",r.LOCATION="location",r.PHOTO="photo",(a=e.EGetLaunchParamsResponseLanguages||(e.EGetLaunchParamsResponseLanguages={})).RU="ru",a.UK="uk",a.UA="ua",a.EN="en",a.BE="be",a.KZ="kz",a.PT="pt",a.ES="es",(s=e.EGetLaunchParamsResponseGroupRole||(e.EGetLaunchParamsResponseGroupRole={})).ADMIN="admin",s.EDITOR="editor",s.MEMBER="member",s.MODER="moder",s.NONE="none",(o=e.EGetLaunchParamsResponsePlatforms||(e.EGetLaunchParamsResponsePlatforms={})).DESKTOP_WEB="desktop_web",o.MOBILE_WEB="mobile_web",o.MOBILE_ANDROID="mobile_android",o.MOBILE_ANDROID_MESSENGER="mobile_android_messenger",o.MOBILE_IPHONE="mobile_iphone",o.MOBILE_IPHONE_MESSENGER="mobile_iphone_messenger",o.MOBILE_IPAD="mobile_ipad","undefined"==typeof window||window.CustomEvent||(window.CustomEvent=(g.prototype=Event.prototype,g));var v=function(e){var t=void 0,r=[];function a(e){r.push(e)}function s(){return u||l}function o(){return d&&window.parent!==window}function c(){return s()||o()}"undefined"!=typeof window&&"addEventListener"in window&&window.addEventListener(p,(function(e){if(u||l)return i(r).map((function(t){return t.call(null,e)}));if(d&&e&&e.data){var n=e.data,a=n.type,s=n.data,o=n.frameId;a&&"SetSupportedHandlers"===a?s.supportedHandlers:a&&"VKWebAppSettings"===a?t=o:i(r).map((function(e){return e({detail:{type:a,data:s}})}))}}));var h=n((function(i,n){m&&m[i]?m[i](JSON.stringify(n)):f&&f[i]&&"function"==typeof f[i].postMessage?f[i].postMessage(n):d&&parent.postMessage({handler:i,params:n,type:"vk-connect",webFrameId:t,connectVersion:e},"*")}),a);return{send:h,sendPromise:h,subscribe:a,unsubscribe:function(e){var t=r.indexOf(e);-1<t&&r.splice(t,1)},supports:function(e){return l?!(!m||"function"!=typeof m[e]):u?!(!f||!f[e]||"function"!=typeof f[e].postMessage):d&&-1<_.indexOf(e)},isWebView:s,isIframe:o,isEmbedded:c,isStandalone:function(){return!c()}}}("2.5.1");e.applyMiddleware=function e(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];return i.includes(void 0)||i.includes(null)?e.apply(void 0,i.filter((function(e){return"function"==typeof e}))):function(e){if(0===i.length)return e;var n,r={subscribe:e.subscribe,send:function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return e.send.apply(e,t)}};return n=i.filter((function(e){return"function"==typeof e})).map((function(e){return e(r)})).reduce((function(e,t){return function(i){return e(t(i))}}))(e.send),t(t({},e),{send:n})}},e.default=v,Object.defineProperty(e,"__esModule",{value:!0})}(t)}}]);